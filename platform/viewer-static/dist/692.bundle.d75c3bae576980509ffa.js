"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[692],{51692:(e,t,n)=>{n.r(t),n.d(t,{AdvancedMagnifyTool:()=>pd,AngleTool:()=>oh,AnnotationDisplayTool:()=>Mr,AnnotationTool:()=>Rr,ArrowAnnotateTool:()=>eh,BaseTool:()=>Ga,BidirectionalTool:()=>Ud,BrushTool:()=>Xs,CONSTANTS:()=>Z,CircleROITool:()=>hc,CircleScissorsTool:()=>bh,CobbAngleTool:()=>lh,CrosshairsTool:()=>od,DragProbeTool:()=>Yd,EllipticalROITool:()=>lc,Enums:()=>o,LengthTool:()=>Hd,MIPJumpToClickTool:()=>Ol,MagnifyTool:()=>rd,OrientationMarkerTool:()=>cm,OverlayGridTool:()=>Td,PaintFillTool:()=>Uh,PanTool:()=>il,PlanarFreehandROITool:()=>Yu,PlanarRotateTool:()=>ml,ProbeTool:()=>qd,RectangleROIStartEndThresholdTool:()=>Mh,RectangleROIThresholdTool:()=>yh,RectangleROITool:()=>oc,RectangleScissorsTool:()=>Ch,ReferenceCursors:()=>ch,ReferenceLines:()=>wd,ReferenceLinesTool:()=>wd,ScaleOverlayTool:()=>gh,SegmentationDisplayTool:()=>Ar,SegmentationIntersectionTool:()=>Sd,SphereScissorsTool:()=>Dh,StackScrollMouseWheelTool:()=>pl,StackScrollTool:()=>ul,Synchronizer:()=>qp,SynchronizerManager:()=>K,ToolGroupManager:()=>q,TrackballRotateTool:()=>sl,Types:()=>X,VideoRedactionTool:()=>Hv,VolumeRotateMouseWheelTool:()=>Cl,WindowLevelTool:()=>dl,ZoomTool:()=>El,addTool:()=>Xe,annotation:()=>b,cancelActiveManipulations:()=>$p,cursors:()=>C,destroy:()=>Dv,drawing:()=>v,init:()=>_v,removeTool:()=>Je,segmentation:()=>p,state:()=>Ze,synchronizers:()=>Y,utilities:()=>z});var o={};n.r(o),n.d(o,{AnnotationStyleStates:()=>ie,Events:()=>re,KeyboardBindings:()=>Q,MouseBindings:()=>J,SegmentationRepresentations:()=>le,Swipe:()=>de,ToolModes:()=>ne});var i={};n.r(i),n.d(i,{checkAndDefineIsLockedProperty:()=>Ee,getAnnotationsLocked:()=>fe,getAnnotationsLockedCount:()=>ve,isAnnotationLocked:()=>pe,setAnnotationLocked:()=>ge,unlockAllAnnotations:()=>me});var a={};n.r(a),n.d(a,{deselectAnnotation:()=>Se,getAnnotationsSelected:()=>ye,getAnnotationsSelectedByToolName:()=>Oe,getAnnotationsSelectedCount:()=>Me,isAnnotationSelected:()=>Pe,setAnnotationSelected:()=>De});var r={};n.r(r),n.d(r,{checkAndDefineIsVisibleProperty:()=>Ve,isAnnotationVisible:()=>Ue,setAnnotationVisibility:()=>Le,showAllAnnotations:()=>ke});var s={};n.r(s),n.d(s,{copyPoints:()=>Kt,copyPointsList:()=>zt,getDeltaDistance:()=>Wt,getDeltaDistanceBetweenIPoints:()=>$t,getDeltaPoints:()=>Ht,getDeltaRotation:()=>Gt,getMeanPoints:()=>qt,getMeanTouchPoints:()=>jt});var l={};n.r(l),n.d(l,{triggerSegmentationDataModified:()=>Yn,triggerSegmentationModified:()=>Zn,triggerSegmentationRemoved:()=>Kn,triggerSegmentationRepresentationModified:()=>jn,triggerSegmentationRepresentationRemoved:()=>qn});var d={};n.r(d),n.d(d,{addColorLUT:()=>Io,addSegmentation:()=>to,addSegmentationRepresentation:()=>ho,getAllSegmentationRepresentations:()=>oo,getColorLUT:()=>wo,getDefaultSegmentationStateManager:()=>Jn,getGlobalConfig:()=>go,getSegmentSpecificRepresentationConfig:()=>co,getSegmentation:()=>Qn,getSegmentationRepresentationByUID:()=>fo,getSegmentationRepresentationSpecificConfig:()=>lo,getSegmentationRepresentations:()=>no,getSegmentations:()=>eo,getToolGroupIdsWithSegmentation:()=>io,getToolGroupSpecificConfig:()=>ao,removeColorLUT:()=>Eo,removeSegmentation:()=>po,removeSegmentationRepresentation:()=>vo,setGlobalConfig:()=>mo,setSegmentSpecificRepresentationConfig:()=>uo,setSegmentationRepresentationSpecificConfig:()=>so,setToolGroupSpecificConfig:()=>ro});var c={};n.r(c),n.d(c,{getActiveSegmentationRepresentation:()=>ya,setActiveSegmentationRepresentation:()=>Oa});var u={};n.r(u),n.d(u,{getLockedSegments:()=>xa,isSegmentIndexLocked:()=>Pa,setSegmentIndexLocked:()=>Ma});var h={};n.r(h),n.d(h,{addColorLUT:()=>Ra,getColorForSegmentIndex:()=>Aa,setColorForSegmentIndex:()=>La,setColorLUT:()=>Na});var g={};n.r(g),n.d(g,{getSegmentationVisibility:()=>Ua,setSegmentVisibility:()=>Ba,setSegmentationVisibility:()=>ka,setSegmentsVisibility:()=>Va});var m={};n.r(m),n.d(m,{color:()=>h,getGlobalConfig:()=>Co,getGlobalRepresentationConfig:()=>bo,getSegmentSpecificConfig:()=>Po,getSegmentationRepresentationSpecificConfig:()=>yo,getToolGroupSpecificConfig:()=>Do,setGlobalConfig:()=>To,setGlobalRepresentationConfig:()=>_o,setSegmentSpecificConfig:()=>Mo,setSegmentationRepresentationSpecificConfig:()=>Oo,setToolGroupSpecificConfig:()=>So,visibility:()=>g});var f={};n.r(f),n.d(f,{getActiveSegmentIndex:()=>Ha,setActiveSegmentIndex:()=>Fa});var p={};n.r(p),n.d(p,{activeSegmentation:()=>c,addSegmentationRepresentations:()=>Sa,addSegmentations:()=>di,config:()=>m,removeSegmentationsFromToolGroup:()=>ri,segmentIndex:()=>f,segmentLocking:()=>u,state:()=>d,triggerSegmentationEvents:()=>l});var v={};n.r(v),n.d(v,{draw:()=>Xa,drawArrow:()=>gr,drawCircle:()=>tr,drawEllipse:()=>nr,drawHandles:()=>or,drawLine:()=>ir,drawLinkedTextBox:()=>ur,drawPolyline:()=>ar,drawRect:()=>hr,drawRedactionRect:()=>mr,drawTextBox:()=>lr,setAttributesIfNecessary:()=>Qa,setNewAttributesIfValid:()=>er});var E={};n.r(E),n.d(E,{getFont:()=>Or,getState:()=>yr,style:()=>Dr});var w={};n.r(w),n.d(w,{extend2DBoundingBoxInViewAxis:()=>ns,getBoundingBoxAroundShape:()=>os});var I={};n.r(I),n.d(I,{getCanvasEllipseCorners:()=>gs,pointInEllipse:()=>hs});var C={};n.r(C),n.d(C,{CursorNames:()=>Gs,CursorSVG:()=>Rs,ImageMouseCursor:()=>_s,MouseCursor:()=>Cs,SVGMouseCursor:()=>Vs,elementCursor:()=>T,registerCursor:()=>As,setCursorForElement:()=>Ws});var T={};n.r(T),n.d(T,{hideElementCursor:()=>js,initElementCursor:()=>zs,resetElementCursor:()=>qs,setElementCursor:()=>Ks});var b={};n.r(b),n.d(b,{FrameOfReferenceSpecificAnnotationManager:()=>Ke,config:()=>E,locking:()=>i,selection:()=>a,state:()=>j,visibility:()=>r});var _={};n.r(_),n.d(_,{default:()=>Dl,filterAnnotationsForDisplay:()=>_r,filterAnnotationsWithinSlice:()=>br,getPointInLineOfSightWithCriteria:()=>bl,getWorldWidthAndHeightFromCorners:()=>Tl});var D={};n.r(D),n.d(D,{filterViewportsWithFrameOfReferenceUID:()=>Ml,filterViewportsWithParallelNormals:()=>kl,filterViewportsWithToolEnabled:()=>Al,getViewportIdsWithToolToRender:()=>Ul});var S={};n.r(S),n.d(S,{distanceToPoint:()=>zl,distanceToPointSquared:()=>$l,intersectLine:()=>ql});var y={};n.r(y),n.d(y,{distanceToPoint:()=>sd});var O={};n.r(O),n.d(O,{getTextBoxCoordsCanvas:()=>Nd});var P={};n.r(P),n.d(P,{distanceToPoint:()=>Xd});var M={};n.r(M),n.d(M,{BasicStatsCalculator:()=>Qd,Calculator:()=>Jd});var x={};n.r(x),n.d(x,{findClosestPoint:()=>dr,liangBarksyClip:()=>Wl});var R={};n.r(R),n.d(R,{addCanvasPointsToArray:()=>bc,calculateAreaOfPoints:()=>Dc,getClosestIntersectionWithPolyline:()=>fc,getFirstIntersectionWithPolyline:()=>mc,getSubPixelSpacingAndXYDirections:()=>Cc,pointCanProjectOnLine:()=>_c,pointsAreWithinCloseContourProximity:()=>Tc});var N={};n.r(N),n.d(N,{BasicStatsCalculator:()=>M,ellipse:()=>I,lineSegment:()=>S,point:()=>y,polyline:()=>R,rectangle:()=>P,vec2:()=>x});var A={};n.r(A),n.d(A,{createLabelmapVolumeForViewport:()=>pm,createMergedLabelmapForIndex:()=>gm,floodFill:()=>Nh,getBrushSizeForToolGroup:()=>Em,getBrushThresholdForToolGroup:()=>Im,getDefaultRepresentationConfig:()=>fm,isValidRepresentationConfig:()=>mm,rectangleROIThresholdVolumeByRange:()=>hm,setBrushSizeForToolGroup:()=>vm,setBrushThresholdForToolGroup:()=>wm,thresholdSegmentationByRange:()=>Cm,thresholdVolumeByRange:()=>nl,triggerSegmentationRender:()=>kr});var L={};n.r(L),n.d(L,{getOrientationStringLPS:()=>Tm,invertOrientationStringLPS:()=>bm});var k={};n.r(k),n.d(k,{Events:()=>Dm,addToolState:()=>ym,getToolState:()=>Om,playClip:()=>Am,stopClip:()=>Lm});var U={};n.r(U),n.d(U,{default:()=>Fm,interpolateAnnotation:()=>Bm});var V={};n.r(V),n.d(V,{getBoundsIJKFromRectangleAnnotations:()=>um});var B={};n.r(B),n.d(B,{isViewportPreScaled:()=>Gd,jumpToSlice:()=>es,jumpToWorld:()=>Sl});var F={};n.r(F),n.d(F,{generateImageFromTimeData:()=>uf,getDataInTime:()=>cf});var H={};n.r(H),n.d(H,{getPoint:()=>hf,getPolyDataPointIndexes:()=>gf,getPolyDataPoints:()=>mf});var W={};n.r(W),n.d(W,{ColorbarRangeTextPosition:()=>ff});var G={};n.r(G),n.d(G,{Colorbar:()=>Sf,Enums:()=>W,ViewportColorbar:()=>Pf});var $={};n.r($),n.d($,{colorbar:()=>G});var z={};n.r(z),n.d(z,{boundingBox:()=>w,calibrateImageSpacing:()=>Xr,cine:()=>k,clip:()=>Zr,debounce:()=>Kr,drawing:()=>O,dynamicVolume:()=>F,getAnnotationNearPoint:()=>Wr,getAnnotationNearPointOnEnabledElement:()=>Gr,isObject:()=>zr,jumpToSlice:()=>es,math:()=>N,orientation:()=>L,planar:()=>_,planarFreehandROITool:()=>U,pointInShapeCallback:()=>ts,pointInSurroundingSphereCallback:()=>as,pointToString:()=>Ca,polyDataUtils:()=>H,rectangleROITool:()=>V,roundNumber:()=>rs,scroll:()=>Qr,segmentation:()=>A,stackContextPrefetch:()=>df,stackPrefetch:()=>tf,throttle:()=>qr,touch:()=>s,triggerAnnotationRender:()=>Ir,triggerAnnotationRenderForViewportIds:()=>Jr,triggerEvent:()=>te.triggerEvent,viewport:()=>B,viewportFilters:()=>D,voi:()=>$});var K={};n.r(K),n.d(K,{createSynchronizer:()=>jp,destroy:()=>Zp,destroySynchronizer:()=>Jp,getAllSynchronizers:()=>Xp,getSynchronizer:()=>Yp,getSynchronizersForViewport:()=>Up});var q={};n.r(q),n.d(q,{createToolGroup:()=>rv,destroy:()=>lv,destroyToolGroup:()=>sv,getAllToolGroups:()=>cv,getToolGroup:()=>dv,getToolGroupForViewport:()=>Vp,getToolGroupsWithToolName:()=>hv});var j={};n.r(j),n.d(j,{addAnnotation:()=>Ev,getAnnotation:()=>Cv,getAnnotationManager:()=>mv,getAnnotations:()=>vv,getNumberOfAnnotations:()=>wv,removeAllAnnotations:()=>Tv,removeAnnotation:()=>Iv,resetAnnotationManager:()=>pv,setAnnotationManager:()=>fv});var Z={};n.r(Z),n.d(Z,{COLOR_LUT:()=>Un});var Y={};n.r(Y),n.d(Y,{createCameraPositionSynchronizer:()=>Mv,createStackImageSynchronizer:()=>Bv,createVOISynchronizer:()=>Rv,createZoomPanSynchronizer:()=>Lv});var X={};n.r(X);var J,Q,ee,te=n(82125);!function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button"}(J||(J={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(Q||(Q={})),function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(ee||(ee={}));const ne=ee;var oe;!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked"}(oe||(oe={}));const ie=oe;var ae;!function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(ae||(ae={}));const re=ae;var se;!function(e){e.Labelmap="LABELMAP",e.Contour="CONTOUR",e.Surface="SURFACE"}(se||(se={}));const le=se;var de;!function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(de||(de={}));var ce=n(11677),ue=n.n(ce);const he=new Set;function ge(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=we();e&&(t?function(e,t,n){t.has(e)||(t.add(e),n.added.push(e))}(e,he,n):Ie(e,he,n)),Ce(n,he)}function me(){const e=we();!function(e,t){e.forEach((n=>{Ie(n,e,t)}))}(he,e),Ce(e,he)}function fe(){return Array.from(he)}function pe(e){return he.has(e)}function ve(){return he.size}function Ee(e){if(e){const t=!!e.isLocked;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isLocked");if(t)return t.configurable&&(t.set!==Te||t.get!==be);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:Te,get:be}),ge(e,t)}}function we(){return Object.freeze({added:[],removed:[],locked:[]})}function Ie(e,t,n){t.delete(e)&&n.removed.push(e)}function Ce(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.locked.push(t)})),(0,te.triggerEvent)(te.eventTarget,re.ANNOTATION_LOCK_CHANGE,e))}function Te(e){ge(this,e)}function be(){return pe(this)}const _e=new Set;function De(e){!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=xe();t||Re(_e,n);e&&!_e.has(e)&&(_e.add(e),n.added.push(e));Ne(n,_e)}(e,arguments.length>2&&void 0!==arguments[2]&&arguments[2]):Se(e)}function Se(e){const t=xe();e?_e.delete(e)&&t.removed.push(e):Re(_e,t),Ne(t,_e)}function ye(){return Array.from(_e)}function Oe(e){return ye().filter((t=>Cv(t).metadata.toolName===e))}function Pe(e){return _e.has(e)}function Me(){return _e.size}function xe(){return Object.freeze({added:[],removed:[],selection:[]})}function Re(e,t){e.forEach((n=>{e.delete(n)&&t.removed.push(n)}))}function Ne(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.selection.push(t)})),(0,te.triggerEvent)(te.eventTarget,re.ANNOTATION_SELECTION_CHANGE,e))}const Ae=new Set;function Le(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=Be();e&&(t?Fe(e,Ae,n):function(e,t,n){t.has(e)||(t.add(e),Pe(e)&&Se(e),n.lastHidden.push(e))}(e,Ae,n)),He(n)}function ke(){const e=Be();Ae.forEach((t=>{Fe(t,Ae,e)})),He(e)}function Ue(e){if(Cv(e))return!Ae.has(e)}function Ve(e){if(e){const t=e.isVisible??!0;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isVisible");if(t)return t.configurable&&(t.set!==We||t.get!==Ge);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:We,get:Ge}),Le(e.annotationUID,t)}}function Be(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function Fe(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function He(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(Ae.forEach((t=>{e.hidden.push(t)})),(0,te.triggerEvent)(te.eventTarget,re.ANNOTATION_VISIBILITY_CHANGE,e))}function We(e){Le(this.annotationUID,e)}function Ge(){return Ue(this.annotationUID)}class $e{constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;const t=e,n=(0,te.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{const t=e.detail,{FrameOfReferenceUID:n}=t,o=this.annotations[n];o&&Object.keys(o).forEach((e=>{o[e].forEach((e=>{void 0!==e.invalidated&&(e.invalidated=!0)}))}))},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{const n=this.annotations;return n[e]?t?n[e][t]:n[e]:[]},this.getAnnotation=e=>{const t=this.annotations;for(const n in t){const o=t[n];for(const t in o){const n=o[t];for(const t of n)if(e===t.annotationUID)return t}}},this.getNumberOfAnnotations=(e,t)=>{const n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let o=0;for(const e in n)o+=n[e].length;return o},this.addAnnotation=(e,t)=>{const{metadata:n}=e,{FrameOfReferenceUID:o,toolName:i}=n;t=t||o;const a=this.annotations;let r=a[t];r||(a[t]={},r=a[t]);let s=r[i];s||(r[i]=[],s=r[i]),s.push(e),Ee(e),Ve(e)},this.removeAnnotation=e=>{const{annotations:t}=this;for(const n in t){const o=t[n];for(const t in o){const n=o[t],i=n.findIndex((t=>t.annotationUID===e));-1!==i&&(n.splice(i,1),0===n.length&&delete o[t])}0===Object.keys(o).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{const n=this.annotations;n[e]&&(t?delete n[e][t]:delete n[e])},this.saveAnnotations=(e,t)=>{const n=this.annotations;if(e&&t){const o=n[e];if(!o)return;const i=o[t];return ue()(i)}if(e){const t=n[e];return ue()(t)}return ue()(n)},this.restoreAnnotations=(e,t,n)=>{const o=this.annotations;if(t&&n){let i=o[t];i||(o[t]={},i=o[t]),i[n]=e}else t?o[t]=e:this.annotations=ue()(e)},this.getNumberOfAllAnnotations=()=>{let e=0;const t=this.annotations;for(const n in t){const o=t[n];for(const t in o){e+=o[t].length}}return e},this.removeAllAnnotations=()=>{this.annotations={}},e||(e=te.utilities.uuidv4()),this.annotations={},this.uid=e,te.eventTarget.addEventListener(te.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}}const ze=new $e("DEFAULT"),Ke=$e;let qe={};const je={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:qe,enabledElements:[],handleRadius:6};let Ze={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:qe,enabledElements:[],handleRadius:6};function Ye(){qe={},Ze=ue()(je)}function Xe(e){const t=e.toolName,n=void 0!==Ze.tools[t];if(!t)throw new Error(`No Tool Found for the ToolClass ${e.name}`);if(n)throw new Error(`${t} has already been added globally`);Ze.tools[t]={toolClass:e}}function Je(e){const t=e.toolName;if(!t)throw new Error(`No tool found for: ${e.name}`);if(void 0===!Ze.tools[t])throw new Error(`${t} cannot be removed because it has not been added`);delete Ze.tools[t]}function Qe(e,t){const n=t||e.currentTarget,{viewport:o}=(0,te.getEnabledElement)(n),i=function(e){return[e.clientX,e.clientY]}(e),a=function(e){return[e.pageX,e.pageY]}(e),r=function(e,t){const n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,a);return{page:a,client:i,canvas:r,world:o.canvasToWorld(r)}}const et=function(e){const t=e.currentTarget,{viewportId:n,renderingEngineId:o}=(0,te.getEnabledElement)(t),i=Qe(e,t),a={event:e,eventName:re.MOUSE_DOUBLE_CLICK,viewportId:n,renderingEngineId:o,camera:{},element:t,startPoints:i,lastPoints:i,currentPoints:i,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};!(0,te.triggerEvent)(t,re.MOUSE_DOUBLE_CLICK,a)&&(e.stopImmediatePropagation(),e.preventDefault())},tt=re.MOUSE_MOVE;const nt=function(e){const t=e.currentTarget,n=(0,te.getEnabledElement)(t),{renderingEngineId:o,viewportId:i}=n,a={renderingEngineId:o,viewportId:i,camera:{},element:t,currentPoints:Qe(e),eventName:tt,event:e};!(0,te.triggerEvent)(t,tt,a)&&(e.stopImmediatePropagation(),e.preventDefault())},{MOUSE_DOWN:ot,MOUSE_DOWN_ACTIVATE:it,MOUSE_CLICK:at,MOUSE_UP:rt,MOUSE_DRAG:st}=re,lt=3,dt={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};let ct={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};const ut={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function ht(e){if("cornerstone-canvas"!==e.target.className)return;const t=Qe(e,ct.element),n=Ct(ct.element,ct.lastPoints),o=Tt(t,n);if(ut.doubleClickTimeout){if(!ft(o.canvas))return;vt()}const i={event:e,eventName:st,mouseButton:ct.mouseButton,renderingEngineId:ct.renderingEngineId,viewportId:ct.viewportId,camera:{},element:ct.element,startPoints:It(ct.startPoints),lastPoints:It(n),currentPoints:t,deltaPoints:o};!(0,te.triggerEvent)(ct.element,st,i)&&(e.stopImmediatePropagation(),e.preventDefault()),ct.lastPoints=It(t)}function gt(e){if("cornerstone-canvas"===e.target.className){if(clearTimeout(ct.preventClickTimeout),ut.doubleClickTimeout)ut.mouseUpEvent?wt():(ut.mouseUpEvent=e,ct.element.addEventListener("mousemove",mt));else{const t=ct.isClickEvent?at:rt,n=Qe(e,ct.element),o=Tt(n,ct.lastPoints),i={event:e,eventName:t,mouseButton:ct.mouseButton,element:ct.element,renderingEngineId:ct.renderingEngineId,viewportId:ct.viewportId,camera:{},startPoints:It(ct.startPoints),lastPoints:It(ct.lastPoints),currentPoints:n,deltaPoints:o};(0,te.triggerEvent)(i.element,t,i),wt()}document.removeEventListener("mousemove",ht)}}function mt(e){ft(Tt(Qe(e,ct.element),Ct(ct.element,ct.lastPoints)).canvas)&&(vt(),nt(e))}function ft(e){return Math.abs(e[0])+Math.abs(e[1])>lt}function pt(){ct.isClickEvent=!1}function vt(){ut.ignoreDoubleClick=!0;const e=ut.mouseDownEvent,t=ut.mouseUpEvent;Et(),function(e){const t=Tt(ct.startPoints,ct.startPoints),n={event:e,eventName:ot,element:ct.element,mouseButton:ct.mouseButton,renderingEngineId:ct.renderingEngineId,viewportId:ct.viewportId,camera:{},startPoints:ct.startPoints,lastPoints:ct.startPoints,currentPoints:ct.startPoints,deltaPoints:t};ct.lastPoints=It(n.lastPoints),(0,te.triggerEvent)(n.element,ot,n)&&(0,te.triggerEvent)(n.element,it,n)}(e),t&&gt(t)}function Et(){ut.doubleClickTimeout&&(clearTimeout(ut.doubleClickTimeout),ut.doubleClickTimeout=null),ut.mouseDownEvent=null,ut.mouseUpEvent=null}function wt(){document.removeEventListener("mouseup",gt),ct.element?.removeEventListener("mousemove",mt),ct.element?.addEventListener("mousemove",nt),Et(),ct=JSON.parse(JSON.stringify(dt))}function It(e){return JSON.parse(JSON.stringify(e))}function Ct(e,t){const{viewport:n}=(0,te.getEnabledElement)(e),o=n.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:o}}function Tt(e,t){return{page:bt(e.page,t.page),client:bt(e.client,t.client),canvas:bt(e.canvas,t.canvas),world:(n=e.world,o=t.world,[n[0]-o[0],n[1]-o[1],n[2]-o[2]])};var n,o}function bt(e,t){return[e[0]-t[0],e[1]-t[1]]}function _t(e){ut.ignoreDoubleClick?(ut.ignoreDoubleClick=!1,e.stopImmediatePropagation(),e.preventDefault()):wt()}const Dt=function(e){if(ut.doubleClickTimeout){if(e.buttons===ut.mouseDownEvent.buttons)return;return ut.mouseDownEvent=e,void vt()}ut.doubleClickTimeout=setTimeout(vt,1===e.buttons?400:150),ut.mouseDownEvent=e,ut.ignoreDoubleClick=!1,ct.element=e.currentTarget,ct.mouseButton=e.buttons;const t=(0,te.getEnabledElement)(ct.element),{renderingEngineId:n,viewportId:o}=t;ct.renderingEngineId=n,ct.viewportId=o,ct.preventClickTimeout=setTimeout(pt,ct.clickDelay),ct.element.removeEventListener("mousemove",nt);const i=Qe(e,ct.element);ct.startPoints=It(i),ct.lastPoints=It(i),document.addEventListener("mouseup",gt),document.addEventListener("mousemove",ht)};function St(e){e.removeEventListener("dblclick",et),e.removeEventListener("mousedown",Dt),e.removeEventListener("mousemove",nt),e.removeEventListener("dblclick",_t,{capture:!0})}const yt={enable:function(e){St(e),e.addEventListener("dblclick",et),e.addEventListener("mousedown",Dt),e.addEventListener("mousemove",nt),e.addEventListener("dblclick",_t,{capture:!0})},disable:St},Ot={mouse:0,touch:1};let Pt,Mt;function xt(e,t){const n=Date.now();if(e!==Pt){if(n-Mt<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;Pt=e}Mt=n}const Rt=xt.bind(null,Ot.mouse),Nt=xt.bind(null,Ot.touch);function At(e,t,n){const o=n?Rt:Nt;t.forEach((function(t){e.addEventListener(t,o,{passive:!1})}))}function Lt(e,t,n){const o=n?Rt:Nt;t.forEach((function(t){e.removeEventListener(t,o)}))}const kt=["mousedown","mouseup","mousemove"],Ut=["touchstart","touchend"];function Vt(e){Lt(e,kt,Ot.mouse),Lt(e,Ut,Ot.touch)}const Bt={enable:function(e){Vt(e),At(e,kt,Ot.mouse),At(e,Ut,Ot.touch)},disable:Vt};function Ft(e,t){const n=t||e.currentTarget,o="touchend"===e.type?e.changedTouches:e.touches;return Object.keys(o).map((e=>{const t=function(e){return[e.clientX,e.clientY]}(o[e]),i=function(e){return[e.pageX,e.pageY]}(o[e]),a=function(e,t){const n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,i),{viewport:r}=(0,te.getEnabledElement)(n);return{page:i,client:t,canvas:a,world:r.canvasToWorld(a),touch:{identifier:e,radiusX:o[e].radiusX,radiusY:o[e].radiusY,force:o[e].force,rotationAngle:o[e].rotationAngle}}}))}function Ht(e,t){const n=qt(e),o=qt(t);return{page:Zt(n.page,o.page),client:Zt(n.client,o.client),canvas:Zt(n.canvas,o.canvas),world:(i=n.world,a=o.world,[i[0]-a[0],i[1]-a[1],i[2]-a[2]])};var i,a}function Wt(e,t){const n=qt(e),o=qt(t);return{page:Xt(n.page,o.page),client:Xt(n.client,o.client),canvas:Xt(n.canvas,o.canvas),world:Jt(n.world,o.world)}}function Gt(e,t){}function $t(e,t){const n=Yt(e),o=Yt(t);return{page:n.page-o.page,client:n.client-o.client,canvas:n.canvas-o.canvas,world:n.world-o.world}}function zt(e){return JSON.parse(JSON.stringify(e))}function Kt(e){return JSON.parse(JSON.stringify(e))}function qt(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function jt(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function Zt(e,t){return[e[0]-t[0],e[1]-t[1]]}function Yt(e){const t=[];for(let n=0;n<e.length;n++)for(let o=0;o<e.length;o++)n<o&&t.push({page:Xt(e[n].page,e[o].page),client:Xt(e[n].client,e[o].client),canvas:Xt(e[n].canvas,e[o].canvas),world:Jt(e[n].world,e[o].world)});return t.reduce(((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length})),{page:0,client:0,canvas:0,world:0})}function Xt(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function Jt(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}te.Settings.getRuntimeSettings();const{TOUCH_START:Qt,TOUCH_START_ACTIVATE:en,TOUCH_PRESS:tn,TOUCH_DRAG:nn,TOUCH_END:on,TOUCH_TAP:an,TOUCH_SWIPE:rn}=re,sn={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},ln={page:0,client:0,canvas:0,world:0},dn={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...sn,touch:null}],lastPointsList:[{...sn,touch:null}],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:ln,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},cn={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...sn,touch:null}],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300};let un=JSON.parse(JSON.stringify(dn)),hn=JSON.parse(JSON.stringify(cn));function gn(e,t,n){return(0,te.triggerEvent)(e,t,n)}function mn(e){const t=Ft(e,un.element),n=pn(un.element,un.lastPointsList),o=t.length===n.length?Ht(t,n):sn,i=t.length===n.length?$t(t,n):ln,a=t.length===n.length?Wt(t,un.lastPointsList):ln;un.accumulatedDistance={page:un.accumulatedDistance.page+a.page,client:un.accumulatedDistance.client+a.client,canvas:un.accumulatedDistance.canvas+a.canvas,world:un.accumulatedDistance.world+a.world};const r={event:e,eventName:nn,renderingEngineId:un.renderingEngineId,viewportId:un.viewportId,camera:{},element:un.element,startPoints:jt(un.startPointsList),lastPoints:jt(n),currentPoints:jt(t),startPointsList:zt(un.startPointsList),lastPointsList:zt(n),currentPointsList:t,deltaPoints:o,deltaDistance:i};gn(un.element,nn,r),function(e,t){const n=(new Date).getTime(),o=un.startTime.getTime();if(un.swiped||n-o>un.swipeToleranceMs)return;const[i,a]=t.canvas,r={event:e,eventName:rn,renderingEngineId:un.renderingEngineId,viewportId:un.viewportId,camera:{},element:un.element,swipe:null};Math.abs(i)>un.swipeDistanceThreshold&&(r.swipe=i>0?de.RIGHT:de.LEFT,gn(r.element,rn,r),un.swiped=!0);Math.abs(a)>un.swipeDistanceThreshold&&(r.swipe=a>0?de.DOWN:de.UP,gn(r.element,rn,r),un.swiped=!0)}(e,o),un.lastPointsList=zt(t)}function fn(e){clearTimeout(un.pressTimeout);const t=Ft(e,un.element),n=pn(un.element,un.lastPointsList),o=t.length===n.length?Ht(t,n):Ht(t,t),i=t.length===n.length?$t(t,n):$t(t,t),a={event:e,eventName:on,element:un.element,renderingEngineId:un.renderingEngineId,viewportId:un.viewportId,camera:{},startPointsList:zt(un.startPointsList),lastPointsList:zt(n),currentPointsList:t,startPoints:jt(un.startPointsList),lastPoints:jt(n),currentPoints:jt(t),deltaPoints:o,deltaDistance:i};gn(a.element,on,a),function(e){const t=(new Date).getTime(),n=un.startTime.getTime();if(t-n>hn.tapToleranceMs)return;0===hn.taps&&(hn.element=un.element,hn.renderingEngineId=un.renderingEngineId,hn.viewportId=un.viewportId,hn.startPointsList=un.startPointsList);if(hn.taps>0&&(hn.element!=un.element||hn.renderingEngineId!=un.renderingEngineId||hn.viewportId!=un.viewportId))return;const o=Ft(e,hn.element),i=Wt(o,hn.startPointsList).canvas;if(i>hn.tapMaxDistance)return;clearTimeout(hn.tapTimeout),hn.taps+=1,hn.tapTimeout=setTimeout((()=>{const t={event:e,eventName:an,element:hn.element,renderingEngineId:hn.renderingEngineId,viewportId:hn.viewportId,camera:{},currentPointsList:o,currentPoints:jt(o),taps:hn.taps};gn(t.element,an,t),hn=JSON.parse(JSON.stringify(cn))}),hn.tapToleranceMs)}(e),un=JSON.parse(JSON.stringify(dn)),document.removeEventListener("touchmove",mn),document.removeEventListener("touchend",fn)}function pn(e,t){const{viewport:n}=(0,te.getEnabledElement)(e);return t.map((e=>{const t=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:t,touch:e.touch}}))}const vn=function(e){un.element=e.currentTarget;const t=(0,te.getEnabledElement)(un.element),{renderingEngineId:n,viewportId:o}=t;un.renderingEngineId=n,un.viewportId=o,un.isTouchStart||(clearTimeout(un.pressTimeout),un.pressTimeout=setTimeout((()=>function(e){if(un.accumulatedDistance.canvas>un.pressMaxDistance)return;const t={event:e,eventName:tn,renderingEngineId:un.renderingEngineId,viewportId:un.viewportId,camera:{},element:un.element,startPointsList:zt(un.startPointsList),lastPointsList:zt(un.lastPointsList),startPoints:Kt(jt(un.startPointsList)),lastPoints:Kt(jt(un.lastPointsList))};gn(t.element,tn,t)}(e)),un.pressDelay),function(e){un.isTouchStart=!0,un.startTime=new Date;const t=Ft(e,un.element),n=jt(t),o=sn,i=ln,a={event:e,eventName:Qt,element:un.element,renderingEngineId:un.renderingEngineId,viewportId:un.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:o,deltaDistance:i};un.startPointsList=zt(a.startPointsList),un.lastPointsList=zt(a.lastPointsList);gn(a.element,Qt,a)&&gn(a.element,en,a)}(e),document.addEventListener("touchmove",mn),document.addEventListener("touchend",fn))};function En(e){Bt.disable(e),e.removeEventListener("touchstart",vn)}const wn={enable:function(e){En(e),Bt.enable(e),e.addEventListener("touchstart",vn,{passive:!1})},disable:En},In=10,Cn=40,Tn=800;const bn=function(e){const t=e.currentTarget,n=(0,te.getEnabledElement)(t),{renderingEngineId:o,viewportId:i}=n;if(e.deltaY>-1&&e.deltaY<1)return;e.preventDefault();const{spinX:a,spinY:r,pixelX:s,pixelY:l}=function(e){let t=0,n=0,o=0,i=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),o=t*In,i=n*In,"deltaY"in e&&(i=e.deltaY),"deltaX"in e&&(o=e.deltaX),(o||i)&&e.deltaMode&&(1===e.deltaMode?(o*=Cn,i*=Cn):(o*=Tn,i*=Tn)),o&&!t&&(t=o<1?-1:1),i&&!n&&(n=i<1?-1:1),{spinX:t,spinY:n,pixelX:o,pixelY:i}}(e),d=r<0?-1:1,c={event:e,eventName:re.MOUSE_WHEEL,renderingEngineId:o,viewportId:i,element:t,camera:{},detail:e,wheel:{spinX:a,spinY:r,pixelX:s,pixelY:l,direction:d},points:Qe(e)};(0,te.triggerEvent)(t,re.MOUSE_WHEEL,c)};function _n(e){e.removeEventListener("wheel",bn)}const Dn={enable:function(e){_n(e),e.addEventListener("wheel",bn,{passive:!1})},disable:_n},Sn={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};let yn={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function On(e){yn.element=e.currentTarget;const t=(0,te.getEnabledElement)(yn.element),{renderingEngineId:n,viewportId:o}=t;yn.renderingEngineId=n,yn.viewportId=o,yn.key=e.key,yn.keyCode=e.keyCode,e.preventDefault();const i={renderingEngineId:yn.renderingEngineId,viewportId:yn.viewportId,element:yn.element,key:yn.key,keyCode:yn.keyCode};(0,te.triggerEvent)(i.element,re.KEY_DOWN,i),document.addEventListener("keyup",Mn),document.addEventListener("visibilitychange",Pn),yn.element.removeEventListener("keydown",On)}function Pn(){document.removeEventListener("visibilitychange",Pn),"hidden"===document.visibilityState&&xn()}function Mn(e){const t={renderingEngineId:yn.renderingEngineId,viewportId:yn.viewportId,element:yn.element,key:yn.key,keyCode:yn.keyCode};document.removeEventListener("keyup",Mn),document.removeEventListener("visibilitychange",Pn),yn.element.addEventListener("keydown",On),yn=ue()(Sn),(0,te.triggerEvent)(t.element,re.KEY_UP,t)}function xn(){yn.keyCode=void 0}const Rn=On;function Nn(e){e.removeEventListener("keydown",Rn)}const An={enable:function(e){Nn(e),e.addEventListener("keydown",Rn)},disable:Nn,getModifierKey:function(){return yn.keyCode}};var Ln=n(2242),kn=n(56090);const Un=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]],Vn={renderOutline:!0,outlineWidthActive:2,outlineWidthInactive:2,outlineOpacity:1,outlineOpacityInactive:.85,renderFill:!0,fillAlpha:1,fillAlphaInactive:0};const Bn=function(){return Vn},Fn={renderOutline:!0,outlineWidthActive:3,outlineWidthInactive:2,renderFill:!0,renderFillInactive:!0,fillAlpha:.7,fillAlphaInactive:.65,outlineOpacity:1,outlineOpacityInactive:.85};const Hn=function(){return Fn},Wn=Hn(),Gn=Bn(),$n={colorLUT:[],segmentations:[],globalConfig:{renderInactiveSegmentations:!0,representations:{[le.Labelmap]:Wn,[le.Contour]:Gn}},toolGroups:{}};const zn=new class{constructor(e){e||(e=te.utilities.uuidv4()),this.state=ue()($n),this.uid=e}getState(){return this.state}getToolGroups(){return Object.keys(this.state.toolGroups)}getColorLUT(e){return this.state.colorLUT[e]}resetState(){this.state=ue()($n)}getSegmentation(e){return this.state.segmentations.find((t=>t.segmentationId===e))}addSegmentation(e){if(this._initDefaultColorLUTIfNecessary(),this.getSegmentation(e.segmentationId))throw new Error(`Segmentation with id ${e.segmentationId} already exists`);this.state.segmentations.push(e)}getSegmentationRepresentations(e){const t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}getAllSegmentationRepresentations(){const e={};return Object.entries(this.state.toolGroups).forEach((t=>{let[n,o]=t;e[n]=o.segmentationRepresentations})),e}addSegmentationRepresentation(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}getGlobalConfig(){return this.state.globalConfig}setGlobalConfig(e){this.state.globalConfig=e}getSegmentationRepresentationByUID(e,t){return this.getSegmentationRepresentations(e).find((e=>e.segmentationRepresentationUID===t))}removeSegmentation(e){this.state.segmentations=this.state.segmentations.filter((t=>t.segmentationId!==e))}removeSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No viewport specific segmentation state found for viewport ${e}`);const o=n.findIndex((e=>e.segmentationRepresentationUID===t));-1===o&&console.warn(`No viewport specific segmentation state data found for viewport ${e} and segmentation data UID ${t}`);const i=n[o];n.splice(o,1),this._handleActiveSegmentation(e,i)}setActiveSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No segmentation data found for toolGroupId: ${e}`);const o=n.find((e=>e.segmentationRepresentationUID===t));if(!o)throw new Error(`No segmentation data found for segmentation data UID ${t}`);o.active=!0,this._handleActiveSegmentation(e,o)}getToolGroupSpecificConfig(e){const t=this.state.toolGroups[e];if(t)return t.config}getSegmentationRepresentationSpecificConfig(e,t){const n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}setSegmentationRepresentationSpecificConfig(e,t,n){const o=this.getSegmentationRepresentationByUID(e,t);o&&(o.segmentationRepresentationSpecificConfig=n)}getSegmentSpecificConfig(e,t,n){const o=this.getSegmentationRepresentationByUID(e,t);if(o)return o.segmentSpecificConfig[n]}setSegmentSpecificConfig(e,t,n){const o=this.getSegmentationRepresentationByUID(e,t);o&&(o.segmentSpecificConfig=n)}setSegmentationRepresentationConfig(e,t){let n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config={...n.config,...t}}addColorLUT(e,t){this.state.colorLUT[t]&&console.log("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=e}removeColorLUT(e){delete this.state.colorLUT[e]}_handleActiveSegmentation(e,t){const n=this.getSegmentationRepresentations(e);if(0===n.length)return;if(1===n.length)return void(n[0].active=!0);0!==n.filter((e=>e.active)).length?t.active&&n.forEach((e=>{e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})):n[0].active=!0}_initDefaultColorLUTIfNecessary(){0!==this.state.colorLUT.length&&this.state.colorLUT[0]||this.addColorLUT(Un,0)}}("DEFAULT");function Kn(e){const t={segmentationId:e};(0,te.triggerEvent)(te.eventTarget,re.SEGMENTATION_REMOVED,t)}function qn(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};(0,te.triggerEvent)(te.eventTarget,re.SEGMENTATION_REPRESENTATION_REMOVED,n)}function jn(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};if(t)return void(0,te.triggerEvent)(te.eventTarget,re.SEGMENTATION_REPRESENTATION_MODIFIED,n);(no(e)||[]).forEach((t=>{const{segmentationRepresentationUID:n}=t,o={toolGroupId:e,segmentationRepresentationUID:n};(0,te.triggerEvent)(te.eventTarget,re.SEGMENTATION_REPRESENTATION_MODIFIED,o)}))}function Zn(e){let t;t=e?[e]:eo().map((e=>{let{segmentationId:t}=e;return t})),t.forEach((e=>{const t={segmentationId:e};(0,te.triggerEvent)(te.eventTarget,re.SEGMENTATION_MODIFIED,t)}))}function Yn(e,t){const n={segmentationId:e,modifiedSlicesToUse:t};(0,te.triggerEvent)(te.eventTarget,re.SEGMENTATION_DATA_MODIFIED,n)}const Xn=function(e){const{segmentationId:t,representation:n}=e;return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:{[n.type]:{...n.data}}}};function Jn(){return zn}function Qn(e){return Jn().getSegmentation(e)}function eo(){return Jn().getState().segmentations}function to(e,t){const n=Jn(),o=Xn(e);n.addSegmentation(o),t||Zn(o.segmentationId)}function no(e){return Jn().getSegmentationRepresentations(e)}function oo(){return Jn().getAllSegmentationRepresentations()}function io(e){if(!e)throw new Error("getToolGroupIdsWithSegmentation: segmentationId is empty");const t=Jn(),n=t.getState(),o=Object.keys(n.toolGroups),i=[];return o.forEach((n=>{t.getSegmentationRepresentations(n).forEach((t=>{t.segmentationId===e&&i.push(n)}))})),i}function ao(e){return Jn().getToolGroupSpecificConfig(e)}function ro(e,t,n){Jn().setSegmentationRepresentationConfig(e,t),n||jn(e)}function so(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];Jn().setSegmentationRepresentationSpecificConfig(e,t,n),o||jn(e,t)}function lo(e,t){return Jn().getSegmentationRepresentationSpecificConfig(e,t)}function co(e,t,n){return Jn().getSegmentSpecificConfig(e,t,n)}function uo(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];Jn().setSegmentSpecificConfig(e,t,n),o||jn(e,t)}function ho(e,t,n){Jn().addSegmentationRepresentation(e,t),n||jn(e,t.segmentationRepresentationUID)}function go(){return Jn().getGlobalConfig()}function mo(e,t){Jn().setGlobalConfig(e),t||Zn()}function fo(e,t){return Jn().getSegmentationRepresentationByUID(e,t)}function po(e){Jn().removeSegmentation(e),Kn(e)}function vo(e,t){Jn().removeSegmentationRepresentation(e,t),qn(e,t)}function Eo(e){Jn().removeColorLUT(e)}function wo(e){return Jn().getColorLUT(e)}function Io(e,t){Jn().addColorLUT(e,t)}function Co(){return go()}function To(e){mo(e)}function bo(e){return Co().representations[e]}function _o(e,t){const n=Co();To({...n,representations:{...n.representations,[e]:{...n.representations[e],...t}}})}function Do(e){return ao(e)}function So(e,t){ro(e,t)}function yo(e,t){return lo(e,t)}function Oo(e,t,n){so(e,t,n)}function Po(e,t,n){return co(e,t,n)}function Mo(e,t,n){uo(e,t,n)}const xo=async function(e,t,n){const o=(0,te.getEnabledElement)(e),{renderingEngine:i,viewport:a}=o,{id:r}=a,s=[{volumeId:t,actorUID:n,visibility:!0,blendMode:te.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND}];await(0,te.addVolumesToViewports)(i,s,[r],!1,!0)};const Ro=function(e,t){const n=(0,te.getEnabledElement)(e),{viewport:o}=n;o instanceof te.StackViewport||o.removeVolumeActors([t])},No=255,Ao=new Map;function Lo(e,t,n,o){const i={...e,...t,...o||{}};return{fillAlpha:n?i.fillAlpha:i.fillAlphaInactive,outlineWidth:n?i.outlineWidthActive:i.outlineWidthInactive,renderFill:n?i.renderFill:i.renderFillInactive,renderOutline:i.renderOutline,outlineOpacity:n?i.outlineOpacity:i.outlineOpacityInactive}}function ko(e,t,n,o){let{fillAlpha:i,renderFill:a,renderOutline:r,segmentColor:s,outlineWidth:l,segmentsHidden:d}=o;const c=`${e}-${t}-${n}`,u=Ao.get(c);if(!u)return Ao.set(c,{fillAlpha:i,renderFill:a,renderOutline:r,outlineWidth:l,segmentColor:s.slice(),segmentsHidden:new Set(d)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:h,renderFill:g,renderOutline:m,outlineWidth:f,segmentColor:p,segmentsHidden:v}=u,E=p[0]!==s[0]||p[1]!==s[1]||p[2]!==s[2],w=p[3]!==s[3]||h!==i||g!==a||m!==r||f!==l||v.has(n)!==d.has(n);return Ao.set(c,{fillAlpha:i,renderFill:a,renderOutline:r,outlineWidth:l,segmentColor:s.slice(),segmentsHidden:new Set(d)}),{forceOpacityUpdate:w,forceColorUpdate:E}}const Uo={render:async function(e,t,n){const{colorLUTIndex:o,active:i,segmentationId:a,segmentationRepresentationUID:r,segmentsHidden:s,config:l}=t,d=Qn(a).representationData[le.Labelmap],{volumeId:c}=d;if(!te.cache.getVolume(c))throw new Error(`No Labelmap found for volumeId: ${c}`);if(!function(e,t){if(!t)return!0;const n=e.getDefaultActor();if(!n)return!1;const{uid:o}=n,i=te.cache.getVolume(o);if(i){const e=te.cache.getVolume(t);if(e&&i.metadata.FrameOfReferenceUID===e.metadata.FrameOfReferenceUID)return!0}return!1}(e,d?.referencedVolumeId))return;let u=e.getActor(r);if(!u){const t=Qn(a),{volumeId:n}=t.representationData[le.Labelmap];await async function(e,t,n){await xo(e.element,t,n)}(e,n,r),u=e.getActor(r)}if(!u)return;const{cfun:h,ofun:g}=l,m=n.renderInactiveSegmentations;!function(e,t,n,o,i,a,r,s,l,d){const{segmentSpecificConfig:c,segmentationRepresentationSpecificConfig:u}=r,h=u[le.Labelmap],g=wo(i),m=Math.min(256,g.length),f=t.actor,{uid:p}=t,{outlineWidth:v,renderOutline:E,outlineOpacity:w}=Lo(a,h,s);for(let t=0;t<m;t++){const i=t,r=g[i],l=c[i]?.[le.Labelmap],{fillAlpha:u,outlineWidth:m,renderFill:f,renderOutline:v}=Lo(a,h,s,l),{forceOpacityUpdate:E,forceColorUpdate:w}=ko(e,p,i,{fillAlpha:u,renderFill:f,renderOutline:v,segmentColor:r,outlineWidth:m,segmentsHidden:d});if(w&&n.addRGBPoint(i,r[0]/No,r[1]/No,r[2]/No),E)if(f){const e=d.has(i)?0:r[3]/255*u;o.removePoint(i),o.addPointLong(i,e,.5,1)}else o.addPointLong(i,.01,.5,1)}f.getProperty().setRGBTransferFunction(0,n),o.setClamping(!1),f.getProperty().setScalarOpacity(0,o),f.getProperty().setInterpolationTypeToNearest(),f.getProperty().setUseLabelOutline(E),f.getProperty().setLabelOutlineOpacity(w),f.getProperty().setLabelOutlineThickness(v);const I=s||l;f.setVisibility(I)}(e.id,u,h,g,o,n.representations[le.Labelmap],t,i,m,s)},addSegmentationRepresentation:async function(e,t,n){const{segmentationId:o}=t,i=te.utilities.uuidv4(),a=new Set,r=kn.ZP.newInstance(),s=Ln.ZP.newInstance();s.addPoint(0,0);const l={segmentationId:o,segmentationRepresentationUID:i,type:le.Labelmap,segmentsHidden:a,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{cfun:r,ofun:s}};if(n){const t=Do(e),o=te.utilities.deepMerge(t,n);So(e,{renderInactiveSegmentations:o.renderInactiveSegmentations||!0,representations:{...o.representations}})}return ho(e,l),i},removeSegmentationRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(function(e,t){const n=dv(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:o}=n;for(const e of o){const{viewportId:n,renderingEngineId:o}=e,i=(0,te.getEnabledElementByIds)(n,o);Ro(i.viewport.element,t)}}(e,t),vo(e,t),n){dv(e).getViewportsInfo().forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;(0,te.getEnabledElementByIds)(t,n).viewport.render()}))}}};var Vo=n(7736),Bo=n(46809),Fo=n(13234),Ho=n(80785),Wo=n(24172),Go=n(79005);const{vtkErrorMacro:$o}=Bo.m;function zo(e,t,n,o){e.set(function(e,t){let n=0;return e.map(((e,o)=>o===n?(n+=e+1,e):e+t))}(t,n),o)}const Ko={outputPointsPrecision:Wo.XJ.DEFAULT};function qo(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,Ko,n),Bo.m.setGet(e,t,["outputPointsPrecision"]),Bo.m.obj(e,t),Bo.m.algo(e,t,1,1),function(e,t){t.classHierarchy.push("vtkAppendPolyData"),e.requestData=(n,o)=>{const i=e.getNumberOfInputPorts();if(!i)return void $o("No input specified.");if(1===i)return void(o[0]=n[0]);const a=Ho.ZP.newInstance();let r=0,s=0,l=1,d=1,c=0,u=0,h=0,g=0,m=!0,f=!0,p=!0;for(let e=0;e<i;e++){const t=n[e];if(!t)continue;const o=t.getPoints().getNumberOfPoints();r+=o,c+=t.getVerts().getNumberOfValues(),u+=t.getLines().getNumberOfValues(),h+=t.getStrips().getNumberOfValues(),g+=t.getPolys().getNumberOfValues(),o&&(d&&(d=0,s=t.getPoints().getDataType()),l=t.getPoints().getDataType(),s=s>l?s:l);const i=t.getPointData();i?(m=m&&null!==i.getNormals(),f=f&&null!==i.getTCoords(),p=p&&null!==i.getScalars()):(m=!1,f=!1,p=!1)}t.outputPointsPrecision===Wo.XJ.SINGLE?s=Go.Tu.FLOAT:t.outputPointsPrecision===Wo.XJ.DOUBLE&&(s=Go.Tu.DOUBLE);const v=Fo.ZP.newInstance({dataType:s});v.setNumberOfPoints(r);const E=v.getData(),w=new Uint32Array(c),I=new Uint32Array(u),C=new Uint32Array(h),T=new Uint32Array(g);let b=null,_=null,D=null;const S=n[i-1];if(m){const e=S.getPointData().getNormals();b=Vo.default.newInstance({numberOfComponents:3,numberOfTuples:r,size:3*r,dataType:e.getDataType(),name:e.getName()})}if(f){const e=S.getPointData().getTCoords();_=Vo.default.newInstance({numberOfComponents:2,numberOfTuples:r,size:2*r,dataType:e.getDataType(),name:e.getName()})}if(p){const e=S.getPointData().getScalars();D=Vo.default.newInstance({numberOfComponents:e.getNumberOfComponents(),numberOfTuples:r,size:r*e.getNumberOfComponents(),dataType:e.getDataType(),name:e.getName()})}r=0,c=0,u=0,h=0,g=0;for(let e=0;e<i;e++){const t=n[e];E.set(t.getPoints().getData(),3*r),zo(w,t.getVerts().getData(),r,c),c+=t.getVerts().getNumberOfValues(),zo(I,t.getLines().getData(),r,u),u+=t.getLines().getNumberOfValues(),zo(C,t.getStrips().getData(),r,h),h+=t.getStrips().getNumberOfValues(),zo(T,t.getPolys().getData(),r,g),g+=t.getPolys().getNumberOfValues();const o=t.getPointData();if(m){const e=o.getNormals();b.getData().set(e.getData(),3*r)}if(f){const e=o.getTCoords();_.getData().set(e.getData(),2*r)}if(p){const e=o.getScalars();D.getData().set(e.getData(),r*D.getNumberOfComponents())}r+=t.getPoints().getNumberOfPoints()}a.setPoints(v),a.getVerts().setData(w),a.getLines().setData(I),a.getStrips().setData(C),a.getPolys().setData(T),b&&a.getPointData().setNormals(b),_&&a.getPointData().setTCoords(_),D&&a.getPointData().setScalars(D),o[0]=a}}(e,t)}var jo={newInstance:Bo.m.newInstance(qo,"vtkAppendPolyData"),extend:qo},Zo=n(32241),Yo=n(93284),Xo=n(58954);function Jo(e,t,n){let o=e.segmentSpecificConfig?.[t];return o||(o=e.segmentSpecificConfig?.[n]),o?o.CONTOUR:null}const Qo=new Map;function ei(e){return Qo.get(e)}function ti(e,t){Qo.set(e,t)}function ni(e,t,n,o,i){const{segmentationRepresentationUID:a,segmentsHidden:r}=n,s=jo.newInstance(),l=new Map,d=new Map;t.forEach((e=>{const t=te.cache.getGeometry(e);if(!t)return void console.warn(`No geometry found for geometryId ${e}. Skipping render.`);const o=t.data.getSegmentIndex();!function(e){if(!e)throw new Error(`No contours found for geometryId ${e.id}`);const t=e.id;if(e.type!==te.Enums.GeometryType.CONTOUR)throw new Error(`Geometry type ${e.type} not supported for rendering.`);e.data||console.warn(`No contours found for geometryId ${t}. Skipping render.`)}(t);const i=Jo(n,e,o),a=t.data,c=function(e){const t=[],n=Fo.ZP.newInstance(),o=Xo.ZP.newInstance();let i=0;e.getContours().forEach((e=>{const n=e.getPoints(),a=e.getFlatPointsArray(),r=e.getType(),s=n.map(((e,t)=>t+i));r===te.Enums.ContourType.CLOSED_PLANAR&&s.push(s[0]);const l=Float32Array.from(a);t.push(...l),o.insertNextCell([...s]),i+=n.length})),n.setData(t,3);const a=Ho.ZP.newInstance();return a.setPoints(n),a.setLines(o),a}(a),u=a.getColor(),h=c.getPoints().getNumberOfPoints(),g=Vo.default.newInstance({size:4*h,numberOfComponents:4,dataType:"Uint8Array"});for(let e=0;e<h;++e)g.setTuple(e,[...u,255]);c.getPointData().setScalars(g),i&&d.set(o,i),l.set(o,[...u,r.has(o)?0:255]),0===o?s.setInputData(c):s.addInputData(c)}));const c=s.getOutputData(),u=o.representations.CONTOUR.outlineWidthActive,h=Yo.default.newInstance();h.setInputData(c);const g=Zo.ZP.newInstance();g.setMapper(h),g.getProperty().setLineWidth(u),ti(a,Object.assign({},ei(a),{segmentsHidden:new Set(r),segmentSpecificMap:d,outlineWidthActive:u})),g.setForceOpaque(!0),e.addActor({uid:i,actor:g}),e.resetCamera(),e.render()}function oi(e,t,n,o,i){const{segmentationRepresentationUID:a,segmentsHidden:r}=n,s=o.representations.CONTOUR,l=ei(a),d=e.getActor(i);if(!d)return void console.warn(`No contour actor found for actorUID ${i}. Skipping render.`);const{actor:c}=d,u=s.outlineWidthActive;l?.outlineWidthActive!==u&&(c.getProperty().setLineWidth(u),ti(a,Object.assign({},l,{outlineWidthActive:u})));const h=c.getMapper(),g=h.getLookupTable(),m=[],f=[];for(const e of r)l.segmentsHidden.has(e)||m.push(e);for(const e of l.segmentsHidden)r.has(e)||f.push(e);const p=Array.from(l.segmentsHidden).filter((e=>!f.includes(e))).concat(m),{contourSets:v,segmentSpecificConfigs:E}=t.reduce(((e,t)=>{const o=te.cache.getGeometry(t),{data:i}=o,a=i.getSegmentIndex(),r=Jo(n,t,a);return e.contourSets.push(i),e.segmentSpecificConfigs[a]=r??{},e}),{contourSets:[],segmentSpecificConfigs:{}}),w=[...p,...f],I=Object.values(E).some((e=>Object.keys(e).length>0));let C=!1;if(w.length||I){const e=h.getInputData(),t=e.getPointData().getScalars().getData();let n=0;v.forEach((e=>{const o=e.getSegmentIndex(),i=e.getTotalNumberOfPoints();if(w.includes(o)||E[o]?.fillAlpha){const a=e.getColor();let r=p.includes(o)?0:255;const s=E[o];void 0!==s.fillAlpha&&(r=255*s.fillAlpha);for(let e=0;e<i;++e)t[n+4*e]=a[0],t[n+4*e+1]=a[1],t[n+4*e+2]=a[2],t[n+4*e+3]=r;C=!0}n+=4*i})),C&&e.modified(),ti(a,Object.assign({},l,{segmentsHidden:new Set(r)})),h.setLookupTable(g)}e.render()}const ii=function(e,t){const n=(0,te.getEnabledElement)(e),{viewport:o}=n,i=o.getActors().map((e=>{let{uid:n}=e;return n.includes(t)?n:void 0})).filter(Boolean);o.removeActors(i)};const ai={render:async function(e,t,n){const{segmentationId:o}=t,i=Qn(o).representationData[le.Contour],{geometryIds:a}=i;e instanceof te.StackViewport||(a?.length||console.warn(`No contours found for segmentationId ${o}. Skipping render.`),function(e,t,n,o){const{segmentationRepresentationUID:i}=n,a=`CONTOUR_${i}`;(e.getActor(a)?oi:ni)(e,t,n,o,a)}(e,a,t,n))},addSegmentationRepresentation:async function(e,t,n){const{segmentationId:o}=t,i=te.utilities.uuidv4(),a=new Set,r={segmentationId:o,segmentationRepresentationUID:i,type:le.Contour,segmentsHidden:a,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}};if(n){const t=Do(e),o=te.utilities.deepMerge(t,n);So(e,{renderInactiveSegmentations:o.renderInactiveSegmentations||!0,representations:{...o.representations}})}return ho(e,r),i},removeSegmentationRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(function(e,t){const n=dv(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:o}=n;for(const e of o){const{viewportId:n,renderingEngineId:o}=e,i=(0,te.getEnabledElementByIds)(n,o);ii(i.viewport.element,t)}}(e,t),vo(e,t),function(e){Qo.delete(e)}(t),n){dv(e).getViewportsInfo().forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;(0,te.getEnabledElementByIds)(t,n).viewport.render()}))}}};const ri=function(e,t,n){const o=no(e);if(!o||0===o.length)return;const i=o.map((e=>e.segmentationRepresentationUID));let a=t;if(a){const e=t.filter((e=>!i.includes(e)));if(e.length>0)throw new Error(`The following segmentationRepresentationUIDs are not part of the toolGroup: ${JSON.stringify(e)}`)}else a=i;a.forEach((t=>{!function(e,t,n){const o=fo(e,t),{type:i}=o;if(i===le.Labelmap)Uo.removeSegmentationRepresentation(e,t,n);else{if(i!==le.Contour)throw new Error(`The representation ${i} is not supported yet`);ai.removeSegmentationRepresentation(e,t,n)}}(e,t,n)}))};const si=function(e){if(!e.representation.data)throw new Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");const t=e.representation.data;if(!t.volumeId)throw new Error("The segmentationInput.representationData.volumeId is undefined, please provide a valid representationData.volumeId");if(!te.cache.getVolume(t.volumeId))throw new Error(`volumeId of ${t.volumeId} not found in cache, you should load and cache volume before adding segmentation`)};const li=function(e){if(!e||!e.length)throw new Error("The segmentationInputArray is undefined or empty array");e.forEach((e=>{if(void 0===e.segmentationId)throw new Error("The segmentationInput.segmentationId is undefined, please provide a valid segmentationId");if(void 0===e.representation)throw new Error("The segmentationInput.representation is undefined, please provide a valid representation");e.representation.type===le.Labelmap&&si(e)}))};const di=function(e){li(e),e.map((e=>{to(ue()(e))}))};const ci=function(e,t){const n=(0,te.getEnabledElement)(e),{viewport:o}=n,i=o.getActors().map((e=>{let{uid:n}=e;return n.startsWith(t)?n:void 0})).filter(Boolean);o.removeActors(i)};var ui=n(32943),hi=n(59290),gi=n(81425),mi=n(44011);const fi={elements:[]};function pi(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,fi,n),Bo.m.obj(e,t),function(e,t){t.classHierarchy.push("vtkPriorityQueue"),e.push=(e,n)=>{const o=t.elements.findIndex((t=>t.priority>e));t.elements.splice(o,0,{priority:e,element:n})},e.pop=()=>t.elements.length>0?t.elements.shift().element:null,e.deleteById=e=>{t.elements=t.elements.filter((t=>{let{element:n}=t;return n.id!==e}))},e.length=()=>t.elements.length}(e,t)}var vi={newInstance:Bo.m.newInstance(pi,"vtkPriorityQueue"),extend:pi},Ei=n(88564),wi=n(53034);const Ii=1e-6,Ci=1.1920929e-7,Ti={FAILURE:-1,OUTSIDE:0,INSIDE:1,INTERSECTION:2,ON_LINE:3};function bi(e,t,n,o,i){return(o[e]-n[e])*(i[t]-n[t])-(i[e]-n[e])*(o[t]-n[t])}const _i={PolygonWithPointIntersectionState:Ti,pointInPolygon:function(e,t,n,o){if(e[0]<n[0]||e[0]>n[1]||e[1]<n[2]||e[1]>n[3]||e[2]<n[4]||e[2]>n[5])return Ti.OUTSIDE;if((0,ui.l)(o)<=Ci)return Ti.FAILURE;let i=1e-8*((n[1]-n[0])*(n[1]-n[0])+(n[3]-n[2])*(n[3]-n[2])+(n[5]-n[4])*(n[5]-n[4]));i*=i,i=0===i?Ci:i;const a=[],r=[];for(let n=0;n<t.length;){if(a[0]=t[n++],a[1]=t[n++],a[2]=t[n++],(0,ui.e)(e,a)<=i)return Ti.INSIDE;const{distance:o,t:s}=gi.ZP.distanceToLine(e,a,r);if(o<=i&&s>0&&s<1)return Ti.INSIDE}let s,l;Math.abs(o[0])>Math.abs(o[1])?Math.abs(o[0])>Math.abs(o[2])?(s=1,l=2):(s=0,l=1):Math.abs(o[1])>Math.abs(o[2])?(s=0,l=2):(s=0,l=1);let d=0;for(let n=0;n<t.length;)a[0]=t[n++],a[1]=t[n++],a[2]=t[n++],n<t.length?(r[0]=t[n],r[1]=t[n+1],r[2]=t[n+2]):(r[0]=t[0],r[1]=t[1],r[2]=t[2]),a[l]<=e[l]?r[l]>e[l]&&bi(s,l,a,r,e)>0&&++d:r[l]<=e[l]&&bi(s,l,a,r,e)<0&&--d;return 0===d?Ti.OUTSIDE:Ti.INSIDE},getBounds:function(e,t,n){const o=e.length,i=[];t.getPoint(e[0],i),n[0]=i[0],n[1]=i[0],n[2]=i[1],n[3]=i[1],n[4]=i[2],n[5]=i[2];for(let a=1;a<o;a++)t.getPoint(e[a],i),Ei.ZP.addPoint(n,...i);const a=Ei.ZP.getLengths(n);return(0,ui.d)(a,a)},getNormal:function(e,t,n){n.length=3,n[0]=0,n[1]=0,n[2]=0;const o=[];let i=[],a=[];const r=[],s=[];t.getPoint(e[0],o),t.getPoint(e[1],i);for(let l=2;l<e.length;l++){t.getPoint(e[l],a),(0,ui.s)(a,i,r),(0,ui.s)(o,i,s);const d=[0,0,0];(0,ui.j)(r,s,d),(0,ui.k)(n,d,n),[i,a]=[a,i]}return(0,ui.l)(n)}};function Di(e,t){function n(e){const n=[0,0,0],o=[0,0,0],i=[0,0,0],a=[0,0,0];(0,ui.s)(e.point,e.previous.point,n),(0,ui.s)(e.next.point,e.point,o),(0,ui.s)(e.previous.point,e.next.point,i),(0,ui.j)(n,o,a);const r=(0,ui.d)(a,t.normal);if(r<=0)return-1;const s=(0,ui.n)(n)+(0,ui.n)(o)+(0,ui.n)(i);return s*s/r}function o(e){if(t.pointCount<=3)return!0;const n=e.previous,o=e.next,i=[0,0,0];(0,ui.s)(o.point,n.point,i);const a=[0,0,0];if((0,ui.j)(i,t.normal,a),(0,ui.l)(a),0===(0,ui.n)(a))return!1;let r=mi.ZP.evaluate(a,n.point,o.next.point),s=r>Ii?1:r<-Ii?-1:0,l=s<0?1:0;for(let e=o.next.next;e.id!==n.id;e=e.next){const t=e.previous;r=mi.ZP.evaluate(a,n.point,e.point);const i=r>Ii?1:r<-Ii?-1:0;if(i!==s){if(l||(l=i<=0?1:0),gi.ZP.intersection(n.point,o.point,e.point,t.point,[0],[0])===wi.C.YES_INTERSECTION)return!1;s=i}}return 1===l}function i(e,o){t.pointCount-=1;const i=e.previous,a=e.next;t.tris=t.tris.concat(e.point),t.tris=t.tris.concat(a.point),t.tris=t.tris.concat(i.point),i.next=a,a.previous=i,o.deleteById(i.id),o.deleteById(a.id);const r=n(i);r>0&&o.push(r,i);const s=n(a);s>0&&o.push(s,a),e.id===t.firstPoint.id&&(t.firstPoint=a)}function a(){!function(){const e=[0,0,0],n=[0,0,0];t.normal=[0,0,0];const o=[...t.firstPoint.point];let i=t.firstPoint;for(let a=0;a<t.pointCount;a++){(0,ui.s)(i.point,o,e),(0,ui.s)(i.next.point,o,n);const a=[0,0,0];(0,ui.j)(e,n,a),(0,ui.k)(t.normal,a,t.normal),i=i.next}(0,ui.l)(t.normal)}();const e=vi.newInstance();let a=t.firstPoint;for(let o=0;o<t.pointCount;o++){const t=n(a);t>0&&e.push(t,a),a=a.next}for(;t.pointCount>2&&e.length()>0;)if(t.pointCount===e.length()){i(e.pop(),e)}else{const t=e.pop();o(t)&&i(t,e)}return t.pointCount<=2}t.classHierarchy.push("vtkPolygon"),e.triangulate=()=>t.firstPoint?a():null,e.setPoints=e=>{t.pointCount=e.length,t.firstPoint={id:0,point:e[0],next:null,previous:null};let n=t.firstPoint;for(let o=1;o<t.pointCount;o++)n.next={id:o,point:e[o],next:null,previous:n},n=n.next;t.firstPoint.previous=n,n.next=t.firstPoint},e.getPointArray=()=>t.tris}const Si={firstPoint:null,pointCount:0,tris:[]};function yi(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,Si,n),Bo.m.obj(e,t),Di(e,t)}var Oi={newInstance:Bo.m.newInstance(yi,"vtkPolygon"),extend:yi,..._i};const{vtkErrorMacro:Pi}=Bo.m,Mi=[(e,t,n)=>t,(e,t,n)=>(e.setTuple(t,n),t),(e,t,n)=>e.insertNextTuple(n)],xi=[[[0,1],[0,1],[0,1]],[[1,2],[0,1],[0,1]],[[0,1],[1,2],[0,1]],[[1,2],[1,2],[0,1]],[[0,1],[0,1],[1,2]],[[1,2],[0,1],[1,2]],[[0,1],[1,2],[1,2]],[[1,2],[1,2],[1,2]]];const Ri={pointIdSet:null,minBounds:null,maxBounds:null,minDataBounds:null,maxDataBounds:null,parent:null,children:null};function Ni(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,Ri,n),Bo.m.obj(e,t),Bo.m.setGetArray(e,t,["minBounds","maxBounds","minDataBounds","maxDataBounds"],6),Bo.m.get(e,t,["pointIdSet","numberOfPoints"]),Bo.m.set(e,t,["parent"]),function(e,t){t.classHierarchy.push("vtkIncrementalOctreeNode"),e.createPointIdSet=(e,n)=>{null==t.pointIdSet&&(t.pointIdSet=[])},e.setBounds=(e,n,o,i,a,r)=>{null==t.minBounds&&(t.minBounds=[]),null==t.maxBounds&&(t.maxBounds=[]),null==t.minDataBounds&&(t.minDataBounds=[]),null==t.maxDataBounds&&(t.maxDataBounds=[]),t.minBounds[0]=e,t.maxBounds[0]=n,t.minBounds[1]=o,t.maxBounds[1]=i,t.minBounds[2]=a,t.maxBounds[2]=r,t.minDataBounds[0]=n,t.maxDataBounds[0]=e,t.minDataBounds[1]=i,t.maxDataBounds[1]=o,t.minDataBounds[2]=r,t.maxDataBounds[2]=a},e.getBounds=e=>{e[0]=t.minBounds[0],e[1]=t.maxBounds[0],e[2]=t.minBounds[1],e[3]=t.maxBounds[1],e[4]=t.minBounds[2],e[5]=t.maxBounds[2]},e.getChildIndex=e=>Number(e[0]>t.children[0].getMaxBoundsByReference()[0])+(Number(e[1]>t.children[0].getMaxBoundsByReference()[1])<<1)+(Number(e[2]>t.children[0].getMaxBoundsByReference()[2])<<2),e.containsPoint=e=>t.minBounds[0]<e[0]&&e[0]<=t.maxBounds[0]&&t.minBounds[1]<e[1]&&e[1]<=t.maxBounds[1]&&t.minBounds[2]<e[2]&&e[2]<=t.maxBounds[2]?1:0,e.containsPointByData=e=>t.minDataBounds[0]<=e[0]&&e[0]<=t.maxDataBounds[0]&&t.minDataBounds[1]<=e[1]&&e[1]<=t.maxDataBounds[1]&&t.minDataBounds[2]<=e[2]&&e[2]<=t.maxDataBounds[2]?1:0,e.updateCounterAndDataBounds=(e,n,o)=>{if(t.numberOfPoints+=n,!o)return!1;let i=!1;return e[0]<t.minDataBounds[0]&&(i=!0,t.minDataBounds[0]=e[0]),e[0]>t.maxDataBounds[0]&&(i=!0,t.maxDataBounds[0]=e[0]),e[1]<t.minDataBounds[1]&&(i=!0,t.minDataBounds[1]=e[1]),e[1]>t.maxDataBounds[1]&&(i=!0,t.maxDataBounds[1]=e[1]),e[2]<t.minDataBounds[2]&&(i=!0,t.minDataBounds[2]=e[2]),e[2]>t.maxDataBounds[2]&&(i=!0,t.maxDataBounds[2]=e[2]),i},e.updateCounterAndDataBoundsRecursively=(n,o,i,a)=>{const r=e.updateCounterAndDataBounds(n,o,i);return t.parent===a?r:t.parent.updateCounterAndDataBoundsRecursively(n,o,r,a)},e.containsDuplicatePointsOnly=e=>t.minDataBounds[0]===e[0]&&e[0]===t.maxDataBounds[0]&&t.minDataBounds[1]===e[1]&&e[1]===t.maxDataBounds[1]&&t.minDataBounds[2]===e[2]&&e[2]===t.maxDataBounds[2],e.isLeaf=()=>null==t.children,e.getChild=e=>t.children[e],e.separateExactlyDuplicatePointsFromNewInsertion=(t,n,o,i,a,r)=>{let s,l=i;const d=[0,0,0],c=[0,0,0],u=[0,0,0],h=[0,0,0],g=[null,null,null];let m=null,f=e,p=e;for(t.getPoint(n[0],d);f===p;){for(m=f,u[0]=.5*(m.minBounds[0]+m.maxBounds[0]),u[1]=.5*(m.minBounds[1]+m.maxBounds[1]),u[2]=.5*(m.minBounds[2]+m.maxBounds[2]),g[0]=m.minBounds,g[1]=u,g[2]=m.maxBounds,m.children=[Ai(),Ai(),Ai(),Ai(),Ai(),Ai(),Ai(),Ai()],s=0;s<8;s++)c[0]=g[xi[s][0][0]][0],h[0]=g[xi[s][0][1]][0],c[1]=g[xi[s][1][0]][1],h[1]=g[xi[s][1][1]][1],c[2]=g[xi[s][2][0]][2],h[2]=g[xi[s][2][1]][2],m.children[s]=Ai(),m.children[s].setParent(m),m.children[s].setBounds(c[0],h[0],c[1],h[1],c[2],h[2]);f=m.children[m.getChildIndex(d)],p=m.children[m.getChildIndex(o)]}return l=Mi[r](t,l,o),p.createPointIdSet(a>>2,a>>1),p.getPointIdSet().push(l),p.updateCounterAndDataBoundsRecursively(o,1,1,null),f.setPointIdSet(n),f.updateCounterAndDataBoundsRecursively(d,n.length,1,e),l},e.createChildNodes=(n,o,i,a,r,s,l)=>{let d=l,c=a;const u=[];if(n.getPoint(o[0],u),e.containsDuplicatePointsOnly(u))return c=e.separateExactlyDuplicatePointsFromNewInsertion(n,o,i,c,r,s),{success:!1,nbNodes:d,pointIdx:c};let h,g,m=-1,f=-1;const p=[0,0,0,0,0,0,0,0],v=[],E=[],w=[];let I;const C=[.5*(t.minBounds[0]+t.maxBounds[0]),.5*(t.minBounds[1]+t.maxBounds[1]),.5*(t.minBounds[2]+t.maxBounds[2])],T=[t.minBounds,C,t.maxBounds];for(t.children=[],h=0;h<8;h++)v[0]=T[xi[h][0][0]][0],E[0]=T[xi[h][0][1]][0],v[1]=T[xi[h][1][0]][1],E[1]=T[xi[h][1][1]][1],v[2]=T[xi[h][2][0]][2],E[2]=T[xi[h][2][1]][2],t.children[h]=Ai(),t.children[h].setParent(e),t.children[h].setBounds(v[0],E[0],v[1],E[1],v[2],E[2]),t.children[h].createPointIdSet(r>>2,r>>1);for(T[0]=null,T[1]=null,T[2]=null,h=0;h<r;h++)I=o[h],n.getPoint(I,w),g=e.getChildIndex(w),t.children[g].getPointIdSet().push(I),t.children[g].updateCounterAndDataBounds(w),p[g]++;for(h=0;h<8;h++)if(p[h]===r){f=h;break}for(g=e.getChildIndex(i),f===g?(({numberOfNodes:d,pointIdx:c}=t.children[g].createChildNodes(n,o,i,c,r,s,d)),m=f):(c=Mi[s](n,c,i),t.children[g].getPointIdSet().push(c),t.children[g].updateCounterAndDataBoundsRecursively(i,1,1,null),p[g]++),h=0;h<8;h++)0!==p[h]&&h!==m||(t.children[h].getPointIdSet().length=0);return{success:!0,numberOfNodes:d,pointIdx:c}},e.insertPoint=(n,o,i,a,r,s)=>{let l=0,d=a;return t.pointIdSet?t.pointIdSet.length<i||e.containsDuplicatePointsOnly(o)?(d=Mi[r](n,d,o),t.pointIdSet.push(d),e.updateCounterAndDataBoundsRecursively(o,1,1,null)):(({numberOfNodes:l,pointIdx:d}=e.createChildNodes(n,t.pointIdSet,o,d,i,r,s)),t.pointIdSet=null):(d=Mi[r](n,d,o),t.pointIdSet=[],t.pointIdSet.push(d),e.updateCounterAndDataBoundsRecursively(o,1,1,null)),{numberOfNodes:s+l,pointIdx:d}},e.getDistance2ToBoundary=(n,o,i,a,r)=>{let s=null,l=null,d=null,c=null,u=Number.MAX_VALUE;r?(s=e.getMinDataBounds(),l=e.getMaxDataBounds(),d=a.getMinDataBounds(),c=a.getMaxDataBounds()):(s=t.minBounds,l=t.maxBounds,d=a.getMinBounds(),c=a.getMaxBounds());let h=0;const g=Number(n[0]<s[0]),m=Number(n[0]>l[0]),f=Number(n[1]<s[1]),p=Number(n[1]>l[1]),v=Number(n[2]<s[2]),E=Number(n[2]>l[2]),w=Number(!g&&!m),I=Number(!f&&!p);switch((Number(!v&&!E)<<2)+(I<<1)+w){case 0:o[0]=g?s[0]:l[0],o[1]=f?s[1]:l[1],o[2]=v?s[2]:l[2],u=(0,ui.e)(n,o);break;case 1:o[0]=n[0],o[1]=f?s[1]:l[1],o[2]=v?s[2]:l[2],u=(0,ui.e)(n,o);break;case 2:o[0]=g?s[0]:l[0],o[1]=n[1],o[2]=v?s[2]:l[2],u=(0,ui.e)(n,o);break;case 3:v?(u=s[2]-n[2],o[2]=s[2]):(u=n[2]-l[2],o[2]=l[2]),u*=u,o[0]=n[0],o[1]=n[1];break;case 4:o[0]=g?s[0]:l[0],o[1]=f?s[1]:l[1],o[2]=n[2],u=(0,ui.e)(n,o);break;case 5:f?(u=s[1]-n[1],o[1]=s[1]):(u=n[1]-l[1],o[1]=l[1]),u*=u,o[0]=n[0],o[2]=n[2];break;case 6:g?(u=s[0]-n[0],o[0]=s[0]):(u=n[0]-l[0],o[0]=l[0]),u*=u,o[1]=n[1],o[2]=n[2];break;case 7:{if(i){let e;e=n[0]-s[0],s[0]!==d[0]&&e<u&&(h=0,u=e),e=l[0]-n[0],l[0]!==c[0]&&e<u&&(h=1,u=e),e=n[1]-s[1],s[1]!==d[1]&&e<u&&(h=2,u=e),e=l[1]-n[1],l[1]!==c[1]&&e<u&&(h=3,u=e),e=n[2]-s[2],s[2]!==d[2]&&e<u&&(h=4,u=e),e=l[2]-n[2],l[2]!==c[2]&&e<u&&(h=5,u=e)}else{const e=[n[0]-s[0],l[0]-n[0],n[1]-s[1],l[1]-n[1],n[2]-s[2],l[2]-n[2]];for(let t=0;t<6;t++)e[t]<u&&(h=t,u=e[t])}u!==Number.MAX_VALUE&&(u*=u),o[0]=n[0],o[1]=n[1],o[2]=n[2];const e=[s,l],t=h>>1;o[t]=e[1&h][t];break}default:Pi("unexpected case in getDistance2ToBoundary")}return u},e.getDistance2ToInnerBoundary=(t,n)=>e.getDistance2ToBoundary(t,[],0,n,0)}(e,t)}const Ai=Bo.m.newInstance(Ni,"vtkIncrementalOctreeNode");var Li={newInstance:Ai,extend:Ni};const ki={dataSet:null,maxLevel:8,level:8,automatic:!1,tolerance:0,useExistingSearchStructure:!1};var Ui={extend:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,ki,n),Bo.m.obj(e,t),Bo.m.get(e,t,["level"]),Bo.m.setGet(e,t,["dataSet","maxLevel","automatic","tolerance","useExistingSearchStructure"]),function(e,t){t.classHierarchy.push("vtkLocator")}(0,t)}};var Vi={extend:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Ui.extend(e,t,function(e){return{bounds:null,numberOfBuckets:0,...e}}(n)),Bo.m.obj(e,t),Bo.m.get(e,t,["numberOfBuckets"]),Bo.m.setGetArray(e,t,["bounds"],6),function(e,t){t.classHierarchy.push("vtkAbstractPointLocator")}(0,t)}};const{vtkErrorMacro:Bi}=Bo.m;function Fi(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Vi.extend(e,t,function(e){return{fudgeFactor:0,octreeMaxDimSize:0,buildCubicOctree:!1,maxPointsPerLeaf:128,insertTolerance2:1e-6,locatorPoints:null,octreeRootNode:null,numberOfNodes:0,...e}}(n)),Bo.m.obj(e,t),Bo.m.setGet(e,t,["fudgeFactor","octreeMaxDimSize","buildCubicOctree","maxPointsPerLeaf","insertTolerance2","locatorPoints","octreeRootNode","numberOfNodes"]),function(e,t){function n(e,t){return e.isLeaf()?e:n(e.getChild(e.getChildIndex(t)),t)}t.classHierarchy.push("vtkIncrementalOctreePointLocator"),e.freeSearchStructure=()=>{t.octreeRootNode=null,t.numberOfNodes=0,t.locatorPoints=null},e.findClosestPointInLeafNode=(e,n)=>{let o=Number.MAX_VALUE;if(null==e.getPointIdSet())return[-1,o];let i=0,a=0;const r=[];let s=-1,l=-1,d=e.getPointIdSet();i=d.length;for(let e=0;e<i&&(s=d[e],t.locatorPoints.getPoint(s,r),a=ui.f.distance2BetweenPoints(r,n),a<o&&(o=a,l=s),0!==o);e++);return d=null,[l,o]},e.findClosestPointInSphere=(n,o,i,a)=>{let r=-1,s=Number.MAX_VALUE;const l=[];let d,c,u,h,g;for(l.push(t.octreeRootNode);0===!l.length&&s>0;){if(d=l.top(),l.pop(),d.isLeaf())[g,h]=e.findClosestPointInLeafNode(d,n),h<s&&(s=h,r=g);else for(let e=0;e<8;e++)c=d.getChild(e),u=c.getNumberOfPoints()?c.getDistance2ToBoundary(n,t.octreeRootNode,1):o+o,c!==i&&(u<=a||1===c.containsPoint(n))&&l.push(c),c=null;d=null}return[s<=o?r:-1,s]},e.initPointInsertion=function(n,o){let i=0,a=0;if(null==n)return Bi("a valid vtkPoints object required for point insertion"),!1;e.freeSearchStructure(),t.locatorPoints=n,t.insertTolerance2=t.tolerance*t.tolerance,t.octreeMaxDimSize=0;const r=[...o],s=Ei.ZP.getLengths(o);if(t.octreeMaxDimSize=Math.max(...s),t.buildCubicOctree)for(i=0;i<3;i++)if(s[i]!==t.octreeMaxDimSize){const e=t.octreeMaxDimSize-s[i];r[2*i]-=.5*e,r[2*i+1]+=.5*e,s[i]=t.octreeMaxDimSize}t.fudgeFactor=1e-5*t.octreeMaxDimSize;const l=.1*t.octreeMaxDimSize;for(i=0;i<3;i++)if(s[i]<l){a=2*i;const e=r[a];r[a]=r[a+1]-l,r[a+1]=e+l}else r[2*i]-=t.fudgeFactor;return t.octreeRootNode=Li.newInstance(),++t.numberOfNodes,t.octreeRootNode.setBounds(...r),!0},e.findClosestPointInSphereWithTolerance=(n,o,i)=>e.findClosestPointInSphere(n,o,i,t.octreeMaxDimSize*t.octreeMaxDimSize*4,o),e.findDuplicateFloatTypePointInVisitedLeafNode=(e,n)=>{let o,i=-1,a=-1;const r=e.getPointIdSet(),s=t.locatorPoints.getData();for(let e=0;e<r.length;e++)if(i=r[e],o=(i<<1)+i,n[0]===s[o]&&n[1]===s[o+1]&&n[2]===s[o+2]){a=i;break}return a},e.findDuplicateDoubleTypePointInVisitedLeafNode=(e,n)=>{let o,i=-1,a=-1;const r=e.getPointIdSet(),s=t.locatorPoints.getData();for(let e=0;e<r.length;e++)if(i=r[e],o=(i<<1)+i,n[0]===s[o]&&n[1]===s[o+1]&&n[2]===s[o+2]){a=i;break}return a},e.findDuplicatePointInLeafNode=(n,o)=>null==n.getPointIdSet()?-1:t.locatorPoints.getDataType()===Go.Tu.FLOAT?e.findDuplicateFloatTypePointInVisitedLeafNode(n,o):e.findDuplicateDoubleTypePointInVisitedLeafNode(n,o),e.insertPoint=(e,o)=>{const i=n(t.octreeRootNode,o);({numberOfNodes:t.numberOfNodes}=i.insertPoint(t.locatorPoints,o,t.maxPointsPerLeaf,e,1,t.numberOfNodes))},e.insertUniquePoint=n=>{let o,{pointIdx:i,leafContainer:a}=e.isInsertedPoint(n);return i>-1?{success:!1,idx:i}:(({numberOfNodes:o,pointIdx:i}=a.insertPoint(t.locatorPoints,n,t.maxPointsPerLeaf,i,2,t.numberOfNodes)),t.numberOfNodes=o,{success:!0,idx:i})},e.insertNextPoint=e=>{const o=n(t.octreeRootNode,e),{numberOfNodes:i,pointIdx:a}=o.insertPoint(t.locatorPoints,e,t.maxPointsPerLeaf,-1,2,t.numberOfNodes);return t.numberOfNodes=i,a},e.isInsertedPointForZeroTolerance=o=>{const i=n(t.octreeRootNode,o);return{pointIdx:e.findDuplicatePointInLeafNode(i,o),leafContainer:i}},e.isInsertedPointForNonZeroTolerance=o=>{let i,a;const r=n(t.octreeRootNode,o);let[s,l]=e.findClosestPointInLeafNode(r,o);return 0===l||(r.getDistance2ToInnerBoundary(o,t.octreeRootNode)<t.insertTolerance2&&(a=e.findClosestPointInSphereWithTolerance(o,t.insertTolerance2,r,i),i<l&&(l=i,s=a)),s=l<=t.insertTolerance2?s:-1),{pointIdx:s,leafContainer:r}},e.isInsertedPoint=(n,o)=>0===t.insertTolerance2?e.isInsertedPointForZeroTolerance(n,o):e.isInsertedPointForNonZeroTolerance(n,o)}(e,t)}var Hi={newInstance:Bo.m.newInstance(Fi,"vtkIncrementalOctreePointLocator"),extend:Fi};const Wi=1e-5;const{vtkErrorMacro:Gi}=Bo.m;function $i(e){const t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0)??0,n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0)??e.length-1,o=t+Math.floor((n-t)/2);for(let i=t;i<=o;++i)[e[i],e[n-(i-t)]]=[e[n-(i-t)],e[i]]}function zi(e,t,n,o){const i=[],a=[],r=[];(0,ui.s)(t,e,i),(0,ui.s)(n,t,a),(0,ui.s)(e,n,r);const s=(i[1]*a[2]-i[2]*a[1])*o[0]+(i[2]*a[0]-i[0]*a[2])*o[1]+(i[0]*a[1]-i[1]*a[0])*o[2];let l=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2])+Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])+Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);return l*=l,l=0!==l?l:1,s/l*10.392304845413264}function Ki(e,t,n,o,i){const a=[1,2,0];let r=0;const s=[-1,-1,-1];for(let e=0;e<3;e++){const i=n[e],l=o[i];if(l>=0){let o=i+1;o===t.length&&(o=0),o===n[a[e]]&&(s[e]=l,r++)}}if(0===r)e.insertNextCell([t[n[0]],t[n[1]],t[n[2]]]);else{const o=[[t[n[0]],t[n[1]]],[t[n[1]],t[n[2]]],[t[n[2]],t[n[0]]]];let a=0,r=0;for(let e=0;e<3;e++)if(s[e]>=0){const t=s[e],n=i[t],l=i.slice(t+1,t+1+n);o[e][0]!==l[0]&&o[e][1]!==l[n-1]&&Gi("assertion error in vtkCCSInsertTriangle"),n>a&&(a=n,r=e),o[e]=l}const l=(r+2)%3,d=(r+1)%3,c=o[l].length>2,u=o[d].length>2,h=[];h[l]=o[r][1],h[r]=o[l][0],h[d]=o[r][o[r].length-2];for(let t=0;t<3;t++)if((t!==l||c)&&(t!==d||u)){let n=0,i=o[t].length-1;t===r&&(n+=c,i-=u);for(let a=n;a<i;a++)e.insertNextCell([o[t][a],o[t][a+1],h[t]])}}}function qi(e,t,n,o,i,a){let r=e.length;if(r<3)return!0;if(3===r){return Ki(i,e,[0,1,2],n,o),!0}let s=!1,l=[],d=[],c=[],u=0,h=0,g=0;const m=[];for(m.length=r,u=0;u<r;u++)m[u]=[u,0];g=r-2,t.getPoint(e[m[g][0]],d),u=r-1,t.getPoint(e[m[u][0]],c);let f,p=0,v=0,E=0;for(h=0;h<r;h++){[l,d,c]=[d,c,l],t.getPoint(e[m[h][0]],c);const n=zi(l,d,c,a);n>v&&(E=u,v=n),p+=n<0,m[u][1]=n,u=h}for(;;){if(v<=Number.MIN_VALUE){s=!0;break}if(u=E,h=u+1!==r?u+1:0,g=0!==u?u-1:r-1,m[u][1]>0){if(f=!0,t.getPoint(e[m[h][0]],c),t.getPoint(e[m[g][0]],l),p){const n=[],o=[];(0,ui.s)(c,l,n),(0,ui.j)(n,a,o);const i=(0,ui.d)(l,o);let s=h+1!==r?h+1:0,d=[];t.getPoint(e[m[s][0]],d);let u=(0,ui.d)(d,o)<i,p=u;s=s+1!==r?s+1:0;let v=[];const E=[],w=[];for(;f&&s!==g;s=s+1!==r?s+1:0){[d,v]=[v,d],t.getPoint(e[m[s][0]],d);const n=(0,ui.d)(d,o)<i;(u?!n:n)&&(u=!u,p=!0,f=gi.ZP.intersection(l,c,d,v,E,w)===gi.ZP.IntersectionState.NO_INTERSECTION)}f&&=p}if(f){if(Ki(i,e,[m[u][0],m[h][0],m[g][0]],n,o),m.splice(u,1),g-=0===u,h-=0!==h,--r<3)break;const s=0!==g?g-1:r-1;t.getPoint(e[m[s][0]],d);const f=zi(d,l,c,a);p-=m[g][1]<0&&f>=0,m[g][1]=f;const v=h+1!==r?h+1:0;t.getPoint(e[m[v][0]],d);const E=zi(l,c,d,a);p-=m[h][1]<0&&E>=0,m[h][1]=E}else m[u][1]=Number.MIN_VALUE}for(E=0,v=m[0][1],u=1;u<r;u++){const e=m[u][1];e>v&&(E=u,v=e)}}return!s}function ji(e,t,n,o,i){const a=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],r=[n[0]-e[0],n[1]-e[1],n[2]-e[2]],s=[o[0]-e[0],o[1]-e[1],o[2]-e[2]],l=[],d=[];(0,ui.j)(r,a,l),(0,ui.j)(r,s,d);const c=(0,ui.d)(l,i),u=(0,ui.d)(d,i);if(0!==c&&0!==u){const e=c<0,t=u<0;if(e?!t:t)return 1-2*t;const n=(0,ui.d)(r,a),o=(0,ui.n)(a),i=((0,ui.d)(r,s)*(0,ui.n)(s)-n*o)*(1-2*e);if(0!==i)return 1-2*(i<0)}return 0}function Zi(e,t,n,o){const i=Wi*Wi,a=[],r=[],s=[],l=[],d=[];let c,u;for(let h=0;h<e.length;h++){const g=e[h],m=g.length,f=[];if(n.push(f),m<4){f[0]=-1,f[1]=-1,f[2]=-1;continue}let p=m;const v=[],E=Oi.getBounds(g,t,v)*i,w=[];let I=0,C=-1;const T=[];let b=0;t.getPoint(g[m-1],a),t.getPoint(g[0],r),(0,ui.s)(r,a,l),c=(0,ui.d)(l,l);for(let e=0;e<m;e++){let n=e+1;n>=m&&(n-=m),t.getPoint(g[n],s),(0,ui.s)(s,r,d),u=(0,ui.d)(d,d);const h=(0,ui.d)(l,d),v=c*u-h*h,_=g[e];if(p<=3||c>E&&(h<0||c<E||u<E||v>c*u*i)){if(b>1){_!==C&&(o.push(_),b++);const e=o.length-b-1;o[e]=b,f.push(e)}else 0===b?T.push(_):f.push(-1);w.push(_),I=_,C=_,b=1,a[0]=s[0],a[1]=s[1],a[2]=s[2],r[0]=s[0],r[1]=s[1],r[2]=s[2],l[0]=d[0],l[1]=d[1],l[2]=d[2],c=u}else b>0&&_!==C?(1===b&&(o.push(1),o.push(I)),o.push(_),C=_,b++):T.push(_),p--,r[0]=s[0],r[1]=s[1],r[2]=s[2],(0,ui.s)(s,a,l),c=(0,ui.d)(l,l)}for(let e=0;e<T.length;e++){const t=T[e];t!==C&&(1===b&&(o.push(1),o.push(I)),o.push(t),C=t,b++)}if(b>1){const e=o.length-b-1;o[e]=b,f.push(e)}e[h]=w}}function Yi(e,t,n){$i(e,1,e.length-1),t.reverse();for(let e=0;e<t.length;e++)if(t[e]>=0){const o=t[e]+1;$i(n,o,o+n[t[e]]-1)}}function Xi(e,t,n){const o=[0,0,0],i=[],a=[],r=[],s=[],l=[],d=[];t.getPoint(e[0],i),t.getPoint(e[1],a),(0,ui.s)(a,i,s);for(let n=2;n<e.length;n++)t.getPoint(e[n],r),(0,ui.s)(r,i,l),(0,ui.j)(s,l,d),(0,ui.k)(o,d,o),a[0]=r[0],a[1]=r[1],a[2]=r[2],s[0]=l[0],s[1]=l[1],s[2]=l[2];const c=(0,ui.d)(o,n);return{isNormalNotZero:0!==c,sense:c>0}}function Ji(e,t,n,o,i,a,r){const s=e.length,l=t.length,d=[],c=[],u=[];for(let h=0;h<l;h++){const g=(h>>1)+(1&h)*(l+1>>1);n.getPoint(t[g],d);const m=Oi.pointInPolygon(d,i,a,o);if(m===Ti.FAILURE&&Gi("Error finding point in polygon in vtkCCSPolyInPoly"),m!==Ti.OUTSIDE){let t=0;n.getPoint(e[s-1],c);for(let o=0;o<s;o++){n.getPoint(e[o],u);const{distance:i}=gi.ZP.distanceToLine(d,c,u);if(i<r){t=1;break}c[0]=u[0],c[1]=u[1],c[2]=u[2]}if(!t)return!0}}return!1}function Qi(e,t,n,o){const i=e.length;if(0===i)return 0;const a=[];let r=0;for(let o=0;o<i;o++)t.getPoint(e[o],a),n[r++]=a[0],n[r++]=a[1],n[r++]=a[2];return Oi.getBounds(e,t,o)*(Wi*Wi)}function ea(e,t,n,o,i,a,r,s){const l=e[i][r],d=e[a][s],c=Wi,u=[],h=[];t.getPoint(l,u),t.getPoint(d,h);const g=[];(0,ui.s)(h,u,g);const m=(0,ui.l)(g);if(0===m)return!0;const f=m*m*c*c;let p=i,v=r,E=u;const w=[];let I=h;const C=[];for(let o=0;o<2;o++){const o=e[p],i=o.length;let r=i-v-1,l=v+1;if(r>=i&&(r-=i),l>=i&&(l-=i),t.getPoint(o[r],w),t.getPoint(o[l],C),ji(E,w,I,C,n)>0)return!1;p=a,v=s,E=h,I=u}const T=[];(0,ui.j)(n,g,T),T[3]=-(0,ui.d)(T,u);for(let i=0;i<o.length;i++){const a=e[o[i]],r=a.length,s=[],c=[];let m=a[r-1];t.getPoint(m,s);let p=T[0]*s[0]+T[1]*s[1]+T[2]*s[2]+T[3],v=p>0;for(let e=0;e<r;e++){const o=a[e];t.getPoint(o,c);const i=T[0]*c[0]+T[1]*c[1]+T[2]*c[2]+T[3],r=i>0;if(l!==m&&l!==o&&d!==m&&d!==o&&((v?!r:r)||p*p<f||i*i<f)&&((0,ui.s)(c,s,g),(0,ui.d)(g,g)>0)){const e=[];(0,ui.j)(g,n,e),e[3]=-(0,ui.d)(e,s);const t=e[0]*u[0]+e[1]*u[1]+e[2]*u[2]+e[3],o=e[0]*h[0]+e[1]*h[1]+e[2]*h[2]+e[3],a=o>0;if(t>0?!a:a){let e=u,n=s;if(i*i<p*p&&(e=h),o*o<t*t&&(n=c),(0,ui.e)(e,n)>f)return!1}}m=o,s[0]=c[0],s[1]=c[1],s[2]=c[2],p=i,v=r}}return!0}function ta(e,t,n,o,i){const a=e.length,r=t.length,s=n>0?n-1:a-1,l=n<a-1?n+1:0,d=o>0?o-1:r-1,c=o<r-1?o+1:0,u=[],h=[],g=[];i.getPoint(e[n],h),i.getPoint(t[o],g);const m=[],f=[];(0,ui.s)(g,h,m);const p=(0,ui.d)(m,m);let v,E,w=0;return i.getPoint(e[s],u),(0,ui.s)(u,h,f),v=(0,ui.d)(f,f),v>0&&(E=(0,ui.d)(m,f),E*=E/v,E>w&&(w=E)),i.getPoint(e[l],u),(0,ui.s)(u,h,f),v=(0,ui.d)(f,f),v>0&&(E=(0,ui.d)(m,f),E*=E/v,E>w&&(w=E)),i.getPoint(t[d],u),(0,ui.s)(g,u,f),v=(0,ui.d)(f,f),v>0&&(E=(0,ui.d)(m,f),E*=E/v,E>w&&(w=E)),i.getPoint(t[c],u),(0,ui.s)(g,u,f),v=(0,ui.d)(f,f),v>0&&(E=(0,ui.d)(m,f),E*=E/v,E>w&&(w=E)),p>0?w/p:Number.MAX_VALUE}function na(e,t,n,o,i,a,r,s){const l=e[n],d=e[o],c=d.length,u=[];!function(e,t,n,o){const i=[],a=[],r=[],s=[],l=[];let d,c;const u=[0,0];o[0]=0,o[1]=0;const h=e.length;t.getPoint(e[h-1],a),t.getPoint(e[0],i),(0,ui.s)(i,a,r),d=Math.sqrt((0,ui.d)(r,r));for(let g=0;g<h;g++){let m=g+1;if(m===h&&(m=0),t.getPoint(e[m],a),(0,ui.s)(a,i,s),c=Math.sqrt((0,ui.d)(s,s)),(0,ui.j)(r,s,l),(0,ui.d)(l,n)<0&&d*c>0){const e=(0,ui.d)(r,s)/(d*c);e<u[0]&&(u[1]=u[0],u[0]=e,o[1]=o[0],o[0]=g)}i[0]=a[0],i[1]=a[1],i[2]=a[2],r[0]=s[0],r[1]=s[1],r[2]=s[2],d=c}}(d,i,a,u);const h=[];h.length=l.length;let g=0;r[0][0]=0,r[0][1]=0,r[1][0]=0,r[1][1]=0;let m=!1;for(g=0;g<2;g++){const f=s?c:3;for(let s=0;s<f&&!m;s++){let f=(s>>1)+(1&s)*(c+1>>1);f=(f+u[g])%c;for(let e=0;e<l.length;e++){const t=ta(l,d,e,f,i);h[e]=[t,e]}h.sort(((e,t)=>e[0]-t[0]));for(let s=0;s<h.length;s++){const c=h[s][1];if(g>0){if(f===r[0][1]||c===r[0][0])continue;const e=[],t=[];i.getPoint(l[r[0][0]],e),i.getPoint(d[r[0][1]],t);const n=[],o=[];let a,s;if(i.getPoint(l[c],n),i.getPoint(d[f],o),gi.ZP.intersection(e,t,n,o,a,s)===gi.ZP.IntersectionState.YES_INTERSECTION)continue}if(ea(e,i,a,t,n,o,c,f)){r[g][0]=c,r[g][1]=f,m=!0;break}}}if(!m)return!1}return!0}function oa(e,t,n,o,i,a){const r=[],s=[];for(let t=0;t<2;t++){const l=e[n][a[t][0]],d=e[o][a[t][1]];i.getPoint(l,r),i.getPoint(d,s)}const l=e[n],d=e[o],c=t[n],u=t[o],h=l.length,g=d.length;let m;const f=h*(a[1][0]<a[0][0])+a[1][0]-a[0][0]+1,p=f+g*(a[0][1]<a[1][1])+a[0][1]-a[1][1]+1,v=[];v.length=p;const E=new Array(p);m=a[0][0];for(let e=0;e<f;e++){const t=m++;v[e]=l[t],E[e]=c[t],m*=m!==h}E[f-1]=-1,m=a[1][1];for(let e=f;e<p;e++){const t=m++;v[e]=d[t],E[e]=u[t],m*=m!==g}E[p-1]=-1;const w=h*(a[0][0]<a[1][0])+a[0][0]-a[1][0]+1,I=w+g*(a[1][1]<a[0][1])+a[1][1]-a[0][1]+1,C=[];C.length=I;const T=new Array(I);m=a[1][0];for(let e=0;e<w;e++){const t=m++;C[e]=l[t],T[e]=c[t],m*=m!==h}T[w-1]=-1,m=a[0][1];for(let e=w;e<I;e++){const t=m++;C[e]=d[t],T[e]=u[t],m*=m!==g}T[I-1]=-1,e[n]=v,e[o]=C,t[n]=E,t[o]=T}const{vtkErrorMacro:ia}=Bo.m,aa=!1;function ra(e,t,n,o,i){let a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],r=!1;if(n<=0)return!1;const s=e.getPoints(),l=[],d=[],c=i?.length<3;!function(e,t,n,o,i,a){let r=0,s=[];const l=new Uint8Array(n-t);e.buildLinks(e.getPoints().getNumberOfPoints());let d=0,c=n-t;for(;c>0;){const u=d++,h=[];i.push(h);let g=0,m=!1;for(g=t;g<n;g++)if(!l[g-t]){s=e.getCellPoints(g).cellPointIds,r=s.length;let t=r;r>2&&s[0]===s[r-1]&&(t=r-1,m=!0),h.length=t;for(let e=0;e<t;e++)h[e]=s[e];break}l[g-t]=1,c--;let f=0===c&&!m;for(;!m&&!f&&c>0;){f=!0;const i=h.length,a=[],d=[h[i-1],h[0]];for(let u=0;u<2;u++){const p=[],v=e.getPointCells(d[u]);for(let i=0;i<v.length;i++)g=v[i],g>=t&&g<n&&!l[g-t]&&(s=e.getCellPoints(g).cellPointIds,r=s.length,a[0]=s[0],a[1]=s[r-1],(d[u]===a[u]||!o&&d[u]===a[1-u])&&p.push(g));if(p.length>0){if(p.length>1){let t=p.length;do{g=p[--t],s=e.getCellPoints(g).cellPointIds,r=s.length,a[0]=s[0],a[1]=s[r-1];const n=d[u]!==a[u];(!n&&(0===u&&h[i-2]===s[1]||1===u&&h[1]===s[r-2])||n&&(0===u&&h[i-2]===s[r-2]||1===u&&h[1]===s[1]))&&p.splice(t,1)}while(t>0&&p.length>1)}if(g=p[0],s=e.getCellPoints(g).cellPointIds,r=s.length,a[0]=s[0],a[1]=s[r-1],m=d[u]===a[u]?d[1-u]===a[1-u]:d[1-u]===a[u],0===u)for(let e=1;e<r-(m?1:0);e++)h.push(s[e]);else for(let e=m?1:0;e<r-1;e++)h.unshift(s[e]);if(d[u]!==a[u]){let e=h.length,t=m?1:0,n=r-1;for(1===u&&(e=r-1-(m?1:0),t=s+1,n=s+r-(m?1:0));t!==n;)h[--e]=h[t++]}l[g-t]=1,c--,f=!1}}}f&&a.push(u)}}(e,t,t+n,c,l,d);let u=i;if(!c){u=[0,0,1];let e=0;const t=[];for(let n=0;n<l.length;n++){const o=Oi.getNormal(l[n],s,t);o>e&&(e=o,u[0]=t[0],u[1]=t[1],u[2]=t[2])}}!function(e,t,n,o){const i=Wi,a=[],r=[],s=[];let l,d,c,u,h,g,m,f,p=t.length;for(;0!==p;){l=e[t[p-1]],c=l[l.length-1],n.getPoint(c,r),h=Number.MAX_VALUE,g=0;for(let a=0;a<p;a++){d=e[t[a]],u=d[0],n.getPoint(u,s),m=[s[0]-r[0],s[1]-r[1],s[2]-r[2]],f=(0,ui.n)(m),0!==f&&(m[0]/=f,m[1]/=f,m[2]/=f);const l=[.5*(r[0]+s[0]),.5*(r[1]+s[1]),.5*(r[2]+s[2])],p=[];(0,ui.j)(o,m,p),p[3]=-(0,ui.d)(p,l);let v=!1;const E=e.length,w=[];for(let t=0;t<E&&!v;t++){const o=e[t],r=o.length;for(let e=0;e<r;e++){const t=o[e];if(t!==c&&t!==u){n.getPoint(t,w);const e=w[0]*p[0]+w[1]*p[1]+w[2]*p[2]+p[3],o=(0,ui.e)(w,l);if(e<0&&e*e>i*i*o){v=!0;break}}}!v&&f<h&&(h=f,g=a)}}if(h<Number.MAX_VALUE)if(g===p-1)t.pop();else{const n=t[g];l.push(...e[n]),a.push(n),t.splice(g,1)}else a.push(t[p-1]),t.pop();p=t.length}a.sort(((e,t)=>e-t));let v=a.length;for(;v>0;)e.splice(a[--v],1);t.length=0}(l,d,s,u);const h=[],g=[];Zi(l,s,h,g);const m=l.length,f=new Array(m);for(let e=0;e<m;e++)f[e]=[e];!function(e,t,n,o,i,a,r){const s=e.length;if(s<=1)return;const l=[],d=[];let c;r||(c=new Int32Array(s));let u=1;for(let t=0;t<s;t++)u=Math.max(u,e[t].length);const h=new Float64Array(3*u),g=[0,0,0,0,0,0];let m;for(let o=0;o<s;o++){const i=e[o].length;if(i<3)continue;const{isNormalNotZero:r,sense:d}=Xi(e[o],t,a);r&&(l[o]=!d),m=Qi(e[o],t,h,g);for(let r=0;r<s;r++)r!==o&&e[r].length>=3&&(n[r].includes(o)||Ji(e[o],e[r],t,a,h.subarray(3*i),g,m)&&(n[o].push(r),c&&(c[r]+=1)))}if(r){for(let e=0;e<s;e++)if(l[e])n[e].length=0;else if(n[e].length>1){d.length=0;for(let t=1;t<n[e].length;t++)d[n[e][t]]=!0;for(let t=1;t<n[e].length;t++){const o=n[e][t];if(!l[o])for(let e=0;e<n[o].length;e++)d[n[o][e]]=!1}n[e].length=0,n[e].push(e);for(let t=0;t<s;t++)d[t]&&n[e].push(t)}}else{const t=[];for(let e=0;e<s;e++)0===c[e]&&t.push(e);let a;for(;t.length>0;)if(a=t.length-1,t.pop(),l[a]&&(Yi(e[a],o[a],i),l[a]=!1),n[a].length>1){d.length=0;for(let r=1;r<n[a].length;r++){const s=n[a][r];c[s]>1?(c[s]-=2,0===c[s]&&t.push(s)):(d[s]=1,n[s].length=0,l[s]||(Yi(e[s],o[s],i),l[s]=!1))}n[a].length=0,n[a].push(a);for(let e=0;e<s;e++)d[e]&&n[a].push(e)}}}(l,s,f,h,g,u,c),function(e,t,n,o,i){let a=0,r=0;for(;r<n.length;){const s=n[r];if(s.length>1){const l=s[0];let d=s[1],c=new Array(s.length);for(let t=1;t<s.length;t++)c[t]=[e[s[t]].length,t];c=[c[0],...c.splice(1).sort(((e,t)=>e[0]-t[0]))],$i(c,1,c.length-1);let u=0,h=0;for(let n=0;n<2&&!u;n++)for(let a=1;a<s.length;a++){h=c[a][1],d=s[h];const r=[];if(na(e,s,l,d,t,i,r,n)){oa(e,o,l,d,t,r),u=1;break}}if(u)s.splice(h,1),0===n[d].length&&n[d].push(d);else{for(let e=1;e<s.length;e++)d=s[e],0===n[d].length&&n[d].push(d);s.length=1,a=1}if(s.length>1){const o=e[l],a=new Float64Array(3*o.length),c=[0,0,0,0,0,0],u=Qi(o,t,a,c);let h=r,g=1;for(;g<s.length;)Ji(o,e[s[g]],t,i,a,c,u)?g++:(n[d].push(s[g]),s.splice(g,1),d<h&&(h=d));r=h;continue}}r++}return!a}(l,s,f,h,u)||(r=!0),function(e,t,n,o,i,a){const r=Fo.ZP.newInstance({dataType:Go.Tu.DOUBLE,empty:!0}),s=Hi.newInstance();let l,d,c,u,h=0;for(let g=0;g<e.length;g++){if(l=e[g],d=l.length,c=[],u=Wi*Math.sqrt(Oi.getBounds(l,t,c)),0===u)continue;r.initialize(),s.setTolerance(u),s.initPointInsertion(r,c);let m=!1,f=0,p=0,v=0;const E=[],w=[],I=[],C=[];for(p=0;p<d;p++){t.getPoint(l[p],E);const{success:e,pointIdx:n}=s.insertUniquePoint(E,0);if(!e&&(s.insertNextPoint(E),f=n,v=l[p]!==l[f],p>f+2-v&&d+f>p+2-v)){if(!a){m=!0;break}{let e=d+f-1,n=f+1,o=p+1;if(e>=d&&(e-=d),n>=d&&(n-=d),o>=d&&(o-=d),t.getPoint(l[e],w),t.getPoint(l[n],I),t.getPoint(l[o],C),ji(E,w,I,C,i)>0){m=!0;break}}}}if(m){h++;const t=p-f,i=e[g],a=o[g],r=i.slice(f,f+t+v),s=a.slice(f,f+t+v),l=new Array(d-t+v),c=new Array(d-t+v);v&&(s[t]=-1);for(let e=0;e<f+v;e++)l[e]=i[e],c[e]=a[e];v&&(c[f]=-1);for(let e=p;e<d;e++)l[e-t+v]=i[e],c[e-t+v]=a[e];e[g]=r,o[g]=s,e.push(l),o.push(c),n.length=e.length,n[g].length>0&&n[e.length-1].push(e.length-1)}}}(l,s,f,h,u,c);for(let e=0;e<f.length;e++)0!==f[e].length&&(a?qi(l[e],s,h[e],g,o,u)||(r=!1):o.insertNextCell(g.slice(1,g.length)));return!r}const sa={triangulateContours:ra,triangulatePolygon:function(e,t,n){const o=[...e],i=[],a=[];Zi([o],t,a,i);const r=a[0];let s=!0;const l=[];return 0!==Oi.getNormal(o,t,l)&&(s=qi(o,t,r,i,n,l)),s}};const la={triangulatePolys:!0};function da(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,la,n),Bo.m.obj(e,t),Bo.m.algo(e,t,1,1),Bo.m.setGet(e,t,["triangulatePolys"]),function(e,t){t.classHierarchy.push("vtkContourTriangulator"),e.requestData=(e,n)=>{const o=e[0],i=Ho.ZP.newInstance();if(n[0]=i,!o)return ia("Invalid or missing input"),!1;let a=!1;const r=o.getLines();if(null==r||0===r.getNumberOfCells())return!0;o.buildCells();const s=Xo.ZP.newInstance({dataType:Go.Tu.DOUBLE,empty:!0});return i.setPolys(s),i.setPoints(o.getPoints()),i.getPointData().passData(o.getPointData()),a=!ra(o,o.getNumberOfVerts(),r.getNumberOfCells(),s,null,t.triangulatePolys),a&&aa&&ia("Triangulation failed, output might have holes."),!0}}(e,t)}var ca={newInstance:Bo.m.newInstance(da,"vtkContourTriangulator"),extend:da,...sa};class ua{constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.oriented=e,this.edgeMap=new Map}initialize(){this.edgeMap.clear()}computeEdgeKey(e,t){return this.oriented||e<t?e*t*.5*(e*t+1)+t:t*e*.5*(t*e+1)+e}insertUniqueEdge(e,t,n){const o=this.computeEdgeKey(e,t);let i=this.edgeMap.get(o);return i||(i={key:o,edgeId:this.edgeMap.size,value:n},this.edgeMap.set(o,i)),i}insertEdge(e,t,n){const o=this.computeEdgeKey(e,t),i={key:o,edgeId:this.edgeMap.size,value:n};return this.edgeMap.set(o,i),i}isInsertedEdge(e,t){const n=this.computeEdgeKey(e,t);return this.edgeMap.get(n)}static getEdgePointIds(e){const t=.5*(-1+Math.sqrt(8*e.key+1)),n=e.key-.5*(t+1)*t;return[n,t-n]}}var ha={newInstance:function(){return new ua((arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).oriented)}};var ga={ScalarMode:{NONE:0,COLORS:1,LABELS:2}};const{vtkErrorMacro:ma,capitalize:fa}=Bo.m,{ScalarMode:pa}=ga;function va(e,t){function n(e,t,n,o,i,a,r,s){s>0&&([i,a]=[a,i],[r,s]=[s,r]);const l=n.insertUniqueEdge(i,a);if(null!=l.value)return l.value;const d=e.getPoint(i),c=e.getPoint(a),u=1-r/(r-s),h=1-u,g=[u*d[0]+h*c[0],u*d[1]+h*c[1],u*d[2]+h*c[2]],m=o*o;return(0,ui.e)(g,d)<m?(l.value=i,i):(0,ui.e)(g,c)<m?(l.value=a,a):(l.value=e.insertNextTuple(g),t.interpolateData(t,i,a,l.value,h),l.value)}function o(e,o,i,a,r,s,l,d){let c,u,h,g,m,f,p;const v=[],E=r.getData();let w=0;for(let r=0;r<E.length;r+=c+1,w++){c=E[r],h=E[r+1],m=o.getData()[h],p=m>0;for(let I=2;I<=c;I++)if(u=h,g=m,f=p,h=E[r+I],m=o.getData()[h],p=m>0,(f||p)&&((f?!p:p)&&(v[f?1:0]=n(e,i,a,t.tolerance,u,h,g,m)),u!==h)){v[0]=u,v[1]=h;const e=s.insertNextCell(v);d.passData(l,w,e)}}}function i(e,n,o,i,a){if(o<=0)return;!ca.triangulateContours(e,n,o,i,[-a[0],-a[1],-a[2]])&&t.triangulationErrorDisplay&&ma("Triangulation failed, polyData may not be watertight.")}function a(e,t,n){return ca.triangulatePolygon(e,t,n)}function r(e,o,i,r,s,l,d,c,u,h,g){const m=t._idList;let f=Number.MAX_VALUE;s&&(s<4?f=3:4===s&&(f=4));let p=!1;const v=l.getData(),E=[];let w,I=0;for(let s=0;s<v.length;s+=w+1,I++){w=v[s];let l=v[s+w],C=o.getData()[l],T=C>0,b=T?l:-1,_=0;E[0]=0,E[1]=0;let D=0;for(let a=1;a<=w;a++){const d=l,c=C,u=T;l=v[s+a],C=o.getData()[l],T=C>0,(u||T)&&((u?!T:T)&&(_=n(e,i,r,t.tolerance,d,l,c,C),_!==b&&(m[D++]=_,b=_),E[u?1:0]=_),T&&(_=l,_!==b&&(m[D++]=_,b=_)))}const S=D;if(m.length=S,t.triangulatePolys&&S>f){let t=d.getNumberOfCells();a(m,e,d)||(p=!0);const n=d.getNumberOfCells();for(;t<n;t++)h.passData(u,I,t)}else if(S>2){const e=d.insertNextCell(m);h.passData(u,I,e)}if(E[0]!==E[1]){const e=c.insertNextCell(E);g.passData(u,I,e)}}p&&t.triangulationErrorDisplay&&ma("Triangulation failed, output may not be watertight")}t.classHierarchy.push("vtkClipClosedSurface"),e.getMTime=()=>t.clippingPlanes.reduce(((e,t)=>t.getMTime()>e?t.getMTime():e),t.mtime),e.requestData=(e,n)=>{const a=e[0],s=Ho.ZP.newInstance();if(n[0]=s,!a)return void ma("Invalid or missing input");null==t._idList?t._idList=[]:t._idList.length=0;const l=a.getPoints();let d=0,c=Go.Tu.FLOAT;l&&(d=l.getNumberOfPoints(),c=l.getDataType());const u=Fo.ZP.newInstance({size:3*d,dataType:Go.Tu.DOUBLE}),h=hi.ZP.newInstance();let g=null;t.passPointData&&(g=a.getPointData());const m=[];for(let e=0;e<d;e++)l.getPoint(e,m),u.setTuple(e,m),g&&h.passData(g,e,e);const f=ha.newInstance(),p=Ho.ZP.newInstance();let v,E,w,I=0,C=0,T=0,b=1;const _=[[0,0,0],[0,0,0],[0,0,0]];t.scalarMode===pa.COLORS?(b=3,function(e,t,n,o){const i=[e,t,n];for(let e=0;e<3;e++)for(let t=0;t<3;t++)o[e][t]=Math.round(255*(a=i[e][t],r=0,s=1,Math.min(Math.max(a,r),s)));var a,r,s}(t.baseColor,t.clipColor,t.activePlaneColor,_)):t.scalarMode===pa.LABELS&&(_[0][0]=0,_[1][0]=1,_[2][0]=2);const D=a.getVerts()?.getNumberOfCells()||0,S=a.getLines(),y=S?.getNumberOfCells()||0,O=a.getPolys(),P=O?.getNumberOfCells()||0,M=a.getStrips()?.getNumberOfCells()||0;if(t.scalarMode!==pa.NONE){v=Vo.default.newInstance({dataType:Go.Tu.UNSIGNED_CHAR,empty:!0,numberOfComponents:b});const e=a.getCellData().getScalars();e&&e.getDataType()===Go.Tu.UNSIGNED_CHAR&&3===b&&3===e.getNumberOfComponents()&&(w=a.getCellData().getScalars(),I=D,C=D+y,T=D+y+P)}let x;y>0?(x=Xo.ZP.newInstance({dataType:S.getDataType(),values:new Uint8Array(3*y),size:0}),function(e,t,n,o,i,a){const r=[...a];let s=0;const l=e.getData();let d;for(let e=0;e<l.length;e+=d+1){d=l[e],n&&n.getTuple(o+s++,r);for(let n=1;n<d;n++)t.insertNextCell([l[e+n],l[e+n+1]]),i&&i.insertNextTuple(r)}}(S,x,w,I,v,_[0])):x=Xo.ZP.newInstance({empty:!0});let R=null,N=3;(P>0||M>0)&&(v&&(E=Vo.default.newInstance({dataType:Go.Tu.UNSIGNED_CHAR,empty:!0,numberOfComponents:b})),R=Xo.ZP.newInstance(),function(e,t,n,o,i,a){if(e&&(t.deepCopy(e),i)){const e=[...a],r=t.getNumberOfCells();if(i.insertTuple(r-1,e),n)for(let t=0;t<r;t++)n.getTuple(t+o,e),i.setTuple(t,e);else for(let t=0;t<r;t++)i.setTuple(t,e)}}(O,R,w,C,E,_[0]),function(e,t,n,o,i,a){if(0===e.getNumberOfCells())return;const r=e.getData();let s,l=o;for(let e=0;e<r.length;e+=s+1,l++){s=r[e];let o=r[e+1],d=r[e+2];for(let n=0;n<s-2;n++){const i=r[e+n+3];n%2?t.insertNextCell([d,o,i]):t.insertNextCell([o,d,i]),o=d,d=i}if(i){const e=[...a];n&&n.getTuple(l,e);const t=s-3,o=i.getNumberOfTuples();if(t>=0){i.insertTuple(o+t,e);for(let n=0;n<t;n++)i.setTuple(o+n,e)}}}}(a.getStrips(),R,w,T,E,_[0]),N=O.getCellSizes().reduce(((e,t)=>e>t?e:t),0));let A=Xo.ZP.newInstance({dataType:x.getDataType(),empty:!0}),L=null;R&&(L=Xo.ZP.newInstance({dataType:R.getDataType(),empty:!0}));let k=hi.ZP.newInstance();k.copyScalarsOn(),k.setScalars(v);let U=hi.ZP.newInstance();U.copyScalarsOn(),U.setScalars(E);let V=hi.ZP.newInstance();V.copyScalarsOn();let B=hi.ZP.newInstance();B.copyScalarsOn();const F=t.clippingPlanes;for(let e=0;e<F.length;e++){const n=F[e];let a=5;e===F.length-1&&(a=N);const s=e===t.activePlaneId,l=n.getNormal();l[3]=-(0,ui.d)(l,n.getOrigin());const d=u.getNumberOfPoints(),c=Vo.default.newInstance({dataType:Go.Tu.DOUBLE,size:d}),g=c.getData(),m=u.getData();let v=0;for(let e=0;e<d;e)g[e++]=m[v++]*l[0]+m[v++]*l[1]+m[v++]*l[2]+l[3];if(f.initialize(),o(u,c,h,f,x,A,k,V),R){const e=A.getNumberOfCells();r(u,c,h,f,a,R,L,A,U,B,V);let t=V.getScalars();if(t){const n=_[1+(s?1:0)],o=_[2],i=A.getNumberOfCells(),a=[];for(let r=e;r<i;r++)t.getTuple(r,a),3===b&&a[0]===o[0]&&a[1]===o[1]&&a[2]===o[2]||t.setTuple(r,n)}let n=L.getNumberOfCells();const o=A.getNumberOfCells();if(p.setPoints(u),p.setLines(A),p.buildCells(),i(p,e,o-e,L,l),t=B.getScalars(),t){const e=_[1+(s?1:0)],o=L.getNumberOfCells();if(o>n)for(t.insertTuple(o-1,e);n<o;n++)t.setTuple(n,e)}if(t=V.getScalars(),t){const e=[0,255,255],n=A.getNumberOfCells();if(n>o){t.insertTuple(n-1,e);for(let i=o;i<n;i++)t.setTuple(i,e)}}}[x,A]=[A,x],A.initialize(),R&&([R,L]=[L,R],L.initialize()),[k,V]=[V,k],V.initialize(),[U,B]=[B,U],B.initialize()}const H=k.getScalars();if(t.generateOutline?s.setLines(x):H&&H.initialize(),t.generateFaces&&(s.setPolys(R),R&&H)){const e=U.getScalars(),t=H.getNumberOfTuples(),n=e.getNumberOfTuples();if(n>0){const o=[0,0,0];H.insertTuple(n+t-1,o);for(let i=0;i<n;i++)e.getTuple(i,o),H.setTuple(i+t,o)}}if(H&&t.scalarMode===pa.COLORS)H.setName("Colors"),s.getCellData().setScalars(H);else if(t.scalarMode===pa.LABELS){const e=H.newClone();e.setData(H.getData().slice()),e.setName("Labels"),s.getCellData().setScalars(e)}else s.getCellData().setScalars(null);!function(e,t,n,o){const i=t.getNumberOfPoints();let a=0;const r=e.getPointData(),s=[];s.length=i;const l=[e.getVerts(),e.getLines(),e.getPolys(),e.getStrips()];l.forEach((e=>{if(!e)return;const t=e.getData();let n,o;for(let e=0;e<t.length;e+=n+1){n=t[e];for(let i=1;i<=n;i++)o=t[e+i],void 0===s[o]&&(s[o]=a++)}}));const d=Fo.ZP.newInstance({size:3*a,dataType:o}),c=[];let u;for(let e=0;e<i;e++)u=s[e],void 0!==u&&(t.getPoint(e,c),d.setTuple(u,c),r.passData(n,e,u));l.forEach((e=>{if(!e)return;const t=e.getData();let n,o;for(let e=0;e<t.length;e+=n+1){n=t[e];for(let i=1;i<=n;i++)o=t[e+i],t[e+i]=s[o]}})),e.setPoints(d)}(s,u,h,c),n[0]=s},Object.keys(pa).forEach((n=>{const o=fa(n.toLowerCase());e[`setScalarModeTo${o}`]=()=>{t.scalarMode=pa[n]}}))}const Ea={clippingPlanes:null,tolerance:1e-6,passPointData:!1,triangulatePolys:!1,scalarMode:pa.NONE,generateOutline:!1,generateFaces:!0,activePlaneId:-1,baseColor:[1,99/255,71/255],clipColor:[244/255,164/255,96/255],activePlaneColor:[227/255,207/255,87/255],triangulationErrorDisplay:!1};function wa(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,Ea,n),Bo.m.obj(e,t),Bo.m.algo(e,t,1,1),Bo.m.setGet(e,t,["clippingPlanes","tolerance","passPointData","triangulatePolys","scalarMode","generateOutline","generateFaces","activePlaneId","triangulationErrorDisplay"]),Bo.m.setGetArray(e,t,["baseColor","clipColor","activePlaneColor"],3),va(e,t)}var Ia={newInstance:Bo.m.newInstance(wa,"vtkClipClosedSurface"),extend:wa,...ga};function Ca(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return parseFloat(e[0]).toFixed(t)+","+parseFloat(e[1]).toFixed(t)+","+parseFloat(e[2]).toFixed(t)+","}const Ta=new Map;function ba(e){const{actorEntry:t,vtkPlanes:n,viewport:o}=e.detail;if(!t?.clippingFilter)return;const i=t.actor.getMapper(),{viewPlaneNormal:a}=o.getCamera(),r=o.getCurrentImageIdIndex(),s=`${o.id}-${Ca(a)}-${r}`;let l=Ta.get(t.uid);l||(l=new Map,Ta.set(t.uid,l));let d=l.get(s);if(!d){const e=t.clippingFilter;e.setClippingPlanes(n);try{e.update(),d=e.getOutputData(),l.set(s,d)}catch(e){console.error("Error clipping surface",e)}}i.setInputData(d)}const _a=function(e,t,n){const o=(0,te.getEnabledElement)(e),{viewport:i}=o,a=t.getPoints(),r=t.getPolys(),s=t.getColor(),l=Ho.ZP.newInstance();l.getPoints().setData(a,3);const d=Xo.ZP.newInstance({values:Float32Array.from(r)});l.setPolys(d);const c=Yo.default.newInstance({});let u;if(i instanceof te.VolumeViewport3D)c.setInputData(l);else{u=Ia.newInstance({clippingPlanes:[],activePlaneId:2,passPointData:!1}),u.setInputData(l),u.setGenerateOutline(!0),u.setGenerateFaces(!1),u.update();const e=u.getOutputData();c.setInputData(e)}const h=Zo.ZP.newInstance();h.setMapper(c),h.getProperty().setColor(s[0]/255,s[1]/255,s[2]/255),i.addActor({actor:h,uid:n,clippingFilter:u}),e.addEventListener(te.Enums.Events.CLIPPING_PLANES_UPDATED,ba)};const Da={render:async function(e,t,n){const{colorLUTIndex:o,active:i,segmentationId:a,segmentationRepresentationUID:r,segmentsHidden:s}=t,l=Qn(a).representationData[le.Surface],{geometryId:d}=l;d||console.warn(`No Surfaces found for segmentationId ${a}. Skipping render.`);const c=te.cache.getGeometry(d);if(!c)throw new Error(`No Surfaces found for geometryId ${d}`);if(c.type!==te.Enums.GeometryType.SURFACE)throw new Error(`Geometry type ${c.type} not supported for rendering.`);if(!c.data)return void console.warn(`No Surfaces found for geometryId ${d}. Skipping render.`);const u=c.data;!function(e,t,n){const o=n,i=e.getActor(o);if(i)throw new Error("Not implemented yet. (Update surface)");_a(e.element,t,o)}(e,u,`${r}_${u.id}}`),e.resetCamera(),e.render()},addSegmentationRepresentation:async function(e,t,n){const{segmentationId:o}=t,i=te.utilities.uuidv4(),a=new Set,r={segmentationId:o,segmentationRepresentationUID:i,type:le.Surface,segmentsHidden:a,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}};if(n){const t=Do(e),o=te.utilities.deepMerge(t,n);So(e,{renderInactiveSegmentations:o.renderInactiveSegmentations||!0,representations:{...o.representations}})}return ho(e,r),i},removeSegmentationRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(function(e,t){const n=dv(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:o}=n;for(const e of o){const{viewportId:n,renderingEngineId:o}=e,i=(0,te.getEnabledElementByIds)(n,o);ci(i.viewport.element,t)}}(e,t),vo(e,t),n){dv(e).getViewportsInfo().forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;(0,te.getEnabledElementByIds)(t,n).viewport.render()}))}}};const Sa=async function(e,t,n){if(!dv(e))throw new Error(`No tool group found for toolGroupId: ${e}`);const o=t.map((t=>async function(e,t,n){let o;if(t.type===le.Labelmap)o=await Uo.addSegmentationRepresentation(e,t,n);else if(t.type===le.Contour)o=await ai.addSegmentationRepresentation(e,t,n);else{if(t.type!==le.Surface)throw new Error(`The representation type ${t.type} is not supported`);o=await Da.addSegmentationRepresentation(e,t,n)}return o}(e,t,n)));return await Promise.all(o)};function ya(e){const t=Jn().getSegmentationRepresentations(e);if(!t)return;return t.find((e=>e.active))}function Oa(e,t){Jn().setActiveSegmentationRepresentation(e,t),jn(e,t)}function Pa(e,t){const n=Qn(e);if(!n)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:o}=n;return o.has(t)}function Ma(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const o=Qn(e);if(!o)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:i}=o;n?i.add(t):i.delete(t),Zn(e)}function xa(e){const t=Qn(e);if(!t)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:n}=t;return Array.from(n)}function Ra(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");te.utilities.isEqual(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),Io(e,t)}function Na(e,t,n){const o=fo(e,t);if(!o)throw new Error(`setColorLUT: could not find segmentation representation with UID ${t}`);if(!wo(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);o.colorLUTIndex=n,jn(e,t)}function Aa(e,t,n){const o=fo(e,t);if(!o)throw new Error(`segmentation representation with UID ${t} does not exist for tool group ${e}`);const{colorLUTIndex:i}=o;return wo(i)[n]}function La(e,t,n,o){const i=Aa(e,t,n);for(let e=0;e<o.length;e++)i[e]=o[e];jn(e,t)}function ka(e,t,n){const o=no(e);if(!o)return;const i=o.find((e=>e.segmentationRepresentationUID===t));if(!i)return;const{segmentsHidden:a,segmentationId:r}=i,s=function(e){const t=Qn(e);if(t.type===le.Labelmap){const t=te.cache.getVolume(e).getScalarData(),n={};for(let e=0;e<t.length;e++){const o=t[e];0===o||n[o]||(n[o]=!0)}return Object.keys(n).map((e=>parseInt(e,10)))}if(t.type===le.Contour){const n=t.representationData.CONTOUR?.geometryIds;if(!n)throw new Error(`No geometryIds found for segmentationId ${e}`);return n.map((e=>te.cache.getGeometry(e).data.getSegmentIndex()))}}(r);n?a.clear():s.forEach((e=>{a.add(e)})),jn(e,i.segmentationRepresentationUID)}function Ua(e,t){const n=no(e).find((e=>e.segmentationRepresentationUID===t));if(!n)return;const{segmentsHidden:o}=n;return 0===o.size}function Va(e,t,n,o){const i=fo(e,t);i&&(n.forEach((e=>{o?i.segmentsHidden.delete(e):i.segmentsHidden.add(e)})),jn(e,t))}function Ba(e,t,n,o){const i=fo(e,t);i&&(o?i.segmentsHidden.delete(n):i.segmentsHidden.add(n),jn(e,t))}function Fa(e,t){const n=Qn(e);n?.activeSegmentIndex!==t&&(n.activeSegmentIndex=t,Zn(e))}function Ha(e){const t=Qn(e);if(t)return t.activeSegmentIndex}class Wa{constructor(e,t){const n=te.utilities.deepMerge(t,e),{configuration:o={},supportedInteractionTypes:i,toolGroupId:a}=n;o.strategies||(o.strategies={},o.defaultStrategy=void 0,o.activeStrategy=void 0,o.strategyOptions={}),this.toolGroupId=a,this.supportedInteractionTypes=i||[],this.configuration=Object.assign({},o),this.mode=ne.Disabled}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){const{strategies:n,activeStrategy:o}=this.configuration;return n[o].call(this,e,t)}setConfiguration(e){this.configuration=te.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetVolumeId(e){if(this.configuration.volumeId)return this.configuration.volumeId;const t=e.getActors();return t?t.find((e=>"vtkVolume"===e.actor.getClassName()))?.uid:void 0}getTargetIdImage(e,t){if(e.startsWith("imageId:")){const n=e.split("imageId:")[1],o=te.utilities.imageIdToURI(n);let i=te.utilities.getViewportsWithImageURI(o,t.id);if(!i||!i.length)return;if(i=i.filter((e=>e.getCurrentImageId()===n)),!i||!i.length)return;return i[0].getImageData()}if(e.startsWith("volumeId:")){const n=e.split("volumeId:")[1],o=te.utilities.getViewportsWithVolumeId(n,t.id);if(!o||!o.length)return;return o[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){if(e instanceof te.StackViewport)return`imageId:${e.getCurrentImageId()}`;if(e instanceof te.BaseVolumeViewport)return`volumeId:${this.getTargetVolumeId(e)}`;if(e instanceof te.VideoViewport)return"";throw new Error("getTargetId: viewport must be a StackViewport or VolumeViewport")}}Wa.toolName="BaseTool";const Ga=Wa;var $a=n(45451);const za="viewport-element";function Ka(e,t){if(Ze.svgNodeCache[e])return Ze.svgNodeCache[e][t]?Ze.svgNodeCache[e][t].domRef:void 0}function qa(e,t,n,o){if(!Ze.svgNodeCache[t])return null;Ze.svgNodeCache[t][o]={touched:!0,domRef:n},e.appendChild(n)}function ja(e,t){Ze.svgNodeCache[e]&&Ze.svgNodeCache[e][t]&&(Ze.svgNodeCache[e][t].touched=!0)}function Za(e,t){Ze.svgNodeCache[t]&&Object.keys(Ze.svgNodeCache[t]).forEach((n=>{const o=Ze.svgNodeCache[t][n];!o.touched&&o.domRef&&(e.removeChild(o.domRef),delete Ze.svgNodeCache[t][n])}))}const Ya=function(e){const t=(0,te.getEnabledElement)(e),{viewportId:n,renderingEngineId:o}=t,i=`${n}:${o}`,a=function(e){const t=`.${za}`,n=e.querySelector(t);return n.querySelector(":scope > .svg-layer")}(e);return Object.keys(Ze.svgNodeCache[i]).forEach((e=>{Ze.svgNodeCache[i][e].touched=!1})),{svgLayerElement:a,svgNodeCacheForCanvas:Ze.svgNodeCache,getSvgNode:Ka.bind(this,i),appendNode:qa.bind(this,a,i),setNodeTouched:ja.bind(this,i),clearUntouched:Za.bind(this,a,i)}};const Xa=function(e,t){const n=Ya(e);t(n),n.clearUntouched()};const Ja=function(e,t,n){return`${e}::${t}::${n}`};const Qa=function(e,t){Object.keys(e).forEach((n=>{const o=t.getAttribute(n),i=e[n];void 0===i||""===i?t.removeAttribute(n):o!==i&&t.setAttribute(n,i)}))};const er=function(e,t){Object.keys(e).forEach((n=>{const o=e[n];void 0!==o&&""!==o&&t.setAttribute(n,o)}))};const tr=function(e,t,n,o,i){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";const{color:s,fill:l,width:d,lineWidth:c,lineDash:u,fillOpacity:h,strokeOpacity:g}=Object.assign({color:"dodgerblue",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},a),m=c||d,f=Ja(t,"circle",n),p=e.getSvgNode(f),v={cx:`${o[0]}`,cy:`${o[1]}`,r:`${i}`,stroke:s,fill:l,"stroke-width":m,"stroke-dasharray":u,"fill-opacity":h,"stroke-opacity":g};if(p)Qa(v,p),e.setNodeTouched(f);else{const t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==r&&t.setAttribute("data-id",r),er(v,t),e.appendNode(t,f)}};const nr=function(e,t,n,o,i){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";const{color:s,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),u=d||l,h=Ja(t,"ellipse",n),g=e.getSvgNode(h),m=Math.abs(o[0]-i[0]),f=Math.abs(o[1]-i[1]),p=[Math.min(o[0],i[0])+m/2,Math.min(o[1],i[1])+f/2],v={cx:`${p[0]}`,cy:`${p[1]}`,rx:`${m/2}`,ry:`${f/2}`,stroke:s,fill:"transparent","stroke-width":u,"stroke-dasharray":c};if(g)Qa(v,g),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==r&&t.setAttribute("data-id",r),er(v,t),e.appendNode(t,h)}};const or=function(e,t,n,o){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const{color:a,handleRadius:r,width:s,lineWidth:l,fill:d,type:c,opacity:u}=Object.assign({color:"dodgerblue",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},i),h=l||s;for(let i=0;i<o.length;i++){const s=o[i],l="http://www.w3.org/2000/svg",g=Ja(t,"handle",`hg-${n}-index-${i}`);let m;if("circle"===c)m={cx:`${s[0]}`,cy:`${s[1]}`,r,stroke:a,fill:d,"stroke-width":h,opacity:u};else{if("rect"!==c)throw new Error(`Unsupported handle type: ${c}`);{const e=1.5*parseFloat(r);m={x:`${s[0]-.5*e}`,y:`${s[1]-.5*e}`,width:`${e}`,height:`${e}`,stroke:a,fill:d,"stroke-width":h,rx:""+.1*e,opacity:u}}}const f=e.getSvgNode(g);if(f)Qa(m,f),e.setNodeTouched(g);else{const t=document.createElementNS(l,c);er(m,t),e.appendNode(t,g)}}};function ir(e,t,n,o,i){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";if(isNaN(o[0])||isNaN(o[1])||isNaN(i[0])||isNaN(i[1]))return;const{color:s,width:l,lineWidth:d,lineDash:c,shadow:u}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},a),h=d||l,g=Ja(t,"line",n),m=e.getSvgNode(g),f=u?`filter:url(#shadow-${e.svgLayerElement.id});`:"",p={x1:`${o[0]}`,y1:`${o[1]}`,x2:`${i[0]}`,y2:`${i[1]}`,stroke:s,style:f,"stroke-width":h,"stroke-dasharray":c};if(m)Qa(p,m),e.setNodeTouched(g);else{const t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==r&&t.setAttribute("data-id",r),er(p,t),e.appendNode(t,g)}}function ar(e,t,n,o,i){if(o.length<2)return;const{fillColor:a,fillOpacity:r,color:s,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",fillColor:"none",fillOpacity:0,lineWidth:void 0,lineDash:void 0,connectLastToFirst:!1},i),u=d||l,h=Ja(t,"polyline",n),g=e.getSvgNode(h);let m="";for(const e of o)m+=`${e[0]}, ${e[1]} `;if(i.connectLastToFirst){const e=o[0];m+=`${e[0]}, ${e[1]}`}const f={points:m,stroke:s,fill:a,"fill-opacity":r,"stroke-width":u,"stroke-dasharray":c};if(g)Qa(f,g),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","polyline");er(f,t),e.appendNode(t,h)}}function rr(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function sr(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||(n=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.setAttribute("class","background"),e.insertBefore(n,e.firstChild));const o=e.getBBox(),i={x:`${o.x}`,y:`${o.y}`,width:`${o.width}`,height:`${o.height}`,fill:t};return Qa(i,n),o}const lr=function(e,t,n,o,i){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};return function(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[""],i=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0;const{padding:r,color:s,fontFamily:l,fontSize:d,background:c}=a;let u;const[h,g]=[i[0]+r,i[1]+r],m="http://www.w3.org/2000/svg",f=Ja(t,"text",n),p=e.getSvgNode(f);if(p){const t=p.querySelector("text"),n=Array.from(t.children);for(let e=0;e<n.length;e++){const t=n[e],i=o[e]||"";t.textContent=i}if(o.length>n.length){for(let e=0;e<o.length-n.length;e++){const i=rr(o[e+n.length]);t.appendChild(i)}p.appendChild(t),e.appendNode(p,f)}const i={transform:`translate(${h} ${g})`};Qa({fill:s,"font-size":d,"font-family":l},t),Qa(i,p),u=sr(p,c),e.setNodeTouched(f)}else{const t=document.createElementNS(m,"g");t.setAttribute("transform",`translate(${h} ${g})`);const n=function(e,t){const{color:n,fontFamily:o,fontSize:i}=t,a="http://www.w3.org/2000/svg",r=document.createElementNS(a,"text"),s="user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);",l=`filter:url(#shadow-${e.svgLayerElement.id});`,d=`${s}${l}`;return r.setAttribute("x","0"),r.setAttribute("y","0"),r.setAttribute("fill",n),r.setAttribute("font-family",o),r.setAttribute("font-size",i),r.setAttribute("style",d),r}(e,a);for(let e=0;e<o.length;e++){const t=rr(o[e]);n.appendChild(t)}t.appendChild(n),e.appendNode(t,f),u=sr(t,c)}return Object.assign({},u,{x:h,y:g,height:u.height+r,width:u.width+r})}(e,t,n,o,i,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a))};function dr(e,t){let n=[0,0],o=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){const i=function(e,t){const[n,o]=e,[i,a]=t;return Math.sqrt(Math.pow(n-i,2)+Math.pow(o-a,2))}(t,e);i<o&&(o=i,n=[...e])})),n}const cr=function(e,t,n,o,i,a){let r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};const s=o.length>0?dr(o,i):i,l=function(e){const{x:t,y:n,height:o,width:i}=e,a=i/2,r=o/2;return[[t+a,n],[t,n+r],[t+a,n+o],[t+i,n+r]]}(a);ir(e,t,`link-${n}`,s,dr(l,s),Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},r))};const ur=function(e,t,n,o,i,a,r){let s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};const l=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},s),d=lr(e,t,n,o,i,l);return cr(e,t,n,a,i,d,l),d};function hr(e,t,n,o,i){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";const{color:s,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),u=d||l,h=Ja(t,"rect",n),g=e.getSvgNode(h),m=[Math.min(o[0],i[0]),Math.min(o[1],i[1])],f=Math.abs(o[0]-i[0]),p=Math.abs(o[1]-i[1]),v={x:`${m[0]}`,y:`${m[1]}`,width:`${f}`,height:`${p}`,stroke:s,fill:"transparent","stroke-width":u,"stroke-dasharray":c};if(g)Qa(v,g),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==r&&t.setAttribute("data-id",r),er(v,t),e.appendNode(t,h)}}function gr(e,t,n,o,i){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};if(isNaN(o[0])||isNaN(o[1])||isNaN(i[0])||isNaN(i[1]))return;const{color:r,width:s,lineWidth:l,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a);ir(e,t,n,o,i,{color:r,width:s,lineWidth:l,lineDash:d});const c=Math.atan2(i[1]-o[1],i[0]-o[0]),u={start:[i[0]-10*Math.cos(c-Math.PI/7),i[1]-10*Math.sin(c-Math.PI/7)],end:i},h={start:[i[0]-10*Math.cos(c+Math.PI/7),i[1]-10*Math.sin(c+Math.PI/7)],end:i};ir(e,t,"2",u.start,u.end,{color:r,width:s,lineWidth:l}),ir(e,t,"3",h.start,h.end,{color:r,width:s,lineWidth:l})}function mr(e,t,n,o,i){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const{color:r,width:s,lineWidth:l,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),c=l||s,u=Ja(t,"rect",n),h=e.getSvgNode(u),g=[Math.min(o[0],i[0]),Math.min(o[1],i[1])],m=Math.abs(o[0]-i[0]),f=Math.abs(o[1]-i[1]),p={x:`${g[0]}`,y:`${g[1]}`,width:`${m}`,height:`${f}`,stroke:r,fill:"black","stroke-width":c,"stroke-dasharray":d};if(h)Qa(p,h),e.setNodeTouched(u);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");er(p,t),e.appendNode(t,u)}}function fr(e,t){const n=(0,te.getEnabledElement)(e),{renderingEngineId:o,viewportId:i}=n,a=Vp(i,o);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const n=s[e],o=a.toolOptions[n];if(o&&t.includes(o.mode)){const e=a.getToolInstance(n);r.push(e)}}return r}const{Active:pr,Passive:vr,Enabled:Er}=ne;const wr=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){const n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}},this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach((e=>{this._needsRender.add(e)})),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){const t=[...this._viewportElements.values()];e.forEach((e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,te.getEnabledElement)(e);if(!t)return void console.warn("Element has been disabled");if(!(0,te.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");const n=fr(e,[pr,vr,Er]),{renderingEngineId:o,viewportId:i}=t,a={element:e,renderingEngineId:o,viewportId:i};Xa(e,(o=>{let i=!1;n.forEach((e=>{if(e.renderAnnotation){const n=e.renderAnnotation(t,o);i=i||n}})),i&&(0,te.triggerEvent)(e,re.ANNOTATION_RENDERED,{...a})}))}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}};const Ir=function(e){wr.renderViewport(e)},{EPSILON:Cr}=te.CONSTANTS,Tr=1-Cr;function br(e,t,n){const{viewPlaneNormal:o}=t,i=e.filter((e=>{let t=e.metadata.viewPlaneNormal;if(!t){const{referencedImageId:n}=e.metadata,{imageOrientationPatient:o}=te.metaData.get("imagePlaneModule",n),i=$a.R3.fromValues(o[0],o[1],o[2]),a=$a.R3.fromValues(o[3],o[4],o[5]);t=$a.R3.create(),$a.R3.cross(t,i,a),e.metadata.viewPlaneNormal=t}const n=Math.abs($a.R3.dot(o,t))>Tr;return t&&n}));if(!i.length)return[];const a=n/2,{focalPoint:r}=t,s=[];for(const e of i){const t=e.data.handles.points[0];if(!e.isVisible)continue;const n=$a.R3.create();$a.R3.sub(n,r,t);const i=$a.R3.dot(n,o);Math.abs(i)<a&&s.push(e)}return s}function _r(e,t){if(e instanceof te.StackViewport){const n=e.getCurrentImageId(),o=n.indexOf(":"),i=n.substring(o+1);return t.filter((e=>{if(!e.isVisible)return!1;const t=e.metadata.referencedImageId;if(void 0===t)return!1;const n=t.indexOf(":");return t.substring(n+1)===i}))}if(e instanceof te.VideoViewport){const n=e.getFrameOfReferenceUID();return t.filter((e=>e.metadata.FrameOfReferenceUID===n))}if(e instanceof te.VolumeViewport){const n=e.getCamera(),{spacingInNormalDirection:o}=te.utilities.getTargetVolumeAndSpacingInNormalDir(e,n);return br(t,n,o)}throw new Error(`Viewport Type ${e.type} not supported`)}const Dr=new class{constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){const{annotationUID:n,viewportId:o,toolGroupId:i,toolName:a}=t;return this._getToolStyle(e,n,o,i,a)}_getToolStyle(e,t,n,o,i){if(t){const n=this.getAnnotationToolStyles(t);if(n&&n[e])return n[e]}if(n){const t=this.getViewportToolStyles(n);if(t){if(t[i]&&t[i][e])return t[i][e];if(t.global&&t.global[e])return t.global[e]}}if(o){const t=this.getToolGroupToolStyles(o);if(t){if(t[i]&&t[i][e])return t[i][e];if(t.global&&t.global[e])return t.global[e]}}const a=this.getDefaultToolStyles();return a[i]&&a[i][e]?a[i][e]:a.global&&a.global[e]?a.global[e]:void 0}_initializeConfig(e){const t={};for(const n in e)t[n]=e[n];this.config={default:{global:t}}}};function Sr(e,t,n,o){const i=function(e,t,n){const o=[`${e}`];return t&&o.push(`${o[0]}${t}`),n&&o.push(`${o[o.length-1]}${n}`),o}(e,n,o);for(let e=i.length-1;e>=0;--e){const n=Dr.getStyleProperty(i[e],t);if(void 0!==n)return n}}const yr=function(e){if(e){if(e.data&&e.highlighted)return ie.Highlighted;if(Pe(e.annotationUID))return ie.Selected;if(pe(e))return ie.Locked}return ie.Default};const Or=function(e,t,n){return`${Sr("textBoxFontSize",e,t,n)}px ${Sr("textBoxFontFamily",e,t,n)}`};class Pr extends Ga{constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{const{element:t,imageId:n}=e.detail,o=te.utilities.imageIdToURI(n),i=mv();i.getFramesOfReference().forEach((e=>{const n=i.getAnnotations(e)[this.getToolName()];n&&n.length&&(n.forEach((e=>{if(!e.metadata?.referencedImageId)return;te.utilities.imageIdToURI(e.metadata.referencedImageId)===o&&(e.invalidated=!0,e.data.cachedStats={})})),Ir(t))}))}}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,te.getEnabledElement)(e),{viewport:o}=n;return _r(o,t)}getReferencedImageId(e,t,n,o){const i=this.getTargetId(e);let a;if(e instanceof te.StackViewport||e instanceof te.VideoViewport)a=i.split("imageId:")[1];else{const e=i.split("volumeId:")[1],o=te.cache.getVolume(e);a=te.utilities.getClosestImageId(o,t,n)}return a}getStyle(e,t,n){return Sr(e,t,yr(n),this.mode)}}Pr.toolName="AnnotationDisplayTool";const Mr=Pr;class xr extends Mr{constructor(e,t){super(e,t),this.mouseMoveCallback=(e,t)=>{if(!t)return!1;const{element:n,currentPoints:o}=e.detail,i=o.canvas;let a=!1;for(const e of t){if(pe(e)||!Ue(e.annotationUID))continue;const{data:t}=e,o=t.handles?t.handles.activeHandleIndex:void 0,r=this._imagePointNearToolOrHandle(n,e,i,6),s=r&&!e.highlighted,l=!r&&e.highlighted;s||l?(e.highlighted=!e.highlighted,a=!0):t.handles&&t.handles.activeHandleIndex!==o&&(a=!0)}return a},e.configuration?.getTextLines&&(this.configuration.getTextLines=e.configuration.getTextLines),e.configuration?.statsCalculator&&(this.configuration.statsCalculator=e.configuration.statsCalculator)}getHandleNearImagePoint(e,t,n,o){const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s,textBox:l}=r.handles;if(l){const{worldBoundingBox:e}=l;if(e){const t={topLeft:a.worldToCanvas(e.topLeft),topRight:a.worldToCanvas(e.topRight),bottomLeft:a.worldToCanvas(e.bottomLeft),bottomRight:a.worldToCanvas(e.bottomRight)};if(n[0]>=t.topLeft[0]&&n[0]<=t.bottomRight[0]&&n[1]>=t.topLeft[1]&&n[1]<=t.bottomRight[1])return r.handles.activeHandleIndex=null,l}}for(let e=0;e<s.length;e++){const t=s[e],i=a.worldToCanvas(t);if(!0===$a.K4.distance(n,i)<o)return r.handles.activeHandleIndex=e,t}r.handles.activeHandleIndex=null}getLinkedTextBoxStyle(e,t){return{visibility:this.getStyle("textBoxVisibility",e,t),fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}isSuvScaled(e,t,n){if(e instanceof te.BaseVolumeViewport){const e=t.split("volumeId:")[1],n=te.cache.getVolume(e);return void 0!==n.scaling?.PT}if(e instanceof te.StackViewport){const e=n&&te.metaData.get("scalingModule",n);return"number"==typeof e?.suvbw}throw new Error("Viewport is not a valid type")}_imagePointNearToolOrHandle(e,t,n,o){if(this.getHandleNearImagePoint(e,t,n,o))return!0;return!!this.isPointNearTool(e,t,n,o,"mouse")||void 0}}xr.toolName="AnnotationTool";const Rr=xr;class Nr extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{}}),this.renderSegmentation=e=>{const t=dv(e);if(!t)return;const n=no(e);if(!n||0===n.length)return;const o=t.viewportsInfo.map((e=>{let{renderingEngineId:t,viewportId:n}=e;const o=(0,te.getEnabledElementByIds)(n,t);if(o)return o.viewport})),i=n.map((t=>{const n=this._getMergedRepresentationsConfig(e),i=[],a={[le.Labelmap]:Uo,[le.Contour]:ai,[le.Surface]:Da}[t.type];for(const e of o){const o=a.render(e,t,n);i.push(o)}return i}));Promise.allSettled(i).then((()=>{o.forEach((e=>{e.render()}))}))}}onSetToolEnabled(){const e=this.toolGroupId,t=no(e);t&&0!==t.length&&t.forEach((t=>{ka(e,t.segmentationRepresentationUID,!0)}))}onSetToolDisabled(){const e=this.toolGroupId,t=no(e);t&&0!==t.length&&t.forEach((t=>{ka(e,t.segmentationRepresentationUID,!1)}))}_getMergedRepresentationsConfig(e){const t=Do(e),n=Co();return te.utilities.deepMerge(n,t)}}Nr.toolName="SegmentationDisplay";const Ar=Nr;const Lr=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedToolGroups=()=>{this._throwIfDestroyed();const e=Array.from(this._needsRender.values());for(const t of e)if(this._triggerRender(t),this._needsRender.delete(t),0===this._needsRender.size)return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}}removeToolGroup(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}renderToolGroupSegmentations(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setToolGroupSegmentationToBeRenderedNextFrame(e){e.forEach((e=>{this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}_triggerRender(e){const t=dv(e);if(!t)return void console.warn(`No tool group found with toolGroupId: ${e}`);const{viewportsInfo:n}=t,o=[];n.forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;const i=(0,te.getRenderingEngine)(n);i?o.push(i.getViewport(t)):console.warn("rendering Engine has been destroyed")}));const i=t.getToolInstance(Ar.toolName);function a(e){const{element:t,viewportId:n,renderingEngineId:o}=e.detail;t.removeEventListener(te.Enums.Events.IMAGE_RENDERED,a);const i=Vp(n,o);if(!i)return void console.warn("toolGroup has been destroyed");const r={toolGroupId:i.id,viewportId:n};(0,te.triggerEvent)(te.eventTarget,re.SEGMENTATION_RENDERED,{...r})}i?(o.forEach((e=>{let{element:t}=e;t.addEventListener(te.Enums.Events.IMAGE_RENDERED,a)})),i.renderSegmentation(e)):console.warn("No segmentation tool found inside",e)}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}};function kr(e){Lr.renderToolGroupSegmentations(e)}const Ur=kr,Vr=function(e){const{toolGroupId:t}=e.detail;Ur(t)},Br=function(e){const{segmentationId:t,modifiedSlicesToUse:n}=e.detail,{representationData:o,type:i}=Qn(t);let a;if(i!==le.Labelmap)throw new Error(`onSegmentationDataModified: representationType ${i} not supported yet`);{const e=te.cache.getVolume(o[i].volumeId);if(!e)return void console.warn("segmentation not found in cache");const{imageData:r,vtkOpenGLTexture:s}=e;let l;if(n&&Array.isArray(n))l=n;else{const e=r.getDimensions()[2];l=[...Array(e).keys()]}l.forEach((e=>{s.setUpdatedFrame(e)})),r.modified(),a=io(t)}a.forEach((e=>{Ur(e)}))},Fr=function(e){const{toolGroupId:t,segmentationRepresentationUID:n}=e.detail;Ur(t)},Hr=function(e){const{segmentationId:t}=e.detail;io(t).forEach((e=>{no(e).forEach((n=>{n.segmentationId===t&&jn(e,n.segmentationRepresentationUID)}))}))};function Wr(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5;const o=(0,te.getEnabledElement)(e);if(!o)throw new Error("getAnnotationNearPoint: enabledElement not found");return Gr(o,t,n)}function Gr(e,t,n){const{renderingEngineId:o,viewportId:i}=e,a=Vp(i,o);if(!a)return null;const{_toolInstances:r}=a;for(const o in r){const i=$r(r[o],e,t,n);if(i)return i}return null}function $r(e,t,n,o){const{viewport:i}=t,a=vv(e.constructor.toolName,i?.element),r=i?.getCurrentImageId?.();if(a?.length){const{element:i}=t.viewport;for(const t of a){const a=t.metadata?.referencedImageId;if(!(r&&a&&r!==a||!e.isPointNearTool)&&(e.isPointNearTool(i,t,n,o,"")||e.getHandleNearImagePoint(i,t,n,o)))return t}}return null}const zr=function(e){const t=typeof e;return null!==e&&("object"===t||"function"===t)};const Kr=function(e,t,n){let o,i,a,r,s,l,d=0,c=!1,u=!1,h=!0;const g=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function m(t){const n=o,a=i;return o=i=void 0,d=t,r=e.apply(a,n),r}function f(e,t){return g?window.requestAnimationFrame(e):setTimeout(e,t)}function p(e){const n=e-l;return void 0===l||n>=t||n<0||u&&e-d>=a}function v(){const e=Date.now();if(p(e))return E(e);s=f(v,function(e){const n=e-d,o=t-(e-l);return u?Math.min(o,a-n):o}(e))}function E(e){return s=void 0,h&&o?m(e):(o=i=void 0,r)}function w(){const e=Date.now(),n=p(e);for(var a=arguments.length,h=new Array(a),g=0;g<a;g++)h[g]=arguments[g];if(o=h,i=this,l=e,n){if(void 0===s)return function(e){return d=e,s=f(v,t),c?m(e):r}(l);if(u)return s=f(v,t),m(l)}return void 0===s&&(s=f(v,t)),r}return t=Number(t)||0,zr(n)&&(c=Boolean(n.leading),u="maxWait"in n,a=u?Math.max(Number(n.maxWait)||0,t):a,h="trailing"in n?Boolean(n.trailing):h),w.cancel=function(){void 0!==s&&function(e){if(g)return window.cancelAnimationFrame(e);clearTimeout(e)}(s),d=0,o=l=i=s=void 0},w.flush=function(){return void 0===s?r:E(Date.now())},w.pending=function(){return void 0!==s},w};const qr=function(e,t,n){let o=!0,i=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return zr(n)&&(o="leading"in n?Boolean(n.leading):o,i="trailing"in n?Boolean(n.trailing):i),Kr(e,t,{leading:o,trailing:i,maxWait:t})};function jr(e,t,n){return Math.min(Math.max(t,e),n)}const Zr=jr,{calibratedPixelSpacingMetadataProvider:Yr}=te.utilities;function Xr(e,t,n){"number"==typeof n&&(n={type:te.Enums.CalibrationTypes.USER,scale:n}),Yr.add(e,n);t.getStackViewports().forEach((t=>{t.getImageIds().includes(e)&&t.calibrateSpacing(e)}))}const Jr=function(e,t){t.length&&t.forEach((t=>{const{element:n}=e.getViewport(t);Ir(n)}))};function Qr(e,t){if(!(0,te.getEnabledElement)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof te.StackViewport&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");const{type:n}=e,{volumeId:o,delta:i,scrollSlabs:a}=t;if(e instanceof te.StackViewport)e.scroll(i,t.debounceLoading,t.loop);else if(e instanceof te.VolumeViewport)!function(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const i=o,{numScrollSteps:a,currentStepIndex:r,sliceRangeInfo:s}=te.utilities.getVolumeViewportScrollInfo(e,t,i);if(!s)return;const{sliceRange:l,spacingInNormalDirection:d,camera:c}=s,{focalPoint:u,viewPlaneNormal:h,position:g}=c,{newFocalPoint:m,newPosition:f}=te.utilities.snapFocalPointToSlice(u,g,l,h,d,n);e.setCamera({focalPoint:m,position:f}),e.render();const p=r+n;if((p>a||p<0)&&e.getCurrentImageId()){const o={volumeId:t,viewport:e,delta:n,desiredStepIndex:p,currentStepIndex:r,numScrollSteps:a,currentImageId:e.getCurrentImageId()};te.utilities.triggerEvent(te.eventTarget,te.EVENTS.VOLUME_SCROLL_OUT_OF_BOUNDS,o)}}(e,o,i,a);else{if(!(e instanceof te.VideoViewport))throw new Error(`Not implemented for Viewport Type: ${n}`);e.scroll(i)}}const es=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{imageIndex:n,debounceLoading:o,volumeId:i}=t,a=(0,te.getEnabledElement)(e);if(!a)throw new Error("Element has been disabled");const{viewport:r}=a,{imageIndex:s,numberOfSlices:l}=function(e,t){if(e instanceof te.StackViewport)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};if(e instanceof te.VolumeViewport)return te.utilities.getImageSliceDataForVolumeViewport(e);throw new Error("Unsupported viewport type")}(r,o),d=function(e,t){const n=e-1;return Zr(t,0,n)}(l,n);Qr(r,{delta:d-s,debounceLoading:o,volumeId:i})};function ts(e,t,n,o){let i,a,r,s,l,d,c;c=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData();const u=e.getDimensions();o?[[i,a],[r,s],[l,d]]=o:(i=0,a=u[0],r=0,s=u[1],l=0,d=u[2]);const h=$a.R3.fromValues(i,r,l),g=e.getDirection(),m=g.slice(0,3),f=g.slice(3,6),p=g.slice(6,9),v=e.getSpacing(),[E,w,I]=v,C=e.indexToWorld(h),T=$a.R3.fromValues(m[0]*E,m[1]*E,m[2]*E),b=$a.R3.fromValues(f[0]*w,f[1]*w,f[2]*w),_=$a.R3.fromValues(p[0]*I,p[1]*I,p[2]*I),D=u[0],S=u[0]*u[1],y=[];for(let e=l;e<=d;e++)for(let o=r;o<=s;o++)for(let s=i;s<=a;s++){const a=[s,o,e],d=s-i,u=o-r,h=e-l,g=C,m=[g[0]+d*T[0]+u*b[0]+h*_[0],g[1]+d*T[1]+u*b[1]+h*_[1],g[2]+d*T[2]+u*b[2]+h*_[2]];if(t(m,a)){const t=e*S+o*D+s,i=c[t];y.push({value:i,index:t,pointIJK:a,pointLPS:m}),null!==n&&n({value:i,index:t,pointIJK:a,pointLPS:m})}}return y}const ns=function(e,t){const n=e.findIndex((e=>{let[t,n]=e;return t===n}));if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e};const os=function(e,t){let n=1/0,o=0,i=1/0,a=0,r=1/0,s=0;if(e.forEach((e=>{n=Math.min(e[0],n),o=Math.max(e[0],o),i=Math.min(e[1],i),a=Math.max(e[1],a),r=Math.min(e[2],r),s=Math.max(e[2],s)})),n=Math.floor(n),o=Math.floor(o),i=Math.floor(i),a=Math.floor(a),r=Math.floor(r),s=Math.floor(s),t){const[e,l,d]=t;n=Math.max(0,n),o=Math.min(e-1,o),i=Math.max(0,i),a=Math.min(l-1,a),r=Math.max(0,r),s=Math.min(d-1,s)}return[[n,o],[i,a],[r,s]]},{transformWorldToIndex:is}=te.utilities;function as(e,t,n,o){const{boundsIJK:i,centerWorld:a,radiusWorld:r}=function(e,t,n){const[o,i]=e,a=$a.R3.fromValues((o[0]+i[0])/2,(o[1]+i[1])/2,(o[2]+i[2])/2),r=$a.R3.distance(o,i)/2;let s;if(!n){const e=is(t,a),n=t.getSpacing(),o=Math.min(...n),i=Math.ceil(r/o);return s=[[e[0]-i,e[0]+i],[e[1]-i,e[1]+i],[e[2]-i,e[2]+i]],{boundsIJK:s,centerWorld:a,radiusWorld:r}}return s=function(e,t,n,o,i){const[a,r]=n,s=e.getDimensions(),l=t.getCamera(),d=$a.R3.fromValues(l.viewUp[0],l.viewUp[1],l.viewUp[2]),c=$a.R3.fromValues(l.viewPlaneNormal[0],l.viewPlaneNormal[1],l.viewPlaneNormal[2]),u=$a.R3.create();$a.R3.cross(u,d,c);const h=$a.R3.create(),g=$a.R3.create();$a.R3.scaleAndAdd(h,r,c,i),$a.R3.scaleAndAdd(g,a,c,-i),$a.R3.scaleAndAdd(h,h,u,-i),$a.R3.scaleAndAdd(g,g,u,i);const m=[is(e,h),is(e,g)],f=os(m,s);return f}(t,n,e,0,r),{boundsIJK:s,centerWorld:a,radiusWorld:r}}(t,e,o),s={center:a,radius:r};ts(e,(e=>function(e,t){const{center:n,radius:o}=e;return(t[0]-n[0])**2+(t[1]-n[1])**2+(t[2]-n[2])**2<=o**2}(s,e)),n,i)}const rs=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(null==e||""===e)return"NaN";if((e=Number(e))<1e-4)return`${e}`;const n=e>=100?t-2:e>=10?t-1:e>=1?t:e>=.1?t+1:e>=.01?t+2:e>=.001?t+3:t+4;return e.toFixed(n)};const ss=function(e,t,n){const{THRESHOLD_INSIDE_CIRCLE:o}=n,i=t.getScalarData()[e],{threshold:a}=o;return a[0]<=i&&i<=a[1]};function ls(e,t){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{viewport:o}=e,{volume:i,segmentsLocked:a,segmentIndex:r,imageVolume:s,strategySpecificConfiguration:l,segmentationId:d,points:c}=t,{imageData:u,dimensions:h}=i,g=i.getScalarData(),m=[];let f;f=n?e=>{let{value:t,index:n,pointIJK:o}=e;a.includes(t)||ss(n,s,l)&&(g[n]=r,m.push(n))}:e=>{let{index:t,value:n}=e;a.includes(n)||(g[t]=r,m.push(t))},as(u,[c[0],c[1]],f,o);const p=h[0]*h[1],v=Math.floor(m[0]/p),E=Math.floor(m[m.length-1]/p);Yn(d,Array.from({length:E-v+1},((e,t)=>t+v)))}function ds(e,t){ls(e,t,!0)}function cs(e,t){const{volume:n,imageVolume:o}=t;if(!te.utilities.isEqual(n.dimensions,o.dimensions)||!te.utilities.isEqual(n.direction,o.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");ls(e,t,!0,!0)}function us(e,t){ds(e,Object.assign({},t,{segmentIndex:0}))}function hs(e,t){const{center:n,xRadius:o,yRadius:i,zRadius:a}=e,[r,s,l]=t,[d,c,u]=n;let h=0;return 0!==o&&(h+=(r-d)*(r-d)/(o*o)),0!==i&&(h+=(s-c)*(s-c)/(i*i)),0!==a&&(h+=(l-u)*(l-u)/(a*a)),h<=1}function gs(e){const[t,n,o,i]=e;return[[o[0],n[1]],[i[0],t[1]]]}const{transformWorldToIndex:ms}=te.utilities;function fs(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{volume:o,imageVolume:i,points:a,segmentsLocked:r,segmentIndex:s,segmentationId:l,strategySpecificConfiguration:d}=t,{imageData:c,dimensions:u}=o,h=o.getScalarData(),{viewport:g}=e,m=$a.R3.fromValues(0,0,0);a.forEach((e=>{$a.R3.add(m,m,e)})),$a.R3.scale(m,m,1/a.length);const f=a.map((e=>g.worldToCanvas(e))),[p,v]=gs(f),E=g.canvasToWorld(p),w=g.canvasToWorld(v),I=[ms(c,E),ms(c,w)],C=os(I,u),T={center:m,xRadius:Math.abs(E[0]-w[0])/2,yRadius:Math.abs(E[1]-w[1])/2,zRadius:Math.abs(E[2]-w[2])/2},b=new Set;let _;_=n?e=>{let{value:t,index:n,pointIJK:o}=e;r.includes(t)||ss(n,i,d)&&(h[n]=s,b.add(o[2]))}:e=>{let{value:t,index:n,pointIJK:o}=e;r.includes(t)||(h[n]=s,b.add(o[2]))},ts(c,((e,t)=>hs(T,e)),_,C);Yn(l,Array.from(b))}function ps(e,t){fs(e,t,!1)}function vs(e,t){const{volume:n,imageVolume:o}=t;if(!te.utilities.isEqual(n.dimensions,o.dimensions)||!te.utilities.isEqual(n.direction,o.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");fs(e,t,!0)}function Es(e,t){ps(e,{...t,segmentIndex:0})}const ws=Symbol("DefinedCursors"),Is=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class Cs{constructor(e,t){this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){const{fallback:t}=this;return t instanceof Cs?`${e}, ${t.getStyleProperty()}`:e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){const t=Ts(Cs,ws);let n=t.get(e);return n instanceof Cs?n:Is.has(e)?(n=new Cs(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){if(t instanceof Cs){return Ts(Cs,ws).set(e,t),!0}return!1}}function Ts(e,t){let n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}const bs=Is.values();class _s extends Cs{constructor(e,t,n,o,i){super(o||_s.getUniqueInstanceName("image-cursor"),i),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}getStyleProperty(){const{url:e,x:t,y:n}=this;let o=`url('${e}')`;return t>=0&&n>=0&&(t>0||n>0)&&(o+=` ${t} ${n}`),this.addFallbackStyleProperty(o)}static getUniqueInstanceName(e){return`${e}-${te.utilities.getRuntimeId(_s)}`}}const Ds={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},Ss={x:127,y:60},ys='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',Os='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',Ps='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',Ms='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',xs='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',Rs={Angle:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:Ns(Ds,{iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:Ns(Ds,{iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:Ns(Ds,{iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:Ns(Ds,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:Ns(Ds,{iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:Ns(Ds,{iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:Ns(Ds,{iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:Ns(Ds,{iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Probe:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:Ns(Ds,{iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:Ns(Ds,{iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:Ns(Ds,{iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:Ns(Ds,{iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:Ns(Ds,{iconContent:`${Ps} ${ys}`,viewBox:Ss}),SegmentationFreeHandFillInside:Ns(Ds,{iconContent:`${Ps} ${Os}`,viewBox:Ss}),SegmentationFreeHandEraseOutside:Ns(Ds,{iconContent:`${Ps} ${ys}`,viewBox:Ss}),SegmentationFreeHandFillOutside:Ns(Ds,{iconContent:`${Ps} ${Os}`,viewBox:Ss}),SegmentationRectangleEraseInside:Ns(Ds,{iconContent:`${Ms} ${ys}`,viewBox:Ss}),RectangleScissor:Ns(Ds,{iconContent:`${Ms} ${Os}`,viewBox:Ss}),"RectangleScissor.FILL_INSIDE":Ns(Ds,{iconContent:`${Ms} ${Os}`,viewBox:Ss}),"RectangleScissor.FILL_OUTSIDE":Ns(Ds,{iconContent:`${Ms} ${Os}`,viewBox:Ss}),"RectangleScissor.ERASE_OUTSIDE":Ns(Ds,{iconContent:`${Ms} ${ys}`,viewBox:Ss}),"RectangleScissor.ERASE_INSIDE":Ns(Ds,{iconContent:`${Ms} ${ys}`,viewBox:Ss}),CircleScissor:Ns(Ds,{iconContent:`${xs} ${Os}`,viewBox:Ss}),"CircleScissor.FILL_INSIDE":Ns(Ds,{iconContent:`${xs} ${Os}`,viewBox:Ss}),"CircleScissor.ERASE_OUTSIDE":Ns(Ds,{iconContent:`${xs} ${ys}`,viewBox:Ss}),"CircleScissor.FILL_OUTSIDE":Ns(Ds,{iconContent:`${xs} ${Os}`,viewBox:Ss})};function Ns(e,t){return Object.assign(Object.create(e),t)}function As(e,t,n){Rs[e]=Ns(Ds,{iconContent:t,viewBox:n})}const Ls=Object.keys(Rs),ks=ie.Highlighted,Us=ne.Active;class Vs extends _s{constructor(e,t,n,o,i){super(e,t,n,o,i)}static getDefinedCursor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;n||(n=Sr("color",{},ks,Us));const o=function(e,t,n){const o=t?"pointer":"cursor";return`${o}:${e}/${n}`}(e,t,n);let i=super.getDefinedCursor(o);if(!i){const a=function(e){return Rs[e]}(e);a&&(i=function(e,t,n,o,i){const{x:a,y:r}=e.mousePoint;return new Vs(function(e,t,n){return URL.createObjectURL(function(e,t,n){const o=(t?Hs:Fs)(e,n);return new Blob([o],{type:"image/svg+xml"})}(e,t,n))}(e,n,{color:o}),a,r,t,i)}(a,o,t,n,super.getDefinedCursor("default")),super.setDefinedCursor(o,i))}return i}}function Bs(e,t){const n=Object(t),o=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,((e,t)=>o(t)?n[t]+"":""))}function Fs(e,t){const{iconContent:n,iconSize:o,viewBox:i}=e;return Bs(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${o}" height="${o}" viewBox="0 0\n      ${i.x} ${i.y}">\n      ${n}\n    </svg>`,t)}function Hs(e,t){const{iconContent:n,iconSize:o,viewBox:i,mousePointerGroupString:a}=e,r=16+o;return Bs(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${r}" height="${r}" viewBox="0 0 ${r} ${r}">\n      <g>${a}</g>\n      <g transform="translate(16, 16) scale(${o/Math.max(i.x,i.y,1)})">${n}</g>\n    </svg>`,t)}const Ws=function(e,t){let n=Vs.getDefinedCursor(t,!0);n||(n=Cs.getDefinedCursor(t)),n||(console.log(`Cursor ${t} is not defined either as SVG or as a standard cursor.`),n=Cs.getDefinedCursor(t)),Ks(e,n)},Gs=[...Ls,...bs],$s=Symbol("ElementCursorsMap");function zs(e,t){Zs(e)[0]=t,Ks(e,t)}function Ks(e,t){const n=Zs(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof Cs?t:Cs.getDefinedCursor("auto")).getStyleProperty()}function qs(e){Ks(e,Zs(e)[1])}function js(e){Ks(e,Cs.getDefinedCursor("none"))}function Zs(e){let t=Zs[$s];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(Zs,$s,{value:t}));let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}class Ys extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:ps,ERASE_INSIDE_CIRCLE:Es,FILL_INSIDE_SPHERE:ds,ERASE_INSIDE_SPHERE:us,THRESHOLD_INSIDE_CIRCLE:vs,THRESHOLD_INSIDE_SPHERE:cs},strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25}}),this.onSetToolPassive=()=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=()=>{this.disableCursor()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{viewport:i,renderingEngine:a}=o;if(i instanceof te.StackViewport)throw new Error("Not implemented yet");const r=ya(this.toolGroupId);if(!r)throw new Error("No active segmentation detected, create one before using the brush tool");const{segmentationId:s,type:l}=r,d=xa(s),{representationData:c}=Qn(s),{volumeId:u}=c[l],h=te.cache.getVolume(u),g=i.getActors()[0].uid,m=te.cache.getVolume(g),f=[i.id];return this._editData={segmentation:h,imageVolume:m,segmentsLocked:d},this._activateDraw(n),js(n),e.preventDefault(),Jr(a,f),!0},this.mouseMoveCallback=e=>{this.mode===ne.Active&&this.updateCursor(e)},this._dragCallback=e=>{const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{renderingEngine:i}=o,{imageVolume:a,segmentation:r,segmentsLocked:s}=this._editData;this.updateCursor(e);const{segmentIndex:l,segmentationId:d,segmentationRepresentationUID:c,brushCursor:u,viewportIdsToRender:h}=this._hoverData,{data:g}=u,{viewPlaneNormal:m,viewUp:f}=u.metadata;Jr(i,h);const p={points:g.handles.points,volume:r,imageVolume:a,segmentIndex:l,segmentsLocked:s,viewPlaneNormal:m,toolGroupId:this.toolGroupId,segmentationId:d,segmentationRepresentationUID:c,viewUp:f,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration};this.applyActiveStrategy(o,p)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{imageVolume:o,segmentation:i,segmentsLocked:a}=this._editData,{segmentIndex:r,segmentationId:s,segmentationRepresentationUID:l,brushCursor:d}=this._hoverData,{data:c}=d,{viewPlaneNormal:u,viewUp:h}=d.metadata;this._deactivateDraw(n),qs(n);const g=(0,te.getEnabledElement)(n),{viewport:m}=g;if(this._editData=null,this.updateCursor(e),m instanceof te.StackViewport)throw new Error("Not implemented yet");const f={points:c.handles.points,volume:i,imageVolume:o,segmentIndex:r,segmentsLocked:a,viewPlaneNormal:u,toolGroupId:this.toolGroupId,segmentationId:s,segmentationRepresentationUID:l,viewUp:h,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration};this.applyActiveStrategy(g,f)},this._activateDraw=e=>{e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,te.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.toolGroupId,h=ya(u);if(!h)return void console.warn("No active segmentation detected, create one before using the brush tool");const{segmentationRepresentationUID:g,segmentationId:m}=h,f=Ha(m),p=Aa(u,g,f),v=[s.id],E={metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:p},data:{}};this._hoverData={brushCursor:E,centerCanvas:i,segmentIndex:f,segmentationId:m,segmentationRepresentationUID:g,segmentColor:p,viewportIdsToRender:v},this._calculateCursor(n,i),Jr(r,v)}_calculateCursor(e,t){const n=(0,te.getEnabledElement)(e),{viewport:o}=n,{canvasToWorld:i}=o,a=o.getCamera(),{brushSize:r}=this.configuration,s=$a.R3.fromValues(a.viewUp[0],a.viewUp[1],a.viewUp[2]),l=$a.R3.fromValues(a.viewPlaneNormal[0],a.viewPlaneNormal[1],a.viewPlaneNormal[2]),d=$a.R3.create();$a.R3.cross(d,s,l);const c=i([t[0],t[1]]),u=$a.R3.create(),h=$a.R3.create(),g=$a.R3.create(),m=$a.R3.create();for(let e=0;e<=2;e++)u[e]=c[e]-s[e]*r,h[e]=c[e]+s[e]*r,g[e]=c[e]-d[e]*r,m[e]=c[e]+d[e]*r;const{brushCursor:f}=this._hoverData,{data:p}=f;void 0===p.handles&&(p.handles={}),p.handles.points=[u,h,g,m],p.invalidated=!1}invalidateBrushCursor(){if(void 0!==this._hoverData){const{data:e}=this._hoverData.brushCursor;e.invalidated=!0}}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const o=this._hoverData.brushCursor;if(!0===o.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const i=o.metadata,a=i.brushCursorUID,r=o.data,{points:s}=r.handles,l=s.map((e=>n.worldToCanvas(e))),d=l[0],c=l[1],u=[Math.floor((d[0]+c[0])/2),Math.floor((d[1]+c[1])/2)],h=Math.abs(d[1]-Math.floor((d[1]+c[1])/2)),g=`rgb(${i.segmentColor.slice(0,3)})`;if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");tr(t,a,"0",u,h,{color:g})}}Ys.toolName="Brush";const Xs=Ys;function Js(e,t){const n=dv(e);if(void 0===n)return;const o=n._toolInstances;if(!Object.keys(o).length)return;if(t&&o[t])return[o[t]];return Object.values(o).filter((e=>e instanceof Xs))}const Qs=(e,t)=>JSON.stringify(e)===JSON.stringify(t);function el(e,t,n,o){const i=[];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let a=0;a<2;a++){const r=[...o];r[0]=r[0]+(2*e-1)*n[0]/2,r[1]=r[1]+(2*t-1)*n[1]/2,r[2]=r[2]+(2*a-1)*n[2]/2,i.push(r)}const a=i.map((t=>te.utilities.transformWorldToIndex(e,t)));return os(a,t)}function tl(e,t){const{spacing:n}=e,o=e.getScalarData(),i=[];let a=0;for(let e=0;e<t.length;e++){const{imageData:r,spacing:s,dimensions:l}=t[e].volume,d=t[e].volume.getScalarData().length;d===o.length&&Qs(s,n)&&(a=e);const c=r.getPointData().getScalars().getData(),u=t[e].lower,h=t[e].upper;i.push({imageData:r,referenceValues:c,lower:u,upper:h,spacing:s,dimensions:l,volumeSize:d})}return{volumeInfoList:i,baseVolumeIdx:a}}const nl=function(e,t,n){const{imageData:o}=e,i=e.getScalarData(),{overwrite:a,boundsIJK:r}=n,s=n?.overlapType||0;if(a)for(let e=0;e<i.length;e++)i[e]=0;const{baseVolumeIdx:l,volumeInfoList:d}=tl(e,t);let c,u,h;const g=(e,t,n)=>{const{imageData:o,dimensions:i,lower:a,upper:r}=e,l=el(o,i,t,n);u=0,c=0,h={lower:a,upper:r};let d=!1;return ts(o,(()=>!0),(e=>{let{value:t}=e;u+=1,t>=h.lower&&t<=h.upper&&(c+=1)}),l),0===s?d=c>0:1==s&&(d=c===u),d},m=(e,t)=>{const{imageData:n,referenceValues:o,lower:i,upper:a}=e,r=o[n.computeOffsetIndex(t)];return!(r<=i||r>=a)};return ts(o,(()=>!0),(e=>{let{index:t,pointIJK:n,pointLPS:o}=e,a=d.length>0;for(let e=0;e<d.length&&(a=d[e].volumeSize===i.length?m(d[e],n):g(d[e],d[l].spacing,o),a);e++);a&&(i[t]=1)}),r),Yn(e.volumeId),e};class ol extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]})}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,te.getEnabledElement)(t),i=n.world,a=o.viewport.getCamera(),{focalPoint:r,position:s}=a,l=[s[0]-i[0],s[1]-i[1],s[2]-i[2]],d=[r[0]-i[0],r[1]-i[1],r[2]-i[2]];o.viewport.setCamera({focalPoint:d,position:l}),o.viewport.render()}}ol.toolName="Pan";const il=ol;var al=n(21894);class rl extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:4}}),this.rotateCamera=(e,t,n,o)=>{const i=e.getVtkActiveCamera(),a=i.getViewUp(),r=i.getFocalPoint(),s=i.getPosition(),l=[0,0,0],d=[0,0,0],c=[0,0,0],u=$a._E.identity(new Float32Array(16));$a._E.translate(u,u,t),$a._E.rotate(u,u,o,n),$a._E.translate(u,u,[-t[0],-t[1],-t[2]]),$a.R3.transformMat4(l,s,u),$a.R3.transformMat4(d,r,u),$a._E.identity(u),$a._E.rotate(u,u,o,n),$a.R3.transformMat4(c,a,u),e.setCamera({position:l,viewUp:c,focalPoint:d})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:o}=e.detail,i=n.canvas,a=o.canvas,{rotateIncrementDegrees:r}=this.configuration,s=(0,te.getEnabledElement)(t),{viewport:l}=s,d=l.getCamera(),c=t.clientWidth,u=t.clientHeight,h=[i[0]/c,i[1]/u],g=[a[0]/c,a[1]/u],m=[.5*c,.5*u],f=l.canvasToWorld(m),p=(1+Math.abs(.5))**2,v=[g[0],0,0],E=[h[0],0,0],w=v[0]**2,I=E[0]**2,C=w>p?0:Math.sqrt(p-w),T=I>p?0:Math.sqrt(p-I),b=[v[0],0,C];al.ZP.normalize(b);const _=[E[0],0,T];al.ZP.normalize(_);const D=al.ZP.dot(b,_);if(Math.abs(D)>1e-4){const e=-2*Math.acos(al.ZP.clampValue(D,-1,1))*Math.sign(h[0]-g[0])*r,t=d.viewUp,n=d.viewPlaneNormal,o=[0,0,0],i=[0,0,0];al.ZP.cross(t,n,o),al.ZP.normalize(o),al.ZP.cross(n,o,i),al.ZP.normalize(i),al.ZP.normalize(t),this.rotateCamera(l,f,i,e);const a=(g[1]-h[1])*r;this.rotateCamera(l,f,o,a),l.render()}}}rl.toolName="TrackballRotate";const sl=rl;class ll extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{defaultWindowLevelMultiplier:.125,defaultWindowRange:8192}}),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{const n=Math.floor(t[2]/2),o=t[0]*t[1];let i,a;e instanceof Float32Array?(i=4,a=Float32Array):e instanceof Uint8Array?(i=1,a=Uint8Array):e instanceof Uint16Array?(i=2,a=Uint16Array):e instanceof Int16Array&&(i=2,a=Int16Array);const r=new a(e.buffer,n*o*i,o),{max:s,min:l}=this._getMinMax(r,o);return s-l}}touchDragCallback(e){this.mouseDragCallback(e)}mouseUpCallback(e){this.touchEndCallback(e)}touchEndCallback(e){const{element:t}=e.detail,n=(0,te.getEnabledElement)(t),{viewport:o}=n;if(this.configuration?.onEndHook&&o instanceof te.VolumeViewport){const e=this.getTargetId(o).split("volumeId:")[1],n={element:t,viewportId:o.id,volumeId:e};this.configuration.onEndHook(n)}}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,te.getEnabledElement)(t),{renderingEngine:i,viewport:a}=o;let r,s,l,d,c,u,h=!1;if(a instanceof te.VolumeViewport||a instanceof te.VolumeViewport3D){r=this.getTargetId(a).split("volumeId:")[1],u=te.utilities.getViewportsWithVolumeId(r,i.id);const e=a.getProperties();({lower:s,upper:l}=e.voiRange);const t=te.cache.getVolume(r);d=t.metadata.Modality,h=t.scaling&&Object.keys(t.scaling).length>0}else{if(!(a instanceof te.StackViewport))throw new Error("Viewport is not a valid type");{const e=a.getProperties();d=a.modality,({lower:s,upper:l}=e.voiRange);const{preScale:t}=a.getImageData();h=t.scaled&&void 0!==t.scalingParameters?.suvbw}}return c="PT"===d?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:s,upper:l,clientHeight:t.clientHeight,isPreScaled:h,viewport:a,volumeId:r}):this.getNewRange({viewport:a,deltaPointsCanvas:n.canvas,volumeId:r,lower:s,upper:l}),a instanceof te.StackViewport?(a.setProperties({voiRange:c}),void a.render()):a instanceof te.VolumeViewport||a instanceof te.VolumeViewport3D?(a.setProperties({voiRange:c}),void u.forEach((e=>{e.render()}))):void 0}getPTScaledNewRange(e){let{deltaPointsCanvas:t,lower:n,upper:o,clientHeight:i,viewport:a,volumeId:r,isPreScaled:s}=e,l=this.configuration.defaultWindowLevelMultiplier;l=s?5/i:this._getMultiplierFromDynamicRange(a,r)||this.configuration.defaultWindowLevelMultiplier;return o-=t[1]*l,o=s?Math.max(o,.1):o,{lower:n,upper:o}}getNewRange(e){let{viewport:t,deltaPointsCanvas:n,volumeId:o,lower:i,upper:a}=e;const r=this._getMultiplierFromDynamicRange(t,o)||this.configuration.defaultWindowLevelMultiplier,s=n[0]*r,l=n[1]*r;let{windowWidth:d,windowCenter:c}=te.utilities.windowLevel.toWindowLevel(i,a);return d+=s,c+=l,d=Math.max(d,1),te.utilities.windowLevel.toLowHighRange(d,c)}_getMultiplierFromDynamicRange(e,t){let n;if(t){const e=te.cache.getVolume(t),{dimensions:o}=e,i=e.getScalarData(),a=this._getImageDynamicRangeFromMiddleSlice(i,o),r=e?.metadata?.BitsStored,s=r?2**r:1/0;n=Math.min(a,s)}else n=this._getImageDynamicRangeFromViewport(e);const o=n/this.configuration.defaultWindowRange;let i=this.configuration.defaultWindowLevelMultiplier;return o>1&&(i=Math.round(o)),i}_getImageDynamicRangeFromViewport(e){const{imageData:t}=e.getImageData(),n=t.getDimensions();let o,i;if(o=t.getScalarData?t.getScalarData():t.getPointData().getScalars(),1!==n[2])return this._getImageDynamicRangeFromMiddleSlice(o,n);if(o.getRange)i=o.getRange();else{const{min:e,max:t}=this._getMinMax(o,o.length);i=[e,t]}return i[1]-i[0]}_getMinMax(e,t){let n=1/0,o=-1/0;for(let i=0;i<t;i++){const t=e[i];t<n&&(n=t),t>o&&(o=t)}return{max:o,min:n}}}ll.toolName="WindowLevel";const dl=ll;class cl extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,leftRightMode:!1,debounceIfNotLoaded:!0,loop:!1,stackScrollEnabled:!0,mipMode:{enabled:!0,invert:!1,pixelsPerThickness:40,minSlabThickness:.05,maxSlabThickness:30}}}),this.deltaY=1,this.deltaX=1}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{deltaPoints:t,viewportId:n,renderingEngineId:o}=e.detail,{viewport:i}=(0,te.getEnabledElementByIds)(n,o),a=this.getTargetId(i),{debounceIfNotLoaded:r,invert:s,loop:l,leftRightMode:d,stackScrollEnabled:c}=this.configuration,u=t.canvas[1],h=t.canvas[0];let g;i instanceof te.VolumeViewport&&(g=a.split("volumeId:")[1]);const m=this._getPixelPerImage(i),f=u+this.deltaY,p=h+this.deltaX;if(!m)return;if(c&&!d)if(Math.abs(f)>=m){const e=Math.round(f/m);Qr(i,{delta:s?-e:e,volumeId:g,debounceLoading:r,loop:l}),this.deltaY=f%m}else this.deltaY=f;if(c&&d)if(Math.abs(p)>=m){const e=Math.round(p/m);Qr(i,{delta:s?-e:e,volumeId:g,debounceLoading:r,loop:l}),this.deltaX=p%m}else this.deltaX=p;const{mipMode:v}=this.configuration;if(!v?.enabled)return;const{pixelsPerThickness:E,mipModeInvert:w}=v;v?.enabled&&d&&(Math.abs(f)>=E?(this._triggerMIP(i,f>0?-1:1,w),this.deltaY=f%E):this.deltaY=f),v?.enabled&&!d&&(Math.abs(p)>=E?(this._triggerMIP(i,p>0?1:-1,w),this.deltaX=p%E):this.deltaX=p)}_getPixelPerImage(e){const{element:t}=e,n=this._getNumberOfSlices(e);return Math.max(2,t.offsetHeight/Math.max(n,8))}_getNumberOfSlices(e){if(e instanceof te.VolumeViewport){const{numberOfSlices:t}=te.utilities.getImageSliceDataForVolumeViewport(e);return t}if(e instanceof te.StackViewport)return e.getImageIds().length}_triggerMIP(e,t,n){const o=n?-1:1,{minSlabThickness:i,maxSlabThickness:a}=this.configuration.mipMode;if(e instanceof te.VolumeViewport){const n=Math.min(a,e.getSlabThickness()+o*t);n<=i?(e.setBlendMode(0),e.setSlabThickness(i),e.render()):(e.setBlendMode(1),e.setSlabThickness(n>=a?a:n),e.render())}}}cl.toolName="StackScroll";const ul=cl;function hl(e,t){return 3===e[0].length?function(e,t){const[n,o]=e,[i,a]=t,r=$a.R3.sub($a.R3.create(),o,n),s=$a.R3.sub($a.R3.create(),i,a),l=$a.R3.dot(r,s)/($a.R3.length(r)*$a.R3.length(s));return 180*Math.acos(l)/Math.PI}(e,t):function(e,t){const[n,o]=e,[i,a]=t,r=$a.K4.sub($a.K4.create(),o,n),s=$a.K4.sub($a.K4.create(),i,a),l=$a.K4.dot(r,s)/($a.K4.length(r)*$a.K4.length(s));return Math.acos(l)*(180/Math.PI)}(e,t)}class gl extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]}),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:o}=e.detail,i=n.world,a=o.world,r=(0,te.getEnabledElement)(t),{viewport:s}=r,l=s.getCamera(),d=[.5*t.clientWidth,.5*t.clientHeight],c=s.canvasToWorld(d);let u=hl([a,c],[c,i]);const{viewPlaneNormal:h,viewUp:g}=l,m=$a.R3.sub($a.R3.create(),c,a),f=$a.R3.sub($a.R3.create(),c,i),p=$a.R3.cross($a.R3.create(),m,f);if($a.R3.dot(h,p)>0&&(u=-u),!Number.isNaN(u)){if(s instanceof te.BaseVolumeViewport){const e=u*Math.PI/180,t=$a._E.identity(new Float32Array(16));$a._E.rotate(t,t,e,h);const n=$a.R3.transformMat4($a.R3.create(),g,t);s.setCamera({viewUp:n})}else{const{rotation:e}=s.getProperties();s.setProperties({rotation:e+u})}s.render()}}}gl.toolName="PlanarRotate";const ml=gl;class fl extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1,scrollSlabs:!1}})}mouseWheelCallback(e){const{wheel:t,element:n}=e.detail,{direction:o}=t,{invert:i}=this.configuration,{viewport:a}=(0,te.getEnabledElement)(n),r=o*(i?-1:1),s=this.getTargetId(a).split("volumeId:")[1];Qr(a,{delta:r,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:s,scrollSlabs:this.configuration.scrollSlabs})}}fl.toolName="StackScrollMouseWheel";const pl=fl;class vl extends Ga{constructor(){var e;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,zoomFactor:2,invert:!1,reverseDeltaY:!1}}),e=this,this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,i=o.world,a=(0,te.getEnabledElement)(n).viewport.getCamera(),{focalPoint:r}=a;this.initialMousePosWorld=i;let s=$a.R3.fromValues(r[0]-i[0],r[1]-i[1],r[2]-i[2]);return s=$a.R3.normalize($a.R3.create(),s),this.dirVec=s,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=function(t,n,o){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{element:a,deltaPoints:r}=t.detail;let s=i?t.detail.deltaDistance.canvas:r.canvas[1];e.configuration.reverseDeltaY&&(s=-s);const l=[a.clientWidth,a.clientHeight],{parallelScale:d,focalPoint:c,position:u}=o;let h=(1-s*(e.configuration.zoomFactor/l[1])*(e.configuration.invert?-1:1))*d,g=c,m=u;if(!e.configuration.zoomToCenter){const t=$a.R3.distance(c,e.initialMousePosWorld),n=s*(e.configuration.zoomFactor/l[1])*(e.configuration.invert?-1:1);h=(1-n)*d,m=$a.R3.scaleAndAdd($a.R3.create(),u,e.dirVec,-t*n),g=$a.R3.scaleAndAdd($a.R3.create(),c,e.dirVec,-t*n)}const f=n.getImageData();let p=[1,1,1];f&&(p=f.spacing);const{minZoomScale:v,maxZoomScale:E}=e.configuration,w=a.clientHeight*p[1]*.5,I=w/h;let C=h,T=!1;f&&(I<v?(C=w/v,T=!0):I>=E&&(C=w/E,T=!0)),n.setCamera({parallelScale:C,focalPoint:T?c:g,position:T?u:m}),e.configuration?.onZoomChange&&e.configuration?.onZoomChange(n.id)},this._dragPerspectiveProjection=function(t,n,o){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{element:a,deltaPoints:r}=t.detail;let s=i?t.detail.deltaDistance.canvas:r.canvas[1];e.configuration.reverseDeltaY&&(s=-s);const l=[a.clientWidth,a.clientHeight],{position:d,focalPoint:c,viewPlaneNormal:u}=o,h=al.ZP.distance2BetweenPoints(d,c),g=Math.sqrt(h)/l[1],m=[-u[0],-u[1],-u[2]],f=e.configuration.invert?s/g:s*g;let p=f*m[0];d[0]+=p,c[0]+=p,p=f*m[1],d[1]+=p,c[1]+=p,p=f*m[2],d[2]+=p,c[2]+=p,n.setCamera({position:d,focalPoint:c})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,o=(0,te.getEnabledElement)(t),{viewport:i}=o,a=i.getCamera(),r=n.world,{focalPoint:s}=a;this.initialMousePosWorld=r;let l=$a.R3.fromValues(s[0]-r[0],s[1]-r[1],s[2]-r[2]);l=$a.R3.normalize($a.R3.create(),l),this.dirVec=l,a.parallelProjection?this._dragParallelProjection(e,i,a,!0):this._dragPerspectiveProjection(e,i,a,!0),i.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,te.getEnabledElement)(t),{viewport:o}=n,i=o.getCamera();i.parallelProjection?this._dragParallelProjection(e,o,i):this._dragPerspectiveProjection(e,o,i),o.render()}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,te.getEnabledElement)(t),i=n.world,a=o.viewport.getCamera(),{focalPoint:r,position:s}=a,l=[s[0]-i[0],s[1]-i[1],s[2]-i[2]],d=[r[0]-i[0],r[1]-i[1],r[2]-i[2]];o.viewport.setCamera({focalPoint:d,position:l}),o.viewport.render()}}vl.toolName="Zoom";const El=vl,wl={X:[1,0,0],Y:[0,1,0],Z:[0,0,1],CUSTOM:[]};class Il extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:wl.Z,rotateIncrementDegrees:.5}})}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,o=(0,te.getEnabledElement)(t),{viewport:i}=o,{direction:a,rotateIncrementDegrees:r}=this.configuration,s=i.getCamera(),{viewUp:l,position:d,focalPoint:c}=s,{direction:u}=n,[h,g,m]=c,[f,p,v]=a,E=u*r,w=[0,0,0],I=[0,0,0],C=[0,0,0],T=$a._E.identity(new Float32Array(16));$a._E.translate(T,T,[h,g,m]),$a._E.rotate(T,T,E,[f,p,v]),$a._E.translate(T,T,[-h,-g,-m]),$a.R3.transformMat4(w,d,T),$a.R3.transformMat4(I,c,T),$a._E.identity(T),$a._E.rotate(T,T,E,[f,p,v]),$a.R3.transformMat4(C,l,T),i.setCamera({position:w,viewUp:C,focalPoint:I}),i.render()}}Il.toolName="VolumeRotateMouseWheel";const Cl=Il;function Tl(e,t,n,o){const i=$a.R3.create();$a.R3.cross(i,t,e);const a=$a.R3.fromValues(...n),r=$a.R3.fromValues(...o),s=$a.R3.create();$a.R3.subtract(s,a,r);const l=$a.R3.length(s);if(l<1e-4)return{worldWidth:0,worldHeight:0};const d=$a.R3.dot(s,i)/(l*$a.R3.length(i));return{worldWidth:Math.sqrt(1-d*d)*l,worldHeight:d*l}}function bl(e,t,n,o){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.25;const a=e.getCamera(),{position:r}=a,{spacingInNormalDirection:s}=te.utilities.getTargetVolumeAndSpacingInNormalDir(e,a,n),l=s*i,d=e.getBounds(),c=d[0],u=d[1],h=[0,0,0];let g,m=[0,0,0];al.ZP.subtract(t,r,h);for(let t=c;t<=u;t+=l){m=[t,0,0];const n=(t-r[0])/h[0];if(m[1]=n*h[1]+r[1],m[2]=n*h[2]+r[2],_l(m,d)){const t=o(e.getIntensityFromWorld(m),m);t&&(g=t)}}return g}const _l=function(e,t){const[n,o,i,a,r,s]=t;return e[0]>n&&e[0]<o&&e[1]>i&&e[1]<a&&e[2]>r&&e[2]<s},Dl={filterAnnotationsWithinSlice:br,getWorldWidthAndHeightFromCorners:Tl,filterAnnotationsForDisplay:_r,getPointInLineOfSightWithCriteria:bl};function Sl(e,t){if(!(e instanceof te.VolumeViewport))return;const{focalPoint:n}=e.getCamera(),o=[0,0,0];return $a.R3.sub(o,t,n),function(e,t){const n=e.getCamera(),o=n.viewPlaneNormal,i=$a.R3.dot(t,o),a=$a.R3.fromValues(o[0],o[1],o[2]);if($a.R3.scale(a,a,i),Math.abs(a[0])>.001||Math.abs(a[1])>.001||Math.abs(a[2])>.001){const t=[0,0,0],o=[0,0,0];$a.R3.add(t,n.focalPoint,a),$a.R3.add(o,n.position,a),e.setCamera({focalPoint:t,position:o}),e.render()}}(e,o),!0}class yl extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}})}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,o=(0,te.getEnabledElement)(t),{viewport:i,renderingEngine:a}=o,r=this.getTargetId(i);if(!r.startsWith("volumeId"))throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");const s=r.split("volumeId:")[1];let l=-1/0;const d=bl(i,n.world,s,((e,t)=>{if(e>l)return l=e,t}));if(!d||!d.length)return;const{targetViewportIds:c,toolGroupId:u}=this.configuration;a.getViewports().filter((e=>{if(c?.indexOf(e.id)>=0)return!0;const t=Vp(e.id,a.id);return!(!u||u!==t?.id)})).forEach((e=>{e instanceof te.VolumeViewport?Sl(e,d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}yl.toolName="MIPJumpToClickTool";const Ol=yl;var Pl=n(33183);function Ml(e,t){const n=e.length,o=[];for(let i=0;i<n;i++){const n=e[i];n.getFrameOfReferenceUID()===t&&o.push(n)}return o}const{Active:xl,Passive:Rl,Enabled:Nl}=ne;function Al(e,t){const n=e.length,o=[];for(let i=0;i<n;i++){const n=e[i],a=Vp(n.id,n.renderingEngineId);if(!a)continue;Ll(a,t)&&o.push(n)}return o}function Ll(e,t){const{toolOptions:n}=e,o=n[t];if(!o)return!1;const i=o.mode;return i===xl||i===Rl||i===Nl}const kl=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.999;return e.filter((e=>{const o=e.getCamera();return Math.abs($a.R3.dot(o.viewPlaneNormal,t.viewPlaneNormal))>n}))};function Ul(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const o=(0,te.getEnabledElement)(e),{renderingEngine:i,FrameOfReferenceUID:a}=o;let r=i.getViewports();r=Ml(r,a),r=Al(r,t);const s=i.getViewport(o.viewportId);n&&(r=kl(r,s.getCamera()));return r.map((e=>e.id))}const Vl=1e-6,Bl=1,Fl=0;function Hl(e,t,n){const[o,i]=n;if(Math.abs(t)<Vl)return e<0;const a=e/t;if(t>0){if(a>i)return 0;a>o&&(n[0]=a)}else{if(a<o)return 0;a<i&&(n[1]=a)}return 1}function Wl(e,t,n,o,i){const[a,r]=e,[s,l]=t,d=s-a,c=l-r;if(void 0===o||void 0===i?(o=e,i=t):(o[0]=e[0],o[1]=e[1],i[0]=t[0],i[1]=t[1]),Math.abs(d)<Vl&&Math.abs(c)<Vl&&a>=n[0]&&a<=n[2]&&r>=n[1]&&r<=n[3])return Bl;const u=[0,1];if(Hl(n[0]-a,d,u)&&Hl(a-n[2],-d,u)&&Hl(n[1]-r,c,u)&&Hl(r-n[3],-c,u)){const[e,t]=u;return t<1&&(i[0]=a+t*d,i[1]=r+t*c),e>0&&(o[0]+=e*d,o[1]+=e*c),Bl}return Fl}function Gl(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}function $l(e,t,n){const o=Gl(e,t);if(0===o)return Gl(n,e);const i=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/o;if(i<0)return Gl(n,e);if(i>1)return Gl(n,t);return Gl(n,[e[0]+i*(t[0]-e[0]),e[1]+i*(t[1]-e[1])])}function zl(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt($l(e,t,n))}function Kl(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function ql(e,t,n,o){const[i,a]=e,[r,s]=t,[l,d]=n,[c,u]=o,h=s-a,g=i-r,m=r*a-i*s,f=h*l+g*d+m,p=h*c+g*u+m;if(0!==f&&0!==p&&Kl(f)===Kl(p))return;const v=u-d,E=l-c,w=c*d-l*u,I=v*i+E*a+w,C=v*r+E*s+w;if(0!==I&&0!==C&&Kl(I)===Kl(C))return;const T=h*E-v*g;let b;b=g*w-E*m;const _=b/T;b=v*m-h*w;return[_,b/T]}const{RENDERING_DEFAULTS:jl}=te.CONSTANTS;function Zl(){return"rgb(0, 200, 0)"}function Yl(){return!0}function Xl(){return!0}function Jl(){return!0}const Ql=1,ed=2,td=3;class nd extends Rr{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:te.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9},jumpThreshold:0}}),this.toolCenter=[0,0,0],this.resetAnnotations=()=>{const e=this._getViewportsInfo();e.forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;const o=(0,te.getEnabledElementByIds)(t,n),{viewport:i}=o,{element:a}=i;let r=this._getAnnotations(o);r=this.filterInteractableAnnotationsForElement(a,r),r.length&&Iv(r[0].annotationUID)})),this.computeToolCenter(e)},this.initializeViewport=e=>{let{renderingEngineId:t,viewportId:n}=e;const o=(0,te.getEnabledElementByIds)(n,t),{FrameOfReferenceUID:i,viewport:a}=o,{element:r}=a,{position:s,focalPoint:l,viewPlaneNormal:d}=a.getCamera();let c=this._getAnnotations(o);c=this.filterInteractableAnnotationsForElement(r,c),c.length&&Iv(c[0].annotationUID);return Ev({highlighted:!1,metadata:{cameraPosition:[...s],cameraFocalPoint:[...l],FrameOfReferenceUID:i,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:n}},r),{normal:d,point:a.canvasToWorld([a.canvas.clientWidth/2,a.canvas.clientHeight/2])}},this._getViewportsInfo=()=>dv(this.toolGroupId).viewportsInfo,this.computeToolCenter=e=>{if(!e.length||1===e.length)return void console.warn("For crosshairs to operate, at least two viewports must be given.");const[t,n,o]=e,{normal:i,point:a}=this.initializeViewport(t),{normal:r,point:s}=this.initializeViewport(n);let l=[0,0,0],d=$a.R3.create();o?({normal:l,point:d}=this.initializeViewport(o)):($a.R3.add(d,a,s),$a.R3.scale(d,d,.5),$a.R3.cross(l,i,r));const c=te.utilities.planar.planeEquation(i,a),u=te.utilities.planar.planeEquation(r,s),h=te.utilities.planar.planeEquation(l,d);this.toolCenter=te.utilities.planar.threePlaneIntersection(c,u,h);const{renderingEngine:g}=(0,te.getEnabledElementByIds)(e[0].viewportId,e[0].renderingEngineId);Jr(g,e.map((e=>{let{viewportId:t}=e;return t})))},this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.world,a=(0,te.getEnabledElement)(n),{viewport:r}=a;if(this.configuration.jumpThreshold){if($a.R3.distance($a.R3.fromValues(...i),$a.R3.fromValues(...this.toolCenter))>this.configuration.jumpThreshold)return}this._jump(a,i);const s=this._getAnnotations(a),l=this.filterInteractableAnnotationsForElement(r.element,s),{data:d}=l[0],{rotationPoints:c}=d.handles,u=[];for(let e=0;e<c.length-1;++e){const t=c[e][1],n=this._getReferenceLineControllable(t.id),o=this._getReferenceLineDraggableRotatable(t.id);n&&o&&(u.push(t.id),e++)}return d.activeViewportIds=[...u],d.handles.activeOperation=Ql,e.preventDefault(),js(n),this._activateModify(n),l[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0,this.configuration?.onInteraction&&this.configuration.onInteraction(!0),this._activateModify(o),js(o),e.preventDefault()},this.isPointNearTool=(e,t,n,o)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o;t.highlighted=!0,this.configuration?.onInteraction&&this.configuration.onInteraction(!0),this._activateModify(i),js(i),e.preventDefault()},this.onCameraModified=e=>{const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{renderingEngine:i}=o,a=o.viewport,r=this._getAnnotations(o),s=this.filterInteractableAnnotationsForElement(n,r)[0];if(!s)return;const l=a.getCamera(),d=s.metadata.cameraPosition,c=[0,0,0];al.ZP.subtract(l.position,d,c);const u=s.metadata.cameraFocalPoint,h=[0,0,0];al.ZP.subtract(l.focalPoint,u,h),s.metadata.cameraPosition=[...l.position],s.metadata.cameraFocalPoint=[...l.focalPoint];const g=this._getReferenceLineControllable(a.id),m=this._getReferenceLineDraggableRotatable(a.id);if(!te.utilities.isEqual(l.position,d,.001)&&g&&m){let e=!1;te.utilities.isEqual(c,h,.001)||(e=!0);const t=Math.abs(al.ZP.dot(c,l.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=c[0],this.toolCenter[1]+=c[1],this.toolCenter[2]+=c[2])}if(this.configuration.autoPan?.enabled){Vp(a.id,i.id).getViewportIds().filter((e=>e!==a.id)).forEach((e=>{this._autoPanViewportIfNecessary(e,i)}))}const f=Ul(n,this.getToolName(),!1);Jr(i,f)},this.mouseMoveCallback=(e,t)=>{const{element:n,currentPoints:o}=e.detail,i=o.canvas;let a=!1;for(let e=0;e<t.length;e++){const o=t[e];if(pe(o))continue;const{data:r,highlighted:s}=o;if(!r.handles)continue;const l=r.handles.activeOperation,d=r.activeViewportIds&&r.activeViewportIds.length>0?[...r.activeViewportIds]:[];r.activeViewportIds=[],r.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,o,i,6)||this._pointNearTool(n,o,i,6);c&&!s||!c&&s?(o.highlighted=!s,a=!0):r.handles.activeOperation===l&&this._areViewportIdArraysEqual(r.activeViewportIds,d)||(a=!0)}return a},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,te.getEnabledElement)(e),{viewportId:o}=n;return t.filter((e=>e.data.viewportId===o))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,renderingEngine:i}=e,{element:a}=o,r=this._getAnnotations(e),s=o.getCamera(),l=this.filterInteractableAnnotationsForElement(a,r)[0];if(!r?.length||!l?.data)return n;const d=l.annotationUID,{clientWidth:c,clientHeight:u}=o.canvas,h=Math.sqrt(c*c+u*u),g=Math.min(c,u),m=l.data,f=o.worldToCanvas(this.toolCenter),p=this._filterAnnotationsByUniqueViewportOrientations(e,r),v=[],E=[0,0,c,u];p.forEach((e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=i.getViewport(t.viewportId),a=n.getCamera(),r=this._getReferenceLineControllable(n.id),l=this._getReferenceLineDraggableRotatable(n.id),d=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:c,clientHeight:u}=n.canvas,m=Math.sqrt(c*c+u*u),w=[.5*c,.5*u],I=n.canvasToWorld(w),C=[0,0,0];al.ZP.cross(s.viewPlaneNormal,a.viewPlaneNormal,C),al.ZP.normalize(C),al.ZP.multiplyScalar(C,m);const T=[0,0,0];al.ZP.add(I,C,T);const b=[0,0,0];al.ZP.subtract(I,C,b);const _=o.worldToCanvas(T),D=o.worldToCanvas(I),S=$a.K4.create();$a.K4.subtract(S,_,D),$a.K4.normalize(S,S);const y=$a.K4.create();$a.K4.scale(y,S,100*h);const O=$a.K4.create();$a.K4.scale(O,S,.4*g);const P=$a.K4.create();$a.K4.scale(P,S,.2*g);const M=$a.K4.create(),x=this.configuration.referenceLinesCenterGapRadius;$a.K4.scale(M,S,2===p.length?x:0);const R=$a.K4.create(),N=$a.K4.create(),A=$a.K4.create(),L=$a.K4.create();let k=$a.K4.clone(f);l&&r||(k=$a.K4.clone(D)),$a.K4.add(R,k,M),$a.K4.add(N,k,y),$a.K4.subtract(A,k,M),$a.K4.subtract(L,k,y),Wl(R,N,E),Wl(A,L,E);const U=$a.K4.create();$a.K4.subtract(U,f,O);const V=$a.K4.create();$a.K4.add(V,f,O);let B=$a.K4.clone(f);!l&&d&&(B=$a.K4.clone(D));let F=[...this.toolCenter];!l&&d&&(F=[...I]);const H=[0,0,0];al.ZP.subtract(T,b,H),al.ZP.normalize(H);const{viewPlaneNormal:W}=s,{matrix:G}=Pl.Z.buildFromDegree().rotate(90,W),$=[0,0,0];$a.R3.transformMat4($,H,G);const z=n.getSlabThickness(),K=[...$];al.ZP.multiplyScalar(K,z);const q=[0,0,0];al.ZP.add(F,K,q);const j=o.worldToCanvas(q),Z=$a.K4.create();$a.K4.subtract(Z,B,j);const Y=$a.K4.create();$a.K4.subtract(Y,B,y),$a.K4.add(Y,Y,Z);const X=$a.K4.create();$a.K4.add(X,B,y),$a.K4.add(X,X,Z),Wl(Y,X,E);const J=$a.K4.create();$a.K4.add(J,B,y),$a.K4.subtract(J,J,Z);const Q=$a.K4.create();$a.K4.subtract(Q,B,y),$a.K4.subtract(Q,Q,Z),Wl(J,Q,E);const ee=$a.K4.create(),te=$a.K4.create(),ne=$a.K4.create(),oe=$a.K4.create();$a.K4.subtract(ee,B,P),$a.K4.add(ee,ee,Z),$a.K4.add(te,B,P),$a.K4.add(te,te,Z),$a.K4.subtract(ne,B,P),$a.K4.subtract(ne,ne,Z),$a.K4.add(oe,B,P),$a.K4.subtract(oe,oe,Z),v.push([n,R,N,A,L,Y,X,J,Q,U,V,ee,te,ne,oe])}));const w=[],I=[],C=this._getReferenceLineColor(o.id),T=void 0!==C?C:"rgb(200, 200, 200)";if(v.forEach(((e,n)=>{const i=e[0],a=this._getReferenceLineColor(i.id),r=this._getReferenceLineControllable(i.id),s=this._getReferenceLineDraggableRotatable(i.id)||this.configuration.mobile?.enabled,l=this._getReferenceLineSlabThicknessControlsOn(i.id)||this.configuration.mobile?.enabled,c=m.activeViewportIds.find((e=>e===i.id));let u=void 0!==a?a:"rgb(200, 200, 200)",h=1;const g=null!==m.handles.activeOperation&&m.handles.activeOperation===Ql&&c;g&&(h=2.5);let f=`${n}`;if(r&&s?(f=`${n}One`,ir(t,d,f,e[1],e[2],{color:u,lineWidth:h}),f=`${n}Two`,ir(t,d,f,e[3],e[4],{color:u,lineWidth:h})):ir(t,d,f,e[2],e[4],{color:u,lineWidth:h}),r){u=void 0!==a?a:"rgb(200, 200, 200)";const r=m.handles.activeOperation===ed,h=[e[9],e[10]],p=[o.canvasToWorld(e[9]),i,e[1],e[2]],v=[o.canvasToWorld(e[10]),i,e[3],e[4]];w.push(p,v);const E=m.handles.activeOperation===td,C=[e[11],e[12],e[13],e[14]],T=[o.canvasToWorld(e[11]),i,e[5],e[6]],b=[o.canvasToWorld(e[12]),i,e[5],e[6]],_=[o.canvasToWorld(e[13]),i,e[7],e[8]],D=[o.canvasToWorld(e[14]),i,e[7],e[8]];if(I.push(T,b,_,D),(g||this.configuration.mobile?.enabled)&&!r&&!E&&s&&l){let e=`${n}One`;or(t,d,e,h,{color:u,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"}),e=`${n}Two`,or(t,d,e,C,{color:u,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(g&&!r&&!E&&s){or(t,d,`${n}`,h,{color:u,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"})}else if(c&&!r&&!E&&l){or(t,d,`${n}`,C,{color:u,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(r&&s){or(t,d,`${n}`,h,{color:u,handleRadius:2,fill:u,type:"circle"})}else E&&c&&l&&or(t,d,f,C,{color:u,handleRadius:2,fill:u,type:"rect"});i.getSlabThickness()>.5&&l&&(f=`${n}STOne`,ir(t,d,f,e[5],e[6],{color:u,width:1,lineDash:[2,3]}),f=`${n}STTwo`,ir(t,d,f,e[7],e[8],{color:u,width:e,lineDash:[2,3]}))}})),n=!0,m.handles.rotationPoints=w,m.handles.slabThicknessPoints=I,this.configuration.viewportIndicators){tr(t,d,"0",[.95*c,.05*u],.01*h,{color:T,fill:T})}return n},this._getAnnotations=e=>{const{viewport:t}=e;return vv(this.getToolName(),t.element)},this._onNewVolume=e=>{const t=this._getViewportsInfo();this.computeToolCenter(t)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach((e=>{let n=!1;for(let o=0;o<t.length;++o)if(e===t[o]){n=!0;break}if(!1===n)return!1})),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:o,viewport:i}=e,a=t.filter((e=>e.data.viewportId!==n));if(!a||!a.length)return[];const r=i.getCamera(),{viewPlaneNormal:s,position:l}=r,d=a.filter((e=>{const{viewportId:t}=e.data,n=o.getViewport(t).getCamera();return!(te.utilities.isEqual(n.viewPlaneNormal,s,.01)&&te.utilities.isEqual(n.position,l,1))}));return d},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:o}=e,{data:i}=t,a=o.getViewport(i.viewportId),r=n.filter((e=>{const{data:t}=e,n=o.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)}));if(!r||!r.length)return[];const s=a.getCamera(),l=s.viewPlaneNormal;al.ZP.normalize(l);return r.filter((e=>{const{viewportId:t}=e.data,n=o.getViewport(t).getCamera(),i=n.viewPlaneNormal;return al.ZP.normalize(i),te.utilities.isEqual(l,i,.01)&&te.utilities.isEqual(s.viewUp,n.viewUp,.01)}))},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{const{renderingEngine:n,viewport:o}=e,i=o.getCamera().viewPlaneNormal;al.ZP.normalize(i);const a=t.filter((e=>{const{data:t}=e,i=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(i.id);return o!==i&&!0===a})),r=[];for(let e=0;e<a.length;++e){const t=a[e],{viewportId:o}=t.data,s=n.getViewport(o).getCamera(),l=s.viewPlaneNormal;if(al.ZP.normalize(l),te.utilities.isEqual(i,l,.01)||te.utilities.isOpposite(i,l,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();te.utilities.isEqual(i.viewPlaneNormal,s.viewPlaneNormal,.01)&&te.utilities.isEqual(i.position,s.position,1)&&(d=!0)}d||r.push(t)}const s=t.filter((e=>{const{data:t}=e,i=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(i.id);return o!==i&&!0!==a}));for(let e=0;e<s.length;++e){const t=s[e],{viewportId:o}=t.data,a=n.getViewport(o).getCamera(),l=a.viewPlaneNormal;if(al.ZP.normalize(l),te.utilities.isEqual(i,l,.01)||te.utilities.isOpposite(i,l,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();te.utilities.isEqual(i.viewPlaneNormal,a.viewPlaneNormal,.01)&&te.utilities.isEqual(i.position,a.position,1)&&(d=!0)}d||r.push(t)}const l=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<l.length;++e){const t=l[e];if(r.some((e=>e===t)))continue;const{viewportId:o}=t.data,a=n.getViewport(o).getCamera(),s=a.viewPlaneNormal;if(al.ZP.normalize(s),te.utilities.isEqual(i,s,.01)||te.utilities.isOpposite(i,s,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();te.utilities.isEqual(i.viewPlaneNormal,a.viewPlaneNormal,.01)&&te.utilities.isEqual(i.position,a.position,1)&&(d=!0)}d||r.push(t)}return r},this._checkIfViewportsRenderingSameScene=(e,t)=>{const n=e.getActors(),o=t.getActors();let i=!0;return n.forEach((e=>{n.length===o.length&&void 0!==o.find((t=>{let{uid:n}=t;return n===e.uid}))||(i=!1)})),i},this._jump=(e,t)=>{Ze.isInteractingWithTool=!0;const{viewport:n,renderingEngine:o}=e,i=this._getAnnotations(e),a=[0,0,0];al.ZP.subtract(t,this.toolCenter,a);const r=this._getAnnotationsForViewportsWithDifferentCameras(e,i).filter((e=>{const{data:t}=e,i=o.getViewport(t.viewportId),a=this._checkIfViewportsRenderingSameScene(n,i);return this._getReferenceLineControllable(i.id)&&this._getReferenceLineDraggableRotatable(i.id)&&a}));return 0===r.length?(Ze.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(o,r,a),Ze.isInteractingWithTool=!1,!0)},this._activateModify=e=>{Ze.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),this.configuration?.onInteraction&&this.configuration.onInteraction(!1),qs(n),this.editData=null;const o=(0,te.getEnabledElement)(n),{renderingEngine:i}=o,a=Ul(n,this.getToolName(),!1);Jr(i,a),this.configuration?.onEndHook&&this.configuration.onEndHook()},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:o}=t,i=(0,te.getEnabledElement)(o),{renderingEngine:a,viewport:r}=i,s=this._getAnnotations(i),l=this.filterInteractableAnnotationsForElement(o,s)[0];if(!l)return;const{handles:d}=l.data,{currentPoints:c}=e.detail,u=c.canvas;if(d.activeOperation===Ql){const e=this._getAnnotationsForViewportsWithDifferentCameras(i,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineDraggableRotatable(n.id);return!0===o&&!0===i&&l.data.activeViewportIds.find((e=>e===n.id))}));this.configuration?.onDragHook&&this.configuration.onDragHook(e),this._applyDeltaShiftToSelectedViewportCameras(a,e,n)}else if(d.activeOperation===ed){const e=this._getAnnotationsForViewportsWithDifferentCameras(i,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineDraggableRotatable(n.id);return!0===o&&!0===i}));this.configuration?.onDragHook&&this.configuration.onDragHook(e);const n=$a.K4.create(),o=$a.K4.create(),l=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],d=r.worldToCanvas(l),c=t.currentPoints.canvas,u=$a.K4.create();$a.K4.sub(u,c,t.deltaPoints.canvas),$a.K4.sub(n,u,d),$a.K4.sub(o,c,d);let h=$a.K4.angle(n,o);this._isClockWise(d,u,c)&&(h*=-1),h=Math.round(100*h)/100;const g=r.getCamera().viewPlaneNormal,{matrix:m}=Pl.Z.buildFromRadian().translate(l[0],l[1],l[2]).rotate(h,g).translate(-l[0],-l[1],-l[2]),f=[];e.forEach((e=>{const{data:t}=e;t.handles.toolCenter=l;const n=a.getViewport(t.viewportId),o=n.getCamera(),{viewUp:i,position:r,focalPoint:s}=o;i[0]+=r[0],i[1]+=r[1],i[2]+=r[2],$a.R3.transformMat4(s,s,m),$a.R3.transformMat4(r,r,m),$a.R3.transformMat4(i,i,m),i[0]-=r[0],i[1]-=r[1],i[2]-=r[2],n.setCamera({position:r,viewUp:i,focalPoint:s}),f.push(n.id)})),a.renderViewports(f)}else if(d.activeOperation===td){const e=this._getAnnotationsForViewportsWithDifferentCameras(i,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===o&&!0===i&&l.data.activeViewportIds.find((e=>e===n.id))}));if(0===e.length)return;const o=this._filterViewportWithSameOrientation(i,e[0],s);this.configuration?.onDragHook&&this.configuration.onDragHook(o);const d=[];d.push(r.id),o.forEach((e=>{const{data:o}=e,i=a.getViewport(o.viewportId),s=i.getCamera().viewPlaneNormal,c=al.ZP.dot(n,s),h=[...s];if(al.ZP.multiplyScalar(h,c),Math.abs(h[0])>.001||Math.abs(h[1])>.001||Math.abs(h[2])>.001){const e=Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]),n=t.lastPoints.world,o=[0,0,0],c=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(i.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter((e=>e[1].uid===i.id));if(2===t.length){const e=r.canvasToWorld(t[0][3]),n=r.canvasToWorld(t[1][3]);al.ZP.add(e,n,c),al.ZP.multiplyScalar(c,.5)}}al.ZP.subtract(n,c,o);const g=al.ZP.dot(o,s),m=[...s];al.ZP.multiplyScalar(m,g);const f=[m[0],m[1],m[2]];$a.R3.normalize(f,f);const p=[h[0],h[1],h[2]];$a.R3.normalize(p,p);let v=i.getSlabThickness();te.utilities.isOpposite(f,p,.001)?v-=e:v+=e,v=Math.abs(v),v=Math.max(jl.MINIMUM_SLAB_THICKNESS,v);this._pointNearReferenceLine(l,u,6,i)&&(v=jl.MINIMUM_SLAB_THICKNESS);Vp(i.id,a.id).getToolInstance(this.getToolName()).setSlabThickness(i,v),d.push(i.id)}})),a.renderViewports(d)}},this._pointNearReferenceLine=(e,t,n,o)=>{const{data:i}=e,{rotationPoints:a}=i.handles;for(let e=0;e<a.length-1;++e){const i=a[e][1];if(i.id!==o.id)continue;if(!this._getReferenceLineControllable(i.id))continue;const r={start:{x:a[e][2][0],y:a[e][2][1]},end:{x:a[e][3][0],y:a[e][3][1]}},s=zl([r.start.x,r.start.y],[r.end.x,r.end.y],[t[0],t[1]]),l={start:{x:a[e+1][2][0],y:a[e+1][2][1]},end:{x:a[e+1][3][0],y:a[e+1][3][1]}},d=zl([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(s<=n||d<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||Zl,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||Yl,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||Xl,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||Jl}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach((e=>{let{renderingEngineId:t,viewportId:n}=e;const o=(0,te.getEnabledElementByIds)(n,t);if(!o)return;const i=this._getAnnotations(o);i?.length&&i.forEach((e=>{Iv(e.annotationUID)}))}))}getHandleNearImagePoint(e,t,n,o){const i=(0,te.getEnabledElement)(e),{viewport:a}=i;let r=this._getRotationHandleNearImagePoint(a,t,n,o);return null!==r?r:(r=this._getSlabThicknessHandleNearImagePoint(a,t,n,o),null!==r?r:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;const{viewport:o}=(0,te.getEnabledElementByIds)(t,n),{element:i}=o;i.removeEventListener(te.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_subscribeToViewportNewVolumeSet(e){e.forEach((e=>{let{viewportId:t,renderingEngineId:n}=e;const{viewport:o}=(0,te.getEnabledElementByIds)(t,n),{element:i}=o;i.addEventListener(te.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:o,clientHeight:i}=n.canvas,a=n.worldToCanvas(this.toolCenter),r=this.configuration.autoPan.panSize,s=[a[0],a[1]];if(a[0]<0?s[0]=r:a[0]>o&&(s[0]=o-r),a[1]<0?s[1]=r:a[1]>i&&(s[1]=i-r),s[0]===a[0]&&s[1]===a[1])return;const l=n.canvasToWorld(s),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:u,position:h}=c,g=[h[0]-d[0],h[1]-d[1],h[2]-d[2]],m=[u[0]-d[0],u[1]-d[1],u[2]-d[2]];n.setCamera({focalPoint:m,position:g}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:o}=this.configuration;o&&o.length>0&&(n=o);let i=this.configuration.slabThicknessBlendMode;t===jl.MINIMUM_SLAB_THICKNESS&&(i=te.Enums.BlendModes.COMPOSITE);e.setBlendMode(i,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach((t=>{this._applyDeltaShiftToViewportCamera(e,t,n)}))}_applyDeltaShiftToViewportCamera(e,t,n){const{data:o}=t,i=e.getViewport(o.viewportId),a=i.getCamera(),r=a.viewPlaneNormal,s=al.ZP.dot(n,r),l=[...r];if(al.ZP.multiplyScalar(l,s),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const e=[0,0,0],t=[0,0,0];al.ZP.add(a.focalPoint,l,e),al.ZP.add(a.position,l,t),i.setCamera({focalPoint:e,position:t}),i.render()}}_getRotationHandleNearImagePoint(e,t,n,o){const{data:i}=t,{rotationPoints:a}=i.handles;for(let r=0;r<a.length;r++){const s=a[r][0],l=a[r][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineDraggableRotatable(l.id))continue;const d=e.worldToCanvas(s);if($a.K4.distance(n,d)<o)return i.handles.activeOperation=ed,this.editData={annotation:t},s}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,o){const{data:i}=t,{slabThicknessPoints:a}=i.handles;for(let r=0;r<a.length;r++){const s=a[r][0],l=a[r][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(l.id))continue;const d=e.worldToCanvas(s);if($a.K4.distance(n,d)<o)return i.handles.activeOperation=td,i.activeViewportIds=[l.id],this.editData={annotation:t},s}return null}_pointNearTool(e,t,n,o){const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{clientWidth:r,clientHeight:s}=a.canvas,l=Math.sqrt(r*r+s*s),{data:d}=t,{rotationPoints:c}=d.handles,{slabThicknessPoints:u}=d.handles,h=[];for(let e=0;e<c.length-1;++e){const t=c[e][1],i=this._getReferenceLineControllable(t.id),a=this._getReferenceLineDraggableRotatable(t.id);if(!i||!a)continue;const r={start:{x:c[e][2][0],y:c[e][2][1]},end:{x:c[e][3][0],y:c[e][3][1]}},s=zl([r.start.x,r.start.y],[r.end.x,r.end.y],[n[0],n[1]]),l={start:{x:c[e+1][2][0],y:c[e+1][2][1]},end:{x:c[e+1][3][0],y:c[e+1][3][1]}},u=zl([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(s<=o||u<=o)&&(h.push(t.id),d.handles.activeOperation=Ql),e++}for(let e=0;e<u.length-1;++e){const t=u[e][1];if(h.find((e=>e===t.id)))continue;const i=this._getReferenceLineControllable(t.id),a=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!i||!a)continue;const r=u[e][2],s=u[e][3],c=$a.K4.create();$a.K4.add(c,r,s),$a.K4.scale(c,c,.5);const g=$a.K4.create();$a.K4.subtract(g,r,c),$a.K4.normalize(g,g);const m=$a.K4.create();$a.K4.scale(m,g,.05*l);const f=$a.K4.create(),p=$a.K4.create();$a.K4.add(f,c,m),$a.K4.subtract(p,c,m);const v={start:{x:f[0],y:f[1]},end:{x:r[0],y:r[1]}},E=zl([v.start.x,v.start.y],[v.end.x,v.end.y],[n[0],n[1]]),w={start:{x:p[0],y:p[1]},end:{x:s[0],y:s[1]}},I=zl([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]);(E<=o||I<=o)&&(h.push(t.id),d.handles.activeOperation=null),e++}return d.activeViewportIds=[...h],this.editData={annotation:t},d.handles.activeOperation===Ql}}nd.toolName="Crosshairs";const od=nd,id="magnify-viewport";class ad extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,i=(0,te.getEnabledElement)(n),{viewport:a,renderingEngine:r}=i;if(!(a instanceof te.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const s=this._getReferencedImageId(a);if(!s)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const l=Ul(n,this.getToolName());return this.editData={referencedImageId:s,viewportIdsToRender:l,enabledElement:i,renderingEngine:r,currentPoints:o},this._createMagnificationViewport(),this._activateDraw(n),js(n),e.preventDefault(),Jr(r,l),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:o,currentPoints:i}=this.editData,{viewport:a}=e,{element:r}=a,s=a.getProperties(),{canvas:l,world:d}=i;let c;if(c=r.querySelector(".magnifyTool"),null===c){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width=`${this.configuration.magnifyWidth}px`,e.style.height=`${this.configuration.magnifyHeight}px`,e.style.position="absolute",c=e;r.querySelector(".viewport-element").appendChild(e);const t={viewportId:id,type:te.Enums.ViewportType.STACK,element:c};o.enableElement(t)}c.style.top=l[1]-this.configuration.magnifyHeight/2+"px",c.style.left=l[0]-this.configuration.magnifyWidth/2+"px";const u=o.getViewport(id);u.setStack([t]).then((()=>{u.setProperties(s);const{parallelScale:e}=a.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:o}=u.getCamera(),i=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),r=[d[0],d[1],d[2]],l=[r[0]+i*o[0],r[1]+i*o[1],r[2]+i*o[2]];u.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:r,position:l}),u.render()})),c.style.display="block",Jr(o,n)},this._dragCallback=e=>{const t=e.detail,{deltaPoints:n,element:o,currentPoints:i}=t,a=n.world,r=i.canvas,s=(0,te.getEnabledElement)(o),{renderingEngine:l}=s,d=l.getViewport(id),c=o.querySelector(".magnifyTool");if(!c)return;c.style.top=r[1]-this.configuration.magnifyHeight/2+"px",c.style.left=r[0]-this.configuration.magnifyWidth/2+"px";const{focalPoint:u,position:h}=d.getCamera(),g=[h[0]+a[0],h[1]+a[1],h[2]+a[2]],m=[u[0]+a[0],u[1]+a[1],u[2]+a[2]];d.setCamera({focalPoint:m,position:g}),d.render()},this._dragEndCallback=e=>{const{element:t}=e.detail,n=(0,te.getEnabledElement)(t),{renderingEngine:o}=n;o.disableElement(id);const i=t.querySelector(".viewport-element"),a=i.querySelector(".magnifyTool");i.removeChild(a),this._deactivateDraw(t),qs(t)},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._dragEndCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(re.TOUCH_END,this._dragEndCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._dragEndCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(re.TOUCH_END,this._dragEndCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof te.StackViewport&&(n=t.split("imageId:")[1]),n}}ad.toolName="Magnify";const rd=ad;function sd(e,t){if(e.length!==t.length)throw Error("Both points should have the same dimensionality");const[n,o,i=0]=e,[a,r,s=0]=t;return Math.sqrt(Math.pow(n-a,2)+Math.pow(o-r,2)+Math.pow(i-s,2))}function ld(e){const[t,n]=e;return sd(t,n)}function dd(e){const[t,n]=e,o=sd(t,n);return[[t[0]-o,t[1]-o],[t[0]+o,t[1]+o]]}const cd=125,ud=e=>e.uid!==e.referenceId;class hd{constructor(e){let{magnifyViewportId:t,sourceEnabledElement:n,radius:o=cd,position:i=[0,0],zoomFactor:a,autoPan:r}=e;this._enabledElement=null,this._sourceToolGroup=null,this._magnifyToolGroup=null,this._isViewportReady=!1,this._radius=0,this._resized=!1,this._canAutoPan=!1,this._viewportId=t??te.utilities.uuidv4(),this._sourceEnabledElement=n,this._autoPan=r,this.radius=o,this.position=i,this.zoomFactor=a,this.visible=!0,this._browserMouseDownCallback=this._browserMouseDownCallback.bind(this),this._browserMouseUpCallback=this._browserMouseUpCallback.bind(this),this._handleToolModeChanged=this._handleToolModeChanged.bind(this),this._mouseDragCallback=this._mouseDragCallback.bind(this),this._resizeViewportAsync=Kr(this._resizeViewport.bind(this),1),this._initialize()}get sourceEnabledElement(){return this._sourceEnabledElement}get viewportId(){return this._viewportId}get radius(){return this._radius}set radius(e){Math.abs(this._radius-e)>1e-5&&(this._radius=e,this._resized=!0)}update(){const{radius:e,position:t,visible:n}=this,{viewport:o}=this._enabledElement,{element:i}=o,a=2*e,[r,s]=t;this._resized&&(this._resizeViewportAsync(),this._resized=!1),Object.assign(i.style,{display:n?"block":"hidden",width:`${a}px`,height:`${a}px`,left:-e+"px",top:-e+"px",transform:`translate(${r}px, ${s}px)`}),this._isViewportReady&&(this._syncViewports(),o.render())}dispose(){const{viewport:e}=this._enabledElement,{element:t}=e,n=e.getRenderingEngine();this._removeEventListeners(t),n.disableElement(e.id),t.parentNode&&t.parentNode.removeChild(t)}_handleToolModeChanged(e){const{_magnifyToolGroup:t}=this,{toolGroupId:n,toolName:o,mode:i,toolBindingsOptions:a}=e.detail;if(this._sourceToolGroup?.id===n)switch(i){case ne.Active:t.setToolActive(o,a);break;case ne.Passive:t.setToolPassive(o);break;case ne.Enabled:t.setToolEnabled(o);break;case ne.Disabled:t.setToolDisabled(o);break;default:throw new Error(`Unknow tool mode (${i})`)}}_inheritBorderRadius(e){const t=e.querySelector(".viewport-element"),n=e.querySelector(".cornerstone-canvas");t.style.borderRadius="inherit",n.style.borderRadius="inherit"}_createViewportNode(){const e=document.createElement("div"),{radius:t}=this,n=2*t;return e.classList.add("advancedMagnifyTool"),Object.assign(e.style,{display:"block",width:`${n}px`,height:`${n}px`,position:"absolute",overflow:"hidden",borderRadius:"50%",boxSizing:"border-box",left:-t+"px",top:-t+"px",transform:"translate(-1000px, -1000px)"}),e}_convertZoomFactorToParalellScale(e,t,n){const{parallelScale:o}=e.getCamera();return o*(1/n)*(t.canvas.offsetWidth/e.canvas.offsetWidth)}_isStackViewport(e){return"setStack"in e}_isVolumeViewport(e){return"addVolumes"in e}_cloneToolGroups(e,t){const n=e.getActors(),o=`${t.id}-toolGroup`,i=Vp(e.id,e.renderingEngineId),a=i.clone(o,(e=>{const t=i.getToolInstance(e);return t instanceof Rr&&!(t instanceof pd)||e===Ar.toolName}));return a.addViewport(t.id,t.renderingEngineId),n.filter(ud).forEach((e=>{Sa(o,[{segmentationId:e.referenceId,type:le.Labelmap}])})),{sourceToolGroup:i,magnifyToolGroup:a}}_cloneStack(e,t){const n=e.getImageIds();t.setStack(n).then((()=>{this._isViewportReady=!0,this.update()}))}_cloneVolumes(e,t){const n=e.getActors().filter((e=>!ud(e))).map((e=>({volumeId:e.uid})));return t.setVolumes(n).then((()=>{this._isViewportReady=!0,this.update()})),t}_cloneViewport(e,t){const{viewportId:n}=this,o=e.getRenderingEngine(),{options:i}=e,a={element:t,viewportId:n,type:e.type,defaultOptions:{...i}};o.enableElement(a);const r=o.getViewport(n);this._isStackViewport(e)?this._cloneStack(e,r):this._isVolumeViewport(e)&&this._cloneVolumes(e,r),this._inheritBorderRadius(t);const s=this._cloneToolGroups(e,r);this._sourceToolGroup=s.sourceToolGroup,this._magnifyToolGroup=s.magnifyToolGroup}_cancelMouseEventCallback(e){e.stopPropagation(),e.preventDefault()}_browserMouseUpCallback(e){const{element:t}=this._enabledElement.viewport;document.removeEventListener("mouseup",this._browserMouseUpCallback),t.addEventListener("mouseup",this._cancelMouseEventCallback),t.addEventListener("mousemove",this._cancelMouseEventCallback)}_browserMouseDownCallback(e){const{element:t}=this._enabledElement.viewport;this._canAutoPan=!!e.target?.closest(".advancedMagnifyTool"),document.addEventListener("mouseup",this._browserMouseUpCallback),t.removeEventListener("mouseup",this._cancelMouseEventCallback),t.removeEventListener("mousemove",this._cancelMouseEventCallback)}_mouseDragCallback(e){if(!Ze.isInteractingWithTool)return;const{_autoPan:t}=this;if(!t.enabled||!this._canAutoPan)return;const{currentPoints:n}=e.detail,{viewport:o}=this._enabledElement,{canvasToWorld:i}=o,{canvas:a}=n,{radius:r}=this,s=[r,r],l=sd(s,a),d=r-t.padding;if(l<=d)return;const c=l-d,u=$a.K4.sub($a.K4.create(),a,s);$a.K4.normalize(u,u),$a.K4.scale(u,u,c);const h=$a.K4.add($a.K4.create(),this.position,u),g=i(this.position),m=i(h),f=$a.R3.sub($a.R3.create(),m,g),p={points:{currentPosition:{canvas:this.position,world:g},newPosition:{canvas:h,world:m}},delta:{canvas:u,world:f}};t.callback(p)}_addBrowserEventListeners(e){document.addEventListener("mousedown",this._browserMouseDownCallback,!0),e.addEventListener("mousedown",this._cancelMouseEventCallback),e.addEventListener("mouseup",this._cancelMouseEventCallback),e.addEventListener("mousemove",this._cancelMouseEventCallback),e.addEventListener("dblclick",this._cancelMouseEventCallback)}_removeBrowserEventListeners(e){document.removeEventListener("mousedown",this._browserMouseDownCallback,!0),document.removeEventListener("mouseup",this._browserMouseUpCallback),e.removeEventListener("mousedown",this._cancelMouseEventCallback),e.removeEventListener("mouseup",this._cancelMouseEventCallback),e.removeEventListener("mousemove",this._cancelMouseEventCallback),e.removeEventListener("dblclick",this._cancelMouseEventCallback)}_addEventListeners(e){te.eventTarget.addEventListener(re.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),this._addBrowserEventListeners(e)}_removeEventListeners(e){te.eventTarget.removeEventListener(re.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),this._removeBrowserEventListeners(e)}_initialize(){const{_sourceEnabledElement:e}=this,{viewport:t}=e,{canvas:n}=t,o=this._createViewportNode();n.parentNode.appendChild(o),this._addEventListeners(o),this._cloneViewport(t,o),this._enabledElement=(0,te.getEnabledElement)(o)}_syncViewportsCameras(e,t){const n=e.canvasToWorld(this.position),o=this._convertZoomFactorToParalellScale(e,t,this.zoomFactor),{focalPoint:i,position:a,viewPlaneNormal:r}=t.getCamera(),s=Math.sqrt(Math.pow(i[0]-a[0],2)+Math.pow(i[1]-a[1],2)+Math.pow(i[2]-a[2],2)),l=[n[0],n[1],n[2]],d=[l[0]+s*r[0],l[1]+s*r[1],l[2]+s*r[2]];t.setCamera({parallelScale:o,focalPoint:l,position:d})}_syncStackViewports(e,t){t.setImageIdIndex(e.getCurrentImageIdIndex())}_syncViewports(){const{viewport:e}=this._sourceEnabledElement,{viewport:t}=this._enabledElement,n=e.getProperties();t.setProperties(n),this._syncViewportsCameras(e,t),this._isStackViewport(e)&&this._syncStackViewports(e,t)}_resizeViewport(){const{viewport:e}=this._enabledElement;e.getRenderingEngine().resize()}}const gd=1-te.CONSTANTS.EPSILON,{Events:md}=te.Enums;class fd{constructor(){this.createViewport=(e,t)=>{const{magnifyViewportId:n,sourceEnabledElement:o,position:i,radius:a,zoomFactor:r,autoPan:s}=t,{viewport:l}=o,{element:d}=l,c=new hd({magnifyViewportId:n,sourceEnabledElement:o,radius:a,position:i,zoomFactor:r,autoPan:s});return this._addSourceElementEventListener(d),this._magnifyViewportsMap.set(c.viewportId,{annotation:e,magnifyViewport:c}),c},this._annotationRemovedCallback=e=>{const{annotation:t}=e.detail;"AdvancedMagnify"===t.metadata.toolName&&this._destroyViewport(t.data.magnifyViewportId)},this._newStackImageCallback=e=>{const{viewportId:t,imageId:n}=e.detail;this._getMagnifyViewportsMapEntriesBySourceViewportId(t).forEach((e=>{let{annotation:t}=e;t.metadata.referencedImageId=n,t.invalidated=!0}))},this._newVolumeImageCallback=e=>{const{renderingEngineId:t,viewportId:n}=e.detail,o=(0,te.getRenderingEngine)(t).getViewport(n),{viewPlaneNormal:i}=o.getCamera();this._getMagnifyViewportsMapEntriesBySourceViewportId(n).forEach((e=>{let{annotation:t}=e;const{viewPlaneNormal:n}=t.metadata;if(!(Math.abs($a.R3.dot(n,i))>gd))return;const{handles:a}=t.data,r=o.canvasToWorld([0,0]),s=$a.R3.sub($a.R3.create(),r,a.points[0]),l=$a.R3.dot(s,i),d=$a.R3.scale($a.R3.create(),i,l);for(let e=0,t=a.points.length;e<t;e++){const t=a.points[e];t[0]+=d[0],t[1]+=d[1],t[2]+=d[2]}t.invalidated=!0}))},this._magnifyViewportsMap=new Map,this._initialize()}static getInstance(){return fd._singleton=fd._singleton??new fd,fd._singleton}getViewport(e){return this._magnifyViewportsMap.get(e)?.magnifyViewport}dispose(){this._removeEventListeners(),this._destroyViewports()}_destroyViewport(e){const t=this._magnifyViewportsMap.get(e);if(t){const{magnifyViewport:n}=t,{viewport:o}=n.sourceEnabledElement,{element:i}=o;this._removeSourceElementEventListener(i),n.dispose(),this._magnifyViewportsMap.delete(e)}}_destroyViewports(){Array.from(this._magnifyViewportsMap.keys()).forEach((e=>this._destroyViewport(e)))}_getMagnifyViewportsMapEntriesBySourceViewportId(e){return Array.from(this._magnifyViewportsMap.values()).filter((t=>{let{magnifyViewport:n}=t;const{viewport:o}=n.sourceEnabledElement;return o.id===e}))}_addEventListeners(){te.eventTarget.addEventListener(re.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_removeEventListeners(){te.eventTarget.removeEventListener(re.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_addSourceElementEventListener(e){e.addEventListener(md.STACK_NEW_IMAGE,this._newStackImageCallback),e.addEventListener(md.VOLUME_NEW_IMAGE,this._newVolumeImageCallback)}_removeSourceElementEventListener(e){e.removeEventListener(md.STACK_NEW_IMAGE,this._newStackImageCallback),e.removeEventListener(md.VOLUME_NEW_IMAGE,this._newVolumeImageCallback)}_initialize(){this._addEventListeners()}}class pd extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:2.5,zoomFactorList:[2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:[{method:"showZoomFactorsList",bindings:[{mouseButton:J.Secondary,modifierKey:Q.Shift}]}]}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=(0,te.getEnabledElement)(o),{viewport:a,renderingEngine:r}=i,s=n.world,l=n.canvas,{magnifyingGlass:d}=this.configuration,{radius:c,zoomFactor:u,autoPan:h}=d,g=this._getWorldHandlesPoints(a,l,c),m=a.getCamera(),{viewPlaneNormal:f,viewUp:p}=m,v=this.getReferencedImageId(a,s,f,p),E=te.utilities.uuidv4(),w=te.utilities.uuidv4(),I=a.getFrameOfReferenceUID(),C={annotationUID:E,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...f],viewUp:[...p],FrameOfReferenceUID:I,referencedImageId:v},data:{sourceViewportId:a.id,magnifyViewportId:w,zoomFactor:u,handles:{points:g,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(C,{magnifyViewportId:w,sourceEnabledElement:i,position:l,radius:c,zoomFactor:u,autoPan:{enabled:h.enabled,padding:h.padding,callback:e=>{const t=C.data.handles.points,{world:n}=e.delta;for(let e=0,o=t.length;e<o;e++)t[e][0]+=n[0],t[e][1]+=n[1],t[e][2]+=n[2]}}}),Ev(C,o);const T=Ul(o,this.getToolName());return e.preventDefault(),Jr(r,T),C},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles,l=s.map((e=>a.worldToCanvas(e))),d=l[0],c=l[2],u=l[3],h=.5*Math.abs(c[1]-d[1]),g=ld([[u[0]+h,d[1]+h],n]);return Math.abs(g-h)<1.5*o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i},js(o),this._activateModify(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;const{points:r}=a.handles,s=r.findIndex((e=>e===n)),l=Ul(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s},this._activateModify(i),js(i);const d=(0,te.getEnabledElement)(i),{renderingEngine:c}=d;Jr(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a}=this.editData,{data:r}=o;r.handles.activeHandleIndex=null,this._deactivateModify(n),qs(n);const s=(0,te.getEnabledElement)(n),{renderingEngine:l}=s;if(this.editData=null,this.isDrawing=!1,Jr(l,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n,deltaPoints:o}=t,i=o?.world??[0,0,0],a=(0,te.getEnabledElement)(n),{renderingEngine:r}=a,{annotation:s,viewportIdsToRender:l}=this.editData,{points:d}=s.data.handles;d.forEach((e=>{e[0]+=i[0],e[1]+=i[1],e[2]+=i[2]})),s.invalidated=!0,this.editData.hasMoved=!0,Jr(r,l)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a}=this.editData,{data:r}=o;if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const s=(0,te.getEnabledElement)(n),{renderingEngine:l}=s;Jr(l,i)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{viewport:i}=o,{worldToCanvas:a}=i,{annotation:r}=this.editData,{data:s}=r,{points:l}=s.handles,d=l.map((e=>a(e))),c=d[0],u=d[2],h=d[3],g=.5*Math.abs(u[1]-c[1]),m=[h[0]+g,c[1]+g],{currentPoints:f}=t,p=ld([m,f.canvas]),v=this._getWorldHandlesPoints(i,m,p);l[0]=v[0],l[1]=v[1],l[2]=v[2],l[3]=v[3]},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,t.annotationUID},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),a=a?.filter((e=>e.data.sourceViewportId===o.id)),!a?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const i=a[e],{annotationUID:s,data:l}=i,{magnifyViewportId:d,zoomFactor:c,handles:u}=l,{points:h,activeHandleIndex:g}=u;r.annotationUID=s;const m=this.getStyle("lineWidth",r,i),f=this.getStyle("lineDash",r,i),p=this.getStyle("color",r,i),v=h.map((e=>o.worldToCanvas(e))),E=v[0],w=v[2],I=v[3],C=.5*Math.abs(w[1]-E[1]),T=[I[0]+C,E[1]+C];if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!Ue(s))continue;if(pe(i)||this.editData||null===g||(b=[v[g]]),b){or(t,s,"0",b,{color:p})}tr(t,s,"0",T,C,{color:p,lineDash:f,lineWidth:m},`${s}-advancedMagnify`);const _=this.magnifyViewportManager.getViewport(d);_.position=T,_.radius=C,_.zoomFactor=c,_.update(),n=!0}return n},this._getWorldHandlesPoints=(e,t,n)=>[[t[0],t[1]-n],[t[0]+n,t[1]],[t[0],t[1]+n],[t[0]-n,t[1]]].map((t=>e.canvasToWorld(t))),this.magnifyViewportManager=fd.getInstance()}showZoomFactorsList(e,t){const{element:n,currentPoints:o}=e.detail,i=(0,te.getEnabledElement)(n),{viewport:a}=i,{canvas:r}=o,s=n.querySelector(":scope .viewport-element"),l=t.data.zoomFactor,d=this._getZoomFactorsListDropdown(l,(e=>{void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),d.parentElement.removeChild(d),a.render()}));Object.assign(d.style,{left:`${r[0]}px`,top:`${r[1]}px`}),s.appendChild(d),d.focus()}_getZoomFactorsListDropdown(e,t){const{zoomFactorList:n}=this.configuration.magnifyingGlass,o=document.createElement("select");return o.size=5,Object.assign(o.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach((e=>{o.addEventListener(e,(e=>e.stopPropagation()))})),o.addEventListener("change",(e=>{e.stopPropagation(),t(o.value)})),o.addEventListener("keydown",(e=>{((e.keyCode??27===e.which)||"escape"===e.key?.toLowerCase())&&(e.stopPropagation(),t())})),n.forEach((t=>{const n=document.createElement("option");n.label=t,n.title=`Zoom factor ${t.toFixed(1)}`,n.value=t,n.defaultSelected=t===e,o.add(n)})),o}}pd.toolName="AdvancedMagnify";const{EPSILON:vd}=te.CONSTANTS;class Ed extends Mr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",showFullDimension:!1}}),this.editData={},this._init=()=>{const e=(0,te.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=Al(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n||!n.getImageData())return;const{element:o}=n,{viewUp:i,viewPlaneNormal:a}=n.getCamera(),r=te.utilities.getViewportImageCornersInWorld(n);let s=this.editData.annotation;const l=n.getFrameOfReferenceUID();if(s)this.editData.annotation.data.handles.points=r;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...a],viewUp:[...i],FrameOfReferenceUID:l,referencedImageId:null},data:{handles:{points:r}}};Ev(e,o),s=e}this.editData={sourceViewport:n,renderingEngine:e,annotation:s},Jr(e,t.filter((e=>e.id!==n.id)).map((e=>e.id)))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n}=e,{annotation:o,sourceViewport:i}=this.editData;let a=!1;if(!i)return a;if(i.id===n.id)return a;if(!o||!o?.data?.handles?.points)return a;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},s=o.data.handles.points[0],l=o.data.handles.points[1],d=o.data.handles.points[2],c=o.data.handles.points[3],{focalPoint:u,viewPlaneNormal:h,viewUp:g}=n.getCamera(),{viewPlaneNormal:m}=i.getCamera();if(this.isParallel(h,m))return a;const f=te.utilities.planar.planeEquation(h,u),p=[s,d,l,c],v=[s,l,d,c];let E=p,w=$a.R3.subtract($a.R3.create(),p[0],p[1]);w=$a.R3.normalize($a.R3.create(),w);let I=$a.R3.subtract($a.R3.create(),p[2],p[0]);I=$a.R3.normalize($a.R3.create(),I);const C=$a.R3.cross($a.R3.create(),w,I);if(this.isParallel(C,h))return a;this.isPerpendicular(w,h)&&(E=v);const T=te.utilities.planar.linePlaneIntersection(E[0],E[1],f),b=te.utilities.planar.linePlaneIntersection(E[2],E[3],f),{annotationUID:_}=o;r.annotationUID=_;const D=this.getStyle("lineWidth",r,o),S=this.getStyle("lineDash",r,o),y=this.getStyle("color",r,o),O=this.getStyle("shadow",r,o);let P=[T,b].map((e=>n.worldToCanvas(e)));this.configuration.showFullDimension&&(P=this.handleFullDimension(n,T,h,g,b,P));const M=`${_}-line`;return ir(t,_,"1",P[0],P[1],{color:y,width:D,lineDash:S,shadow:O},M),a=!0,a},this.isPerpendicular=(e,t)=>{const n=$a.R3.dot(e,t);return Math.abs(n)<vd}}handleFullDimension(e,t,n,o,i,a){const r=e.getRenderingEngine(),s=this.getTargetId(e),l=this.getTargetIdImage(s,r),d=this.getReferencedImageId(e,t,n,o);if(d&&l)try{const{imageData:n,dimensions:o}=l,[r,s,c,u]=[n.indexToWorld([0,0,0]),n.indexToWorld([o[0]-1,0,0]),n.indexToWorld([o[0]-1,o[1]-1,0]),n.indexToWorld([0,o[1]-1,0])].map((e=>te.utilities.worldToImageCoords(d,e))),[h,g]=[t,i].map((e=>te.utilities.worldToImageCoords(d,e)));a=[[r,s],[s,c],[u,c],[r,u]].map((e=>{let[t,n]=e;return this.intersectInfiniteLines(t,n,h,g)})).filter((e=>e&&this.isInBound(e,o))).map((t=>{const n=te.utilities.imageToWorldCoords(d,t);return e.worldToCanvas(n)}))}catch(e){console.log(e)}return a}intersectInfiniteLines(e,t,n,o){const[i,a]=e,[r,s]=t,[l,d]=n,[c,u]=o,h=s-a,g=i-r,m=r*a-i*s,f=u-d,p=l-c,v=c*d-l*u;if(Math.abs(h*p-f*g)<vd)return;return[(g*v-p*m)/(h*p-f*g),(f*m-h*v)/(h*p-f*g)]}isParallel(e,t){return Math.abs($a.R3.dot(e,t))>1-vd}isInBound(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}Ed.toolName="ReferenceLines";const wd=Ed,{EPSILON:Id}=te.CONSTANTS;class Cd extends Mr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}),this.onSetToolEnabled=()=>{this._init()},this.onSetToolActive=()=>{this._init()},this._init=()=>{const e=this.configuration.sourceImageIds;if(!e?.length)return void console.warn("OverlayGridTool: No sourceImageIds provided in configuration");const t=te.metaData.get("imagePlaneModule",e[0]);if(!t)return void console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");const{frameOfReferenceUID:n}=t,o=dv(this.toolGroupId).viewportsInfo;if(!o?.length)return void console.warn("OverlayGridTool: No viewports found");const i=vv(this.getToolName(),n);if(!i?.length){const t=e.map((e=>this.calculateImageIdPointSets(e)));Ev({highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{viewportData:new Map,pointSets:t}},n)}Jr((0,te.getRenderingEngine)(o[0].renderingEngineId),o.map((e=>{let{viewportId:t}=e;return t})))},this.calculateImageIdPointSets=e=>{const{imagePositionPatient:t,rows:n,columns:o,rowCosines:i,columnCosines:a,rowPixelSpacing:r,columnPixelSpacing:s}=te.metaData.get("imagePlaneModule",e),l=[...t],d=[...t],c=[...t],u=[...t];$a.R3.scaleAndAdd(d,t,a,o*s),$a.R3.scaleAndAdd(c,t,i,n*r),$a.R3.scaleAndAdd(u,c,a,o*s);return{pointSet1:[l,c,d,u],pointSet2:[l,d,c,u]}},this.renderAnnotation=(e,t)=>{const n=this.configuration.sourceImageIds;let o=!1;if(!n?.length)return o;const{viewport:i,FrameOfReferenceUID:a}=e;if(i.getImageIds().length<2)return o;const r=vv(this.getToolName(),a);if(!r?.length)return o;const s=r[0],{annotationUID:l}=s,{focalPoint:d,viewPlaneNormal:c}=i.getCamera(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},h=this.getImageIdNormal(n[0]);if(this.isParallel(c,h))return o;const g=te.utilities.planar.planeEquation(c,d),m=s.data.pointSets,f=s.data.viewportData;for(let e=0;e<n.length;e++){const{pointSet1:n,pointSet2:o}=m[e],a=f.get(i.id)||this.initializeViewportData(f,i.id);if(!a.pointSetsToUse[e]){let t=n,i=$a.R3.subtract($a.R3.create(),n[0],n[1]);i=$a.R3.normalize($a.R3.create(),i),this.isPerpendicular(i,c)&&(t=o),a.pointSetsToUse[e]=t,a.lineStartsWorld[e]=te.utilities.planar.linePlaneIntersection(t[0],t[1],g),a.lineEndsWorld[e]=te.utilities.planar.linePlaneIntersection(t[2],t[3],g)}const r=a.lineStartsWorld[e],d=a.lineEndsWorld[e];u.annotationUID=l;const h=this.getStyle("lineWidth",u,s),p=this.getStyle("lineDash",u,s),v=this.getStyle("color",u,s),E=this.getStyle("shadow",u,s),w=[r,d].map((e=>i.worldToCanvas(e))),I=`${l}-line`;ir(t,l,`${e}`,w[0],w[1],{color:v,width:h,lineDash:p,shadow:E},I)}return o=!0,o},this.initializeViewportData=(e,t)=>(e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)),this.isPerpendicular=(e,t)=>{const n=$a.R3.dot(e,t);return Math.abs(n)<Id}}isParallel(e,t){return Math.abs($a.R3.dot(e,t))>1-Id}getImageIdNormal(e){const{imageOrientationPatient:t}=te.metaData.get("imagePlaneModule",e),n=$a.R3.fromValues(t[0],t[1],t[2]),o=$a.R3.fromValues(t[3],t[4],t[5]);return $a.R3.cross($a.R3.create(),n,o)}}Cd.toolName="OverlayGrid";const Td=Cd;class bd extends Mr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{opacity:.5}}),this._init=()=>{const e=dv(this.toolGroupId).viewportsInfo;if(!e?.length)return void console.warn(this.getToolName()+"Tool: No viewports found");const t=(0,te.getRenderingEngine)(e[0].renderingEngineId)?.getViewport(e[0].viewportId);if(!t)return;const n=t.getFrameOfReferenceUID(),o=vv(this.getToolName(),n);if(!o?.length){const t=new Map;!function(e,t){t.forEach((t=>{let{viewportId:n,renderingEngineId:o}=t;const i=(0,te.getRenderingEngine)(o)?.getViewport(n);_d(e,i)}))}(t,e);Ev({highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{actorsWorldPointsMap:t}},n)}Jr((0,te.getRenderingEngine)(e[0].renderingEngineId),e.map((e=>{let{viewportId:t}=e;return t})))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n,FrameOfReferenceUID:o}=e;let i=!1;const a=vv(this.getToolName(),o);if(!a?.length)return i;const r=a[0],{annotationUID:s}=r,l=r.data.actorsWorldPointsMap;_d(l,n);const d=n.getActors(),c=Dd(n);return d.forEach((e=>{if(!e?.clippingFilter)return;const o=l.get(e.uid);if(!o)return;if(!o.get(c))return;let i=1;const{worldPointsSet:a,color:r}=o.get(c);for(let o=0;o<a.length;o++){const l=a[o].map((e=>n.worldToCanvas(e))),d={color:r,fillColor:r,fillOpacity:this.configuration.opacity,connectLastToFirst:!0},c=e.uid+"#"+i;ar(t,s,c,l,d),i++}})),i=!0,i}}}function _d(e,t){const n=t.getActors(),o=Dd(t);n.forEach((t=>{if(!t?.clippingFilter)return;let n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(o)){const e=mf(t.clippingFilter.getOutputData());if(!e)return;const i=function(e){function t(e){let t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(o,{worldPointsSet:e,color:i})}}))}function Dd(e){const{viewPlaneNormal:t}=e.getCamera(),n=e.getCurrentImageIdIndex();return`${e.id}-${Ca(t)}-${n}`}bd.toolName="SegmentationIntersection";const Sd=bd,{CalibrationTypes:yd}=te.Enums,Od="px",Pd=(e,t)=>{const{calibration:n,hasPixelSpacing:o}=t,i=o?"mm":Od;return n&&n.type?n.type===yd.UNCALIBRATED?Od:n.SequenceOfUltrasoundRegions?"US Region":`${i} ${n.type}`:i},Md=(e,t)=>{const{calibration:n,hasPixelSpacing:o}=t,i=(o?"mm":Od)+"";return n&&n.type?n.SequenceOfUltrasoundRegions?"US Region":`${i} ${n.type}`:i},xd=e=>e.calibration?.scale||1,Rd=e=>e.calibration?.aspect||1;function Nd(e){const t=function(e){const t=[e[0],e[1]].sort(r),n=[e[0],e[1]].sort(s),o=t[t.length-1],i=n[0],a=n[n.length-1];return{top:i,bottom:a,right:o};function r(e,t){return e[0]<t[0]?-1:1}function s(e,t){return e[1]<t[1]?-1:1}}(e),n=(t.top[1]+t.bottom[1])/2;return[t.right[0],n]}const{transformWorldToIndex:Ad}=te.utilities;class Ld extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:kd}}),this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles;let l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[1]),c={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},u=zl([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return u<=o||(l=a.worldToCanvas(s[2]),d=a.worldToCanvas(s[3]),c={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},u=zl([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]),u<=o)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),js(o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,a=t.data;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Ul(i,this.getToolName());js(i),this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i);const d=(0,te.getEnabledElement)(i),{renderingEngine:c}=d;Jr(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;if(void 0!==this.editData.handleIndex){const{points:e}=s.handles,t=$a.R3.distance(e[0],e[1]);if($a.R3.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],o=[...e[1]],i=$a.K4.create();$a.K4.set(i,t[1][0]-t[0][0],t[1][1]-t[1][0]);const a=$a.K4.create();$a.K4.set(a,-i[1],i[0]);const r=$a.K4.create();let l;$a.K4.set(r,o[0]-n[0],o[1]-n[0]),l=$a.K4.dot(r,a)>0?[n,o]:[o,n],s.handles.points=[t[0],t[1],l[0],l[1]]}}if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(d,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=(0,te.getEnabledElement)(o),{renderingEngine:a,viewport:r}=i,{worldToCanvas:s}=r,{annotation:l,viewportIdsToRender:d,handleIndex:c}=this.editData,{data:u}=l,h=n.world;u.handles.points[c]=[...h];const g=u.handles.points.map(s),m={start:{x:g[0][0],y:g[0][1]},end:{x:g[1][0],y:g[1][1]}},f=(g[2][0],g[2][1],g[3][0],g[3][1],$a.K4.distance(g[0],g[1])/3),p=m.start.x-m.end.x,v=m.start.y-m.end.y,E=Math.sqrt(p*p+v*v),w=p/E,I=v/E,C=(m.start.x+m.end.x)/2,T=(m.start.y+m.end.y)/2,b=C+f*I,_=T-f*w,D=C-f*I,S=T+f*w;u.handles.points[2]=r.canvasToWorld([b,_]),u.handles.points[3]=r.canvasToWorld([D,S]),l.invalidated=!0,Jr(a,d),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{renderingEngine:i}=o,{annotation:a,viewportIdsToRender:r,handleIndex:s,movingTextBox:l}=this.editData,{data:d}=a;if(l){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),a.invalidated=!0}else this._dragModifyHandle(e),a.invalidated=!0;Jr(i,r)},this._dragModifyHandle=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=(0,te.getEnabledElement)(o),{viewport:a}=i,{annotation:r,handleIndex:s}=this.editData,{data:l}=r,d=n.world,c=[a.worldToCanvas(l.handles.points[0]),a.worldToCanvas(l.handles.points[1]),a.worldToCanvas(l.handles.points[2]),a.worldToCanvas(l.handles.points[3])],u={start:{x:c[0][0],y:c[0][1]},end:{x:c[1][0],y:c[1][1]}},h={start:{x:c[2][0],y:c[2][1]},end:{x:c[3][0],y:c[3][1]}},g=[...d],m=a.worldToCanvas(g);if(0===s||1===s){const e=c[0===s?1:0],t=$a.K4.set($a.K4.create(),m[0]-e[0],m[1]-e[1]),n=$a.K4.set($a.K4.create(),c[s][0]-e[0],c[s][1]-e[1]);$a.K4.normalize(t,t),$a.K4.normalize(n,n);const o={start:{x:e[0],y:e[1]},end:{x:m[0],y:m[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(o,h))return;const i=e,r=this._getSignedAngle(n,t);let d=c[2][0],u=c[2][1],f=c[3][0],p=c[3][1];d-=i[0],u-=i[1],f-=i[0],p-=i[1];const v=d*Math.cos(r)-u*Math.sin(r),E=d*Math.sin(r)+u*Math.cos(r),w=f*Math.cos(r)-p*Math.sin(r),I=f*Math.sin(r)+p*Math.cos(r);d=v+i[0],u=E+i[1],f=w+i[0],p=I+i[1];const C=a.canvasToWorld([d,u]),T=a.canvasToWorld([f,p]);l.handles.points[s]=g,l.handles.points[2]=C,l.handles.points[3]=T}else{const e=2===s?3:2,t={longLineSegment:{start:u.start,end:u.end},shortLineSegment:{start:h.start,end:h.end}},n=$a.K4.subtract($a.K4.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),o=$a.K4.normalize($a.K4.create(),n),i=$a.K4.subtract($a.K4.create(),[m[0],m[1]],[c[s][0],c[s][1]]),r=$a.K4.length(i),d=this._getSignedAngle(o,i),f=Math.cos(d)*r,p=$a.K4.scaleAndAdd($a.K4.create(),[c[e][0],c[e][1]],o,f);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:m[0],y:m[1]},end:{x:p[0],y:p[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!ql([m[0],m[1]],[p[0],p[1]],[u.start.x,u.start.y],[u.end.x,u.end.y]))return;l.handles.points[e]=a.canvasToWorld(p),l.handles.points[s]=g}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:u}=d,{points:h,activeHandleIndex:g}=u.handles,m=h.map((e=>o.worldToCanvas(e)));l.annotationUID=c;const f=this.getStyle("lineWidth",l,d),p=this.getStyle("lineDash",l,d),v=this.getStyle("color",l,d),E=this.getStyle("shadow",l,d);if(u.cachedStats[r]&&null!=u.cachedStats[r].unit?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(u.cachedStats[r]={length:null,width:null,unit:null},this._calculateCachedStats(d,s,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let w;if(!Ue(c))continue;if(pe(d)||this.editData||null===g||(w=[m[g]]),w){or(t,c,"0",w,{color:v})}const I=`${c}-line-1`,C=`${c}-line-2`;ir(t,c,"0",m[0],m[1],{color:v,lineDash:p,lineWidth:f,shadow:E},I);ir(t,c,"1",m[2],m[3],{color:v,lineDash:p,lineWidth:f,shadow:E},C),n=!0;const T=this.getLinkedTextBoxStyle(l,d);if(!T.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const b=this.configuration.getTextLines(u,r);if(!b||0===b.length)continue;let _;u.handles.textBox.hasMoved||(_=Nd(m),u.handles.textBox.worldPosition=o.canvasToWorld(_));const D=o.worldToCanvas(u.handles.textBox.worldPosition),S=ur(t,c,"1",b,D,m,{},T),{x:y,y:O,width:P,height:M}=S;u.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([y,O]),topRight:o.canvasToWorld([y+P,O]),bottomLeft:o.canvasToWorld([y,O+M]),bottomRight:o.canvasToWorld([y+P,O+M])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{const n=$a.K4.create();$a.K4.set(n,t.end.x-t.start.x,t.end.y-t.start.y),$a.K4.normalize(n,n);const o={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!ql([o.start.x,o.start.y],[o.end.x,o.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,t,n)=>{const{data:o}=e,{viewportId:i,renderingEngineId:a}=n,r=o.handles.points[0],s=o.handles.points[1],l=o.handles.points[2],d=o.handles.points[3],{cachedStats:c}=o,u=Object.keys(c);for(let e=0;e<u.length;e++){const n=u[e],o=this.getTargetIdImage(n,t);if(!o)continue;const{imageData:i,dimensions:a}=o,h=xd(o),g=this._calculateLength(r,s)/h,m=this._calculateLength(l,d)/h,f=g>m?g:m,p=g>m?m:g,v=Ad(i,r),E=Ad(i,s),w=Ad(i,l),I=Ad(i,d);this._isInsideVolume(v,E,w,I,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[n]={length:f,width:p,unit:Pd(0,o)}}e.invalidated=!1;const h=re.ANNOTATION_MODIFIED,g={annotation:e,viewportId:i,renderingEngineId:a};return(0,te.triggerEvent)(te.eventTarget,h,g),c},this._isInsideVolume=(e,t,n,o,i)=>te.utilities.indexWithinDimensions(e,i)&&te.utilities.indexWithinDimensions(t,i)&&te.utilities.indexWithinDimensions(n,i)&&te.utilities.indexWithinDimensions(o,i),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=qr(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:u},data:{handles:{points:[[...i],[...i],[...i],[...i]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};Ev(g,o);const m=Ul(o,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(s,m),g}_calculateLength(e,t){const n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}}function kd(e,t){const{cachedStats:n}=e,{length:o,width:i,unit:a}=n[t];if(void 0===o)return;return[`L: ${rs(o)} ${a}`,`W: ${rs(i)} ${a}`]}Ld.toolName="Bidirectional";const Ud=Ld,{transformWorldToIndex:Vd}=te.utilities;class Bd extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Fd}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;js(o),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:u},data:{handles:{points:[[...i],[...i]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Ev(g,o);const m=Ul(o,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),Jr(s,m),g},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,[s,l]=r.handles.points,d=a.worldToCanvas(s),c=a.worldToCanvas(l),u={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}};return zl([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),js(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(d,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;Jr(d,i)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:u}=d,{points:h,activeHandleIndex:g}=u.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),f=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),v=this.getStyle("shadow",l,d),E=h.map((e=>o.worldToCanvas(e)));let w;if(u.cachedStats[r]&&null!=u.cachedStats[r].unit?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(u.cachedStats[r]={length:null,unit:null},this._calculateCachedStats(d,s,e)),!Ue(c))continue;if(pe(d)||this.editData||null===g||(w=[E[g]]),w){or(t,c,"0",E,{color:p,lineDash:f,lineWidth:m})}const I=`${c}-line`;if(ir(t,c,"1",E[0],E[1],{color:p,width:m,lineDash:f,shadow:v},I),n=!0,!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const C=this.getLinkedTextBoxStyle(l,d);if(!C.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(u,r);if(!u.handles.textBox.hasMoved){const e=Nd(E);u.handles.textBox.worldPosition=o.canvasToWorld(e)}const b=o.worldToCanvas(u.handles.textBox.worldPosition),_=ur(t,c,"1",T,b,E,{},C),{x:D,y:S,width:y,height:O}=_;u.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([D,S]),topRight:o.canvasToWorld([D+y,S]),bottomLeft:o.canvasToWorld([D,S+O]),bottomRight:o.canvasToWorld([D+y,S+O])}}return n},this._throttledCalculateCachedStats=qr(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Ul(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),js(i);const d=(0,te.getEnabledElement)(i),{renderingEngine:c}=d;Jr(c,l),e.preventDefault()}_calculateLength(e,t){const n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}_calculateCachedStats(e,t,n){const o=e.data,{viewportId:i,renderingEngineId:a}=n,r=o.handles.points[0],s=o.handles.points[1],{cachedStats:l}=o,d=Object.keys(l);for(let e=0;e<d.length;e++){const n=d[e],o=this.getTargetIdImage(n,t);if(!o)continue;const{imageData:i,dimensions:a}=o,c=xd(o),u=this._calculateLength(r,s)/c,h=Vd(i,r),g=Vd(i,s);this._isInsideVolume(h,g,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,l[n]={length:u,unit:Pd(0,o)}}e.invalidated=!1;const c=re.ANNOTATION_MODIFIED,u={annotation:e,viewportId:i,renderingEngineId:a};return(0,te.triggerEvent)(te.eventTarget,c,u),l}_isInsideVolume(e,t,n){return te.utilities.indexWithinDimensions(e,n)&&te.utilities.indexWithinDimensions(t,n)}}function Fd(e,t){const n=e.cachedStats[t],{length:o,unit:i}=n;if(null==o||isNaN(o))return;return[`${rs(o)} ${i}`]}Bd.toolName="Length";const Hd=Bd;function Wd(e,t,n){return"CT"===e?"HU":"PT"===e?function(e,t){if(!t.isPreScaled)return"raw";if(t.isSuvScaled)return"SUV";const n=te.metaData.get("generalSeriesModule",e);if("PT"===n?.modality){const t=te.metaData.get("petSeriesModule",e);return t?.units||"unitless"}}(t,n):""}function Gd(e,t){if(e instanceof te.BaseVolumeViewport){const e=t.split("volumeId:"),n=e.length>1?e[1]:e[0],o=te.cache.getVolume(n);return!!o?.scaling&&Object.keys(o.scaling).length>0}if(e instanceof te.StackViewport){const{preScale:t}=e.getImageData()||{};return!!t?.scaled}throw new Error("Viewport is not a valid type")}const{transformWorldToIndex:$d}=te.utilities;class zd extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Kd}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=r.getFrameOfReferenceUID(),g={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:u},data:{label:"",handles:{points:[[...i]]},cachedStats:{}}};Ev(g,o);const m=Ul(o,this.getToolName());return this.editData={annotation:g,newAnnotation:!0,viewportIdsToRender:m},this._activateModify(o),js(o),e.preventDefault(),Jr(s,m),g},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a}=this.editData,r=(0,te.getEnabledElement)(n),{renderingEngine:s}=r,{viewportId:l}=r;if(this.eventDispatchDetail={viewportId:l,renderingEngineId:s.id},this._deactivateModify(n),qs(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(s,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,{annotation:a,viewportIdsToRender:r}=this.editData,{data:s}=a;s.handles.points[0]=[...i],a.invalidated=!0;const l=(0,te.getEnabledElement)(o),{renderingEngine:d}=l;Jr(d,r)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],c=d.annotationUID,u=d.data,h=u.handles.points[0],g=o.worldToCanvas(h);l.annotationUID=c;const m=this.getStyle("color",l,d);if(u.cachedStats[r]&&null!=u.cachedStats[r].value){if(d.invalidated&&(this._calculateCachedStats(d,s,e),o instanceof te.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in u.cachedStats)if(t.startsWith("imageId")){s.getStackViewports().find((t=>{const n=te.utilities.imageIdToURI(e),o=t.hasImageURI(n),i=te.utilities.imageIdToURI(t.getCurrentImageId());return o&&i!==n}))&&delete u.cachedStats[t]}}}else u.cachedStats[r]={Modality:null,index:null,value:null},this._calculateCachedStats(d,s,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;or(t,c,"0",[g],{color:m}),n=!0;const f=this.getLinkedTextBoxStyle(l,d);if(!f.visibility)continue;const p=this.configuration.getTextLines(u,r);if(p){const e=[g[0]+6,g[1]-6];lr(t,c,"0",p,[e[0],e[1]],f)}}return n}}isPointNearTool(){return!1}toolSelectedCallback(){}getHandleNearImagePoint(e,t,n,o){const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,s=r.handles.points[0],l=a.worldToCanvas(s);if(!0===$a.K4.distance(n,l)<o)return s}handleSelectedCallback(e,t){const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i},this._activateModify(o),js(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),e.preventDefault()}_calculateCachedStats(e,t,n){const o=e.data,{viewportId:i,renderingEngineId:a,viewport:r}=n,s=o.handles.points[0],{cachedStats:l}=o,d=Object.keys(l);for(let n=0;n<d.length;n++){const o=d[n],c={isPreScaled:Gd(r,o),isSuvScaled:this.isSuvScaled(r,o,e.metadata.referencedImageId)},u=this.getTargetIdImage(o,t);if(!u)continue;const{dimensions:h,imageData:g,metadata:m}=u,f="getScalarData"in u?u.getScalarData():u.scalarData,p=m.Modality,v=$d(g,s);if(v[0]=Math.round(v[0]),v[1]=Math.round(v[1]),v[2]=Math.round(v[2]),te.utilities.indexWithinDimensions(v,h)){this.isHandleOutsideImage=!1;const t=h[0],n=h[0]*h[1],i=f[v[2]*n+v[1]*t+v[0]];if(o.startsWith("imageId:")){const e=o.split("imageId:")[1],t=te.utilities.imageIdToURI(e),n=te.utilities.getViewportsWithImageURI(t,a)[0];v[2]=n.getCurrentImageIdIndex()}const r=Wd(p,e.metadata.referencedImageId,c);l[o]={index:v,value:i,Modality:p,modalityUnit:r}}else this.isHandleOutsideImage=!0,l[o]={index:v,Modality:p};e.invalidated=!1;const E=re.ANNOTATION_MODIFIED,w={annotation:e,viewportId:i,renderingEngineId:a};(0,te.triggerEvent)(te.eventTarget,E,w)}return l}}function Kd(e,t){const n=e.cachedStats[t],{index:o,value:i,modalityUnit:a}=n;if(void 0===i)return;const r=[];return r.push(`(${o[0]}, ${o[1]}, ${o[2]})`),r.push(`${i.toFixed(2)} ${a}`),r}zd.toolName="Probe";const qd=zd;class jd extends qd{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Zd}}),this.postMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:u},data:{label:"",handles:{points:[[...i]]},cachedStats:{}}},g=Ul(o,this.getToolName());return this.editData={annotation:h,newAnnotation:!0,viewportIdsToRender:g},this._activateModify(o),js(o),e.preventDefault(),Jr(s,g),h},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e;if(!this.editData)return n;const i=this.filterInteractableAnnotationsForElement(o.element,[this.editData.annotation]);if(!i?.length)return n;const a=this.getTargetId(o),r=o.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=this.editData.annotation,d=l.annotationUID,c=l.data,u=c.handles.points[0],h=o.worldToCanvas(u);s.annotationUID=d;const g=this.getStyle("color",s,l);Gd(o,a),this.isSuvScaled(o,a,l.metadata.referencedImageId);if(c.cachedStats[a]&&null!=c.cachedStats[a].value?l.invalidated&&this._calculateCachedStats(l,r,e):(c.cachedStats[a]={Modality:null,index:null,value:null},this._calculateCachedStats(l,r,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;or(t,d,"0",[h],{color:g}),n=!0;const m=this.configuration.getTextLines(c,a);if(m){const e=[h[0]+6,h[1]-6];lr(t,d,"0",m,[e[0],e[1]],this.getLinkedTextBoxStyle(s,l))}return n}}}function Zd(e,t){const n=e.cachedStats[t],{index:o,value:i,modalityUnit:a}=n;if(void 0===i)return;const r=[];return r.push(`(${o[0]}, ${o[1]}, ${o[2]})`),r.push(`${i.toFixed(2)} ${a}`),r}jd.toolName="DragProbe";const Yd=jd;function Xd(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");const[n,o,i,a]=e;let r=655535;const s=function(e,t,n,o){return{top:[[e,t],[e+n,t]],right:[[e+n,t],[e+n,t+o]],bottom:[[e+n,t+o],[e,t+o]],left:[[e,t+o],[e,t]]}}(n,o,i,a);return Object.keys(s).forEach((e=>{const[n,o]=s[e],i=zl(n,o,t);i<r&&(r=i)})),r}const Jd=class{};class Qd extends Jd{}Qd.max=-1/0,Qd.currentMax=0,Qd.sum=0,Qd.sumSquares=0,Qd.squaredDiffSum=0,Qd.count=0,Qd.statsCallback=e=>{let{value:t}=e;t>Qd.max&&(Qd.max=t,Qd.currentMax=t),Qd.count+=1,Qd.sum+=t,Qd.sumSquares+=t**2,Qd.squaredDiffSum+=Math.pow(t-Qd.sum/Qd.count,2)},Qd.getStatistics=()=>{const e=Qd.sum/Qd.count,t=Math.sqrt(Qd.squaredDiffSum/Qd.count),n=Math.sqrt(Qd.sumSquares/Qd.count-e**2);return Qd.max=-1/0,Qd.sum=0,Qd.sumSquares=0,Qd.squaredDiffSum=0,Qd.count=0,[{name:"max",value:Qd.currentMax,unit:null},{name:"mean",value:e,unit:null},{name:"stdDev",value:t,unit:null},{name:"stdDevWithSumSquare",value:n,unit:null}]};const{transformWorldToIndex:ec}=te.utilities;class tc extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:nc,statsCalculator:Qd}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=r.getFrameOfReferenceUID(),g={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:u},data:{label:"",handles:{points:[[...i],[...i],[...i],[...i]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};Ev(g,o);const m=Ul(o,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(s,m),g},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles,l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[3]),c=this._getRectangleImageCoordinates([l,d]),u=[n[0],n[1]],{left:h,top:g,width:m,height:f}=c;return Xd([h,g,m,f],u)<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),js(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Ul(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),js(i);const d=(0,te.getEnabledElement)(i),{renderingEngine:c}=d;Jr(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(d,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world,{points:i}=s.handles;i.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,i=(0,te.getEnabledElement)(n),{worldToCanvas:r,canvasToWorld:l}=i.viewport,d=e.world,{points:c}=s.handles;let u,h,g,m,f,p,v,E;switch(c[a]=[...d],a){case 0:case 3:u=r(c[0]),m=r(c[3]),h=[m[0],u[1]],g=[u[0],m[1]],p=l(h),v=l(g),c[1]=p,c[2]=v;break;case 1:case 2:h=r(c[1]),g=r(c[2]),u=[g[0],h[1]],m=[h[0],g[1]],f=l(u),E=l(m),c[0]=f,c[3]=E}o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;Jr(d,i)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:u}=d,{points:h,activeHandleIndex:g}=u.handles,m=h.map((e=>o.worldToCanvas(e)));l.annotationUID=c;const f=this.getStyle("lineWidth",l,d),p=this.getStyle("lineDash",l,d),v=this.getStyle("color",l,d),{viewPlaneNormal:E,viewUp:w}=o.getCamera();if(u.cachedStats[r]&&null!=u.cachedStats[r].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,E,w,s,e),o instanceof te.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in u.cachedStats)if(t.startsWith("imageId")){s.getStackViewports().find((t=>{const n=te.utilities.imageIdToURI(e),o=t.hasImageURI(n),i=te.utilities.imageIdToURI(t.getCurrentImageId());return o&&i!==n}))&&delete u.cachedStats[t]}}}else u.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(d,E,w,s,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let I;if(!Ue(c))continue;if(pe(d)||this.editData||null===g||(I=[m[g]]),I){or(t,c,"0",I,{color:v})}const C=`${c}-rect`;hr(t,c,"0",m[0],m[3],{color:v,lineDash:p,lineWidth:f},C),n=!0;const T=this.getLinkedTextBoxStyle(l,d);if(!T.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const b=this.configuration.getTextLines(u,r);if(!b||0===b.length)continue;if(!u.handles.textBox.hasMoved){const e=Nd(m);u.handles.textBox.worldPosition=o.canvasToWorld(e)}const _=o.worldToCanvas(u.handles.textBox.worldPosition),D=ur(t,c,"1",b,_,m,{},T),{x:S,y,width:O,height:P}=D;u.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([S,y]),topRight:o.canvasToWorld([S+O,y]),bottomLeft:o.canvasToWorld([S,y+P]),bottomRight:o.canvasToWorld([S+O,y+P])}}return n},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,o,i)=>{const{data:a}=e,{viewportId:r,renderingEngineId:s,viewport:l}=i,d=a.handles.points[0],c=a.handles.points[3],{cachedStats:u}=a,h=Object.keys(u);for(let i=0;i<h.length;i++){const a=h[i],r=this.getTargetIdImage(a,o);if(!r)continue;const{dimensions:s,imageData:g,metadata:m}=r,f=("getScalarData"in r?r.getScalarData():r.scalarData,ec(g,d));f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]);const p=ec(g,c);if(p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(p[2]),this._isInsideVolume(f,p,s)){this.isHandleOutsideImage=!1;const o=[[Math.min(f[0],p[0]),Math.max(f[0],p[0])],[Math.min(f[1],p[1]),Math.max(f[1],p[1])],[Math.min(f[2],p[2]),Math.max(f[2],p[2])]],{worldWidth:i,worldHeight:s}=Tl(t,n,d,c),h=xd(r),v=Math.abs(i*s)/(h*h),E={isPreScaled:Gd(l,a),isSuvScaled:this.isSuvScaled(l,a,e.metadata.referencedImageId)},w=Wd(m.Modality,e.metadata.referencedImageId,E),I=ts(g,(()=>!0),this.configuration.statsCalculator.statsCallback,o),C=this.configuration.statsCalculator.getStatistics();u[a]={Modality:m.Modality,area:v,mean:C[1]?.value,stdDev:C[2]?.value,max:C[0]?.value,statsArray:C,pointsInShape:I,areaUnit:Md(0,r),modalityUnit:w}}else this.isHandleOutsideImage=!0,u[a]={Modality:m.Modality}}e.invalidated=!1;const g=re.ANNOTATION_MODIFIED,m={annotation:e,viewportId:r,renderingEngineId:s};return(0,te.triggerEvent)(te.eventTarget,g,m),u},this._isInsideVolume=(e,t,n)=>te.utilities.indexWithinDimensions(e,n)&&te.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=qr(this._calculateCachedStats,100,{trailing:!0})}}function nc(e,t){const n=e.cachedStats[t],{area:o,mean:i,max:a,stdDev:r,areaUnit:s,modalityUnit:l}=n;if(void 0===i)return;const d=[];return d.push(`Area: ${rs(o)} ${s}`),d.push(`Mean: ${rs(i)} ${l}`),d.push(`Max: ${rs(a)} ${l}`),d.push(`Std Dev: ${rs(r)} ${l}`),d}tc.toolName="RectangleROI";const oc=tc;function ic(e,t,n,o){const i=$a.R3.create();$a.R3.cross(i,t,e);const a=$a.R3.fromValues(...n),r=$a.R3.fromValues(...o),s=$a.R3.create();$a.R3.subtract(s,a,r);const l=$a.R3.length(s);if(l<1e-4)return{worldWidth:0,worldHeight:0};const d=$a.R3.dot(s,i)/(l*$a.R3.length(i));return{worldWidth:Math.sqrt(1-d*d)*l,worldHeight:d*l}}const{transformWorldToIndex:ac}=te.utilities;class rc extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:sc,statsCalculator:Qd}}),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(n.canvas,(0,te.getEnabledElement)(o)),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:u},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},cachedStats:{},initialRotation:r.getRotation()}};Ev(g,o);const m=Ul(o,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,centerWorld:i,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(s,m),g},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles,l=gs(s.map((e=>a.worldToCanvas(e)))),[d,c]=l,u={left:Math.min(d[0],c[0])+o/2,top:Math.min(d[1],c[1])+o/2,width:Math.abs(d[0]-c[0])-o,height:Math.abs(d[1]-c[1])-o},h={left:Math.min(d[0],c[0])-o/2,top:Math.min(d[1],c[1])-o/2,width:Math.abs(d[0]-c[0])+o,height:Math.abs(d[1]-c[1])+o},g=this._pointInEllipseCanvas(u,n);return!(!this._pointInEllipseCanvas(h,n)||g)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},js(o),this._activateModify(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s,l,d,c,u,h=!1;if(n.worldPosition)h=!0;else{const{points:e}=a.handles,{viewport:t}=(0,te.getEnabledElement)(i),{worldToCanvas:o,canvasToWorld:h}=t;r=e.findIndex((e=>e===n));const g=e.map(o);u=g[r],d=Math.abs(g[2][0]-g[3][0]),c=Math.abs(g[0][1]-g[1][1]),s=[(g[2][0]+g[3][0])/2,(g[0][1]+g[1][1])/2],l=h(s)}const g=Ul(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:g,handleIndex:r,canvasWidth:d,canvasHeight:c,centerWorld:l,originalHandleCanvas:u,movingTextBox:h},this._activateModify(i),js(i);const m=(0,te.getEnabledElement)(i),{renderingEngine:f}=m;Jr(f,g),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;o.highlighted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(d,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,te.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerWorld:u}=this.editData,h=s.worldToCanvas(u),{data:g}=d,m=Math.abs(i[0]-h[0]),f=Math.abs(i[1]-h[1]),p=[h[0],h[1]-f],v=[h[0],h[1]+f],E=[h[0]-m,h[1]],w=[h[0]+m,h[1]];g.handles.points=[l(p),l(v),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,Jr(r,c)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;Jr(d,i)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,{viewport:o}=(0,te.getEnabledElement)(n),{canvasToWorld:i,worldToCanvas:a}=o,{annotation:r,canvasWidth:s,canvasHeight:l,handleIndex:d,centerWorld:c,originalHandleCanvas:u}=this.editData,h=o.worldToCanvas(c),{data:g}=r,{points:m}=g.handles,{currentPoints:f}=t,p=f.canvas;if(0===d||1===d){const e=Math.abs(p[1]-h[1]),t=[h[0],h[1]-e],n=[h[0],h[1]+e];m[0]=i(t),m[1]=i(n);const o=s/2+(p[0]-u[0]),a=[h[0]-o,h[1]],r=[h[0]+o,h[1]];m[2]=i(a),m[3]=i(r)}else{const e=Math.abs(p[0]-h[0]),t=[h[0]-e,h[1]],n=[h[0]+e,h[1]];m[2]=i(t),m[3]=i(n);const o=l/2+(p[1]-u[1]),a=[h[0],h[1]-o],r=[h[0],h[1]+o];m[0]=i(a),m[1]=i(r)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:u}=d,{handles:h}=u,{points:g,activeHandleIndex:m}=h;l.annotationUID=c;const f=this.getStyle("lineWidth",l,d),p=this.getStyle("lineDash",l,d),v=this.getStyle("color",l,d),E=g.map((e=>o.worldToCanvas(e))),w=Math.abs(o.getRotation()-(u.initialRotation||0));let I;I=gs(90==w||270==w?[E[2],E[3],E[0],E[1]]:E);const{centerPointRadius:C}=this.configuration;if(u.cachedStats[r]&&null!=u.cachedStats[r].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,o,s,e),o instanceof te.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in u.cachedStats)if(t.startsWith("imageId")){s.getStackViewports().find((t=>{const n=te.utilities.imageIdToURI(e),o=t.hasImageURI(n),i=te.utilities.imageIdToURI(t.getCurrentImageId());return o&&i!==n}))&&delete u.cachedStats[t]}}}else u.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(d,o,s,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let T;if(!Ue(c))continue;if(pe(d)||this.editData||null===m||(T=[E[m]]),T){or(t,c,"0",T,{color:v})}const b=`${c}-ellipse`,_="0";if(nr(t,c,_,I[0],I[1],{color:v,lineDash:p,lineWidth:f},b),C>0){if(Math.min(Math.abs(I[0][0]-I[1][0])/2,Math.abs(I[0][1]-I[1][1])/2)>3*C){const e=this._getCanvasEllipseCenter(E);tr(t,c,`${_}-center`,e,C,{color:v,lineDash:p,lineWidth:f})}}n=!0;const D=this.getLinkedTextBoxStyle(l,d);if(!D.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const S=this.configuration.getTextLines(u,r);if(!S||0===S.length)continue;let y;u.handles.textBox.hasMoved||(y=Nd(I),u.handles.textBox.worldPosition=o.canvasToWorld(y));const O=o.worldToCanvas(u.handles.textBox.worldPosition),P=ur(t,c,"1",S,O,E,{},D),{x:M,y:x,width:R,height:N}=P;u.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([M,x]),topRight:o.canvasToWorld([M+R,x]),bottomLeft:o.canvasToWorld([M,x+N]),bottomRight:o.canvasToWorld([M+R,x+N])}}return n},this._calculateCachedStats=(e,t,n,o)=>{const i=e.data,{viewportId:a,renderingEngineId:r}=o,{points:s}=i.handles,l=s.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[u,h]=gs(l),g=t.canvasToWorld(u),m=t.canvasToWorld(h),{cachedStats:f}=i,p=Object.keys(f),v=g,E=m;for(let o=0;o<p.length;o++){const i=p[o],a=this.getTargetIdImage(i,n);if(!a)continue;const{dimensions:r,imageData:s,metadata:l,hasPixelSpacing:u}=a,h=ac(s,v);h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]);const w=ac(s,E);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(h,w,r)){const n=[[Math.min(h[0],w[0]),Math.max(h[0],w[0])],[Math.min(h[1],w[1]),Math.max(h[1],w[1])],[Math.min(h[2],w[2]),Math.max(h[2],w[2])]],o={center:[(g[0]+m[0])/2,(g[1]+m[1])/2,(g[2]+m[2])/2],xRadius:Math.abs(g[0]-m[0])/2,yRadius:Math.abs(g[1]-m[1])/2,zRadius:Math.abs(g[2]-m[2])/2},{worldWidth:r,worldHeight:u}=ic(d,c,v,E),p=0===r&&0===u,I=xd(a),C=Math.abs(Math.PI*(r/2)*(u/2))/I/I,T={isPreScaled:Gd(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},b=Wd(l.Modality,e.metadata.referencedImageId,T),_=ts(s,((e,t)=>hs(o,e)),this.configuration.statsCalculator.statsCallback,n),D=this.configuration.statsCalculator.getStatistics();f[i]={Modality:l.Modality,area:C,mean:D[1]?.value,max:D[0]?.value,stdDev:D[2]?.value,statsArray:D,pointsInShape:_,isEmptyArea:p,areaUnit:Md(0,a),modalityUnit:b}}else this.isHandleOutsideImage=!0,f[i]={Modality:l.Modality}}e.invalidated=!1;const w=re.ANNOTATION_MODIFIED,I={annotation:e,viewportId:a,renderingEngineId:r};return(0,te.triggerEvent)(te.eventTarget,w,I),f},this._isInsideVolume=(e,t,n)=>te.utilities.indexWithinDimensions(e,n)&&te.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=qr(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(e,t){const n=e.width/2,o=e.height/2;if(n<=0||o<=0)return!1;const i=[e.left+n,e.top+o],a=[t[0]-i[0],t[1]-i[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(o*o)<=1}_getCanvasEllipseCenter(e){const[t,n,o,i]=e,a=[o[0],n[1]],r=[i[0],t[1]];return[(a[0]+r[0])/2,(a[1]+r[1])/2]}}function sc(e,t){const n=e.cachedStats[t],{area:o,mean:i,stdDev:a,max:r,isEmptyArea:s,areaUnit:l,modalityUnit:d}=n,c=[];if(o){const e=s?"Area: Oblique not supported":`Area: ${rs(o)} ${l}`;c.push(e)}return i&&c.push(`Mean: ${rs(i)} ${d}`),r&&c.push(`Max: ${rs(r)} ${d}`),a&&c.push(`Std Dev: ${rs(a)} ${d}`),c}rc.toolName="EllipticalROI";const lc=rc,{transformWorldToIndex:dc}=te.utilities;class cc extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:uc,statsCalculator:Qd}}),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(n.canvas,(0,te.getEnabledElement)(o)),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:u},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...i],[...i]],activeHandleIndex:null},cachedStats:{}}};Ev(g,o);const m=Ul(o,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(s,m),g},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles,l=s.map((e=>a.worldToCanvas(e))),d=ld(l),c=ld([l[0],n]);return Math.abs(c-d)<o/2},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},js(o),this._activateModify(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;if(n.worldPosition)s=!0;else{const{points:e}=a.handles;r=e.findIndex((e=>e===n))}const l=Ul(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),js(i);const d=(0,te.getEnabledElement)(i),{renderingEngine:c}=d;Jr(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;o.highlighted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(d,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,te.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c}=this.editData,{data:u}=d;u.handles.points=[u.handles.points[0],l(i)],d.invalidated=!0,this.editData.hasMoved=!0,Jr(r,c)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;Jr(d,i)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{canvasToWorld:i,worldToCanvas:a}=o.viewport,{annotation:r,handleIndex:s}=this.editData,{data:l}=r,{points:d}=l.handles,c=d.map((e=>a(e))),{currentPoints:u}=t,h=u.canvas;if(0===s){const e=h[0]-c[0][0],t=h[1]-c[0][1],n=h,o=[c[1][0]+e,c[1][1]+t];d[0]=i(n),d[1]=i(o)}else d[1]=i(h)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:u}=d,{handles:h}=u,{points:g,activeHandleIndex:m}=h;l.annotationUID=c;const f=this.getStyle("lineWidth",l,d),p=this.getStyle("lineDash",l,d),v=this.getStyle("color",l,d),E=g.map((e=>o.worldToCanvas(e))),w=E[0],I=ld(E),C=dd(E),{centerPointRadius:T}=this.configuration;if(u.cachedStats[r]&&null!=u.cachedStats[r].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,o,s,e),o instanceof te.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in u.cachedStats)if(t.startsWith("imageId")){s.getStackViewports().find((t=>{const n=te.utilities.imageIdToURI(e),o=t.hasImageURI(n),i=te.utilities.imageIdToURI(t.getCurrentImageId());return o&&i!==n}))&&delete u.cachedStats[t]}}}else u.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(d,o,s,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!Ue(c))continue;if(pe(d)||this.editData||null===m||(b=[E[m]]),b){or(t,c,"0",b,{color:v})}const _="0";tr(t,c,_,w,I,{color:v,lineDash:p,lineWidth:f},`${c}-circle`),T>0&&I>3*T&&tr(t,c,`${_}-center`,w,T,{color:v,lineDash:p,lineWidth:f}),n=!0;const D=this.getLinkedTextBoxStyle(l,d);if(!D.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const S=this.configuration.getTextLines(u,r);if(!S||0===S.length)continue;let y;u.handles.textBox.hasMoved||(y=Nd(C),u.handles.textBox.worldPosition=o.canvasToWorld(y));const O=o.worldToCanvas(u.handles.textBox.worldPosition),P=ur(t,c,"1",S,O,E,{},D),{x:M,y:x,width:R,height:N}=P;u.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([M,x]),topRight:o.canvasToWorld([M+R,x]),bottomLeft:o.canvasToWorld([M,x+N]),bottomRight:o.canvasToWorld([M+R,x+N])}}return n},this._calculateCachedStats=(e,t,n,o)=>{const i=e.data,{viewportId:a,renderingEngineId:r}=o,{points:s}=i.handles,l=s.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[u,h]=dd(l),g=t.canvasToWorld(u),m=t.canvasToWorld(h),{cachedStats:f}=i,p=Object.keys(f),v=g,E=m;for(let o=0;o<p.length;o++){const i=p[o],a=this.getTargetIdImage(i,n);if(!a)continue;const{dimensions:r,imageData:s,metadata:l,hasPixelSpacing:u}=a,h=dc(s,v);h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]);const w=dc(s,E);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(h,w,r)){const n=[[Math.min(h[0],w[0]),Math.max(h[0],w[0])],[Math.min(h[1],w[1]),Math.max(h[1],w[1])],[Math.min(h[2],w[2]),Math.max(h[2],w[2])]],o={center:[(g[0]+m[0])/2,(g[1]+m[1])/2,(g[2]+m[2])/2],xRadius:Math.abs(g[0]-m[0])/2,yRadius:Math.abs(g[1]-m[1])/2,zRadius:Math.abs(g[2]-m[2])/2},{worldWidth:r,worldHeight:u}=ic(d,c,v,E),p=0===r&&0===u,I=xd(a),C=Rd(a),T=Math.abs(Math.PI*(r/I/2)*(u/C/I/2)),b={isPreScaled:Gd(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},_=Wd(l.Modality,e.metadata.referencedImageId,b),D=ts(s,((e,t)=>hs(o,e)),this.configuration.statsCalculator.statsCallback,n),S=this.configuration.statsCalculator.getStatistics();f[i]={Modality:l.Modality,area:T,mean:S[1]?.value,max:S[0]?.value,stdDev:S[2]?.value,statsArray:S,pointsInShape:D,isEmptyArea:p,areaUnit:Md(0,a),radius:r/2/I,radiusUnit:Pd(0,a),perimeter:2*Math.PI*(r/2)/I,modalityUnit:_}}else this.isHandleOutsideImage=!0,f[i]={Modality:l.Modality}}e.invalidated=!1;const w=re.ANNOTATION_MODIFIED,I={annotation:e,viewportId:a,renderingEngineId:r};return(0,te.triggerEvent)(te.eventTarget,w,I),f},this._isInsideVolume=(e,t,n)=>te.utilities.indexWithinDimensions(e,n)&&te.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=qr(this._calculateCachedStats,100,{trailing:!0})}}function uc(e,t){const n=e.cachedStats[t],{radius:o,radiusUnit:i,area:a,mean:r,stdDev:s,max:l,isEmptyArea:d,Modality:c,areaUnit:u,modalityUnit:h}=n,g=[];if(o){const e=d?"Radius: Oblique not supported":`Radius: ${rs(o)} ${i}`;g.push(e)}if(a){const e=d?"Area: Oblique not supported":`Area: ${rs(a)} ${u}`;g.push(e)}return r&&g.push(`Mean: ${rs(r)} ${h}`),l&&g.push(`Max: ${rs(l)} ${h}`),s&&g.push(`Std Dev: ${rs(s)} ${h}`),g}cc.toolName="CircleROI";const hc=cc;function gc(e,t,n){const o=[],i=function(e,t,n){let o,i;const a=[];arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(i=0,o=1):(i=e.length-1,o=0);for(let r=o;r<e.length;r++)pc(t,n,e[i],e[r])&&a.push([i,r]),i=r;return a}(e,t,n,!(arguments.length>3&&void 0!==arguments[3])||arguments[3]);for(let a=0;a<i.length;a++){const r=wc(t,n,e[i[a][0]],e[i[a][1]]);o.push(r)}return o}function mc(e,t,n){let o,i;!(arguments.length>3&&void 0!==arguments[3])||arguments[3]?(i=e.length-1,o=0):(i=0,o=1);for(let a=o;a<e.length;a++){if(pc(t,n,e[i],e[a]))return[i,a];i=a}}function fc(e,t,n){let o,i;!(arguments.length>3&&void 0!==arguments[3])||arguments[3]?(i=e.length-1,o=0):(i=0,o=1);const a=[];for(let r=o;r<e.length;r++){const o=e[i],s=e[r];pc(t,n,o,s)&&a.push([i,r]),i=r}if(0===a.length)return;const r=[];a.forEach((n=>{const o=[e[n[0]],e[n[1]]],i=[(o[0][0]+o[1][0])/2,(o[0][1]+o[1][1])/2];r.push($a.K4.distance(i,t))}));const s=Math.min(...r);return{segment:a[r.indexOf(s)],distance:s}}function pc(e,t,n,o){let i=!1;const a=[vc(e,t,n),vc(e,t,o),vc(n,o,e),vc(n,o,t)];return a[0]!==a[1]&&a[2]!==a[3]||((0===a[0]&&Ec(e,n,t)||0===a[1]&&Ec(e,o,t)||0===a[2]&&Ec(n,e,o)||0===a[3]&&Ec(n,t,o))&&(i=!0),i)}function vc(e,t,n){const o=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===o?0:o>0?1:2}function Ec(e,t,n){return t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1])}function wc(e,t,n,o){const i=(o[1]-n[1])*(t[0]-e[0])-(o[0]-n[0])*(t[1]-e[1]);if(0==i)return;let a=e[1]-n[1],r=e[0]-n[0];const s=(o[0]-n[0])*a-(o[1]-n[1])*r,l=(t[0]-e[0])*a-(t[1]-e[1])*r;a=s/i,r=l/i;return[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}const Ic=.001,Cc=(e,t)=>{let n,o,i;if(e instanceof te.StackViewport){const t=e.getImageData();o=t.direction.slice(0,3),i=t.direction.slice(3,6),n=t.spacing}else{const t=e.getImageData(),{direction:a,spacing:r}=t,{viewPlaneNormal:s,viewUp:l}=e.getCamera(),d=a.slice(0,3),c=a.slice(3,6),u=a.slice(6,9),h=$a.R3.create();$a.R3.cross(h,l,s);const g=Math.abs($a.R3.dot(h,d)),m=Math.abs($a.R3.dot(h,c)),f=Math.abs($a.R3.dot(h,u));let p;if(Math.abs(1-g)<Ic)p=r[0],o=d;else if(Math.abs(1-m)<Ic)p=r[1],o=c;else{if(!(Math.abs(1-f)<Ic))throw new Error("No support yet for oblique plane planar contours");p=r[2],o=u}const v=Math.abs($a.R3.dot(l,d)),E=Math.abs($a.R3.dot(l,c)),w=Math.abs($a.R3.dot(l,u));let I;if(Math.abs(1-v)<Ic)I=r[0],i=d;else if(Math.abs(1-E)<Ic)I=r[1],i=c;else{if(!(Math.abs(1-w)<Ic))throw new Error("No support yet for oblique plane planar contours");I=r[2],i=u}n=[p,I]}return{spacing:[n[0]/t,n[1]/t],xDir:o,yDir:i}},Tc=(e,t,n)=>$a.K4.dist(e,t)<n,bc=(e,t,n,o)=>{const{xDir:i,yDir:a,spacing:r}=o,s=(0,te.getEnabledElement)(e),{viewport:l}=s,d=l.canvasToWorld(t[t.length-1]),c=l.canvasToWorld(n),u=$a.R3.create();$a.R3.subtract(u,c,d);const h=Math.abs($a.R3.dot(u,i)),g=Math.abs($a.R3.dot(u,a)),m=Math.max(Math.floor(h/r[0]),Math.floor(g/r[0]));if(m>1){const e=t[t.length-1],o=$a.K4.dist(e,n),i=$a.K4.create();$a.K4.subtract(i,n,e),$a.K4.set(i,i[0]/o,i[1]/o);const a=o/m;for(let n=1;n<=m;n++)t.push([e[0]+a*i[0]*n,e[1]+a*i[1]*n])}else t.push(n);return m},_c=(e,t,n,o)=>{const i=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],r=i[0]*a[0]+i[1]*a[1];if(r<0)return!1;const s=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===s)return!1;const l=r/s,d=[a[0]/s,a[1]/s],c=[d[0]*l,d[1]*l],u=[t[0]+c[0],t[1]+c[1]];return!($a.K4.distance(e,u)>o)&&!($a.K4.distance(t,u)>$a.K4.distance(t,n))};function Dc(e){const t=e.length;let n=0,o=t-1;for(let i=0;i<t;i++)n+=(e[o][0]+e[i][0])*(e[o][1]-e[i][1]),o=i;return Math.abs(n/2)}var Sc=n(22791),yc=n(47294);function Oc(e,t,n,o){const i=n-t+1,a=Math.floor(o/100*i)??1,r=Math.floor(i/a)??1;if(isNaN(i)||!i||!r)return e;if(i/r<2)return e;const s=Math.max(0,t),l=Math.min(e.length-1,n),d=e.slice(0,s),c=e.slice(l+1,e.length),u=function(e,t){if(!t||0===t.length||t.length===e.length)return e;const n=t[t.length-1]-t[0]+1,o=(0,Sc.nH)(t.map((t=>e[t][0]))),i=(0,Sc.nH)(t.map((t=>e[t][1])));if(a=e,3===a[0]?.length){const a=(0,Sc.nH)(t.map((t=>e[t][2])));return(0,yc.$R)((0,Sc.q$)(o,n),(0,Sc.q$)(i,n),(0,Sc.q$)(a,n))}return(0,yc.$R)((0,Sc.q$)(o,n),(0,Sc.q$)(i,n));var a}(e,function(e,t){const n=[],[o,i]=t,a=i-o+1,r=Math.floor(a/e);let s=0,l=Math.round((a-1)/(r-1)*s)+o;for(;l<=i;)n.push(l),s++,l=Math.round((a-1)/(r-1)*s)+o;return n}(r,[s,l]));return[...d,...u,...c]}function Pc(e){return!0===e?.interpolation?.interpolateOnAdd||!0===e?.interpolation?.interpolateOnEdit}function Mc(e,t,n){return(e+t+n)%t}function xc(e,t,n,o){const[,i,a]=e,[,r,s]=t,l=a.length,d=s.length;let c=e[0],u=t[0];if(!(a[c]&&s[u]&&a[i]&&s[r]))return[void 0,void 0];for(;c!==i&&u!==r;){if(n(s[u],a[c]))return[c,u];c=Mc(c,l,o),u=Mc(u,d,o)}return[void 0,void 0]}function Rc(e,t){const[n,o]=function(e,t){for(let i=0;i<e.length;i++)for(let a=0;a<t.length;a++)if(n=e[i],o=t[a],0===sd(n,o))return[i,a];var n,o}(e,t)||[],i=(e,t)=>!1===function(e,t){return sd(e,t)<.001}(e,t),[a,r]=xc([Mc(n,e.length,1),n,e],[Mc(o,t.length,1),o,t],i,1),[s]=xc([Mc(a,e.length,-1),a,e],[Mc(r,t.length,-1),r,t],i,-1);return[a,s]}function Nc(e,t,n){const{interpolation:o}=e,i=t;if(o){const{knotsRatioPercentageOnAdd:e,knotsRatioPercentageOnEdit:i,interpolateOnAdd:a=!1,interpolateOnEdit:r=!1}=o,s=n?i:e;if(n?r:a){const[e,o]=n?Rc(t,n):[0,t.length-1];return t[e]&&t[o]?Oc(t,e,o,s):t}}return i}function Ac(e,t){const n=e[0],o=e[e.length-1],i=$a.K4.create();$a.K4.set(i,o[0]-n[0],o[1]-n[1]),$a.K4.normalize(i,i);const a=$a.K4.create(),r=$a.K4.create();$a.K4.set(a,-i[1],i[0]),$a.K4.set(r,i[1],-i[0]);const s=[(n[0]+o[0])/2,(n[1]+o[1])/2],l={dist:0,index:null};for(let t=0;t<e.length;t++){const n=e[t],o=$a.K4.dist(n,s);o>l.dist&&(l.dist=o,l.index=t)}return[e[l.index],s].map(t.canvasToWorld)}const{addCanvasPointsToArray:Lc,pointsAreWithinCloseContourProximity:kc,getFirstIntersectionWithPolyline:Uc,getSubPixelSpacingAndXYDirections:Vc}=R;function Bc(e,t,n){this.isDrawing=!0;const o=e.detail,{currentPoints:i,element:a}=o,r=i.canvas,s=(0,te.getEnabledElement)(a),{viewport:l}=s,{spacing:d,xDir:c,yDir:u}=Vc(l,this.configuration.subPixelResolution);this.drawData={canvasPoints:[r],polylineIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:c,yDir:u,movingTextBox:!1},Ze.isInteractingWithTool=!0,a.addEventListener(re.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(re.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(re.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(re.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(re.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(re.TOUCH_TAP,this.mouseUpDrawCallback),js(a)}function Fc(e){Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this.mouseUpDrawCallback),e.removeEventListener(re.MOUSE_DRAG,this.mouseDragDrawCallback),e.removeEventListener(re.MOUSE_CLICK,this.mouseUpDrawCallback),e.removeEventListener(re.TOUCH_END,this.mouseUpDrawCallback),e.removeEventListener(re.TOUCH_DRAG,this.mouseDragDrawCallback),e.removeEventListener(re.TOUCH_TAP,this.mouseUpDrawCallback),qs(e)}function Hc(e){const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,te.getEnabledElement)(o),{renderingEngine:s,viewport:l}=r,{annotation:d,viewportIdsToRender:c,xDir:u,yDir:h,spacing:g,movingTextBox:m}=this.commonData,{polylineIndex:f,canvasPoints:p}=this.drawData,v=p[p.length-1],E=l.canvasToWorld(v),w=$a.R3.create();$a.R3.subtract(w,i,E);const I=Math.abs($a.R3.dot(w,u)),C=Math.abs($a.R3.dot(w,h));if(!(I<=g[0]&&C<=g[1])){if(m){this.isDrawing=!1;const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.data.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else{const t=this.findCrossingIndexDuringCreate(e);if(void 0!==t)this.applyCreateOnCross(e,t);else{const e=Lc(o,p,a,this.commonData);this.drawData.polylineIndex=f+e}}Jr(s,c)}}function Wc(e){const{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,o=n[0],i=n[n.length-1],a=e.detail,{element:r}=a;t&&!kc(o,i,this.configuration.closeContourProximity)?this.completeDrawOpenContour(r):this.completeDrawClosedContour(r)}function Gc(e){this.removeCrossedLinesOnCompleteDraw();const{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;const{annotation:n,viewportIdsToRender:o}=this.commonData,i=(0,te.getEnabledElement)(e),{viewport:a,renderingEngine:r}=i;Lc(e,t,t[0],this.commonData),t.pop();const s=(Pc(this.configuration)?Nc(this.configuration,t):t).map((e=>a.canvasToWorld(e)));n.data.polyline=s,n.data.isOpenContour=!1;const{textBox:l}=n.data.handles;return l.hasMoved||this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,Jr(r,o),this.deactivateDraw(e),!0}function $c(){const{canvasPoints:e}=this.drawData,t=e.length,n=[e[0],e[t-1]],o=e.slice(0,-1).slice(1),i=Uc(o,n[0],n[1],!1);if(i){const t=i[1];this.drawData.canvasPoints=e.splice(0,t)}}function zc(e){const{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;const{annotation:n,viewportIdsToRender:o}=this.commonData,i=(0,te.getEnabledElement)(e),{viewport:a,renderingEngine:r}=i,s=(Pc(this.configuration)?Nc(this.configuration,t):t).map((e=>a.canvasToWorld(e)));n.data.polyline=s,n.data.isOpenContour=!0;const{textBox:l}=n.data.handles;return n.data.handles.points=[s[0],s[s.length-1]],n.data.isOpenUShapeContour&&(n.data.openUShapeContourVectorToPeak=Ac(t,a)),l.hasMoved||this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,Jr(r,o),this.deactivateDraw(e),!0}function Kc(e){const t=e.detail,{currentPoints:n,lastPoints:o}=t,i=n.canvas,a=o.canvas,{canvasPoints:r}=this.drawData,s=r.slice(0,-1),l=Uc(s,i,a,!1);if(void 0===l)return;return l[0]}function qc(e,t){const n=e.detail,{element:o}=n,{canvasPoints:i}=this.drawData,{annotation:a,viewportIdsToRender:r}=this.commonData;Lc(o,i,i[t],this.commonData),i.pop();for(let e=0;e<t;e++)i.shift();this.completeDrawClosedContour(o)&&this.activateClosedContourEdit(e,a,r)}function jc(e){const{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,o=n[0],i=n[n.length-1];t&&!kc(o,i,this.configuration.closeContourProximity)?this.completeDrawOpenContour(e):this.completeDrawClosedContour(e)}function Zc(e,t){const{subPixelResolution:n}=this.configuration;if(function(e,t){const n=Math.max(3*t,3);return e.length<n}(t,n)){const{annotation:t,viewportIdsToRender:n}=this.commonData,o=(0,te.getEnabledElement)(e),{renderingEngine:i}=o;return Iv(t.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,Jr(i,n),this.deactivateDraw(e),!0}return!1}const Yc=function(e){e.activateDraw=Bc.bind(e),e.deactivateDraw=Fc.bind(e),e.applyCreateOnCross=qc.bind(e),e.findCrossingIndexDuringCreate=Kc.bind(e),e.completeDrawOpenContour=zc.bind(e),e.removeCrossedLinesOnCompleteDraw=$c.bind(e),e.mouseDragDrawCallback=Hc.bind(e),e.mouseUpDrawCallback=Wc.bind(e),e.completeDrawClosedContour=Gc.bind(e),e.cancelDrawing=jc.bind(e),e.haltDrawing=Zc.bind(e)},{addCanvasPointsToArray:Xc,getFirstIntersectionWithPolyline:Jc}=R;function Qc(e,t){const n=e.detail,{element:o,currentPoints:i,lastPoints:a}=n,r=i.canvas,s=a.canvas,{editCanvasPoints:l,prevCanvasPoints:d}=this.editData,c=Jc(d,r,s,t);if(c)this.editData.startCrossingIndex=c[0],this.removePointsUpUntilFirstCrossing(t);else if(d.length>=2)if(l.length>this.configuration.checkCanvasEditFallbackProximity){const e=l[0],t=[];for(let n=0;n<d.length;n++){const o=d[n],i=$a.K4.distance(o,e);t.push({distance:i,index:n})}t.sort(((e,t)=>e.distance-t.distance));const n=[t[0],t[1]],o=Math.min(n[0].index,n[1].index);this.editData.startCrossingIndex=o}else{const e=$a.K4.create();$a.K4.subtract(e,l[1],l[0]),$a.K4.normalize(e,e);const n=6,i=[l[0][0]-e[0]*n,l[0][1]-e[1]*n],a=Jc(d,i,l[0],t);if(a){const e=[i];Xc(o,e,l[0],this.commonData),l.unshift(...e),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=l.length-1,this.editData.startCrossingIndex=a[0]}}}function eu(e){const{editCanvasPoints:t,prevCanvasPoints:n}=this.editData;let o=0;for(let i=0;i<t.length-1;i++){const a=[t[i],t[i+1]];if(o++,!!Jc(n,a[0],a[1],e))break}t.splice(0,o),this.editData.editIndex=t.length-1}function tu(e,t){const n=e.detail,{currentPoints:o,lastPoints:i}=n,a=o.canvas,r=i.canvas,{prevCanvasPoints:s}=this.editData;return!!Jc(s,a,r,t)}function nu(e){const{prevCanvasPoints:t,editCanvasPoints:n}=this.editData;for(let o=n.length-1;o>0;o--){const i=[n[o],n[o-1]],a=!!Jc(t,i[0],i[1],e);if(n.pop(),a)break}}function ou(){const{editCanvasPoints:e,prevCanvasPoints:t,startCrossingIndex:n}=this.editData;if(void 0===n)return;const o=e[e.length-1],i=[];for(let e=0;e<t.length;e++){const n=t[e],a=$a.K4.distance(n,o);i.push({distance:a,index:e})}i.sort(((e,t)=>e.distance-t.distance));const a=e.slice(0,-1);for(let n=0;n<i.length;n++){const{index:o}=i[n],r=t[o],s=e[e.length-1];if(!Jc(a,r,s,!1))return o}return-1}function iu(e){const t=e.detail,{currentPoints:n,lastPoints:o}=t,i=n.canvas,a=o.canvas,{editCanvasPoints:r}=this.editData,s=r.slice(0,-2),l=Jc(s,i,a,!1);if(!l)return;const d=l[0],c=r.length-d;for(let e=0;e<c;e++)r.pop()}const au=function(e){e.checkForFirstCrossing=Qc.bind(e),e.removePointsUpUntilFirstCrossing=eu.bind(e),e.checkForSecondCrossing=tu.bind(e),e.findSnapIndex=ou.bind(e),e.removePointsAfterSecondCrossing=nu.bind(e),e.checkAndRemoveCrossesOnEditLine=iu.bind(e)},{getSubPixelSpacingAndXYDirections:ru,addCanvasPointsToArray:su,calculateAreaOfPoints:lu}=R;function du(e,t,n){this.isEditingClosed=!0;const o=e.detail,{currentPoints:i,element:a}=o,r=i.canvas,s=(0,te.getEnabledElement)(a),{viewport:l}=s,d=t.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:u,yDir:h}=ru(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[r],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:u,yDir:h,movingTextBox:!1},Ze.isInteractingWithTool=!0,a.addEventListener(re.MOUSE_UP,this.mouseUpClosedContourEditCallback),a.addEventListener(re.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(re.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),a.addEventListener(re.TOUCH_END,this.mouseUpClosedContourEditCallback),a.addEventListener(re.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(re.TOUCH_TAP,this.mouseUpClosedContourEditCallback),js(a)}function cu(e){Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this.mouseUpClosedContourEditCallback),e.removeEventListener(re.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(re.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),e.removeEventListener(re.TOUCH_END,this.mouseUpClosedContourEditCallback),e.removeEventListener(re.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(re.TOUCH_TAP,this.mouseUpClosedContourEditCallback),qs(e)}function uu(e){const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,te.getEnabledElement)(o),{renderingEngine:s,viewport:l}=r,{viewportIdsToRender:d,xDir:c,yDir:u,spacing:h}=this.commonData,{editIndex:g,editCanvasPoints:m,startCrossingIndex:f}=this.editData,p=m[m.length-1],v=l.canvasToWorld(p),E=$a.R3.create();$a.R3.subtract(E,i,v);const w=Math.abs($a.R3.dot(E,c)),I=Math.abs($a.R3.dot(E,u));if(w<=h[0]&&I<=h[1])return;void 0!==f&&this.checkAndRemoveCrossesOnEditLine(e);const C=g+su(o,m,a,this.commonData);this.editData.editIndex=C,void 0===f&&m.length>1&&this.checkForFirstCrossing(e,!0),this.editData.snapIndex=this.findSnapIndex(),-1!==this.editData.snapIndex?(this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(e),void 0!==f&&this.checkForSecondCrossing(e,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(e)),Jr(s,d)):this.finishEditAndStartNewEdit(e)}function hu(e){const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{viewport:i,renderingEngine:a}=o,{annotation:r,viewportIdsToRender:s}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:d}=this.editData,c=l.map((e=>i.canvasToWorld(e)));r.data.polyline=c,r.data.isOpenContour=!1,this.triggerAnnotationModified(r,o);const u=d.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[u],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0},Jr(a,s)}function gu(e){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:o,snapIndex:i}=this.editData;if(void 0===o||void 0===i)return;const a=e.detail,{element:r}=a,s=[...n];let l,d;su(r,s,t[i],this.commonData),s.length>n.length&&s.pop(),o>i?(l=i,d=o):(l=o,d=i);const c=$a.K4.distance(t[l],s[0]),u=$a.K4.distance(t[l],s[s.length-1]),h=$a.K4.distance(t[d],s[0]),g=$a.K4.distance(t[d],s[s.length-1]),m=[];for(let e=0;e<l;e++){const n=t[e];m.push([n[0],n[1]])}let f=c+g,p=u+h;if(f<p)for(let e=0;e<s.length;e++){const t=s[e];m.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];m.push([t[0],t[1]])}for(let e=d;e<t.length;e++){const n=t[e];m.push([n[0],n[1]])}const v=[];for(let e=l;e<d;e++){const n=t[e];v.push([n[0],n[1]])}if(f=h+u,p=g+c,f<p)for(let e=0;e<s.length;e++){const t=s[e];v.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];v.push([t[0],t[1]])}return lu(m)>lu(v)?m:v}function mu(e){const t=e.detail,{element:n}=t;this.completeClosedContourEdit(n)}function fu(e){const t=(0,te.getEnabledElement)(e),{viewport:n,renderingEngine:o}=t,{annotation:i,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:r,prevCanvasPoints:s}=this.editData;if(r){const e=(Pc(this.configuration)?Nc(this.configuration,r,s):r).map((e=>n.canvasToWorld(e)));i.data.polyline=e,i.data.isOpenContour=!1,i.invalidated=!0,this.triggerAnnotationModified(i,t)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,Jr(o,a),this.deactivateClosedContourEdit(e)}function pu(e){this.completeClosedContourEdit(e)}const vu=function(e){e.activateClosedContourEdit=du.bind(e),e.deactivateClosedContourEdit=cu.bind(e),e.mouseDragClosedContourEditCallback=uu.bind(e),e.mouseUpClosedContourEditCallback=mu.bind(e),e.finishEditAndStartNewEdit=hu.bind(e),e.fuseEditPointsWithClosedContour=gu.bind(e),e.cancelClosedContourEdit=pu.bind(e),e.completeClosedContourEdit=fu.bind(e)},{addCanvasPointsToArray:Eu,getSubPixelSpacingAndXYDirections:wu}=R;function Iu(e,t,n){this.isEditingOpen=!0;const o=e.detail,{currentPoints:i,element:a}=o,r=i.canvas,s=(0,te.getEnabledElement)(a),{viewport:l}=s,d=t.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:u,yDir:h}=wu(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[r],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:u,yDir:h,movingTextBox:!1},Ze.isInteractingWithTool=!0,a.addEventListener(re.MOUSE_UP,this.mouseUpOpenContourEditCallback),a.addEventListener(re.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(re.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),a.addEventListener(re.TOUCH_END,this.mouseUpOpenContourEditCallback),a.addEventListener(re.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(re.TOUCH_TAP,this.mouseUpOpenContourEditCallback),js(a)}function Cu(e){Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this.mouseUpOpenContourEditCallback),e.removeEventListener(re.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(re.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),e.removeEventListener(re.TOUCH_END,this.mouseUpOpenContourEditCallback),e.removeEventListener(re.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(re.TOUCH_TAP,this.mouseUpOpenContourEditCallback),qs(e)}function Tu(e){const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,te.getEnabledElement)(o),{renderingEngine:s,viewport:l}=r,{viewportIdsToRender:d,xDir:c,yDir:u,spacing:h}=this.commonData,{editIndex:g,editCanvasPoints:m,startCrossingIndex:f}=this.editData,p=m[m.length-1],v=l.canvasToWorld(p),E=$a.R3.create();$a.R3.subtract(E,i,v);const w=Math.abs($a.R3.dot(E,c)),I=Math.abs($a.R3.dot(E,u));if(w<=h[0]&&I<=h[1])return;void 0!==f&&this.checkAndRemoveCrossesOnEditLine(e);const C=g+Eu(o,m,a,this.commonData);this.editData.editIndex=C,void 0===f&&m.length>1&&this.checkForFirstCrossing(e,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(e),void 0!==f&&this.checkForSecondCrossing(e,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(e)):this.checkIfShouldOverwriteAnEnd(e)&&this.openContourEditOverwriteEnd(e),Jr(s,d)}function bu(e){const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{viewport:i}=o,{annotation:a,viewportIdsToRender:r}=this.commonData,s=this.fuseEditPointsForOpenContourEndEdit().map((e=>i.canvasToWorld(e)));a.data.polyline=s,a.data.isOpenContour=!0,a.data.handles.points=[s[0],s[s.length-1]],a.data.handles.activeHandleIndex=1,this.triggerAnnotationModified(a,o),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.deactivateOpenContourEdit(n),this.activateOpenContourEndEdit(e,a,r,null)}function _u(e){const t=e.detail,{currentPoints:n,lastPoints:o}=t,i=n.canvas,a=o.canvas,{snapIndex:r,prevCanvasPoints:s,startCrossingIndex:l}=this.editData;if(void 0===l||void 0===r)return!1;if(-1===r)return!0;if(0!==r&&r!==s.length-1)return!1;const d=i,c=a,u=s[r],h=$a.K4.create(),g=$a.K4.create();$a.K4.set(h,d[0]-c[0],d[1]-c[1]),$a.K4.set(g,d[0]-u[0],d[1]-u[1]);const m=$a.K4.dot(h,g),f=Math.sqrt(h[0]*h[0]+h[1]*h[1]),p=Math.sqrt(g[0]*g[0]+g[1]*g[1]);return Math.acos(m/(f*p))<Math.PI/2}function Du(){const{snapIndex:e,prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:o}=this.editData,i=[];if(0===e)for(let e=t.length-1;e>=o;e--){const n=t[e];i.push([n[0],n[1]])}else for(let e=0;e<o;e++){const n=t[e];i.push([n[0],n[1]])}if($a.K4.distance(t[o],n[0])<$a.K4.distance(t[o],n[n.length-1]))for(let e=0;e<n.length;e++){const t=n[e];i.push([t[0],t[1]])}else for(let e=n.length-1;e>=0;e--){const t=n[e];i.push([t[0],t[1]])}return i}function Su(e){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:o,snapIndex:i}=this.editData;if(void 0===o||void 0===i)return;const a=e.detail,{element:r}=a,s=[...n];let l,d;Eu(r,s,t[i],this.commonData),s.length>n.length&&s.pop(),o>i?(l=i,d=o):(l=o,d=i);const c=$a.K4.distance(t[l],s[0]),u=$a.K4.distance(t[l],s[s.length-1]),h=$a.K4.distance(t[d],s[0]),g=$a.K4.distance(t[d],s[s.length-1]),m=[];for(let e=0;e<l;e++){const n=t[e];m.push([n[0],n[1]])}if(c+g<u+h)for(let e=0;e<s.length;e++){const t=s[e];m.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];m.push([t[0],t[1]])}for(let e=d;e<t.length;e++){const n=t[e];m.push([n[0],n[1]])}return m}function yu(e){const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{viewport:i,renderingEngine:a}=o,{annotation:r,viewportIdsToRender:s}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:d}=this.editData,c=l.map((e=>i.canvasToWorld(e)));r.data.polyline=c,r.data.isOpenContour=!0,r.data.handles.points=[c[0],c[c.length-1]],this.triggerAnnotationModified(r,o);const u=d.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[u],startCrossingIndex:void 0,editIndex:0},Jr(a,s)}function Ou(e){const t=e.detail,{element:n}=t;this.completeOpenContourEdit(n)}function Pu(e){const t=(0,te.getEnabledElement)(e),{viewport:n,renderingEngine:o}=t,{annotation:i,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:r,prevCanvasPoints:s}=this.editData;if(r){const e=(Pc(this.configuration)?Nc(this.configuration,r,s):r).map((e=>n.canvasToWorld(e)));i.data.polyline=e,i.data.isOpenContour=!0,i.data.handles.points=[e[0],e[e.length-1]],i.data.isOpenUShapeContour&&(i.data.openUShapeContourVectorToPeak=Ac(r,n)),i.invalidated=!0,this.triggerAnnotationModified(i,t)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,Jr(o,a),this.deactivateOpenContourEdit(e)}function Mu(e){this.completeOpenContourEdit(e)}const xu=function(e){e.activateOpenContourEdit=Iu.bind(e),e.deactivateOpenContourEdit=Cu.bind(e),e.mouseDragOpenContourEditCallback=Tu.bind(e),e.mouseUpOpenContourEditCallback=Ou.bind(e),e.fuseEditPointsWithOpenContour=Su.bind(e),e.finishEditOpenOnSecondCrossing=yu.bind(e),e.checkIfShouldOverwriteAnEnd=_u.bind(e),e.fuseEditPointsForOpenContourEndEdit=Du.bind(e),e.openContourEditOverwriteEnd=bu.bind(e),e.cancelOpenContourEdit=Mu.bind(e),e.completeOpenContourEdit=Pu.bind(e)},{getSubPixelSpacingAndXYDirections:Ru}=R;function Nu(e,t,n,o){this.isDrawing=!0;const i=e.detail,{element:a}=i,r=(0,te.getEnabledElement)(a),{viewport:s}=r,{spacing:l,xDir:d,yDir:c}=Ru(s,this.configuration.subPixelResolution),u=t.data.polyline.map(s.worldToCanvas);0===t.data.handles.activeHandleIndex&&u.reverse();let h=!1;o.worldPosition&&(h=!0),this.drawData={canvasPoints:u,polylineIndex:u.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:l,xDir:d,yDir:c,movingTextBox:h},Ze.isInteractingWithTool=!0,a.addEventListener(re.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(re.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(re.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(re.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(re.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(re.TOUCH_TAP,this.mouseUpDrawCallback),js(a)}const Au=function(e){e.activateOpenContourEndEdit=Nu.bind(e)},{pointsAreWithinCloseContourProximity:Lu}=R;function ku(e,t){const n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id,annotationUID:t.annotationUID},o=this.getStyle("lineWidth",n,t),i=this.getStyle("lineDash",n,t),a=this.getStyle("color",n,t);return{color:void 0===a?void 0:a,width:void 0===o?void 0:o,lineDash:void 0===i?void 0:i,connectLastToFirst:!t.data.isOpenContour}}function Uu(e,t,n){e?.viewport?.getImageData()&&(n.data.isOpenContour?n.data.isOpenUShapeContour?(!function(e,t){t.data.openUShapeContourVectorToPeak||(t.data.openUShapeContourVectorToPeak=function(e,t){const{viewport:n}=e;return Ac(t.data.polyline.map(n.worldToCanvas),n)}(e,t))}(e,n),this.renderOpenUShapedContour(e,t,n)):this.renderOpenContour(e,t,n):this.renderClosedContour(e,t,n))}function Vu(e,t,n){const{viewport:o}=e,i=this._getRenderingOptions(e,n),a=n.data.polyline.map((e=>o.worldToCanvas(e)));ar(t,n.annotationUID,"1",a,i)}function Bu(e,t,n){const{viewport:o}=e,i=this._getRenderingOptions(e,n),a=n.data.polyline.map((e=>o.worldToCanvas(e)));ar(t,n.annotationUID,"1",a,i);const r=n.data.handles.activeHandleIndex;if(!0===this.configuration.alwaysRenderOpenContourHandles?.enabled){const e=this.configuration.alwaysRenderOpenContourHandles.radius,o="0",s=[a[0],a[a.length-1]];0===r?s.shift():1===r&&s.pop(),or(t,n.annotationUID,o,s,{color:i.color,handleRadius:e})}if(null!==r){const e="1",o=a[0===r?0:a.length-1];or(t,n.annotationUID,e,[o],{color:i.color})}}function Fu(e,t,n){const{viewport:o}=e,{polyline:i,openUShapeContourVectorToPeak:a}=n.data;if(this.renderOpenContour(e,t,n),!a)return;const r=o.worldToCanvas(i[0]),s=o.worldToCanvas(i[i.length-1]),l=[o.worldToCanvas(a[0]),o.worldToCanvas(a[1])],d=this._getRenderingOptions(e,n);ar(t,n.annotationUID,"first-to-last",[r,s],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"}),ar(t,n.annotationUID,"midpoint-to-open-contour",[l[0],l[1]],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"})}function Hu(e,t,n){const o=this._getRenderingOptions(e,n),{allowOpenContours:i}=this.configuration,{canvasPoints:a}=this.drawData;if(o.connectLastToFirst=!1,ar(t,n.annotationUID,"1",a,o),i){const e=a[0],i=a[a.length-1];if(Lu(e,i,this.configuration.closeContourProximity))ar(t,n.annotationUID,"2",[i,e],o);else{const i="0";or(t,n.annotationUID,i,[e],{color:o.color,handleRadius:2})}}}function Wu(e,t,n){const{fusedCanvasPoints:o}=this.editData;if(void 0===o)return void this.renderClosedContour(e,t,n);const i=this._getRenderingOptions(e,n);ar(t,n.annotationUID,"preview-1",o,i)}function Gu(e,t,n){const{fusedCanvasPoints:o}=this.editData;if(void 0===o)return void this.renderOpenContour(e,t,n);const i=this._getRenderingOptions(e,n);ar(t,n.annotationUID,"preview-1",o,i)}const $u=function(e){e.renderContour=Uu.bind(e),e.renderClosedContour=Vu.bind(e),e.renderOpenContour=Bu.bind(e),e.renderOpenUShapedContour=Fu.bind(e),e.renderContourBeingDrawn=Hu.bind(e),e.renderClosedContourBeingEdited=Wu.bind(e),e.renderOpenContourBeingEdited=Gu.bind(e),e._getRenderingOptions=ku.bind(e)},{pointCanProjectOnLine:zu}=R,{EPSILON:Ku}=te.CONSTANTS,qu=1-Ku;class ju extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,subPixelResolution:4,interpolation:{interpolateOnAdd:!1,interpolateOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},calculateStats:!1,getTextLines:Zu,statsCalculator:Qd}}),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a,l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=Ul(o,this.getToolName()),g=r.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:u,toolName:this.getToolName()},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},polyline:[[...i]],label:"",cachedStats:{}}};return Ev(m,o),this.activateDraw(e,m,h),e.preventDefault(),Jr(s,h),m},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,a=Ul(i,this.getToolName());this.activateOpenContourEndEdit(e,t,a,n)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n,i=Ul(o,this.getToolName());t.data.isOpenContour?this.activateOpenContourEdit(e,t,i):this.activateClosedContourEdit(e,t,i)},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,r=t.data.polyline;let s=a.worldToCanvas(r[0]);for(let e=1;e<r.length;e++){const t=s,i=a.worldToCanvas(r[e]);if(!0===zu(n,t,i,o))return!0;s=i}if(t.data.isOpenContour)return!1;const l=a.worldToCanvas(r[0]),d=a.worldToCanvas(r[r.length-1]);return!0===zu(n,l,d,o)},this.cancel=e=>{const t=this.isDrawing,n=this.isEditingOpen,o=this.isEditingClosed;t?this.cancelDrawing(e):n?this.cancelOpenContourEdit(e):o&&this.cancelClosedContourEdit(e)},this.triggerAnnotationModified=(e,t)=>{const{viewportId:n,renderingEngineId:o}=t,i=re.ANNOTATION_MODIFIED,a={annotation:e,viewportId:n,renderingEngineId:o};(0,te.triggerEvent)(te.eventTarget,i,a)},this.triggerAnnotationCompleted=e=>{const t=re.ANNOTATION_COMPLETED,n={annotation:e};(0,te.triggerEvent)(te.eventTarget,t,n)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,renderingEngine:i}=e,{element:a}=o,r=this.getTargetId(o);let s=vv(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const l=this.isDrawing,d=this.isEditingOpen,c=this.isEditingClosed;if(l||d||c){const o=this.commonData.annotation.annotationUID;s.forEach((n=>{if(n.annotationUID===o)if(l)this.renderContourBeingDrawn(e,t,n);else if(c)this.renderClosedContourBeingEdited(e,t,n);else{if(!d)throw new Error(`Unknown ${this.getToolName()} annotation rendering state`);this.renderOpenContourBeingEdited(e,t,n)}else this.renderContour(e,t,n)})),n=!0}else s.forEach((n=>{this.renderContour(e,t,n)}));return this.configuration.calculateStats?(s.forEach((n=>{const a=this.commonData?.annotation.annotationUID;if(n.annotationUID!==a||this.commonData?.movingTextBox){if(!this.commonData?.movingTextBox){const{data:t}=n;t.cachedStats[r]&&null!=t.cachedStats[r].areaUnit?n.invalidated&&this._throttledCalculateCachedStats(n,o,i,e):(t.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(n,o,i,e))}this._renderStats(n,o,e,t)}})),n):void 0},this._calculateCachedStats=(e,t,n,o)=>{const i=e.data,{cachedStats:a,polyline:r}=i,s=Object.keys(a);for(let o=0;o<s.length;o++){const i=s[o],l=this.getTargetIdImage(i,n);if(!l)continue;const{imageData:d,metadata:c}=l,u=r.map((e=>t.worldToCanvas(e))),h=u[0],g=t.canvasToWorld(h),m=t.canvasToWorld([h[0]+1,h[1]]),f=t.canvasToWorld([h[0],h[1]+1]),p=$a.R3.distance(g,m),v=$a.R3.distance(g,f),E=xd(l);let w=Dc(u)/E/E;w*=p*v;const I=te.utilities.transformWorldToIndex(d,r[0]);I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]);let C=I[0],T=I[0],b=I[1],_=I[1],D=I[2],S=I[2];for(let e=1;e<r.length;e++){const t=te.utilities.transformWorldToIndex(d,r[e]);t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.floor(t[2]),C=Math.min(C,t[0]),T=Math.max(T,t[0]),b=Math.min(b,t[1]),_=Math.max(_,t[1]),D=Math.min(D,t[2]),S=Math.max(S,t[2])}const y=.01*(T-C),O=.01*(_-b),P=.01*(S-D);C=Math.floor(C-y),T=Math.ceil(T+y),b=Math.floor(b-O),_=Math.ceil(_+O),D=Math.floor(D-P),S=Math.ceil(S+P);const M=[[C,T],[b,_],[D,S]],x=d.indexToWorld([T,_,S]),R=t.worldToCanvas(x);let N=0,A=[],L=0;const k=ts(d,((e,n)=>{let o=!0;const i=t.worldToCanvas(e);return i[1]!=N&&(L=0,N=i[1],A=gc(u,i,[R[0],i[1]]),A.sort((function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1}))),A.length&&i[0]>A[0][0]&&(A.shift(),L++),L%2==0&&(o=!1),o}),this.configuration.statsCalculator.statsCallback,M),U={isPreScaled:Gd(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},V=Wd(c.Modality,e.metadata.referencedImageId,U),B=this.configuration.statsCalculator.getStatistics();a[i]={Modality:c.Modality,area:w,mean:B[1]?.value,max:B[0]?.value,stdDev:B[3]?.value,statsArray:B,pointsInShape:k,areaUnit:Md(0,l),modalityUnit:V}}return this.triggerAnnotationModified(e,o),e.invalidated=!1,a},this._renderStats=(e,t,n,o)=>{const i=e.data,a=this.getTargetId(t),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id},s=this.getLinkedTextBoxStyle(r,e);if(!s.visibility)return;const l=this.configuration.getTextLines(i,a);if(!l||0===l.length)return;const d=i.polyline.map((e=>t.worldToCanvas(e)));if(!i.handles.textBox.hasMoved){const e=Nd(d);i.handles.textBox.worldPosition=t.canvasToWorld(e)}const c=t.worldToCanvas(i.handles.textBox.worldPosition),u=ur(o,e.annotationUID??"","1",l,c,d,{},s),{x:h,y:g,width:m,height:f}=u;i.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([h,g]),topRight:t.canvasToWorld([h+m,g]),bottomLeft:t.canvasToWorld([h,g+f]),bottomRight:t.canvasToWorld([h+m,g+f])}},Yc(this),au(this),vu(this),xu(this),Au(this),$u(this),this._throttledCalculateCachedStats=qr(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,te.getEnabledElement)(e),{viewport:o}=n;let i;if(o instanceof te.StackViewport)i=_r(o,t);else{if(!(o instanceof te.VolumeViewport))throw new Error(`Viewport Type ${o.type} not supported`);{const e=o.getCamera(),{spacingInNormalDirection:n}=te.utilities.getTargetVolumeAndSpacingInNormalDir(o,e);i=this.filterAnnotationsWithinSlice(t,e,n)}}return i}filterAnnotationsWithinSlice(e,t,n){const{viewPlaneNormal:o}=t,i=e.filter((e=>{const t=e.metadata.viewPlaneNormal,n=Math.abs($a.R3.dot(o,t))>qu;return t&&n}));if(!i.length)return[];const a=n/2,{focalPoint:r}=t,s=[];for(const e of i){const t=e.data.polyline[0];if(!e.isVisible)continue;const n=$a.R3.create();$a.R3.sub(n,r,t);const i=$a.R3.dot(n,o);Math.abs(i)<a&&s.push(e)}return s}}function Zu(e,t){const n=e.cachedStats[t],{area:o,mean:i,stdDev:a,max:r,isEmptyArea:s,areaUnit:l,modalityUnit:d}=n,c=[];if(o){const e=s?"Area: Oblique not supported":`Area: ${rs(o)} ${l}`;c.push(e)}return i&&c.push(`Mean: ${rs(i)} ${d}`),r&&c.push(`Max: ${rs(r)} ${d}`),a&&c.push(`Std Dev: ${rs(a)} ${d}`),c}ju.toolName="PlanarFreehandROI";const Yu=ju;class Xu extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:Ju,changeTextCallback:Qu,preventHandleOutsideImage:!1,arrowFirst:!0}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;js(o),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),{arrowFirst:h}=this.configuration,g=r.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:u},data:{text:"",handles:{points:[[...i],[...i]],activeHandleIndex:null,arrowFirst:h,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};Ev(m,o);const f=Ul(o,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),Jr(s,f),m},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,[s,l]=r.handles.points,d=a.worldToCanvas(s),c=a.worldToCanvas(l),u={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}};return zl([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),js(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{viewportId:d,renderingEngineId:c,renderingEngine:u}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),a)this.configuration.getTextCallback((e=>{if(!e)return Iv(o.annotationUID),Jr(u,i),this.editData=null,void(this.isDrawing=!1);o.data.text=e;const t=re.ANNOTATION_COMPLETED,n={annotation:o};(0,te.triggerEvent)(te.eventTarget,t,n),Jr(u,i)}));else{const e=re.ANNOTATION_MODIFIED,t={annotation:o,viewportId:d,renderingEngineId:c};(0,te.triggerEvent)(te.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;Jr(d,i)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let o=vv(this.getToolName(),n);if(o=this.filterInteractableAnnotationsForElement(n,o),!o?.length)return;const i=o.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!i)return;const a=i;this.configuration.changeTextCallback(i,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_END,this._endCallback)},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const i=a[e],{annotationUID:s,data:l}=i,{handles:d,text:c}=l,{points:u,activeHandleIndex:h}=d;r.annotationUID=s;const g=this.getStyle("lineWidth",r,i),m=this.getStyle("lineDash",r,i),f=this.getStyle("color",r,i),p=u.map((e=>o.worldToCanvas(e)));let v;if(pe(i)||this.editData||null===h||(v=[p[h]]),v){or(t,s,"0",p,{color:f,lineWidth:g})}const E="1";if(this.configuration.arrowFirst?gr(t,s,E,p[1],p[0],{color:f,width:g,lineDash:m}):gr(t,s,E,p[0],p[1],{color:f,width:g,lineDash:m}),n=!0,!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!c)continue;const w=this.getLinkedTextBoxStyle(r,i);if(!w.visibility){l.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!l.handles.textBox.hasMoved){const e=p[1];l.handles.textBox.worldPosition=o.canvasToWorld(e)}const I=o.worldToCanvas(l.handles.textBox.worldPosition),C=ur(t,s,"1",[c],I,p,{},w),{x:T,y:b,width:_,height:D}=C;l.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([T,b]),topRight:o.canvasToWorld([T+_,b]),bottomLeft:o.canvasToWorld([T,b+D]),bottomRight:o.canvasToWorld([T+_,b+D])}}return n}}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Ul(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),js(i);const d=(0,te.getEnabledElement)(i),{renderingEngine:c}=d;Jr(c,l),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;const{renderingEngine:o,viewportId:i,renderingEngineId:a}=(0,te.getEnabledElement)(e),r=Ul(e,this.getToolName());Jr(o,r);const s=re.ANNOTATION_MODIFIED;(0,te.triggerEvent)(te.eventTarget,s,{annotation:t,viewportId:i,renderingEngineId:a})}_isInsideVolume(e,t,n){return te.utilities.indexWithinDimensions(e,n)&&te.utilities.indexWithinDimensions(t,n)}}function Ju(e){return e(prompt("Enter your annotation:"))}function Qu(e,t,n){return n(prompt("Enter your annotation:"))}Xu.toolName="ArrowAnnotate";const eh=Xu;class th extends Rr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:nh}}),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;js(o),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:u},data:{handles:{points:[[...i],[...i]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Ev(g,o);const m=Ul(o,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),Jr(s,m),g},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,[s,l,d]=r.handles.points,c=a.worldToCanvas(s),u=a.worldToCanvas(l),h={start:{x:c[0],y:c[1]},end:{x:u[0],y:u[1]}};if(zl([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=o)return!0;if(!d)return!1;const g=a.worldToCanvas(d),m={start:{x:u[0],y:u[1]},end:{x:g[0],y:g[1]}};return zl([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=Ul(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),js(o);const a=(0,te.getEnabledElement)(o),{renderingEngine:r}=a;Jr(r,i),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;if(this.angleStartedNotYetCompleted&&2===s.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(d,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;Jr(d,i)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:u}=d,{points:h,activeHandleIndex:g}=u.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),f=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),v=h.map((e=>o.worldToCanvas(e)));let E;if(u.cachedStats[r]&&null!=u.cachedStats[r].angle?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(u.cachedStats[r]={angle:null},this._calculateCachedStats(d,s,e)),pe(d)||this.editData||null===g||(E=[v[g]]),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(E){or(t,c,"0",v,{color:p,lineDash:f,lineWidth:m})}let w="1";if(ir(t,c,w,v[0],v[1],{color:p,width:m,lineDash:f}),n=!0,3!==v.length)return n;if(w="2",ir(t,c,w,v[1],v[2],{color:p,width:m,lineDash:f}),!u.cachedStats[r]?.angle)continue;const I=this.getLinkedTextBoxStyle(l,d);if(!I.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const C=this.configuration.getTextLines(u,r);if(!u.handles.textBox.hasMoved){const e=v[1];u.handles.textBox.worldPosition=o.canvasToWorld(e)}const T=o.worldToCanvas(u.handles.textBox.worldPosition),b=ur(t,c,"1",C,T,v,{},I),{x:_,y:D,width:S,height:y}=b;u.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([_,D]),topRight:o.canvasToWorld([_+S,D]),bottomLeft:o.canvasToWorld([_,D+y]),bottomRight:o.canvasToWorld([_+S,D+y])}}return n},this._throttledCalculateCachedStats=qr(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Ul(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),js(i);const d=(0,te.getEnabledElement)(i),{renderingEngine:c}=d;Jr(c,l),e.preventDefault()}_calculateCachedStats(e,t,n){const o=e.data,{viewportId:i,renderingEngineId:a}=n;if(3!==o.handles.points.length)return;const r=o.handles.points[0],s=o.handles.points[1],l=o.handles.points[2],{cachedStats:d}=o,c=Object.keys(d);for(let e=0;e<c.length;e++){const t=c[e],n=hl([r,s],[s,l]);d[t]={angle:isNaN(n)?"Incomplete Angle":n}}e.invalidated=!1;const u=re.ANNOTATION_MODIFIED,h={annotation:e,viewportId:i,renderingEngineId:a};return(0,te.triggerEvent)(te.eventTarget,u,h),d}}function nh(e,t){const n=e.cachedStats[t],{angle:o}=n;if(void 0===o)return;return[`${rs(o)} ${String.fromCharCode(176)}`]}th.toolName="Angle";const oh=th,ih=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const o=2===t[0].length?[0,0]:[0,0,0],i=t.length;for(const e of t)o[0]+=e[0]/i,o[1]+=e[1]/i,3===o.length&&(o[2]+=e[2]/i);return o},ah=ih;class rh extends Rr{constructor(){var e;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:sh}}),e=this,this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;js(o),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getReferencedImageId(r,i,d,c),h=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:u},data:{handles:{points:[[...i],[...i]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Ev(g,o);const m=Ul(o,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),Jr(s,m),g},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{distanceToPoint:s,distanceToPoint2:l}=this.distanceToLines({viewport:a,points:r.handles.points,canvasCoords:n,proximity:o});return s<=o||l<=o},this.toolSelectedCallback=function(t,n,o,i){let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6;const r=t.detail,{element:s}=r;n.highlighted=!0;const l=Ul(s,e.getToolName()),d=(0,te.getEnabledElement)(s),{renderingEngine:c,viewport:u}=d,{isNearFirstLine:h,isNearSecondLine:g}=e.distanceToLines({viewport:u,points:n.data.handles.points,canvasCoords:i,proximity:a});e.editData={annotation:n,viewportIdsToRender:l,movingTextBox:!1,isNearFirstLine:h,isNearSecondLine:g},e._activateModify(s),js(s),Jr(c,l),t.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;if(this.angleStartedNotYetCompleted&&s.handles.points.length<4)return qs(n),void(this.editData.handleIndex=s.handles.points.length);this.angleStartedNotYetCompleted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(d,i),a){const e=re.ANNOTATION_COMPLETED,t={annotation:o};(0,te.triggerEvent)(te.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:t,handleIndex:n}=this.editData,o=e.detail,{element:i,currentPoints:a}=o,r=a.world,{data:s}=t;return 1===n?(s.handles.points[1]=r,void(this.editData.hasMoved=s.handles.points[1][0]!==s.handles.points[0][0]||s.handles.points[1][1]!==s.handles.points[0][0])):3===n?(s.handles.points[3]=r,this.editData.hasMoved=s.handles.points[3][0]!==s.handles.points[2][0]||s.handles.points[3][1]!==s.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,js(i),s.handles.points[2]=s.handles.points[3]=r,void(this.editData.handleIndex=s.handles.points.length-1))},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r,isNearFirstLine:s,isNearSecondLine:l}=this.editData,{data:d}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a&&(s||l)){const{deltaPoints:e}=t,n=e.world,i=d.handles.points;if(s){[i[0],i[1]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}else if(l){[i[2],i[3]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;d.handles.points[a]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const c=(0,te.getEnabledElement)(n),{renderingEngine:u}=c;Jr(u,i)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;i.handles.points.length<4&&Iv(t.annotationUID),t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,te.getEnabledElement)(e),{renderingEngine:r}=a;if(Jr(r,n),o){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,te.triggerEvent)(te.eventTarget,e,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._mouseUpCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(re.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(re.MOUSE_CLICK,this._mouseUpCallback)},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._mouseUpCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(re.MOUSE_DOWN,this._mouseDownCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DOWN,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=vv(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:u}=d,{points:h,activeHandleIndex:g}=u.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),f=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),v=h.map((e=>o.worldToCanvas(e)));let E;if(u.cachedStats[r]&&null!=u.cachedStats[r].angle?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(u.cachedStats[r]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(d,s,e)),pe(d)||this.editData||null===g||(E=[v[g]]),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(E){or(t,c,"0",v,{color:p,lineDash:f,lineWidth:m})}const w=[v[0],v[1]],I=[v[2],v[3]];let C="line1";if(ir(t,c,C,w[0],w[1],{color:p,width:m,lineDash:f}),n=!0,v.length<4)return n;C="line2",ir(t,c,C,I[0],I[1],{color:p,width:m,lineDash:f}),C="linkLine";ir(t,c,C,ah(w[0],w[1]),ah(I[0],I[1]),{color:p,lineWidth:"1",lineDash:"1,4"});const{arc1Start:T,arc1End:b,arc2End:_,arc2Start:D}=u.cachedStats[r].points.canvas,{arc1Angle:S,arc2Angle:y}=u.cachedStats[r];if(C="arc1",ir(t,c,C,T,b,{color:p,lineWidth:"1"}),C="arc2",ir(t,c,C,D,_,{color:p,lineWidth:"1"}),!u.cachedStats[r]?.angle)continue;const O=this.getLinkedTextBoxStyle(l,d);if(!O.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const P=this.configuration.getTextLines(u,r);if(!u.handles.textBox.hasMoved){const e=Nd(v);u.handles.textBox.worldPosition=o.canvasToWorld(e)}const M=o.worldToCanvas(u.handles.textBox.worldPosition),x=ur(t,c,"cobbAngleText",P,M,v,{},O),{x:R,y:N,width:A,height:L}=x;u.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([R,N]),topRight:o.canvasToWorld([R+A,N]),bottomLeft:o.canvasToWorld([R,N+L]),bottomRight:o.canvasToWorld([R+A,N+L])};const k="arcAngle1",U=[`${S.toFixed(2)} ${String.fromCharCode(176)}`],V=ah(T,b);lr(t,c,k,U,V,{...O,padding:3});const B="arcAngle2",F=[`${y.toFixed(2)} ${String.fromCharCode(176)}`],H=ah(D,_);lr(t,c,B,F,H,{...O,padding:3})}return n},this.distanceToLines=e=>{let{viewport:t,points:n,canvasCoords:o,proximity:i}=e;const[a,r,s,l]=n,d=t.worldToCanvas(a),c=t.worldToCanvas(r),u=t.worldToCanvas(s),h=t.worldToCanvas(l),g={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},m={start:{x:u[0],y:u[1]},end:{x:h[0],y:h[1]}},f=zl([g.start.x,g.start.y],[g.end.x,g.end.y],[o[0],o[1]]),p=zl([m.start.x,m.start.y],[m.end.x,m.end.y],[o[0],o[1]]);let v=!1,E=!1;return f<=i?v=!0:p<=i&&(E=!0),{distanceToPoint:f,distanceToPoint2:p,isNearFirstLine:v,isNearSecondLine:E}},this.getArcsStartEndPoints=e=>{let{firstLine:t,secondLine:n,mid1:o,mid2:i}=e;const a=[o,i],r=hl(t,a),s=hl(n,a),l=r>90?1:0,d=s>90?0:1,c=ah(a[0],a[1]),u=Math.sqrt((a[1][0]-a[0][0])**2+(a[1][1]-a[0][1])**2),h=.1,g=ah(t[0],t[1]),m=ah(n[0],n[1]),f=[t[l][0]-g[0],t[l][1]-g[1]],p=Math.sqrt(f[0]**2+f[1]**2),v=[f[0]/p,f[1]/p],E=[g[0]+v[0]*u*h,g[1]+v[1]*u*h],w=[c[0]-o[0],c[1]-o[1]],I=Math.sqrt(w[0]**2+w[1]**2),C=[w[0]/I,w[1]/I],T=[o[0]+C[0]*u*h,o[1]+C[1]*u*h],b=[n[d][0]-m[0],n[d][1]-m[1]],_=Math.sqrt(b[0]**2+b[1]**2),D=[b[0]/_,b[1]/_],S=[m[0]+D[0]*u*h,m[1]+D[1]*u*h],y=[c[0]-i[0],c[1]-i[1]],O=Math.sqrt(y[0]**2+y[1]**2),P=[y[0]/O,y[1]/O];return{arc1Start:E,arc1End:T,arc2Start:S,arc2End:[i[0]+P[0]*u*h,i[1]+P[1]*u*h],arc1Angle:r>90?180-r:r,arc2Angle:s>90?180-s:s}},this._throttledCalculateCachedStats=qr(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=Ul(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),js(i);const d=(0,te.getEnabledElement)(i),{renderingEngine:c}=d;Jr(c,l),e.preventDefault()}_calculateCachedStats(e,t,n){const o=e.data,{viewportId:i,renderingEngineId:a}=n;if(4!==o.handles.points.length)return;const r=[null,null],s=[null,null];let l=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=$a.R3.distance(o.handles.points[e],o.handles.points[t]);n<l&&(l=n,r[1]=o.handles.points[e],r[0]=o.handles.points[(e+1)%2],s[0]=o.handles.points[t],s[1]=o.handles.points[2+(t-1)%2])}const{viewport:d}=n,c=o.handles.points.map((e=>d.worldToCanvas(e))),u=[c[0],c[1]],h=[c[2],c[3]],g=ah(u[0],u[1]),m=ah(h[0],h[1]),{arc1Start:f,arc1End:p,arc2End:v,arc2Start:E,arc1Angle:w,arc2Angle:I}=this.getArcsStartEndPoints({firstLine:u,secondLine:h,mid1:g,mid2:m}),{cachedStats:C}=o,T=Object.keys(C);for(let e=0;e<T.length;e++){C[T[e]]={angle:hl(r,s),arc1Angle:w,arc2Angle:I,points:{canvas:{arc1Start:f,arc1End:p,arc2End:v,arc2Start:E},world:{arc1Start:d.canvasToWorld(f),arc1End:d.canvasToWorld(p),arc2End:d.canvasToWorld(v),arc2Start:d.canvasToWorld(E)}}}}e.invalidated=!1;const b=re.ANNOTATION_MODIFIED,_={annotation:e,viewportId:i,renderingEngineId:a};return(0,te.triggerEvent)(te.eventTarget,b,_),C}}function sh(e,t){const n=e.cachedStats[t],{angle:o}=n;if(void 0===o)return;return[`${o.toFixed(2)} ${String.fromCharCode(176)}`]}rh.toolName="CobbAngle";const lh=rh;class dh extends Mr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:t}=e,{element:n,currentPoints:o}=t;this._currentCursorWorldPosition=o.world,this._currentCanvasPosition=o.canvas,this._elementWithCursor=n;const i=this.getActiveAnnotation(n);return null===i?(this.createInitialAnnotation(o.world,n),!1):(this.updateAnnotationPosition(n,i),!1)},this.createInitialAnnotation=(e,t)=>{const n=(0,te.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:o,renderingEngine:i}=n;this.isDrawing=!0;const a=o.getCamera(),{viewPlaneNormal:r,viewUp:s}=a;if(!r||!s)throw new Error("Camera not found");const l=this.getReferencedImageId(o,e,r,s),d=o.getFrameOfReferenceUID(),c={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...s],FrameOfReferenceUID:d,referencedImageId:l},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if(vv(this.getToolName(),t).length>0)return null;if(null===Ev(c,t))return;const u=Ul(t,this.getToolName(),!1);Jr(i,u)},this.onCameraModified=e=>{const t=e.detail,{element:n,previousCamera:o,camera:i}=t,a=(0,te.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const r=o.focalPoint,s=i.viewPlaneNormal,l=i.focalPoint,d=[0,0,0];if(al.ZP.subtract(l,r,d),0===d.reduce(((e,t)=>e+t),0))return;const c=al.ZP.dot(d,s);if(Math.abs(c)<.01)return;if(!this._currentCanvasPosition)return;const u=a.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=u,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,FrameOfReferenceUID:i}=e,a=this._elementWithCursor===o.element;this.configuration.positionSync&&!a&&this.updateViewportImage(o);const{element:r}=o;let s=vv(this.getToolName(),r);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(r,s),!s?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const i=s[e],{annotationUID:r,data:d}=i,{handles:c}=d,{points:u}=c;if(!r)return n;l.annotationUID=r;const h=parseFloat(this.getStyle("lineWidth",l,i)),g=h,m=this.getStyle("lineDash",l,i),f=this.getStyle("color",l,i);if(u[0].some((e=>isNaN(e))))return n;const p=u.map((e=>o.worldToCanvas(e)));if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!Ue(r))continue;const v={upper:"upper",right:"right",lower:"lower",left:"left"},[E,w]=p[0],I=a?20:7,C=a?5:7;ir(t,r,v.upper,[E,w-(I/2+C)],[E,w-I/2],{color:f,lineDash:m,lineWidth:g}),ir(t,r,v.lower,[E,w+(I/2+C)],[E,w+I/2],{color:f,lineDash:m,lineWidth:g}),ir(t,r,v.right,[E+(I/2+C),w],[E+I/2,w],{color:f,lineDash:m,lineWidth:g}),ir(t,r,v.left,[E-(I/2+C),w],[E-I/2,w],{color:f,lineDash:m,lineWidth:g}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=dv(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,te.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&js(e.viewport.element)}))}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=dv(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,te.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&qs(e.viewport.element)}))}getActiveAnnotation(e){const t=vv(this.getToolName(),e);if(!t.length)return null;return t[0]}updateAnnotationPosition(e,t){const n=this._currentCursorWorldPosition;if(!n)return;if(!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;const o=Ul(e,this.getToolName(),!1),i=(0,te.getEnabledElement)(e);if(!i)return;const{renderingEngine:a}=i;Jr(a,o)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];const n=t[0],o=(0,te.getEnabledElement)(e)?.viewport;if(!o)return[];const i=o.getCamera(),{viewPlaneNormal:a,focalPoint:r}=i;if(!a||!r)return[];const s=n.data?.handles?.points;if(!(s instanceof Array)||1!==s.length)return[];const l=s[0],d=te.utilities.planar.planeEquation(a,r);return te.utilities.planar.planeDistanceToPoint(d,l)<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some((e=>isNaN(e))))if(e instanceof te.StackViewport){const n=te.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof te.VolumeViewport){const{focalPoint:n,viewPlaneNormal:o}=e.getCamera();if(!n||!o)return;const i=te.utilities.planar.planeEquation(o,n),a=te.utilities.planar.planeDistanceToPoint(i,t,!0);if(Math.abs(a)<.5)return;const r=$a.R3.normalize($a.R3.create(),$a.R3.fromValues(...o)),s=$a.R3.scale($a.R3.create(),r,a),l=$a.R3.add($a.R3.create(),$a.R3.fromValues(...n),s);if(!0){e.setCamera({focalPoint:l});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}dh.toolName="ReferenceCursors";const ch=dh,uh=[];class hh extends Mr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{viewportId:"",scaleLocation:"bottom"}}),this.editData={},this._init=()=>{const e=(0,te.getRenderingEngines)()[0];if(!e)return;const t=dv(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map((e=>(0,te.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)));let{viewport:o}=n[0];const{FrameOfReferenceUID:i}=n[0];if(this.configuration.viewportId&&n.forEach((e=>{e.viewport.id==this.configuration.viewportId&&(o=e.viewport)})),!o)return;const{viewUp:a,viewPlaneNormal:r}=o.getCamera(),s=te.utilities.getViewportImageCornersInWorld(o);let l=this.editData.annotation;const d=vv(this.getToolName(),o.element);if(d.length&&(l=d.filter((e=>e.data.viewportId==o.id))[0]),uh.includes(o.id))this.editData.annotation.data.viewportId==o.id&&(this.editData.annotation.data.handles.points=s,this.editData.annotation.data.viewportId=o.id);else{const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...a],FrameOfReferenceUID:i,referencedImageId:null},data:{handles:{points:s},viewportId:o.id}};uh.push(o.id),Ev(e,o.element),l=e}this.editData={viewport:o,renderingEngine:e,annotation:l}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{const o=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let i;return i="top"==n||"bottom"==n?o.filter((t=>t<.6*e&&t>.2*e)):o.filter((e=>e<.6*t&&e>.2*t)),i[0]},this.computeEndScaleTicks=(e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}},this.computeInnerScaleTicks=(e,t,n,o,i)=>{let a;"bottom"==t||"top"==t?a=i[0][0]-o[0][0]:"left"!=t&&"right"!=t||(a=i[0][1]-o[0][1]);const r=[],s=[],l=[];let d=e;e>=50&&(d=e/10);const c=a/d;for(let e=0;e<d-1;e++){const i={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};r.push(`${n}-tick${e}`),s.push(`tick${e}`),(e+1)%5==0?l.push([[o[0][0]+i[t][0][0],o[0][1]+i[t][0][1]],[o[1][0]+i[t][0][0],o[1][1]+i[t][0][1]]]):l.push([[o[0][0]+i[t][0][0],o[0][1]+i[t][0][1]],[o[1][0]+i[t][1][0],o[1][1]+i[t][1][1]]])}return{tickIds:r,tickUIDs:s,tickCoordinates:l}},this.computeWorldScaleCoordinates=(e,t,n)=>{let o,i=$a.R3.subtract($a.R3.create(),n[0],n[1]);i=$a.R3.normalize($a.R3.create(),i);let a=$a.R3.subtract($a.R3.create(),n[2],n[0]);a=$a.R3.normalize($a.R3.create(),a);const r={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},s=$a.R3.add($a.R3.create(),r[t][0],r[t][0]).map((e=>e/2)),l=e/2/Math.sqrt(Math.pow(i[0],2)+Math.pow(i[1],2)+Math.pow(i[2],2));return"top"==t||"bottom"==t?o=[$a.R3.subtract($a.R3.create(),s,a.map((e=>e*l))),$a.R3.add($a.R3.create(),s,a.map((e=>e*l)))]:"left"!=t&&"right"!=t||(o=[$a.R3.add($a.R3.create(),s,i.map((e=>e*l))),$a.R3.subtract($a.R3.create(),s,i.map((e=>e*l)))]),o},this.computeCanvasScaleCoordinates=(e,t,n,o,i)=>{let a;if("top"==i||"bottom"==i){const o=t[0][0]-t[1][0];a=[[e.width/2-o/2,n.height],[e.width/2+o/2,n.height]]}else if("left"==i||"right"==i){const n=t[0][1]-t[1][1];a=[[o.width,e.height/2-n/2],[o.width,e.height/2+n/2]]}return a},this.computeScaleBounds=(e,t,n,o)=>{const i=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),r={bottom:[-a,-i],top:[a,i],left:[a,i],right:[-a,-i]},s={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:s[o][0]+r[o][0],width:s[o][1]+r[o][1]}}}renderAnnotation(e,t){if(!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:o}=e,i=vv(this.getToolName(),o.element).filter((e=>e.data.viewportId==o.id))[0],a=e.viewport.canvas;if(!o)return false;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},s={width:a.width,height:a.height},l=i.data.handles.points[0],d=i.data.handles.points[1],c=i.data.handles.points[2],u=i.data.handles.points[3],h=[l,c,d,u],g=$a.R3.distance(c,u),m=$a.R3.distance(l,c),f=this.computeScaleBounds(s,.05,.05,n),p=this.computeScaleBounds(s,.05,.05,n),v=this.computeScaleSize(g,m,n),E=this.computeWorldScaleCoordinates(v,n,h).map((e=>o.worldToCanvas(e))),w=this.computeCanvasScaleCoordinates(s,E,p,f,n),I=this.computeEndScaleTicks(w,n),{annotationUID:C}=i;r.annotationUID=C;const T=this.getStyle("lineWidth",r,i),b=this.getStyle("lineDash",r,i),_=this.getStyle("color",r,i),D=this.getStyle("shadow",r,i),S=`${C}-scaleline`;ir(t,C,"1",w[0],w[1],{color:_,width:T,lineDash:b,shadow:D},S);const y=`${C}-left`;ir(t,C,"2",I.endTick1[0],I.endTick1[1],{color:_,width:T,lineDash:b,shadow:D},y);const O=`${C}-right`;ir(t,C,"3",I.endTick2[0],I.endTick2[1],{color:_,width:T,lineDash:b,shadow:D},O);const P={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},M=[w[0][0]+P[n][0],w[0][1]+P[n][1]],x=this._getTextLines(v),{tickIds:R,tickUIDs:N,tickCoordinates:A}=this.computeInnerScaleTicks(v,n,C,I.endTick1,I.endTick2);for(let e=0;e<N.length;e++)ir(t,C,N[e],A[e][0],A[e][1],{color:_,width:T,lineDash:b,shadow:D},R[e]);return lr(t,C,"text0",x,[M[0],M[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:_}),false}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");return[t.toString().concat(n)]}}hh.toolName="ScaleOverlay";const gh=hh,{transformWorldToIndex:mh}=te.utilities;function fh(e,t){const{volume:n,points:o,segmentsLocked:i,segmentIndex:a,segmentationId:r,constraintFn:s}=t,{imageData:l,dimensions:d}=n,c=n.getScalarData();let u=o.map((e=>mh(l,e)));u=u.map((e=>e.map((e=>Math.round(e)))));const h=os(u,d);ts(l,(()=>!0),(e=>{let{value:t,index:n,pointIJK:o}=e;i.includes(t)||(s?s(o)&&(c[n]=a):c[n]=a)}),h),Yn(r)}function ph(e,t){fh(e,t,!0)}const{transformWorldToIndex:vh}=te.utilities;function Eh(e,t){const{volume:n,points:o,segmentsLocked:i,segmentationId:a}=t,{imageData:r,dimensions:s}=n,l=n.getScalarData(),d=o.map((e=>vh(r,e))),c=os(d,s);ts(r,(()=>!0),(e=>{let{value:t,index:n}=e;i.includes(t)||(l[n]=0)}),c),Yn(a)}function wh(e,t){Eh(e,t,!0)}class Ih extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:ph,ERASE_INSIDE:wh},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.toolGroupId,h=ya(u);if(!h)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:g,segmentationId:m,type:f}=h,p=Ha(m),v=xa(m),E=Aa(u,g,p),{representationData:w}=Qn(m),{volumeId:I}=w[f],C=te.cache.getVolume(I),T={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:E},data:{handles:{points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null}}},b=Ul(o,this.getToolName());return this.editData={annotation:T,segmentation:C,segmentIndex:p,segmentsLocked:v,segmentColor:E,segmentationId:m,viewportIdsToRender:b,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(s,b),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a}=this.editData,{data:r}=o,{currentPoints:s}=t,l=(0,te.getEnabledElement)(n),{worldToCanvas:d,canvasToWorld:c}=l.viewport,u=s.world,{points:h}=r.handles;let g,m,f,p,v,E,w,I;switch(h[a]=[...u],a){case 0:case 3:g=d(h[0]),p=d(h[3]),m=[p[0],g[1]],f=[g[0],p[1]],E=c(m),w=c(f),h[1]=E,h[2]=w;break;case 1:case 2:m=d(h[1]),f=d(h[2]),g=[f[0],m[1]],p=[m[0],f[1]],v=c(g),I=c(p),h[0]=v,h[3]=I}o.invalidated=!0,this.editData.hasMoved=!0;const{renderingEngine:C}=l;Jr(C,i)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:i,hasMoved:a,segmentation:r,segmentationId:s,segmentIndex:l,segmentsLocked:d}=this.editData,{data:c}=o;if(i&&!a)return;c.handles.activeHandleIndex=null,this._deactivateDraw(n),qs(n);const u=(0,te.getEnabledElement)(n),{viewport:h}=u;if(this.editData=null,this.isDrawing=!1,h instanceof te.StackViewport)throw new Error("Not implemented yet");const g={points:c.handles.points,volume:r,segmentationId:s,segmentIndex:l,segmentsLocked:d};this.applyActiveStrategy(u,g)},this._activateDraw=e=>{e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{annotation:i}=this.editData,a=i.metadata,r=i.annotationUID,s=i.data,{points:l}=s.handles,d=l.map((e=>o.worldToCanvas(e))),c=`rgb(${a.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return hr(t,r,"0",d[0],d[3],{color:c}),n=!0,n}}}Ih.toolName="RectangleScissor";const Ch=Ih;class Th extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:ps},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,te.getEnabledElement)(o),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:u}=d,h=this.toolGroupId,g=ya(h);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:m,segmentationId:f,type:p}=g,v=Ha(f),E=xa(f),w=Aa(h,m,v),{representationData:I}=Qn(f),{volumeId:C}=I[p],T=te.cache.getVolume(C),b={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...u],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:w},data:{handles:{points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},_=[s.id];return this.editData={annotation:b,segmentation:T,centerCanvas:a,segmentIndex:v,segmentationId:f,segmentsLocked:E,segmentColor:w,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(l,_),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,te.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerCanvas:u}=this.editData,{data:h}=d,g=Math.abs(i[0]-u[0]),m=Math.abs(i[1]-u[1]),f=Math.sqrt(g*g+m*m),p=[u[0],u[1]+f],v=[u[0],u[1]-f],E=[u[0]-f,u[1]],w=[u[0]+f,u[1]];h.handles.points=[l(p),l(v),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,Jr(r,c)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:i,hasMoved:a,segmentation:r,segmentIndex:s,segmentsLocked:l,segmentationId:d}=this.editData,{data:c}=o,{viewPlaneNormal:u,viewUp:h}=o.metadata;if(i&&!a)return;c.handles.activeHandleIndex=null,this._deactivateDraw(n),qs(n);const g=(0,te.getEnabledElement)(n),{viewport:m}=g;if(this.editData=null,this.isDrawing=!1,m instanceof te.StackViewport)throw new Error("Not implemented yet");const f={points:c.handles.points,volume:r,segmentIndex:s,segmentsLocked:l,viewPlaneNormal:u,segmentationId:d,viewUp:h};this.applyActiveStrategy(g,f)},this._activateDraw=e=>{e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{viewportIdsToRender:i}=this.editData;if(!i.includes(o.id))return n;const{annotation:a}=this.editData,r=a.metadata,s=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>o.worldToCanvas(e))),u=c[0],h=c[1],g=[Math.floor((u[0]+h[0])/2),Math.floor((u[1]+h[1])/2)],m=Math.abs(u[1]-Math.floor((u[1]+h[1])/2)),f=`rgb(${r.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return tr(t,s,"0",g,m,{color:f}),n=!0,n}}}Th.toolName="CircleScissor";const bh=Th;class _h extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:ds},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,te.getEnabledElement)(o),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:u}=d,h=this.toolGroupId,g=ya(h);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:m,segmentationId:f,type:p}=g,v=Ha(f),E=xa(f),w=Aa(h,m,v),{representationData:I}=Qn(f),{volumeId:C}=I[p],T=te.cache.getVolume(C);this.isDrawing=!0;const b={metadata:{viewPlaneNormal:[...c],viewUp:[...u],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:w},data:{invalidated:!0,handles:{points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},_=[s.id];return this.editData={annotation:b,segmentation:T,centerCanvas:a,segmentIndex:v,segmentsLocked:E,segmentColor:w,segmentationId:f,toolGroupId:h,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(l,_),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,te.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerCanvas:u}=this.editData,{data:h}=d,g=Math.abs(i[0]-u[0]),m=Math.abs(i[1]-u[1]),f=Math.sqrt(g*g+m*m),p=[u[0],u[1]+f],v=[u[0],u[1]-f],E=[u[0]-f,u[1]],w=[u[0]+f,u[1]];h.handles.points=[l(p),l(v),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,Jr(r,c)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:i,hasMoved:a,segmentation:r,segmentIndex:s,segmentsLocked:l,segmentationId:d}=this.editData,{data:c}=o,{viewPlaneNormal:u,viewUp:h}=o.metadata;if(i&&!a)return;o.highlighted=!1,c.handles.activeHandleIndex=null,this._deactivateDraw(n),qs(n);const g=(0,te.getEnabledElement)(n),{viewport:m}=g;if(this.editData=null,this.isDrawing=!1,m instanceof te.StackViewport)throw new Error("Not implemented yet");const f={points:c.handles.points,volume:r,segmentIndex:s,segmentsLocked:l,segmentationId:d,viewPlaneNormal:u,viewUp:h};this.applyActiveStrategy(g,f)},this._activateDraw=e=>{e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{viewportIdsToRender:i}=this.editData;if(!i.includes(o.id))return n;const{annotation:a}=this.editData,r=a.metadata,s=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>o.worldToCanvas(e))),u=c[0],h=c[1],g=[Math.floor((u[0]+h[0])/2),Math.floor((u[1]+h[1])/2)],m=Math.abs(u[1]-Math.floor((u[1]+h[1])/2)),f=`rgb(${r.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return tr(t,s,"0",g,m,{color:f}),n=!0,n}}}_h.toolName="SphereScissor";const Dh=_h;class Sh extends oc{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,u=this.getTargetId(r);let h,g;if(r instanceof te.StackViewport)h=u.split("imageId:")[1];else{g=u.split("volumeId:")[1];const e=te.cache.getVolume(g);h=te.utilities.getClosestImageId(e,i,d)}const m=r.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:m,referencedImageId:h,toolName:this.getToolName(),volumeId:g},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},segmentationId:null}};Ev(f,o);const p=Ul(o,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:p,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(s,p),f},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,renderingEngineId:i}=e,{element:a}=o;let r=vv(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<r.length;e++){const a=r[e],{annotationUID:l,data:d}=a,{points:c,activeHandleIndex:u}=d.handles,h=c.map((e=>o.worldToCanvas(e)));s.annotationUID=l;const g=this.getStyle("lineWidth",s,a),m=this.getStyle("lineDash",s,a),f=this.getStyle("color",s,a);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const p=re.ANNOTATION_MODIFIED,v={annotation:a,viewportId:o.id,renderingEngineId:i};let E;if((0,te.triggerEvent)(te.eventTarget,p,v),!Ue(l))continue;if(pe(a)||this.editData||null===u||(E=[h[u]]),E){or(t,l,"0",E,{color:f})}hr(t,l,"0",h[0],h[3],{color:f,lineDash:m,lineWidth:g}),n=!0}return n}}}Sh.toolName="RectangleROIThreshold";const yh=Sh,{transformWorldToIndex:Oh}=te.utilities;class Ph extends oc{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{numSlicesToPropagate:10}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l;let u,h,g;if(r instanceof te.StackViewport)throw new Error("Stack Viewport Not implemented");g=this.getTargetId(r).split("volumeId:")[1],h=te.cache.getVolume(g),u=te.utilities.getClosestImageId(h,i,d);if(!u)throw new Error("This tool does not work on non-acquisition planes");const m=r.getCurrentImageIdIndex(),f=te.utilities.getSpacingInNormalDirection(h,d),p=this._getEndSliceIndex(h,i,f,d),v=r.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:v,referencedImageId:u,toolName:this.getToolName(),volumeId:g,spacingInNormal:f},data:{label:"",startSlice:m,endSlice:p,cachedStats:{projectionPoints:[],projectionPointsImageIds:[u]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(E,h),Ev(E,o);const w=Ul(o,this.getToolName());return this.editData={annotation:E,viewportIdsToRender:w,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(s,w),E},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,i=vv(this.getToolName(),o.element);if(!i?.length)return n;const a=o.getCurrentImageIdIndex(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let s=0;s<i.length;s++){const l=i[s],{annotationUID:d,data:c}=l,{startSlice:u,endSlice:h}=c,{points:g,activeHandleIndex:m}=c.handles,f=g.map((e=>o.worldToCanvas(e)));r.annotationUID=d;const p=this.getStyle("lineWidth",r,l),v=this.getStyle("lineDash",r,l),E=this.getStyle("color",r,l);if(a<Math.min(u,h)||a>Math.max(u,h))continue;l.invalidated&&this._throttledCalculateCachedStats(l,e);let w,I=!1;if(a!==u&&a!==h||(I=!0),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!Ue(d))continue;if(pe(l)||this.editData||null===m||!I||(w=[f[m]]),w){or(t,d,"0",w,{color:E})}let C=v;I||(C=2);hr(t,d,"0",f[0],f[3],{color:E,lineDash:C,lineWidth:p}),n=!0}return n},this._throttledCalculateCachedStats=qr(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:o}=e,{viewPlaneNormal:i,spacingInNormal:a}=o,{imageData:r}=t,{startSlice:s,endSlice:l}=n,{points:d}=n.handles,c=Oh(r,d[0]);if(c[2]!==s)throw new Error("Start slice does not match");const u=$a.R3.fromValues(c[0],c[1],l),h=$a.R3.create();r.indexToWorldVec3(c,h);const g=$a.R3.create();r.indexToWorldVec3(u,g);const m=$a.R3.distance(h,g),f=[];for(let e=0;e<m;e+=a)f.push(d.map((t=>{const n=$a.R3.create();return $a.R3.scaleAndAdd(n,t,i,e),Array.from(n)})));n.cachedStats.projectionPoints=f;const p=[];for(const e of f){const n=te.utilities.getClosestImageId(t,e[0],i);p.push(n)}n.cachedStats.projectionPointsImageIds=p}_calculateCachedStatsTool(e,t){const n=e.data,{viewportId:o,renderingEngineId:i,viewport:a}=t,{cachedStats:r}=n,s=this.getTargetId(a),l=te.cache.getVolume(s.split("volumeId:")[1]);this._computeProjectionPoints(e,l),e.invalidated=!1;const d=re.ANNOTATION_MODIFIED,c={annotation:e,viewportId:o,renderingEngineId:i};return(0,te.triggerEvent)(te.eventTarget,d,c),r}_getEndSliceIndex(e,t,n,o){const i=this.configuration.numSlicesToPropagate,a=$a.R3.create();$a.R3.scaleAndAdd(a,t,o,i*n);const r=n/2,{imageIds:s}=e;let l;for(let e=0;e<s.length;e++){const t=s[e],{imagePositionPatient:n}=te.metaData.get("imagePlaneModule",t),i=$a.R3.create();$a.R3.sub(i,a,n);const d=$a.R3.dot(i,o);Math.abs(d)<r&&(l=e)}return l}}Ph.toolName="RectangleROIStartEndThreshold";const Mh=Ph;function xh(e,t){return e===t}function Rh(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}const Nh=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=n.onFlood,i=n.onBoundary,a=n.equals||xh,r=n.diagonals||!1,s=m(t),l=function(){const e=function(e){const t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))};for(let o=0;o<Math.pow(3,e);o+=1){const i=Rh(o.toString(3),"0",e);t.push(n(i))}return t}(t.length);return e.filter((function(e){const t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||r)}))}(),d=[],c=[],u={},h={};for(d.push({currentArgs:t});d.length>0;)g(d.pop());return{flooded:c,boundaries:function(){const e=[];for(const t in h)void 0!==h[t]&&e.unshift(h[t]);return e}()};function g(e){const t=e.currentArgs,n=e.previousArgs;!0!==u[t]&&(!function(e){u[e]=!0}(t),function(e){const t=f(m,[e]);return f(a,[t,s])}(t)?(function(e){c.push(e),o&&o(...e)}(t),function(e){for(let t=0;t<l.length;t+=1){const n=l[t],o=e.slice(0);for(let t=0;t<e.length;t+=1)o[t]+=n[t];d.push({currentArgs:o,previousArgs:e})}}(t)):function(e){h[e]=e,i&&i(...e)}(n))}function m(t){return e(...t)}function f(e,t){try{return e(...t)}catch(e){return}}},{transformWorldToIndex:Ah,isEqual:Lh}=te.utilities;class kh extends Ga{constructor(){var e;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]}),e=this,this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r}=a,s=r.getCamera(),{viewPlaneNormal:l}=s,d=ya(this.toolGroupId);if(!d)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:c,type:u}=d,h=Ha(c),g=xa(c),{representationData:m}=Qn(c),{volumeId:f}=m[u],p=te.cache.getVolume(f),{dimensions:v,direction:E}=p,w=p.getScalarData(),I=Ah(p.imageData,i),C=this.getFixedDimension(l,E);if(void 0===C)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:T,getLabelValue:b,getScalarDataPositionFromPlane:_,inPlaneSeedPoint:D,fixedDimensionValue:S}=this.generateHelpers(w,v,I,C);if(I[0]<0||I[0]>=v[0]||I[1]<0||I[1]>=v[1]||I[2]<0||I[2]>=v[2])return;const y=b(I[0],I[1],I[2]);if(g.includes(y))return;const O=Nh(T,D),{flooded:P}=O;P.forEach((e=>{const t=_(e[0],e[1]);w[t]=h}));return Yn(c,this.getFramesModified(C,S,O)),!0},this.getFramesModified=(e,t,n)=>{const{boundaries:o}=n;if(2===e)return[t];let i=1/0,a=-1/0;for(let e=0;e<o.length;e++){const t=o[e][1];t<i&&(i=t),t>a&&(a=t)}const r=[];for(let e=i;e<=a;e++)r.push(e);return r},this.generateHelpers=function(t,n,o){let i,a,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;switch(r){case 0:i=o[0],a=[o[1],o[2]];break;case 1:i=o[1],a=[o[0],o[2]];break;case 2:i=o[2],a=[o[0],o[1]];break;default:throw new Error(`Invalid fixedDimension: ${r}`)}const s=(e,t,o)=>o*n[1]*n[0]+t*n[0]+e,l=(e,n,o)=>t[s(e,n,o)],d=e.generateFloodFillGetter(n,r,i,l);return{getScalarDataPositionFromPlane:e.generateGetScalarDataPositionFromPlane(s,r,i),getLabelValue:l,floodFillGetter:d,inPlaneSeedPoint:a,fixedDimensionValue:i}},this.generateFloodFillGetter=(e,t,n,o)=>{let i;switch(t){case 0:i=(t,i)=>{if(!(t>=e[1]||t<0||i>=e[2]||i<0))return o(n,t,i)};break;case 1:i=(t,i)=>{if(!(t>=e[0]||t<0||i>=e[2]||i<0))return o(t,n,i)};break;case 2:i=(t,i)=>{if(!(t>=e[0]||t<0||i>=e[1]||i<0))return o(t,i,n)};break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return i},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let o;switch(t){case 0:o=(t,o)=>e(n,t,o);break;case 1:o=(t,o)=>e(t,n,o);break;case 2:o=(t,o)=>e(t,o,n);break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return o}}getFixedDimension(e,t){const n=t.slice(0,3),o=t.slice(3,6),i=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(Lh(a,r))return 0;const s=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];if(Lh(a,s))return 1;const l=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];return Lh(a,l)?2:void 0}}kh.toolName="PaintFill";const Uh=kh;var Vh=n(24964);var Bh={Corners:{TOP_LEFT:"TOP_LEFT",TOP_RIGHT:"TOP_RIGHT",BOTTOM_LEFT:"BOTTOM_LEFT",BOTTOM_RIGHT:"BOTTOM_RIGHT"}};const{vtkErrorMacro:Fh}=Bo.m,{Corners:Hh}=Bh;const Wh={viewportCorner:Bh.Corners.BOTTOM_LEFT,viewportSize:.2,minPixelSize:50,maxPixelSize:200,parentRenderer:null};function Gh(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,Wh,n),Bo.m.obj(e,t),Bo.m.get(e,t,["enabled","viewportCorner","viewportSize"]),Bo.m.setGet(e,t,["_interactor","minPixelSize","maxPixelSize","parentRenderer"]),Bo.m.get(e,t,["actor"]),Bo.m.moveToProtected(e,t,["interactor"]),function(e,t){t.classHierarchy.push("vtkOrientationMarkerWidget");const n={...e},o=[],i=Vh.ZP.newInstance(),a=new ResizeObserver((t=>{e.updateViewport()}));let r=null,s=null,l=null,d=null,c=null;function u(){t._interactor.isAnimating()||e.updateMarkerOrientation()}t._onParentRendererChanged=()=>e.updateViewport(),e.computeViewport=()=>{const e=t.parentRenderer||t._interactor.getCurrentRenderer(),[n,o,i,a]=e.getViewport(),r=t._interactor.getView(),s=r.getSize(),[l,d]=r.getViewportSize(e),c=Math.min(l,d);let u=t.viewportSize*c;u=Math.max(Math.min(t.minPixelSize,c),Math.min(t.maxPixelSize,u));const h=u/s[0],g=u/s[1];switch(t.viewportCorner){case Hh.TOP_LEFT:return[n,a-g,n+h,a];case Hh.TOP_RIGHT:return[i-h,a-g,i,a];case Hh.BOTTOM_LEFT:return[n,o,n+h,o+g];case Hh.BOTTOM_RIGHT:return[i-h,.04,i,.04+g];default:return Fh("Invalid widget corner"),null}},e.updateViewport=()=>{t.enabled&&(i.setViewport(...e.computeViewport()),t._interactor.render())},e.updateMarkerOrientation=()=>{const e=(t.parentRenderer||t._interactor.getCurrentRenderer()).getActiveCamera();if(!e)return;const n=e.getReferenceByName("position"),a=e.getReferenceByName("focalPoint"),r=e.getReferenceByName("viewUp");if(o[0]!==n[0]||o[1]!==n[1]||o[2]!==n[2]||o[3]!==a[0]||o[4]!==a[1]||o[5]!==a[2]||o[6]!==r[0]||o[7]!==r[1]||o[8]!==r[2]){o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=a[0],o[4]=a[1],o[5]=a[2],o[6]=r[0],o[7]=r[1],o[8]=r[2];const e=i.getActiveCamera();e.setPosition(n[0],n[1],n[2]),e.setFocalPoint(a[0],a[1],a[2]),e.setViewUp(r[0],r[1],r[2]),i.resetCamera()}},e.setEnabled=n=>{if(n){if(t.enabled)return;if(!t.actor)return void Fh("Must set actor before enabling orientation marker.");if(!t._interactor)return void Fh("Must set interactor before enabling orientation marker.");const n=t.parentRenderer||t._interactor.getCurrentRenderer(),o=n.getRenderWindow();o.addRenderer(i),o.getNumberOfLayers()<2&&o.setNumberOfLayers(2),i.setLayer(o.getNumberOfLayers()-1),i.setInteractive(!1),i.addViewProp(t.actor),t.actor.setVisibility(!0),r=n.onEvent((e=>{"ActiveCameraEvent"===e.type&&(s&&s.unsubscribe(),s=e.camera.onModified(u))})),s=n.getActiveCamera().onModified(u),l=t._interactor.onAnimation(e.updateMarkerOrientation),d=t._interactor.onEndAnimation(e.updateMarkerOrientation),a.observe(t._interactor.getView().getCanvas()),e.updateViewport(),e.updateMarkerOrientation(),t.enabled=!0}else{if(!t.enabled)return;t.enabled=!1,a.disconnect(),r.unsubscribe(),r=null,s.unsubscribe(),s=null,l.unsubscribe(),l=null,d.unsubscribe(),d=null,t.actor.setVisibility(!1),i.removeViewProp(t.actor);const e=t._interactor?.findPokedRenderer()?.getRenderWindow();e&&e.removeRenderer(i)}e.modified()},e.setViewportCorner=n=>{n!==t.viewportCorner&&(t.viewportCorner=n,e.updateViewport())},e.setViewportSize=n=>{const o=Math.min(1,Math.max(0,n));o!==t.viewportSize&&(t.viewportSize=o,e.updateViewport())},e.setActor=n=>{const o=t.enabled;e.setEnabled(!1),t.actor=n,e.setEnabled(o)},e.getRenderer=()=>i,e.delete=()=>{n.delete(),c&&(c.unsubscribe(),c=null),r&&(r.unsubscribe(),r=null),s&&(s.unsubscribe(),s=null),l&&(l.unsubscribe(),l=null),d&&(d.unsubscribe(),d=null),a.disconnect()},c=e.onModified(e.updateViewport)}(e,t)}var $h={newInstance:Bo.m.newInstance(Gh,"vtkOrientationMarkerWidget"),extend:Gh,...Bh},zh=n(53333),Kh=n(90699),qh=n(66082);function jh(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0,0];const[n,o,i,a]=t,r=e.getContext("2d").getImageData(n,o,i||e.width,a||e.height),s=qh.ZP.newInstance({type:"vtkImageData"});s.setOrigin(0,0,0),s.setSpacing(1,1,1),s.setExtent(0,(i||e.width)-1,0,(a||e.height)-1,0,0);const l=Vo.default.newInstance({numberOfComponents:4,values:new Uint8Array(r.data.buffer)});return l.setName("scalars"),s.getPointData().setScalars(l),s}var Zh={canvasToImageData:jh,imageToImageData:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{flipX:!1,flipY:!1,rotate:0};const n=document.createElement("canvas");n.width=e.width,n.height=e.height;const o=n.getContext("2d"),{flipX:i,flipY:a,rotate:r}=t;return o.translate(n.width/2,n.height/2),o.scale(i?-1:1,a?-1:1),o.rotate(r*Math.PI/180),o.drawImage(e,-e.width/2,-e.height/2),jh(n)}};const Yh={default:{defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"white",edgeThickness:.1,edgeColor:"black",resolution:400},xMinusFaceProperty:{text:"X-",faceColor:"yellow"},xPlusFaceProperty:{text:"X+",faceColor:"yellow"},yMinusFaceProperty:{text:"Y-",faceColor:"red"},yPlusFaceProperty:{text:"Y+",faceColor:"red"},zMinusFaceProperty:{text:"Z-",faceColor:"#008000"},zPlusFaceProperty:{text:"Z+",faceColor:"#008000"}},lps:{xMinusFaceProperty:{text:"R",faceRotation:-90},xPlusFaceProperty:{text:"L",faceRotation:90},yMinusFaceProperty:{text:"A",faceRotation:0},yPlusFaceProperty:{text:"P",faceRotation:180},zMinusFaceProperty:{text:"I",faceRotation:180},zPlusFaceProperty:{text:"S",faceRotation:0}}};function Xh(e,t){t.set(e)}var Jh={applyDefinitions:Xh,applyPreset:function(e,t){return Xh(Yh[e],t)},registerStylePreset:function(e,t){Yh[e]=t}};const Qh={xPlus:0,xMinus:1,yPlus:2,yMinus:3,zPlus:4,zMinus:5};const eg={defaultStyle:{text:"",faceColor:"white",faceRotation:0,fontFamily:"Arial",fontColor:"black",fontStyle:"normal",fontSizeScale:e=>e/1.8,edgeThickness:.1,edgeColor:"black",resolution:200}};function tg(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,eg,n),Zo.ZP.extend(e,t,n),Bo.m.get(e,t,["defaultStyle","xPlusFaceProperty","xMinusFaceProperty","yPlusFaceProperty","yMinusFaceProperty","zPlusFaceProperty","zMinusFaceProperty"]),function(e,t){t.classHierarchy.push("vtkAnnotatedCubeActor"),t.xPlusFaceProperty={...t.xPlusFaceProperty},t.xMinusFaceProperty={...t.xMinusFaceProperty},t.yPlusFaceProperty={...t.yPlusFaceProperty},t.yMinusFaceProperty={...t.yMinusFaceProperty},t.zPlusFaceProperty={...t.zPlusFaceProperty},t.zMinusFaceProperty={...t.zMinusFaceProperty};let n=null;const o=document.createElement("canvas"),i=Yo.default.newInstance(),a=zh.ZP.newInstance();function r(n){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i&&Object.assign(t[`${n}FaceProperty`],i);const r={...t.defaultStyle,...t[`${n}FaceProperty`]};o.width=r.resolution,o.height=r.resolution;const s=o.getContext("2d");s.fillStyle=r.faceColor,s.fillRect(0,0,o.width,o.height),r.edgeThickness>0&&(s.strokeStyle=r.edgeColor,s.lineWidth=r.edgeThickness*o.width,s.strokeRect(0,0,o.width,o.height)),s.save(),s.translate(0,o.height),s.scale(1,-1),s.translate(o.width/2,o.height/2),s.rotate(-Math.PI*(r.faceRotation/180));const l=r.fontSizeScale(r.resolution);s.fillStyle=r.fontColor,s.textAlign="center",s.textBaseline="middle",s.font=`${r.fontStyle} ${l}px "${r.fontFamily}"`,s.fillText(r.text,0,0),s.restore();const d=Zh.canvasToImageData(o);a.setInputData(d,Qh[n]),e.modified()}function s(){n=Kh.ZP.newInstance({generate3DTextureCoordinates:!0}),i.setInputConnection(n.getOutputPort()),r("xPlus"),r("xMinus"),r("yPlus"),r("yMinus"),r("zPlus"),r("zMinus")}a.setInterpolate(!0),e.setDefaultStyle=e=>{t.defaultStyle={...t.defaultStyle,...e},s()},e.setXPlusFaceProperty=e=>r("xPlus",e),e.setXMinusFaceProperty=e=>r("xMinus",e),e.setYPlusFaceProperty=e=>r("yPlus",e),e.setYMinusFaceProperty=e=>r("yMinus",e),e.setZPlusFaceProperty=e=>r("zPlus",e),e.setZMinusFaceProperty=e=>r("zMinus",e),s(),i.setInputConnection(n.getOutputPort()),e.setMapper(i),e.addTexture(a)}(e,t)}var ng={newInstance:Bo.m.newInstance(tg,"vtkAnnotatedCubeActor"),extend:tg,Presets:Jh};const og={height:1,radius:.5,resolution:6,center:[0,0,0],direction:[1,0,0],capping:!0,pointType:"Float64Array"};function ig(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,og,n),Bo.m.obj(e,t),Bo.m.setGet(e,t,["height","radius","resolution","capping"]),Bo.m.setGetArray(e,t,["center","direction"],3),Bo.m.algo(e,t,0,1),function(e,t){t.classHierarchy.push("vtkConeSource"),e.requestData=function(e,n){if(t.deleted)return;let o=n[0];const i=2*Math.PI/t.resolution,a=-t.height/2,r=t.resolution+1,s=4*t.resolution+1+t.resolution;let l=0;const d=Bo.m.newTypedArray(t.pointType,3*r);let c=0;const u=new Uint32Array(s);d[0]=t.height/2,d[1]=0,d[2]=0,t.capping&&(u[c++]=t.resolution);for(let e=0;e<t.resolution;e++)l++,d[3*l+0]=a,d[3*l+1]=t.radius*Math.cos(e*i),d[3*l+2]=t.radius*Math.sin(e*i),t.capping&&(u[t.resolution-c+++1]=l);for(let e=0;e<t.resolution;e++)u[c++]=3,u[c++]=0,u[c++]=e+1,u[c++]=e+2>t.resolution?1:e+2;Pl.Z.buildFromRadian().translate(...t.center).rotateFromDirections([1,0,0],t.direction).apply(d),o=Ho.ZP.newInstance(),o.getPoints().setData(d,3),o.getPolys().setData(u,1),n[0]=o}}(e,t)}var ag={newInstance:Bo.m.newInstance(ig,"vtkConeSource"),extend:ig};const rg={height:1,initAngle:0,radius:1,resolution:6,center:[0,0,0],direction:[0,1,0],capping:!0,pointType:"Float64Array"};function sg(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,rg,n),Bo.m.obj(e,t),Bo.m.setGet(e,t,["height","initAngle","otherRadius","radius","resolution","capping"]),Bo.m.setGetArray(e,t,["center","direction"],3),Bo.m.algo(e,t,0,1),function(e,t){t.classHierarchy.push("vtkCylinderSource"),e.requestData=function(e,n){if(t.deleted)return;let o=n[0];const i=2*Math.PI/t.resolution;let a=2*t.resolution,r=5*t.resolution;t.capping&&(a=4*t.resolution,r=7*t.resolution+2);const s=Bo.m.newTypedArray(t.pointType,3*a);let l=0;const d=new Uint32Array(r),c=new Float32Array(3*a),u=Vo.default.newInstance({numberOfComponents:3,values:c,name:"Normals"}),h=new Float32Array(2*a),g=Vo.default.newInstance({numberOfComponents:2,values:h,name:"TCoords"}),m=[0,0,0],f=[0,0,0],p=[0,0,0],v=[0,0,0],E=[0,0],w=[0,0],I=null==t.otherRadius?t.radius:t.otherRadius;for(let e=0;e<t.resolution;e++){m[0]=Math.cos(e*i+t.initAngle),f[0]=m[0],p[0]=t.radius*m[0]+t.center[0],v[0]=p[0],E[0]=Math.abs(2*e/t.resolution-1),w[0]=E[0],p[1]=.5*t.height+t.center[1],v[1]=-.5*t.height+t.center[1],E[1]=0,w[1]=1,m[2]=-Math.sin(e*i+t.initAngle),f[2]=m[2],p[2]=I*m[2]+t.center[2],v[2]=p[2];const n=2*e;for(let e=0;e<3;e++)c[3*n+e]=m[e],c[3*(n+1)+e]=f[e],s[3*n+e]=p[e],s[3*(n+1)+e]=v[e],e<2&&(h[2*n+e]=E[e],h[2*(n+1)+e]=w[e])}for(let e=0;e<t.resolution;e++){d[l++]=4,d[l++]=2*e,d[l++]=2*e+1;const n=(2*e+3)%(2*t.resolution);d[l++]=n,d[l++]=n-1}if(t.capping){for(let e=0;e<t.resolution;e++){p[0]=t.radius*Math.cos(e*i+t.initAngle),v[0]=p[0],E[0]=p[0],w[0]=p[0],p[0]+=t.center[0],v[0]+=t.center[0],m[1]=1,f[1]=-1,p[1]=.5*t.height+t.center[1],v[1]=-.5*t.height+t.center[1],p[2]=-I*Math.sin(e*i+t.initAngle),v[2]=p[2],E[1]=p[2],w[1]=p[2],p[2]+=t.center[2],v[2]+=t.center[2];const n=2*t.resolution+e,o=3*t.resolution+t.resolution-e-1;for(let e=0;e<3;e++)c[3*n+e]=m[e],c[3*o+e]=f[e],s[3*n+e]=p[e],s[3*o+e]=v[e],e<2&&(h[2*n+e]=E[e],h[2*o+e]=w[e])}d[l++]=t.resolution;for(let e=0;e<t.resolution;e++)d[l++]=2*t.resolution+e;d[l++]=t.resolution;for(let e=0;e<t.resolution;e++)d[l++]=3*t.resolution+e}Pl.Z.buildFromRadian().translate(...t.center).rotateFromDirections([0,1,0],t.direction).translate(...t.center.map((e=>-1*e))).apply(s),o=Ho.ZP.newInstance(),o.getPoints().setData(s,3),o.getPolys().setData(d,1),o.getPointData().setNormals(u),o.getPointData().setTCoords(g),n[0]=o}}(e,t)}var lg={newInstance:Bo.m.newInstance(sg,"vtkCylinderSource"),extend:sg};const dg={tipResolution:6,tipRadius:.1,tipLength:.35,shaftResolution:6,shaftRadius:.03,invert:!1,direction:[1,0,0],pointType:"Float64Array"};function cg(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,dg,n),Bo.m.obj(e,t),Bo.m.setGet(e,t,["tipResolution","tipRadius","tipLength","shaftResolution","shaftRadius","invert"]),Bo.m.setGetArray(e,t,["direction"],3),Bo.m.algo(e,t,0,1),function(e,t){t.classHierarchy.push("vtkArrowSource"),e.requestData=function(e,n){if(t.deleted)return;const o=lg.newInstance({capping:!0});o.setResolution(t.shaftResolution),o.setRadius(t.shaftRadius),o.setHeight(1-t.tipLength),o.setCenter(0,.5*(1-t.tipLength),0);const i=o.getOutputData(),a=i.getPoints().getData(),r=i.getPointData().getNormals().getData();Pl.Z.buildFromDegree().rotateZ(-90).apply(a).apply(r);const s=ag.newInstance();s.setResolution(t.tipResolution),s.setHeight(t.tipLength),s.setRadius(t.tipRadius);const l=s.getOutputData(),d=l.getPoints().getData();Pl.Z.buildFromRadian().translate(1-.5*t.tipLength,0,0).apply(d);const c=jo.newInstance();c.setInputData(i),c.addInputData(l);const u=c.getOutputData(),h=u.getPoints().getData();Pl.Z.buildFromRadian().translate(.5*t.tipLength-.5,0,0).apply(h),t.invert?(Pl.Z.buildFromRadian().rotateFromDirections([1,0,0],t.direction).scale(-1,-1,-1).apply(h),n[0]=u):(Pl.Z.buildFromRadian().rotateFromDirections([1,0,0],t.direction).scale(1,1,1).apply(h),n[0]=c.getOutputData())}}(e,t)}var ug={newInstance:Bo.m.newInstance(cg,"vtkArrowSource"),extend:cg};function hg(e){const t=e.getPoints().getBounds(),n=[.5*-(t[0]+t[1]),.5*-(t[2]+t[3]),.5*-(t[4]+t[5])];Pl.Z.buildFromDegree().translate(...n).apply(e.getPoints().getData())}function gg(e,t){const n=e.getPoints().getBounds(),o=[0,0,0];o[t]=-n[2*t],Pl.Z.buildFromDegree().translate(...o).apply(e.getPoints().getData())}function mg(e,t,n,o){const i=e.getPoints().getData().length,a=new Uint8Array(i);let r=0;for(;r<i;)a[r++]=t,a[r++]=n,a[r++]=o;e.getPointData().setScalars(Vo.default.newInstance({name:"color",numberOfComponents:3,values:a}))}const fg={config:{recenter:!0,tipResolution:60,tipRadius:.1,tipLength:.2,shaftResolution:60,shaftRadius:.03,invert:!1},xAxisColor:[255,0,0],yAxisColor:[255,255,0],zAxisColor:[0,128,0]};function pg(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,fg,n),Zo.ZP.extend(e,t,n),Bo.m.setGet(e,t,["config"]),Bo.m.setGetArray(e,t,["xAxisColor","yAxisColor","zAxisColor"],3,255),function(e,t){t.classHierarchy.push("vtkAxesActor");const n=Yo.default.newInstance();e.setMapper(n),e.update=()=>{const e=ug.newInstance({direction:[1,0,0],...t.config}).getOutputData();t.config.recenter?hg(e):gg(e,0),mg(e,...t.xAxisColor);const o=ug.newInstance({direction:[0,1,0],...t.config}).getOutputData();t.config.recenter?hg(o):gg(o,1),mg(o,...t.yAxisColor);const i=ug.newInstance({direction:[0,0,1],...t.config}).getOutputData();t.config.recenter?hg(i):gg(i,2),mg(i,...t.zAxisColor);const a=jo.newInstance();a.setInputData(e),a.addInputData(o),a.addInputData(i),n.setInputConnection(a.getOutputPort())},e.update();const o=Bo.m.debounce(e.update,0),{setConfig:i,setXAxisColor:a,setYAxisColor:r,setZAxisColor:s}=e;e.setConfig=e=>!!i(e)&&(o(),!0),e.setXAxisColor=e=>!!a(e)&&(o(),!0),e.setYAxisColor=e=>!!r(e)&&(o(),!0),e.setZAxisColor=e=>!!s(e)&&(o(),!0)}(e,t)}var vg={newInstance:Bo.m.newInstance(pg,"vtkAxesActor"),extend:pg},Eg=n(39053),wg=n(89390);const Ig={};function Cg(e){return!!Ig[e]}function Tg(e,t){Ig[e]=t}var bg={get:function(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ig[arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http"](e)},has:Cg,registerType:Tg};const _g=[];_g["-".charCodeAt(0)]=62,_g["_".charCodeAt(0)]=63;const Dg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(let e=0;e<Dg.length;e++)_g[Dg.charCodeAt(e)]=e;function Sg(e){return void 0!==_g[e.charCodeAt(0)]}function yg(e,t,n,o){const{start:i,count:a}=t,r=a%4,s=Math.floor(a/4);let l=i,d=null,c=n;for(let t=0;t<s;t++){for(;!Sg(e[l]);)l++;for(d=_g[e.charCodeAt(l++)]<<18;!Sg(e[l]);)l++;for(d|=_g[e.charCodeAt(l++)]<<12;!Sg(e[l]);)l++;for(d|=_g[e.charCodeAt(l++)]<<6;!Sg(e[l]);)l++;d|=_g[e.charCodeAt(l++)],o[c++]=d>>16&255,o[c++]=d>>8&255,o[c++]=255&d}switch(r){case 3:for(;!Sg(e[l]);)l++;for(d=_g[e.charCodeAt(l++)]<<10;!Sg(e[l]);)l++;for(d|=_g[e.charCodeAt(l++)]<<4;!Sg(e[l]);)l++;d|=_g[e.charCodeAt(l++)]>>2,o[c++]=d>>8&255,o[c++]=255&d;break;case 2:for(;!Sg(e[l]);)l++;for(d=_g[e.charCodeAt(l++)]<<2;!Sg(e[l]);)l++;d|=_g[e.charCodeAt(l++)]>>4,o[c++]=255&d;break;case 1:throw new Error("BASE64: remain 1 should not happen")}return c}function Og(e,t,n){const o=(e<<16)+(t<<8)+n;return Dg[o>>18]+Dg[o>>12&63]+Dg[o>>6&63]+Dg[63&o]}var Pg={toArrayBuffer:function(e){const t=function(e){const t=e.length,n=[];let o=null;for(let i=0;i<t;i++)Sg(e[i])?(o||(o={start:i,count:0}),o.count++,o.end=i):"="===e[i]&&o&&(n.push(o),o=null);return o&&n.push(o),n}(e),n=t[t.length-1].end+1,o=(4-n%4)%4,i=new ArrayBuffer(3*(n+o)/4-o),a=new Uint8Array(i);let r=0;for(let n=0;n<t.length;n++)r+=yg(e,t[n],r,a),r+=(4-t[n].count%4)%4;return i},fromArrayBuffer:function(e){const t=new Uint8Array(e),n=e.byteLength%3,o=e.byteLength-n,i=Array(o/3);for(let e=0;e<i.length;e++){const n=3*e;i[e]=Og(t[n],t[n+1],t[n+2])}if(n>0){const e=Og(t[o],t[o+1]||0,t[o+2]||0);1===n?i.push(`${e.substr(0,2)}==`):2===n&&i.push(`${e.substr(0,3)}=`)}return i.join("")}};const Mg={name:"",numberOfComponents:1,size:0,dataType:"string"};function xg(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(Object.assign(t,Mg,n),!t.empty&&!t.values&&!t.size)throw new TypeError("Cannot create vtkStringArray object without: size > 0, values");t.values?Array.isArray(t.values)&&(t.values=[...t.values]):t.values=[],t.values&&(t.size=t.values.length),Bo.m.obj(e,t),Bo.m.set(e,t,["name"]),function(e,t){t.classHierarchy.push("vtkStringArray"),e.getComponent=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t.values[e*t.numberOfComponents+n]},e.setComponent=(n,o,i)=>{i!==t.values[n*t.numberOfComponents+o]&&(t.values[n*t.numberOfComponents+o]=i,e.modified())},e.getData=()=>t.values,e.getTuple=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const o=t.numberOfComponents||1;n.length&&(n.length=o);const i=e*o;for(let e=0;e<o;e++)n[e]=t.values[i+e];return n},e.getTupleLocation=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:1)*t.numberOfComponents},e.getNumberOfComponents=()=>t.numberOfComponents,e.getNumberOfValues=()=>t.values.length,e.getNumberOfTuples=()=>t.values.length/t.numberOfComponents,e.getDataType=()=>t.dataType,e.newClone=()=>Rg({name:t.name,numberOfComponents:t.numberOfComponents}),e.getName=()=>(t.name||e.setName(`vtkStringArray${e.getMTime()}`),t.name),e.setData=(n,o)=>{t.values=n,t.size=n.length,o&&(t.numberOfComponents=o),t.size%t.numberOfComponents!=0&&(t.numberOfComponents=1),e.modified()}}(e,t)}const Rg=Bo.m.newInstance(xg,"vtkStringArray");var Ng={newInstance:Rg,extend:xg};function Ag(e){return new TextDecoder("latin1").decode(e)}var Lg={arrayBufferToString:Ag,extractBinary:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const o=Ag(e),i=t.exec(o);if(!i)return{text:o};const a=i.index+i[0].length,r=o.substring(0,a);let s=null;const l=n?n.exec(o):null;if(l){s={text:r+o.substr(l.index),binaryBuffer:e.slice(a,l.index)}}else s={text:r,binaryBuffer:e.slice(a)};return s}};function kg(){const e=new ArrayBuffer(4),t=new Uint8Array(e),n=new Uint32Array(e);return t[0]=161,t[1]=178,t[2]=195,t[3]=212,3569595041===n[0]?"LittleEndian":2712847316===n[0]?"BigEndian":null}var Ug={ENDIANNESS:kg(),getEndianness:kg,swapBytes:function(e,t){if(t<2)return;const n=new Int8Array(e),o=n.length,i=[];for(let e=0;e<o;e+=t){for(let o=0;o<t;o++)i.push(n[e+o]);for(let o=0;o<t;o++)n[e+o]=i.pop()}}};const{vtkErrorMacro:Vg,vtkDebugMacro:Bg}=Bo.m,Fg=()=>(Vg("LiteHttpDataAccessHelper does not support compression. Need to register HttpDataAccessHelper instead."),Promise.reject(new Error("LiteHttpDataAccessHelper does not support compression. Need to register HttpDataAccessHelper instead.")));let Hg=0;function Wg(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=new XMLHttpRequest;return o.open(e,t,!0),n.headers&&Object.entries(n.headers).forEach((e=>{let[t,n]=e;return o.setRequestHeader(t,n)})),n.progressCallback&&o.addEventListener("progress",n.progressCallback),o}const Gg={fetchArray:function(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return o&&o.compression?Fg():n.ref&&!n.ref.pending?new Promise(((i,a)=>{const r=Wg("GET",[t,n.ref.basepath,n.ref.id].join("/"),o);r.onreadystatechange=t=>{1===r.readyState&&(n.ref.pending=!0,1==++Hg&&e?.invokeBusy&&e.invokeBusy(!0)),4===r.readyState&&(n.ref.pending=!1,200===r.status||0===r.status?(n.buffer=r.response,"JSON"===n.ref.encode?n.values=JSON.parse(n.buffer):(Ug.ENDIANNESS!==n.ref.encode&&Ug.ENDIANNESS&&(Bg(`Swap bytes of ${n.name}`),Ug.swapBytes(n.buffer,Go.Xe[n.dataType])),n.values=Bo.m.newTypedArray(n.dataType,n.buffer)),n.values.length!==n.size&&Vg(`Error in FetchArray: ${n.name}, does not have the proper array size. Got ${n.values.length}, instead of ${n.size}`),delete n.ref,0==--Hg&&e?.invokeBusy&&e.invokeBusy(!1),e?.modified&&e.modified(),i(n)):a({xhr:r,e:t}))},r.responseType="string"!==n.dataType?"arraybuffer":"text",r.send()})):Promise.resolve(n)},fetchJSON:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n&&n.compression?Fg():new Promise(((o,i)=>{const a=Wg("GET",t,n);a.onreadystatechange=t=>{1===a.readyState&&1==++Hg&&e?.invokeBusy&&e.invokeBusy(!0),4===a.readyState&&(0==--Hg&&e?.invokeBusy&&e.invokeBusy(!1),200===a.status||0===a.status?o(JSON.parse(a.responseText)):i({xhr:a,e:t}))},a.responseType="text",a.send()}))},fetchText:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n&&n.compression?Fg():new Promise(((o,i)=>{const a=Wg("GET",t,n);a.onreadystatechange=t=>{1===a.readyState&&1==++Hg&&e?.invokeBusy&&e.invokeBusy(!0),4===a.readyState&&(0==--Hg&&e?.invokeBusy&&e.invokeBusy(!1),200===a.status||0===a.status?o(a.responseText):i({xhr:a,e:t}))},a.responseType="text",a.send()}))},fetchBinary:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(((n,o)=>{const i=Wg("GET",e,t);i.onreadystatechange=e=>{4===i.readyState&&(200===i.status||0===i.status?n(i.response):o({xhr:i,e}))},i.responseType="arraybuffer",i.send()}))},fetchImage:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise(((e,o)=>{const i=new Image;n.crossOrigin&&(i.crossOrigin=n.crossOrigin),i.onload=()=>e(i),i.onerror=o,i.src=t}))}};function $g(e,t){return function(e,t){return[...e.getElementsByTagName(t)]}(e,t)[0]}Cg("http")||Tg("http",(e=>Gg));const zg={Int8:Int8Array,UInt8:Uint8Array,Int16:Int16Array,UInt16:Uint16Array,Int32:Int32Array,UInt32:Uint32Array,Int64:Int32Array,UInt64:Uint32Array,Float32:Float32Array,Float64:Float64Array},Kg={Int8:1,UInt8:1,Int16:2,UInt16:2,Int32:4,UInt32:4,Int64:8,UInt64:8,Float32:4,Float64:8};function qg(e){const t=e.length-1;return e.filter(((e,n)=>n<t&&n%2==0))}function jg(e,t,n){if(!["UInt64","UInt32"].includes(n))throw new Error(`Cannot handle a header type of ${n}`);let o=zg[n],i=zg[t],a=!1;"UInt64"===n&&(o=zg.UInt32),/^U?Int64$/.test(t)&&(a=!0,i=zg[t.replace("64","32")]);const{byteOffset:r}=e,s=Kg[t],l=Kg[n];let d;d=r%l==0?new o(e.buffer,r,1):new o(e.buffer.slice(r,r+l));const c=Number(d[0]);let u,h=c/s;a&&(h*=2);const g=r+l;return u=g%s==0?new i(e.buffer,g,h):new i(e.buffer.slice(g,g+c)),a&&(u=qg(u)),u}function Zg(e,t){const n=(0,wg.iF)(e);t.uint8.set(n,t.offset),t.offset+=n.length}function Yg(e,t){const n=function(e,t){if("UInt64"===t){const t=8;let n=new Uint32Array(e.buffer,0,6);const o=n[0],i=[t,o,n[2],n[4]];n=new Uint32Array(e.buffer,24,2*o);for(let e=0;e<o;e++)i.push(n[2*e]);return i}let n=new Uint32Array(e.buffer,0,3);const o=n[0],i=[4,o,n[1],n[2]];n=new Uint32Array(e.buffer,12,o);for(let e=0;e<o;e++)i.push(n[e]);return i}(e,t),o=n[1],i=n[2],a=n[3];let r=0;o>0&&(r=0===a?o*i:(o-1)*i+a);const s=new ArrayBuffer(r),l={offset:0,uint8:new Uint8Array(s)};let d=function(e,t){const[n]=e;return(e.length-1)*n}(n);for(;d<e.length&&120!==e[d];)d++;for(let t=0;t<o;t++){const o=n[4+t];Zg(new Uint8Array(e.buffer,d,o),l),d+=o}return l.uint8}function Xg(e,t,n,o,i,a){const r=t.getAttribute("type"),s=t.getAttribute("Name"),l=t.getAttribute("format"),d=Number(t.getAttribute("NumberOfComponents")||"1");let c=null;if("ascii"===l){c=new zg[r](e*d);let n=0;t.firstChild.nodeValue.split(/[\\t \\n]+/).forEach((e=>{e.trim().length&&(c[n++]=Number(e))}))}else if("binary"===l){const e=new Uint8Array(Pg.toArrayBuffer(t.firstChild.nodeValue.trim()));if("vtkZLibDataCompressor"===n){const t=Yg(e,i);c=new zg[r](t.buffer),/^U?Int64$/.test(r)&&(c=qg(c))}else c=new zg[r](e.buffer,Kg[i]),-1!==r.indexOf("Int64")&&(c=qg(c))}else if("appended"===l){const e=Number(t.getAttribute("offset"));c=jg(new Uint8Array(a,e),r,i)}else console.error("Format not supported",l);return{name:s,values:c,numberOfComponents:d}}function Jg(e){return(new TextDecoder).decode(e).split("\0").slice(0,-1)}function Qg(e,t,n,o,i){const a=[...e.getElementsByTagName("DataArray")].map((e=>Vo.default.newInstance(Xg(Number(e.getAttribute("NumberOfTuples")),e,t,0,o,i)))),r=[...e.getElementsByTagName("Array")].filter((e=>"String"===e.getAttribute("type"))).map((e=>{const n=Ng.newInstance(function(e,t,n,o,i){const a=e.getAttribute("Name"),r=e.getAttribute("format"),s=Number(e.getAttribute("NumberOfComponents")||"1"),l=Number(e.getAttribute("NumberOfTuples")||"1")*s,d=[];if("ascii"===r){const t=e.firstChild.nodeValue.trim().split(/\s+/);let n=0;const o=[];for(;d.length<l;){const e=Number(t[n++]);0===e?(d.push(o.join("")),o.length=0):o.push(String.fromCharCode(e))}}else if("binary"===r){const n=new Uint8Array(Pg.toArrayBuffer(e.firstChild.nodeValue.trim()));if("vtkZLibDataCompressor"===t){const e=Yg(n,o);d.push(...Jg(e))}else{const e=jg(n,"UInt8",o);d.push(...Jg(e))}}else if("appended"===r){const t=Number(e.getAttribute("offset")),n=jg(new Uint8Array(i,t),"UInt8",o);d.push(...Jg(n))}else Bo.m.vtkErrorMacro(`Format not supported: ${r}`);return{name:a,values:d,numberOfComponents:s}}(e,t,0,o,i));return n}));return[...a,...r]}function em(e,t){t.classHierarchy.push("vtkXMLReader"),t.dataAccessHelper||(t.dataAccessHelper=bg.get("http")),e.setUrl=function(n){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.url=n;const i=n.split("/");return i.pop(),t.baseURL=i.join("/"),e.loadData(o)},e.loadData=function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.dataAccessHelper.fetchBinary(e,n)}(t.url,n).then(e.parseAsArrayBuffer)},e.parseAsArrayBuffer=n=>{if(!n)return!1;if(n===t.rawDataBuffer)return!0;e.modified();const{text:o,binaryBuffer:i}=(a=n,Lg.extractBinary(a,/^\s*<AppendedData\s+encoding="raw">\s*_/m,/\n\s*<\/AppendedData>/m));var a;t.rawDataBuffer=n,t.binaryBuffer=i;var r;const s=(r=o,(0,Eg.create)(r)).root(),l=s.node,d=l.getAttribute("type"),c=l.getAttribute("compressor"),u=l.getAttribute("byte_order"),h=l.getAttribute("header_type")||"UInt32";if(c&&"vtkZLibDataCompressor"!==c)return console.error("Invalid compressor",c),!1;if(u&&"LittleEndian"!==u)return console.error("Only LittleEndian encoding is supported"),!1;if(d!==t.dataType)return console.error("Invalid data type",d,"expecting",t.dataType),!1;if($g(l,"AppendedData")){const e=$g(l,"AppendedData"),n=e.getAttribute("encoding"),o=s.filter((e=>{const{node:t}=e;return t.nodeType===Node.ELEMENT_NODE&&"appended"===t.getAttribute("format")&&t.hasAttribute("offset")}),!1,!0).map((e=>({node:e.node,offset:Number(e.node.getAttribute("offset"))})));o.sort(((e,t)=>e.offset-t.offset));let i=t.binaryBuffer;"base64"===n&&(i=e.textContent.trim().substr(1));const a=[];for(let e=0;e<o.length;++e){const t=o[e].offset;let r=0;r=e===o.length-1?i.length||i.byteLength:o[e+1].offset,"base64"===n?a.push(new Uint8Array(Pg.toArrayBuffer(i.substring(t,r)))):a.push(new Uint8Array(i.slice(t,r)))}if("vtkZLibDataCompressor"===c)for(let e=0;e<a.length;++e){const t=Yg(a[e],h),n=new Uint8Array(t.length+Kg[h]);new zg[h](n.buffer,0,1)[0]=t.length,n.set(t,Kg[h]),a[e]=n}const r=a.reduce(((e,t)=>e+t.length),0),d=new ArrayBuffer(r),u=new Uint8Array(d);for(let e=0,t=0;e<a.length;++e)o[e].node.setAttribute("offset",t),u.set(a[e],t),t+=a[e].length;if(t.binaryBuffer=d,!t.binaryBuffer)return console.error("Processing appended data format: requires binaryBuffer to parse"),!1}e.parseXML(l,d,c,u,h);const g=l.getElementsByTagName(d)[0].getElementsByTagName("FieldData")[0];if(g){const e=Qg(g,c,0,h,t.binaryBuffer);for(let n=0;n<t.output.length;n++){const o=t.output[n].getFieldData();for(let t=0;t<e.length;t++)o.addArray(e[t])}}return!0},e.requestData=(n,o)=>{e.parseAsArrayBuffer(t.rawDataBuffer)}}const tm={};var nm={extend:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,tm,n),Bo.m.obj(e,t),Bo.m.get(e,t,["url","baseURL"]),Bo.m.setGet(e,t,["dataAccessHelper"]),Bo.m.algo(e,t,0,1),em(e,t)},processDataArray:Xg,processFieldData:function(e,t,n,o,i,a,r){if(t){const i={};["Scalars","Vectors","Normals","Tensors","TCoords"].forEach((e=>{const o=t.getAttribute(e);o&&(i[o]=n[`set${e}`])}));const s=t.getElementsByTagName("DataArray"),l=s.length;for(let t=0;t<l;t++){const l=s[t],d=Vo.default.newInstance(Xg(e,l,o,0,a,r)),c=d.getName();(i[c]||n.addArray)(d)}}},processCells:function(e,t,n,o,i,a){const r={},s=t.getElementsByTagName("DataArray");for(let e=0;e<s.length;e++){const t=s[e];r[t.getAttribute("Name")]=t}const l=Xg(e,r.offsets,n,0,i,a).values,d=l[l.length-1],c=Xg(d,r.connectivity,n,0,i,a).values,u=new Uint32Array(e+d);let h=0,g=0;return l.forEach((e=>{const t=e-g;u[h++]=t;for(let e=0;e<t;e++)u[h++]=c[g+e];g=e})),u}};function om(e,t,n,o,i,a,r){const s=Number(n.getAttribute(`NumberOf${t}`));if(s>0){const l=n.getElementsByTagName(t)[0].getElementsByTagName("DataArray")[0],{values:d,numberOfComponents:c}=nm.processDataArray(s,l,o,i,a,r);e[`get${t}`]().setData(d,c)}return s}function im(e,t,n,o,i,a,r){const s=Number(n.getAttribute(`NumberOf${t}`));if(s>0){const l=nm.processCells(s,n.getElementsByTagName(t)[0],o,i,a,r);e[`get${t}`]().setData(l)}return s}const am={dataType:"PolyData"};function rm(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,am,n),nm.extend(e,t,n),function(e,t){t.classHierarchy.push("vtkXMLPolyDataReader"),e.parseXML=(e,n,o,i,a)=>{const r=e.getElementsByTagName(t.dataType)[0].getElementsByTagName("Piece"),s=r.length;for(let e=0;e<s;e++){const n=Ho.ZP.newInstance(),s=r[e],l=om(n,"Points",s,o,i,a,t.binaryBuffer);let d=0;["Verts","Lines","Strips","Polys"].forEach((e=>{d+=im(n,e,s,o,i,a,t.binaryBuffer)})),nm.processFieldData(l,s.getElementsByTagName("PointData")[0],n.getPointData(),o,i,a,t.binaryBuffer),nm.processFieldData(d,s.getElementsByTagName("CellData")[0],n.getCellData(),o,i,a,t.binaryBuffer),t.output[e]=n}}}(e,t)}var sm={newInstance:Bo.m.newInstance(rm,"vtkXMLPolyDataReader"),extend:rm};const lm={ANNOTATED_CUBE:1,AXES:2,CUSTOM:3};class dm extends Ga{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{orientationWidget:{enabled:!0,viewportCorner:$h.Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:125,maxPixelSize:125},overlayMarkerType:dm.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[dm.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"L",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"R",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"H"},zMinus:{text:"F",faceRotation:180}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[dm.OVERLAY_MARKER_TYPES.AXES]:{},[dm.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}),this.configuration_invalidated=!0,this.onSetToolEnabled=()=>{this.initViewports(),this.configuration_invalidated=!0},this.onSetToolActive=()=>{this.initViewports()},this.onSetToolDisabled=()=>{this.cleanUpData()},this.orientationMarkers={},this.configuration_invalidated=!0}cleanUpData(){(0,te.getRenderingEngines)()[0].getViewports().forEach((e=>{const t=this.orientationMarkers[e.id];if(!t)return;const{actor:n,orientationWidget:o}=t;o?.setEnabled(!1),o?.delete(),n?.delete();e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow().render(),e.getRenderingEngine().render(),delete this.orientationMarkers[e.id]}))}initViewports(){const e=(0,te.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=Al(t,this.getToolName()),t.forEach((e=>this.addAxisActorInViewport(e)))}async addAxisActorInViewport(e){const t=e.id,n=this.configuration.overlayMarkerType,o=this.configuration.overlayConfiguration[n];if(this.orientationMarkers[t]){const{actor:n,orientationWidget:o}=this.orientationMarkers[t];e.getRenderer().removeActor(n),o.setEnabled(!1)}let i;1===n?i=this.createAnnotationCube(o):2===n?i=vg.newInstance():3===n&&(i=await this.createCustomActor());const a=e.getRenderer(),r=e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow(),{enabled:s,viewportCorner:l,viewportSize:d,minPixelSize:c,maxPixelSize:u}=this.configuration.orientationWidget,h=$h.newInstance({actor:i,interactor:r.getInteractor(),parentRenderer:a});h.setEnabled(s),h.setViewportCorner(l),h.setViewportSize(d),h.setMinPixelSize(c),h.setMaxPixelSize(u),h.updateMarkerOrientation(),this.orientationMarkers[t]={orientationWidget:h,actor:i},r.render(),e.getRenderingEngine().render(),this.configuration_invalidated=!1}async createCustomActor(){const e=this.configuration.overlayConfiguration[lm.CUSTOM].polyDataURL,t=await fetch(e),n=await t.arrayBuffer(),o=sm.newInstance();o.parseAsArrayBuffer(n),o.update();const i=Ho.ZP.newInstance();i.shallowCopy(o.getOutputData()),i.getPointData().setActiveScalars("Color");const a=Yo.default.newInstance();a.setInputData(i),a.setColorModeToDirectScalars();const r=Zo.ZP.newInstance();return r.setMapper(a),r.rotateZ(180),r}createAnnotationCube(e){const t=ng.newInstance();return t.setDefaultStyle({...e.defaultStyle}),t.setXPlusFaceProperty({...e.faceProperties.xPlus}),t.setXMinusFaceProperty({...e.faceProperties.xMinus}),t.setYPlusFaceProperty({...e.faceProperties.yPlus}),t.setYMinusFaceProperty({...e.faceProperties.yMinus}),t.setZPlusFaceProperty({...e.faceProperties.zPlus}),t.setZMinusFaceProperty({...e.faceProperties.zMinus}),t}async createAnnotatedCubeActor(){const e=ng.newInstance(),{faceProperties:t,defaultStyle:n}=this.configuration.annotatedCube;return e.setDefaultStyle(n),Object.keys(t).forEach((n=>{const o=`set${n.charAt(0).toUpperCase()+n.slice(1)}FaceProperty`;e[o](t[n])})),e}}dm.CUBE=1,dm.AXIS=2,dm.VTPFILE=3,dm.OVERLAY_MARKER_TYPES=lm,dm.toolName="OrientationMarker";const cm=dm;const um=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=[];return e.forEach((e=>{const{data:i}=e,{points:a}=i.handles,{imageData:r,dimensions:s}=t;let l=a;if(i.cachedStats?.projectionPoints){const{projectionPoints:e}=i.cachedStats;l=[].concat(...e)}const d=l.map((e=>te.utilities.transformWorldToIndex(r,e)));let c=os(d,s);n.numSlicesToProject&&!i.cachedStats?.projectionPoints&&(c=ns(c,n.numSlicesToProject)),o.push(c)})),1===o.length?o[0]:o.reduce(((e,t)=>({iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)})),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})};const hm=function(e,t,n,o){const i=e.map((e=>Cv(e)));let a;!function(e){const t=[yh.toolName,Mh.toolName];for(const n of e){const e=n.metadata.toolName;if(!t.includes(e))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}(i);for(let e=0;e<n.length;e++){n[e].volume.getScalarData().length!==t.getScalarData().length&&0!==e||(a=um(i,n[e].volume,o))}return nl(t,n,{...o,boundsIJK:a})};const gm=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"mergedLabelmap";e.forEach((t=>{let{direction:n,dimensions:o,origin:i,spacing:a}=t;if(!(te.utilities.isEqual(o,e[0].dimensions)&&te.utilities.isEqual(n,e[0].direction)&&te.utilities.isEqual(a,e[0].spacing)&&te.utilities.isEqual(i,e[0].origin)))throw new Error("labelmaps must have the same size and shape")}));const o=e[0],i=new(0,o.getScalarData().constructor)(o.getScalarData().length);e.forEach((e=>{const n=e.getScalarData();for(let e=0;e<n.length;e++)n[e]===t&&(i[e]=t)}));const a={scalarData:i,metadata:o.metadata,spacing:o.spacing,origin:o.origin,direction:o.direction,dimensions:o.dimensions};return te.volumeLoader.createLocalVolume(a,n,!0)};function mm(e,t){if(e===le.Labelmap)return function(e){return e&&"boolean"==typeof e.renderOutline&&"number"==typeof e.outlineWidthActive&&"number"==typeof e.outlineWidthInactive&&"boolean"==typeof e.renderFill&&"boolean"==typeof e.renderFillInactive&&"number"==typeof e.fillAlpha&&"number"==typeof e.fillAlphaInactive&&"number"==typeof e.outlineOpacity&&"number"==typeof e.outlineOpacityInactive}(t);throw new Error(`Unknown representation type: ${e}`)}function fm(e){const{type:t}=e;if(t===le.Labelmap)return Hn();throw new Error(`Unknown representation type: ${t}`)}async function pm(e){const{viewportId:t,renderingEngineId:n,options:o}=e;let{segmentationId:i}=e;const a=(0,te.getEnabledElementByIds)(t,n);if(!a)throw new Error("element disabled");const{viewport:r}=a;if(!(r instanceof te.VolumeViewport))throw new Error("Segmentation only supports VolumeViewport");const{uid:s}=r.getDefaultActor();if(void 0===i&&(i=`${s}-based-segmentation-${o?.volumeId??te.utilities.uuidv4().slice(0,8)}`),o){const e=(0,ce._cloneDeep)(o);await te.volumeLoader.createLocalVolume(e,i)}else{const{uid:e}=r.getDefaultActor();await te.volumeLoader.createAndCacheDerivedVolume(e,{volumeId:i})}return i}function vm(e,t,n){const o=dv(e);if(void 0===o)return;Js(e,n).forEach((e=>{e.configuration.brushSize=t,e.invalidateBrushCursor()}));const i=o.getViewportsInfo(),a=Object.keys(i).map((e=>i[e]));if(!a.length)return;const{renderingEngineId:r}=a[0],s=o.getViewportIds(),l=(0,te.getRenderingEngine)(r);Jr(l,s)}function Em(e,t){const n=dv(e);if(void 0===n)return;const o=n._toolInstances;if(!Object.keys(o).length)return;const i=Js(e,t)[0];return i?i.configuration.brushSize:void 0}function wm(e,t){const n=dv(e);if(void 0===n)return;Js(e).forEach((e=>{e.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold=t}));const o=n.getViewportsInfo();if(!o.length)return;const{renderingEngineId:i}=o[0],a=n.getViewportIds(),r=(0,te.getRenderingEngine)(i);Jr(r,a)}function Im(e){const t=dv(e);if(void 0===t)return;const n=t._toolInstances;if(!Object.keys(n).length)return;const o=Js(e)[0];return o?o.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold:void 0}const Cm=function(e,t,n,o){const i=e.getScalarData(),{baseVolumeIdx:a,volumeInfoList:r}=tl(e,n);return r.forEach((e=>{const{volumeSize:n}=e;n===i.length?function(e,t,n){const{referenceValues:o,lower:i,upper:a}=n;for(let n=0;n<e.length;n++)if(e[n]===t){const r=o[n];e[n]=r>=i&&r<=a?t:0}}(i,t,e):function(e,t,n,o,i,a){const{imageData:r,lower:s,upper:l,dimensions:d}=n;let c,u,h;for(let n=0;n<e.length;n++)if(e[n]===t){const g=el(r,d,o[i].spacing,o[i].imageData.getPoint(n)),m=e=>{let{value:t}=e;c+=1,t>=h.lower&&t<=h.upper&&(u+=1)};c=0,u=0,h={lower:s,upper:l};let f=!1;ts(r,(()=>!0),m,g),f=0===a?u>0:u===c,e[n]=f?t:0}}(i,t,e,r,a,o)})),Yn(e.volumeId),e};function Tm(e){let t="";const n=e[0]<0?"R":"L",o=e[1]<0?"A":"P",i=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=1e-4;for(let e=0;e<3;e++)if(a[0]>r&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>r&&a[1]>a[0]&&a[1]>a[2])t+=o,a[1]=0;else if(a[2]>r&&a[2]>a[0]&&a[2]>a[1])t+=i,a[2]=0;else if(a[0]>r&&a[1]>r&&a[0]===a[1])t+=n+o,a[0]=0,a[1]=0;else if(a[0]>r&&a[2]>r&&a[0]===a[2])t+=n+i,a[0]=0,a[2]=0;else{if(!(a[1]>r&&a[2]>r&&a[1]===a[2]))break;t+=o+i,a[1]=0,a[2]=0}return t}function bm(e){let t=e.replace("H","f");return t=t.replace("F","h"),t=t.replace("R","l"),t=t.replace("L","r"),t=t.replace("A","p"),t=t.replace("P","a"),t=t.toUpperCase(),t}var _m;!function(e){e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED"}(_m||(_m={}));const Dm=_m,Sm={};function ym(e,t){const n=(0,te.getEnabledElement)(e),{viewportId:o}=n;Sm[o]=t}function Om(e){const t=(0,te.getEnabledElement)(e),{viewportId:n}=t;return Sm[n]}const{ViewportStatus:Pm}=te.Enums,{triggerEvent:Mm}=te.utilities,xm=!0,Rm=!0,Nm=new Map;function Am(e,t){let n,o;if(void 0===e)throw new Error("playClip: element must not be undefined");const i=(0,te.getEnabledElement)(e);if(!i)throw new Error("playClip: element must be a valid Cornerstone enabled element");t.dynamicCineEnabled=t.dynamicCineEnabled??!0;const{viewport:a}=i,r=Vm(a),s=function(e,t){if(e instanceof te.StackViewport)return function(e,t){const n=e.getImageIds();return{get numScrollSteps(){return n.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(n){this.waitForRenderedCount<=t&&e.viewportStatus!==Pm.RENDERED?this.waitForRenderedCount++:(this.waitForRenderedCount=0,Qr(e,{delta:n,debounceLoading:xm}))}}}(e,t.waitForRendered??30);if(e instanceof te.VolumeViewport){const n=Vm(e);return t.dynamicCineEnabled&&n?.isDynamicVolume()?function(e){return{get numScrollSteps(){return e.numTimePoints},get currentStepIndex(){return e.timePointIndex},get frameTimeVectorEnabled(){return!1},scroll(t){e.timePointIndex+=t}}}(n):function(e,t){const{volumeId:n}=t,o={viewPlaneNormal:$a.R3.create(),scrollInfo:null},i=()=>{const t=e.getCamera();if(!o.scrollInfo||!$a.R3.equals(t.viewPlaneNormal,o.viewPlaneNormal)){const i=te.utilities.getVolumeViewportScrollInfo(e,n);o.viewPlaneNormal=t.viewPlaneNormal,o.scrollInfo=i}return o.scrollInfo};return{get numScrollSteps(){return i().numScrollSteps},get currentStepIndex(){return i().currentStepIndex},get frameTimeVectorEnabled(){const n=e.getCamera(),o=t.direction.slice(6,9).map((e=>-e)),i=$a.R3.dot(o,n.viewPlaneNormal);return $a.DV.equals(i,1)},scroll(t){i().currentStepIndex+=t,Qr(e,{delta:t})}}}(e,n)}throw new Error("Unknown viewport type")}(a,t);let l=Om(e);const d=t.dynamicCineEnabled&&r?.isDynamicVolume();if(d&&Um(e),l?km(e,d):(l={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:t.frameTimeVector??void 0,speed:t.frameTimeVectorSpeedMultiplier??1,reverse:t.reverse??!1,loop:t.loop??!0},ym(e,l)),l.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(l.framesPerSecond=Number(t.framesPerSecond),l.reverse=l.framesPerSecond<0,l.ignoreFrameTimeVector=!0),!0!==l.ignoreFrameTimeVector&&l.frameTimeVector&&l.frameTimeVector.length===s.numScrollSteps&&s.frameTimeVectorEnabled){const{timeouts:e,isTimeVarying:t}=function(e,t){let n,o,i,a=0;const r=e.length,s=[];let l=!1;("number"!=typeof t||t<=0)&&(t=1);for(n=1;n<r;n++)i=Number(e[n])/t|0,s.push(i),1===n?o=i:i!==o&&(l=!0),a+=i;s.length>0&&(i=l?a/s.length|0:s[0],s.push(i));return{timeouts:s,isTimeVarying:l}}(l.frameTimeVector,l.speed);n=e,o=t}const c=()=>{const{numScrollSteps:t,currentStepIndex:n}=s;let o=n+(l.reverse?-1:1);if(!Rm&&(o<0||o>=t)){km(e,d);const t={element:e};return void Mm(e,Dm.CLIP_STOPPED,t)}o>=t?o=0:o<0&&(o=t-1);const i=o-n;i&&s.scroll(i)};d&&Nm.set(r.volumeId,e),n&&n.length>0&&o?(l.usingFrameTimeVector=!0,l.intervalId=window.setTimeout((function e(){l.intervalId=window.setTimeout(e,n[s.currentStepIndex]),c()}),0)):(l.usingFrameTimeVector=!1,l.intervalId=window.setInterval(c,1e3/Math.abs(l.framesPerSecond)));const u={element:e};Mm(e,Dm.CLIP_STARTED,u)}function Lm(e){km(e,!0)}function km(e,t){const n=(0,te.getEnabledElement)(e);if(!n)return;const{viewport:o}=n,i=Om(o.element);i&&function(e){const t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}(i),t&&o instanceof te.BaseVolumeViewport&&Um(e)}function Um(e){const{viewport:t}=(0,te.getEnabledElement)(e),n=Vm(t);if(n?.isDynamicVolume()){const t=Nm.get(n.volumeId);Nm.delete(n.volumeId),t&&t!==e&&Lm(t)}}function Vm(e){const t=function(e){return e.getActors().map((e=>te.cache.getVolume(e.uid))).filter((e=>!!e))}(e);return t.find((e=>e.isDynamicVolume()))??t[0]}function Bm(e,t,n){if(function(e,t,n){if(!t?.data?.polyline||n<=0)return!0;if(!e.viewport)return!0;const{renderingEngineId:o,viewportId:i,FrameOfReferenceUID:a}=e,r=Vp(i,o);if(t.metadata.FrameOfReferenceUID!==a)return!0;if(!r)return!0;const s=r.getToolInstance(t.metadata.toolName);return!(s instanceof Yu)||s.isDrawing||s.isEditingOpen||s.isEditingClosed}(e,t,n))return!1;const{viewport:o}=e,i=t.data.polyline.map(o.worldToCanvas),a=Oc(i,0,i.length,n);return a!==i&&(t.data.polyline=a.map(o.canvasToWorld),!0)}const Fm={interpolateAnnotation:Bm},Hm={};function Wm(e,t){const n=(0,te.getEnabledElement)(e),{viewportId:o}=n;Hm[o]=t}function Gm(e){const t=(0,te.getEnabledElement)(e),{viewportId:n}=t;return Hm[n]}const $m=te.Enums.RequestType.Prefetch,zm=0;function Km(e,t){e=Math.round(e)||0;const n=[];let o=(t=Math.round(t)||0)-e+1;if(o<=0)return n;for(;o--;)n[o]=t--;return n}function qm(e){const t=(0,te.getEnabledElement)(e);if(!t)return null;const{viewport:n}=t;if(!(n instanceof te.StackViewport))throw new Error("stackPrefetch: element must be a StackViewport, VolumeViewport stackPrefetch not yet implemented");return{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}}function jm(e){return function(t){const n=t.detail;let o;try{o=qm(e)}catch(e){return}if(!o||!o.imageIds||0===o.imageIds.length)return;const i=o.imageIds.indexOf(n.imageId);if(i<0)return;const a=Gm(e);a&&a.data&&a.data.length&&a.indicesToRequest.push(i)}}const Zm=e=>{const t=new Set(e.imageIds);return e=>e.type!==$m||!t.has(e.additionalDetails.imageId)};let Ym,Xm={maxImagesToPrefetch:1/0,preserveExistingPool:!0};const Jm=10;function Qm(e){const t=Gm(e);if(!t)return;const n=t||{},o=qm(e);if(!o?.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:i}=o;if(n.enabled&&=n.indicesToRequest?.length,!1===n.enabled)return;function a(e){const t=n.indicesToRequest.indexOf(e);t>-1&&n.indicesToRequest.splice(t,1)}t.indicesToRequest.sort(((e,t)=>e-t));if(n.indicesToRequest.slice().forEach((function(e){const t=o.imageIds[e];if(!t)return;(Math.abs(i-e)<6?te.cache.getImageLoadObject(t):te.cache.isLoaded(t))&&a(e)})),!n.indicesToRequest.length)return;Xm.preserveExistingPool||te.imageLoadPoolManager.clearRequestStack($m);const r=function(e,t){let n=0,o=e.length-1;return e.forEach(((e,i)=>{e<t?n=Math.max(i,n):e>t&&(o=Math.min(i,o))})),{low:n,high:o}}(n.indicesToRequest,o.currentImageIdIndex);let s,l;let d=r.low,c=r.high;const u=[];for(;d>=0||c<n.indicesToRequest.length;){const e=o.currentImageIdIndex,t=!(e-n.indicesToRequest[d]>Xm.maxImagesToPrefetch)&&d>=0,i=!(n.indicesToRequest[c]-e>Xm.maxImagesToPrefetch)&&c<n.indicesToRequest.length;if(!i&&!t)break;t&&(l=n.indicesToRequest[d--],s=o.imageIds[l],u.push(s)),i&&(l=n.indicesToRequest[c++],s=o.imageIds[l],u.push(s))}const h=(e,t)=>te.imageLoader.loadAndCacheImage(e,t),{useNorm16Texture:g}=(0,te.getConfiguration)().rendering;u.forEach((e=>{const t={targetBuffer:{type:g?void 0:"Float32Array"},preScale:{enabled:!0},requestType:$m};te.imageLoadPoolManager.addRequest(h.bind(null,e,t),$m,{imageId:e},zm)}))}function ef(e){clearTimeout(Ym),Ym=setTimeout((function(){const t=e.target;try{Qm(t)}catch(e){return}}),Jm)}const tf={enable:function(e){const t=qm(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n={indicesToRequest:Km(0,t.imageIds.length-1),enabled:!0,direction:1},o=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(o,1),Wm(e,n),Qm(e),e.removeEventListener(te.Enums.Events.STACK_NEW_IMAGE,ef),e.addEventListener(te.Enums.Events.STACK_NEW_IMAGE,ef);const i=jm(e);te.eventTarget.removeEventListener(te.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,i),te.eventTarget.addEventListener(te.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,i)},disable:function(e){clearTimeout(Ym),e.removeEventListener(te.Enums.Events.STACK_NEW_IMAGE,ef);const t=jm(e);te.eventTarget.removeEventListener(te.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=Gm(e);n&&n.indicesToRequest.length&&(n.enabled=!1,te.imageLoadPoolManager.clearRequestStack($m))},getConfiguration:function(){return Xm},setConfiguration:function(e){Xm=e}};let nf,of={maxImagesToPrefetch:1/0,minBefore:50,maxAfter:50,directionExtraImages:10,preserveExistingPool:!1};const af=5;function rf(e){const t=qm(e);if(!t?.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n=Gm(e);if(!n)return;const o=n||{};if(o.enabled&&=o.indicesToRequest?.length,!1===o.enabled)return;function i(e){const t=o.indicesToRequest.indexOf(e);t>-1&&o.indicesToRequest.splice(t,1)}const a=o.indicesToRequest.slice(),{currentImageIdIndex:r}=t;if(a.forEach((e=>{const n=t.imageIds[e];if(!n)return;(Math.abs(r-e)<6?te.cache.getImageLoadObject(n):te.cache.isLoaded(n))&&i(e)})),!o.indicesToRequest.length)return;of.preserveExistingPool||te.imageLoadPoolManager.filterRequests(Zm(t));const s=(n,a)=>te.imageLoader.loadAndCacheImage(n,a).then((()=>function(n){i(t.imageIds.indexOf(n));const a=te.cache.getCachedImageBasedOnImageURI(n),{stats:r}=o,s=a?.image?.decodeTimeInMS||0;if(s){r.imageIds.set(n,s),r.decodeTimeInMS+=s;const e=a?.image?.loadTimeInMS||0;r.loadTimeInMS+=e}if(!o.indicesToRequest.length&&a?.sizeInBytes){const{sizeInBytes:t}=a,n=te.cache.getMaxCacheSize()/4/t;if(o.cacheFill){if(r.imageIds.size){r.fillTime=Date.now()-r.start;const{size:e}=r.imageIds;r.fillSize=e,console.log("Done cache fill",r.fillTime,"ms",e,"items","average total time",rs(r.fillTime/e),"ms","average load",rs(r.loadTimeInMS/e),"ms","average decode",rs(r.decodeTimeInMS/e),"ms")}}else r.initialTime=Date.now()-r.start,r.initialSize=r.imageIds.size,lf(e,n),rf(e)}}(n))),{useNorm16Texture:l}=(0,te.getConfiguration)().rendering;a.forEach((e=>{const n=t.imageIds[e],o={targetBuffer:{type:l?void 0:"Float32Array"},preScale:{enabled:!0},requestType:$m};te.imageLoadPoolManager.addRequest(s.bind(null,n,o),$m,{imageId:n},zm)}))}function sf(e){clearTimeout(nf),nf=setTimeout((function(){const t=e.target;try{lf(t),rf(t)}catch(e){return}}),af)}const lf=(e,t)=>{const n=qm(e);if(!n||!n.imageIds||0===n.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:o}=n;let{maxAfter:i=2,minBefore:a=2}=of;const{directionExtraImages:r=10}=of,s=Gm(e)||{indicesToRequest:[],currentImageIdIndex:o,stackCount:0,enabled:!0,direction:1,stats:{start:Date.now(),imageIds:new Map,decodeTimeInMS:0,loadTimeInMS:0,totalBytes:0}},l=o-s.currentImageIdIndex;if(s.direction=l<0?-1:1,s.currentImageIdIndex=o,s.enabled=!0,s.stackCount<100&&(s.stackCount+=r),Math.abs(l)>i||!l)if(s.stackCount=0,t){const e=o/n.imageIds.length;a=Math.ceil(t*e),i=Math.ceil(t*(1-e)),s.cacheFill=!0}else s.cacheFill=!1;else l<0?(a+=s.stackCount,i=0):(i+=s.stackCount,a=0);const d=Math.max(0,o-a),c=Math.min(n.imageIds.length-1,o+i),u=[];for(let e=o+1;e<=c;e++)u.push(e);for(let e=o-1;e>=d;e--)u.push(e);s.indicesToRequest=u,Wm(e,s)};const df={enable:e=>{const t=qm(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");lf(e),rf(e),e.removeEventListener(te.Enums.Events.STACK_NEW_IMAGE,sf),e.addEventListener(te.Enums.Events.STACK_NEW_IMAGE,sf);const n=jm(e);te.eventTarget.removeEventListener(te.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n),te.eventTarget.addEventListener(te.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n)},disable:function(e){clearTimeout(nf),e.removeEventListener(te.Enums.Events.STACK_NEW_IMAGE,sf);const t=jm(e);te.eventTarget.removeEventListener(te.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=Gm(e);n&&n.data.length&&(n.enabled=!1)},getConfiguration:function(){return of},setConfiguration:function(e){of=e}};const cf=function(e,t){const n=t.frameNumbers||[...Array(e.numTimePoints).keys()];if(!t.maskVolumeId&&!t.imageCoordinate)throw new Error("You should provide either maskVolumeId or imageCoordinate");if(t.maskVolumeId&&t.imageCoordinate)throw new Error("You can only use one of maskVolumeId or imageCoordinate");if(t.maskVolumeId){const o=function(e,t,n){const{imageData:o}=n,i=n.getScalarData(),a=i.length,r=[];r.length=a;let s=0;for(let e=0,t=i.length;e<t;e++)0!==i[e]&&(r[s++]=e);r.length=s;const l=t.getScalarDataArrays(),d=[],c=l[0].length===a&&JSON.stringify(t.spacing)===JSON.stringify(n.spacing);if(c){for(let t=0;t<r.length;t++){const n=[];e.forEach((e=>{const o=l[e];n.push(o[r[t]])})),d.push(n)}return d}const u=n=>{let{pointLPS:o,value:i}=n;if(0===i)return;const a=el(t.imageData,t.dimensions,t.spacing,o);let r=0;const s=new Map;e.forEach((e=>s.set(e,0)));const c=t=>{let{index:n}=t;for(let t=0;t<e.length;t++){const o=l[t][n],i=e[t];s.set(i,s.get(i)+o)}r++};ts(t.imageData,(()=>!0),c,a);const u=[];s.forEach((e=>{u.push(e/r)})),d.push(u)};return ts(o,(()=>!0),u),d}(n,e,te.cache.getVolume(t.maskVolumeId));return o}if(t.imageCoordinate){const o=function(e,t,n){const{dimensions:o,imageData:i}=n,a=i.worldToIndex(t);if(a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a[2]=Math.floor(a[2]),!te.utilities.indexWithinDimensions(a,o))throw new Error("outside bounds");const r=o[0],s=o[0]*o[1],l=n.getScalarDataArrays(),d=[];return e.forEach((e=>{const t=l[e],n=a[2]*s+a[1]*r+a[0];d.push(t[n])})),d}(n,t.imageCoordinate,e);return o}};const uf=function(e,t,n){const o=n||[...Array(e.numTimePoints).keys()],i=o.length;if(o.length<=1)throw new Error("Please provide two or more time points");const a=e.getScalarDataArrays(),r=a[0].length,s=new Float32Array(r);if(t===te.Enums.DynamicOperatorType.SUM){for(let e=0;e<i;e++){const t=a[o[e]];for(let e=0;e<r;e++)s[e]+=t[e]}return s}if(t===te.Enums.DynamicOperatorType.SUBTRACT){if(o.length>2)throw new Error("Please provide only 2 time points for subtraction.");for(let e=0;e<r;e++)s[e]+=a[o[0]][e]-a[o[1]][e];return s}if(t===te.Enums.DynamicOperatorType.AVERAGE){for(let e=0;e<i;e++){const t=a[o[e]];for(let e=0;e<r;e++)s[e]+=t[e]}for(let e=0;e<r;e++)s[e]=s[e]/i;return s}};function hf(e,t){if(t<e.length/3)return[e[3*t],e[3*t+1],e[3*t+2]]}function gf(e){const t=e.getLines().getData();let n=0;const o=new Map;for(;n<t.length;){const e=t[n++],i=[];for(let o=0;o<e;o++)i.push(t[n+o]);o.set(i[0],i),n+=e}const i=[],a=e=>{for(const[t,n]of e.entries())if(void 0!==n)return t;return-1};let r=a(o);for(;-1!==r;){const e=[r];for(;o.has(r);){const t=o.get(r)[1];o.has(t)&&e.push(t),o.delete(r),r=t}i.push(e),r=a(o)}return i.length?i:void 0}function mf(e){const t=gf(e);if(!t)return;const n=e.getPoints().getData();return t.map((e=>e.map((e=>hf(n,e)))))}var ff;!function(e){e.Top="top",e.Left="left",e.Bottom="bottom",e.Right="right"}(ff||(ff={}));const pf=e=>e&&e.upper>e.lower,vf=e=>!!e&&e.width>0&&e.height>0,Ef=(e,t)=>!!e&&!!t&&e.lower===t.lower&&e.upper===t.upper,wf=(e,t)=>!!e&&!!t&&e.width===t.width&&e.height===t.height,{clamp:If}=te.utilities;class Cf{constructor(e){Cf.validateProps(e);const{colormap:t,size:n={width:20,height:100},imageRange:o={lower:0,upper:1},voiRange:i={lower:0,upper:1},container:a,showFullPixelValueRange:r=!1}=e;this._colormap=t,this._imageRange=o,this._voiRange=i,this._showFullImageRange=r,this._canvas=this._createRootElement(n),a&&this.appendTo(a)}get colormap(){return this._colormap}set colormap(e){this._colormap=e,this.render()}get size(){const{width:e,height:t}=this._canvas;return{width:e,height:t}}set size(e){const{_canvas:t}=this;vf(e)&&!wf(t,e)&&(this._setCanvasSize(t,e),this.render())}get imageRange(){return{...this._imageRange}}set imageRange(e){pf(e)&&!Ef(e,this._imageRange)&&(this._imageRange=e,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(e){pf(e)&&!Ef(e,this._voiRange)&&(this._voiRange=e,this.render())}get showFullImageRange(){return this._showFullImageRange}set showFullImageRange(e){e!==this._showFullImageRange&&(this._showFullImageRange=e,this.render())}appendTo(e){e.appendChild(this._canvas),this.render()}dispose(){const{_canvas:e}=this,{parentElement:t}=e;t?.removeChild(e)}static validateProps(e){const{size:t,imageRange:n,voiRange:o}=e;if(t&&!vf(t))throw new Error('Invalid "size"');if(n&&!pf(n))throw new Error('Invalid "imageRange"');if(o&&!pf(o))throw new Error('Invalid "voiRange"')}_setCanvasSize(e,t){const{width:n,height:o}=t;e.width=n,e.height=o,Object.assign(e.style,{width:`${n}px`,height:`${o}px`})}_createRootElement(e){const t=document.createElement("canvas");return Object.assign(t.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",boxSizing:"border-box"}),this._setCanvasSize(t,e),t}render(){if(!this._canvas.isConnected)return;const{_colormap:e}=this,{RGBPoints:t}=e,n=t.length/4,o=e=>{const o=4*e;if(!(e<0||e>=n))return{index:e,position:t[o],color:[t[o+1],t[o+2],t[o+3]]}},{width:i,height:a}=this._canvas,r=this._canvas.getContext("2d"),s=i>a,l=s?i:a,{_voiRange:d}=this,c=this._showFullImageRange?this._imageRange:{...d},{windowWidth:u}=te.utilities.windowLevel.toWindowLevel(d.lower,d.upper);let h,g=o(0);const m=(c.upper-c.lower)/(l-1);let f=c.lower;for(let e=0;e<l;e++){const t=(f-d.lower)/u;if(g)for(let e=g.index;e<n&&!(t<=g.position);e++)h=g,g=o(e+1);let l;if(h)if(g){const e=(t-h.position)/(g.position-h.position);p=h.color,v=g.color,E=e,l=[p[0]*(1-E)+v[0]*E,p[1]*(1-E)+v[1]*E,p[2]*(1-E)+v[2]*E]}else l=[...h.color];else l=[...g.color];const c=l.map((e=>If(Math.round(255*e),0,255)));r.fillStyle=`rgb(${c[0]}, ${c[1]}, ${c[2]})`,s?r.fillRect(e,0,1,a):r.fillRect(0,a-e-1,i,1),f+=m}var p,v,E}}const Tf={FONT:"10px Arial",COLOR:"white",TICK_SIZE:5,TICK_WIDTH:1,TICK_LABEL_MARGIN:3,MAX_NUM_TICKS:8,TICKS_STEPS:[1,2.5,5,10]};class bf{constructor(e){bf.validateProps(e);const{top:t=0,left:n=0,size:o={width:20,height:100},imageRange:i={lower:0,upper:1},voiRange:a={lower:0,upper:1},ticks:r,container:s,showFullPixelValueRange:l=!1}=e,{style:d,position:c}=r??{};this._imageRange=i,this._voiRange=a,this._font=d?.font??Tf.FONT,this._color=d?.color??Tf.COLOR,this._tickSize=d?.tickSize??Tf.TICK_SIZE,this._tickWidth=d?.tickWidth??Tf.TICK_WIDTH,this._labelMargin=d?.labelMargin??Tf.TICK_LABEL_MARGIN,this._maxNumTicks=d?.maxNumTicks??Tf.MAX_NUM_TICKS,this._rangeTextPosition=c??ff.Right,this._showFullPixelValueRange=l,this._canvas=this._createCanvasElement(o,t,n),s&&this.appendTo(s)}get size(){const{width:e,height:t}=this._canvas;return{width:e,height:t}}set size(e){const{_canvas:t}=this;vf(e)&&!wf(t,e)&&(this._setCanvasSize(t,e),this.render())}get top(){return Number.parseInt(this._canvas.style.top)}set top(e){const{_canvas:t}=this;e!==this.top&&(t.style.top=`${e}px`,this.render())}get left(){return Number.parseInt(this._canvas.style.left)}set left(e){const{_canvas:t}=this;e!==this.left&&(t.style.left=`${e}px`,this.render())}get imageRange(){return{...this._imageRange}}set imageRange(e){pf(e)&&!Ef(e,this._imageRange)&&(this._imageRange=e,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(e){pf(e)&&!Ef(e,this._voiRange)&&(this._voiRange=e,this.render())}get tickSize(){return this._tickSize}set tickSize(e){e!==this._tickSize&&(this._tickSize=e,this.render())}get tickWidth(){return this._tickWidth}set tickWidth(e){e!==this._tickWidth&&(this._tickWidth=e,this.render())}get color(){return this._color}set color(e){e!==this._color&&(this._color=e,this.render())}get showFullPixelValueRange(){return this._showFullPixelValueRange}set showFullPixelValueRange(e){e!==this._showFullPixelValueRange&&(this._showFullPixelValueRange=e,this.render())}get visible(){return"block"===this._canvas.style.display}set visible(e){e!==this.visible&&(this._canvas.style.display=e?"block":"none",e&&this.render())}appendTo(e){e.appendChild(this._canvas),this.render()}static validateProps(e){const{size:t,imageRange:n,voiRange:o}=e;if(t&&!vf(t))throw new Error('Invalid "size"');if(n&&!pf(n))throw new Error('Invalid "imageRange"');if(o&&!pf(o))throw new Error('Invalid "voiRange"')}_setCanvasSize(e,t){const{width:n,height:o}=t;e.width=n,e.height=o,Object.assign(e.style,{width:`${n}px`,height:`${o}px`})}_createCanvasElement(e,t,n){const o=document.createElement("canvas");return Object.assign(o.style,{display:"none",position:"absolute",boxSizing:"border-box",top:`${t}px`,left:`${n}px`}),this._setCanvasSize(o,e),o}_getTicks(e){const{lower:t,upper:n}=e,o=(n-t)/(this._maxNumTicks-1),i=Math.pow(10,-Math.floor(Math.log10(Math.abs(o)))),a=o*i,r=Tf.TICKS_STEPS.find((e=>e>=a))/i,s=Math.ceil(n/r)*r,l=Math.floor(t/r)*r,d=Math.round((s-l)/r)+1,c=[];for(let e=0;e<d;e++)c.push(l+e*r);return{scaleMin:l,scaleMax:s,step:r,ticks:c}}_getLeftTickInfo(e){let{position:t,labelMeasure:n}=e;const{width:o}=this._canvas;return{labelPoint:[o-this.tickSize-n.width-this._labelMargin,t],tickPoints:{start:[o-this._tickSize,t],end:[o,t]}}}_getRightTickInfo(e){let{position:t}=e;return{labelPoint:[this._tickSize+this._labelMargin,t],tickPoints:{start:[0,t],end:[this._tickSize,t]}}}_getTopTickInfo(e){let{position:t,labelMeasure:n}=e;throw new Error("Not implemented")}_getBottomTickInfo(e){let{position:t,labelMeasure:n}=e;throw new Error("Not implemented")}render(){const{_canvas:e}=this;if(!e.isConnected||!this.visible)return;const{width:t,height:n}=e,o=t>=n,i=o?t:n,a=e.getContext("2d"),{_voiRange:r}=this,s=this._showFullPixelValueRange?this._imageRange:{...r},l=s.upper-s.lower,{ticks:d}=this._getTicks(s);a.clearRect(0,0,t,n),a.font=this._font,a.textBaseline="middle",a.fillStyle=this._color,a.strokeStyle=this._color,a.lineWidth=this.tickWidth,d.forEach((e=>{let t=Math.round(i*((e-s.lower)/l));if(o||(t=n-t),t<0||t>i)return;const r=e.toString(),d=a.measureText(r);let c;c=o?this._rangeTextPosition===ff.Top?this._getTopTickInfo({position:t,labelMeasure:d}):this._getBottomTickInfo({position:t,labelMeasure:d}):this._rangeTextPosition===ff.Left?this._getLeftTickInfo({position:t,labelMeasure:d}):this._getRightTickInfo({position:t});const{labelPoint:u,tickPoints:h}=c,{start:g,end:m}=h;return a.beginPath(),a.moveTo(g[0],g[1]),a.lineTo(m[0],m[1]),a.fillText(r,u[0],u[1]),a.stroke(),t}))}}class _f{constructor(e){let{id:t,container:n}=e;this._containerResizeCallback=e=>{let t,n;const{contentRect:o,contentBoxSize:i}=e[0];o?(t=o.width,n=o.height):i?.length&&(t=i[0].inlineSize,n=i[0].blockSize),this._containerSize={width:t,height:n},this.onContainerResize()},this._id=t,this._containerSize={width:0,height:0},this._rootElement=this.createRootElement(t),this._containerResizeObserver=new ResizeObserver(this._containerResizeCallback),n&&this.appendTo(n)}get id(){return this._id}get rootElement(){return this._rootElement}appendTo(e){const{_rootElement:t,_containerResizeObserver:n}=this,{parentElement:o}=t;e&&e!==o&&(o&&n.unobserve(o),e.appendChild(t),n.observe(e))}destroy(){const{_rootElement:e,_containerResizeObserver:t}=this,{parentElement:n}=e;n?.removeChild(e),t.disconnect()}get containerSize(){return{...this._containerSize}}createRootElement(e){const t=document.createElement("div");return t.id=e,t.classList.add("widget"),Object.assign(t.style,{width:"100%",height:"100%"}),t}onContainerResize(){}}const Df={MULTIPLIER:1,RANGE_TEXT_POSITION:ff.Right,TICKS_BAR_SIZE:50};class Sf extends _f{constructor(e){super(e),this._isMouseOver=!1,this._isInteracting=!1,this._mouseOverCallback=e=>{this._isMouseOver=!0,this.showTicks(),e.stopPropagation()},this._mouseOutCallback=e=>{this._isMouseOver=!1,this.hideTicks(),e.stopPropagation()},this._mouseDownCallback=e=>{this._isInteracting=!0,this.showTicks(),this._addVOIEventListeners(e),e.stopPropagation()},this._mouseDragCallback=(e,t)=>{const n=this.getVOIMultipliers(),o=this._getPointsFromMouseEvent(e),{points:i,voiRange:a}=t,r=$a.K4.sub($a.K4.create(),o.local,i.local),s=r[0]*n[0],l=r[1]*n[1];if(!s&&!l)return;const{lower:d,upper:c}=a;let{windowWidth:u,windowCenter:h}=te.utilities.windowLevel.toWindowLevel(d,c);u=Math.max(u+s,1),h+=l;const g=te.utilities.windowLevel.toLowHighRange(u,h);this.voiRange=g,e.stopPropagation(),e.preventDefault()},this._mouseUpCallback=e=>{this._isInteracting=!1,this.hideTicks(),this._removeVOIEventListeners(),e.stopPropagation()},this._eventListenersManager=new te.utilities.eventListener.MultiTargetEventListenerManager,this._colormaps=Sf.getColormapsMap(e),this._activeColormapName=Sf.getInitialColormapName(e),this._canvas=this._createCanvas(e),this._ticksBar=this._createTicksBar(e),this._rangeTextPosition=e.ticks?.position??Df.RANGE_TEXT_POSITION,this._canvas.appendTo(this.rootElement),this._ticksBar.appendTo(this.rootElement),this._addRootElementEventListeners()}get activeColormapName(){return this._activeColormapName}set activeColormapName(e){if(e===this._activeColormapName)return;const t=this._colormaps.get(e);t?(this._activeColormapName=e,this._canvas.colormap=t):console.warn(`Invalid colormap name (${e})`)}get imageRange(){return this._canvas.imageRange}set imageRange(e){this._canvas.imageRange=e,this._ticksBar.imageRange=e}get voiRange(){return this._canvas.voiRange}set voiRange(e){const{voiRange:t}=this._canvas;pf(e)&&!Ef(e,t)&&(this._canvas.voiRange=e,this._ticksBar.voiRange=e,this.onVoiChange(e))}get showFullImageRange(){return this._canvas.showFullImageRange}set showFullImageRange(e){this._canvas.showFullImageRange=e,this._ticksBar.showFullPixelValueRange=e}destroy(){super.destroy(),this._eventListenersManager.reset()}createRootElement(){const e=document.createElement("div");return Object.assign(e.style,{position:"relative",fontSize:"0",width:"100%",height:"100%"}),e}onContainerResize(){super.onContainerResize(),this.updateTicksBar(),this._canvas.size=this.containerSize}getVOIMultipliers(){return[Df.MULTIPLIER,Df.MULTIPLIER]}onVoiChange(e){}showTicks(){this.updateTicksBar(),this._ticksBar.visible=!0}hideTicks(){this._isInteracting||this._isMouseOver||(this._ticksBar.visible=!1)}static getColormapsMap(e){const{colormaps:t}=e;return t.reduce(((e,t)=>e.set(t.Name,t)),new Map)}static getInitialColormapName(e){const{activeColormapName:t,colormaps:n}=e;return!!t&&n.some((e=>e.Name===t))?t:n[0].Name}_createCanvas(e){const{imageRange:t,voiRange:n,showFullPixelValueRange:o}=e,i=this._colormaps.get(this._activeColormapName);return new Cf({colormap:i,imageRange:t,voiRange:n,showFullPixelValueRange:o})}_createTicksBar(e){const t=e.ticks;return new bf({imageRange:e.imageRange,voiRange:e.voiRange,ticks:t,showFullPixelValueRange:e.showFullPixelValueRange})}_getPointsFromMouseEvent(e){const{rootElement:t}=this,n=[e.clientX,e.clientY],o=[e.pageX,e.pageY],i=t.getBoundingClientRect();return{client:n,page:o,local:[o[0]-i.left-window.pageXOffset,o[1]-i.top-window.pageYOffset]}}updateTicksBar(){const{width:e,height:t}=this.containerSize;if(0===e&&0===t)return;const{_ticksBar:n,_rangeTextPosition:o}=this,i=e>=t,a=i?e:Df.TICKS_BAR_SIZE,r=i?Df.TICKS_BAR_SIZE:t;if(!function(e,t,n){return(e>=t?[ff.Top,ff.Bottom]:[ff.Left,ff.Right]).includes(n)}(e,t,o))throw new Error("Invalid rangeTextPosition value for the current colobar orientation");let s,l;n.size={width:a,height:r},i?(l=0,s=o===ff.Top?-r:t):(s=0,l=o===ff.Left?-a:e),n.top=s,n.left=l}_addRootElementEventListeners(){const{_eventListenersManager:e}=this,{rootElement:t}=this;e.addEventListener(t,"mouseover",this._mouseOverCallback),e.addEventListener(t,"mouseout",this._mouseOutCallback),e.addEventListener(t,"mousedown",this._mouseDownCallback)}_addVOIEventListeners(e){const{_eventListenersManager:t}=this,n={points:this._getPointsFromMouseEvent(e),voiRange:{...this._canvas.voiRange}};this._removeVOIEventListeners(),t.addEventListener(document,"voi.mouseup",this._mouseUpCallback),t.addEventListener(document,"voi.mousemove",(e=>this._mouseDragCallback(e,n)))}_removeVOIEventListeners(){const{_eventListenersManager:e}=this;e.removeEventListener(document,"voi.mouseup"),e.removeEventListener(document,"voi.mousemove")}}const{Events:yf}=te.Enums,Of={lower:-1e3,upper:1e3};class Pf extends Sf{constructor(e){const{element:t,volumeId:n}=e,o=Pf._getImageRange(t,n),i=Pf._getVOIRange(t,n);super({...e,imageRange:o,voiRange:i}),this.autoHideTicks=()=>{if(this._hideTicksTimeoutId)return;const e=this._hideTicksTime-Date.now();e<=0?this.hideTicks():this._hideTicksTimeoutId=window.setTimeout((()=>{this._hideTicksTimeoutId=0,this.autoHideTicks()}),e)},this._stackNewImageCallback=()=>{this.imageRange=Pf._getImageRange(this._element)},this._imageVolumeModifiedCallback=e=>{const{volumeId:t}=e.detail.imageVolume;if(t!==this._volumeId)return;const{_element:n}=this;this.imageRange=Pf._getImageRange(n,t)},this._viewportVOIModifiedCallback=e=>{const{viewportId:t,volumeId:n,range:o}=e.detail,{viewport:i}=this.enabledElement;t===i.id&&n===this._volumeId&&(this.voiRange=o,this.showAndAutoHideTicks())},this._element=t,this._volumeId=n,this._addCornerstoneEventListener()}get element(){return this._element}get enabledElement(){return(0,te.getEnabledElement)(this._element)}getVOIMultipliers(){const{viewport:e}=this.enabledElement;return function(e,t,n){if("PT"===te.utilities.getViewportModality(e,t)){const{clientWidth:o,clientHeight:i}=e.element,a=5/Math.max(o,i),r=Gd(e,t),{fixedPTWindowWidth:s=!0}=n??{},l=s?0:a;return r?[l,a]:[l,4]}return[4,4]}(e,this._volumeId)}onVoiChange(e){super.onVoiChange(e);const{viewport:t}=this.enabledElement;if(t instanceof te.StackViewport)t.setProperties({voiRange:e}),t.render();else if(t instanceof te.VolumeViewport){const{_volumeId:n}=this,o=te.utilities.getViewportsWithVolumeId(n,t.renderingEngineId);t.setProperties({voiRange:e},n),o.forEach((e=>e.render()))}}static _getImageRange(e,t){const n=(0,te.getEnabledElement)(e),{viewport:o}=n,i=t?o.getActor(t):o.getDefaultActor();if(!i)return Of;const a=i.actor.getMapper().getInputData().getPointData().getScalars().getRange();return 0===a[0]&&0===a[1]?Of:{lower:a[0],upper:a[1]}}static _getVOIRange(e,t){const n=(0,te.getEnabledElement)(e),{viewport:o}=n,i=t?o.getActor(t):o.getDefaultActor();if(!i||!te.utilities.isImageActor(i))return Of;const a=i.actor.getProperty().getRGBTransferFunction(0).getRange();return 0===a[0]&&0===a[1]?Of:{lower:a[0],upper:a[1]}}showAndAutoHideTicks(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this._hideTicksTime=Date.now()+e,this.showTicks(),this.autoHideTicks()}_addCornerstoneEventListener(){const{_element:e}=this;te.eventTarget.addEventListener(yf.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.addEventListener(yf.STACK_NEW_IMAGE,this._stackNewImageCallback),e.addEventListener(yf.VOI_MODIFIED,this._viewportVOIModifiedCallback)}}const Mf=function(e){if(!e.detail.removed.length)return;(0,te.getRenderingEngines)().forEach((e=>{const t=e.getViewports().map((e=>e.id));Jr(e,t)}))};const xf=function(e){const{viewportId:t,renderingEngineId:n}=e.detail,o=(0,te.getRenderingEngine)(n);Jr(o,[t])},Rf=function(e){Ir(e.detail.element)},Nf={enable:function(e){e.addEventListener(te.Enums.Events.IMAGE_RENDERED,Rf)},disable:function(e){e.removeEventListener(te.Enums.Events.IMAGE_RENDERED,Rf)}},{Active:Af}=ne;function Lf(e,t,n){if(Ze.isInteractingWithTool)return!1;const{renderingEngineId:o,viewportId:i}=n.detail,a=Vp(i,o);if(!a)return!1;let r;const s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const n=s[e],o=a.toolOptions[n],i=a.getToolInstance(n);if(o.mode===Af&&"function"==typeof i[t]){r=a.getToolInstance(n);break}}r&&r[t](n)}const kf=Lf.bind(null,"Mouse","mouseClickCallback"),Uf=Lf.bind(null,"Mouse","doubleClickCallback");function Vf(e,t,n){const o="touch"===(arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse")?36:6,i=[];return t.forEach((t=>{let{tool:a,annotations:r}=t;for(const t of r){if(t.isLocked||!t.isVisible)continue;const r=a.getHandleNearImagePoint(e,t,n,o);if(r){i.push({tool:a,annotation:t,handle:r});break}}})),i}function Bf(e,t){const n=[];for(let o=0;o<t.length;o++){const i=t[o];if(!i){console.warn("undefined tool in filterToolsWithAnnotationsForElement");continue}let a=vv(i.constructor.toolName,e);a?.length&&("function"==typeof i.filterInteractableAnnotationsForElement&&(a=i.filterInteractableAnnotationsForElement(e,a)),a.length>0&&n.push({tool:i,annotations:a}))}return n}function Ff(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse";const i="touch"===o?36:6,a=[];return t.forEach((t=>{let{tool:r,annotations:s}=t;for(const t of s){if(t.isLocked||!t.isVisible)continue;if(r.isPointNearTool(e,t,n,i,o)){a.push({tool:r,annotation:t});break}}})),a}const Hf=e=>e.shiftKey?e.ctrlKey?Q.ShiftCtrl:e.altKey?Q.ShiftAlt:e.metaKey?Q.ShiftMeta:Q.Shift:e.ctrlKey?e.altKey?Q.CtrlAlt:e.metaKey?Q.CtrlMeta:Q.Ctrl:e.altKey?e.metaKey&&Q.AltMeta||Q.Alt:e.metaKey?Q.Meta:void 0,{Active:Wf}=ne;function Gf(e){const{renderingEngineId:t,viewportId:n}=e.detail,o=e.detail.event,i=Hf(o)||An.getModifierKey(),a=Vp(n,t);if(!a)return null;const r=Object.keys(a.toolOptions),s=a.getDefaultMousePrimary();for(let e=0;e<r.length;e++){const t=r[e],n=a.toolOptions[t],l=n.bindings.length&&n.bindings.some((e=>e.mouseButton===(o?o.buttons:s)&&e.modifierKey===i));if(n.mode===Wf&&l)return a.getToolInstance(t)}}function $f(e,t,n){const{renderingEngineId:o,viewportId:i}=e.detail,a=Vp(i,o);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const o=s[e],i=a.toolOptions[o],l=null!=n&&i.bindings.length&&i.bindings.some((e=>e.mouseButton===n));if(t.includes(i.mode)&&(!n||l)){const e=a.getToolInstance(o);r.push(e)}}return r}const{Active:zf,Passive:Kf}=ne;function qf(e){if(Ze.isInteractingWithTool)return!1;const t=e.detail,{element:n}=t,o=(0,te.getEnabledElement)(n),{canvas:i}=t.currentPoints;if(!o)return!1;const a=function(e,t){const n=new Map,{renderingEngineId:o,viewportId:i}=e.detail,a=Vp(i,o);if(!a)return n;const r=Object.keys(a.toolOptions),s=a.getDefaultMousePrimary(),l=e.detail.event,d=l?.buttons??s,c=Hf(l)||An.getModifierKey();for(let e=0;e<r.length;e++){const o=r[e],i=a.getToolInstance(o),s=i.configuration?.actions;if(!s?.length||!t.includes(i.mode))continue;const l=s.find((e=>e.bindings.length&&e.bindings.some((e=>e.mouseButton===d&&e.modifierKey===c))));l&&n.set(i,l)}return n}(e,[zf,Kf]),r=Ff(n,Bf(n,Array.from(a.keys())),i);if(r.length>0){const{tool:t,annotation:n}=r[0],o=a.get(t);return("string"==typeof o.method?t[o.method]:o.method).call(t,e,n),!0}return!1}const{Active:jf,Passive:Zf}=ne;function Yf(e){if(Ze.isInteractingWithTool)return;const t=Gf(e);if(t&&"function"==typeof t.preMouseDownCallback){if(t.preMouseDownCallback(e))return}const n=1===e.detail.event.buttons,o=[...$f(e,[jf],e.detail.event.buttons)||[],...(n?$f(e,[Zf]):void 0)||[]],i=e.detail,{element:a}=i,r=Bf(a,o),s=i.currentPoints.canvas,l=Vf(a,r,s,"mouse"),d=!!e.detail.event.shiftKey;if(l.length>0){const{tool:t,annotation:n,handle:o}=Xf(l);return Jf(n.annotationUID,d),void t.handleSelectedCallback(e,n,o,"Mouse")}const c=Ff(a,r,s,"mouse");if(c.length>0){const{tool:t,annotation:n}=Xf(c);return Jf(n.annotationUID,d),void t.toolSelectedCallback(e,n,"Mouse",s)}if(t&&"function"==typeof t.postMouseDownCallback){if(t.postMouseDownCallback(e))return}qf(e)}function Xf(e){return e.length>1&&e.find((e=>!pe(e.annotation)&&Ue(e.annotation.annotationUID)))||e[0]}function Jf(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1])if(Pe(e))De(e,!1);else{De(e,!0,!0)}else{De(e,!0,!1)}}function Qf(e){if(Ze.isInteractingWithTool)return;const t=Gf(e);if(t&&!Ze.isMultiPartToolActive&&t.addNewAnnotation){const n=t.addNewAnnotation(e,"mouse");n&&De(n.annotationUID)}}function ep(e){if(Ze.isInteractingWithTool)return;const t=Gf(e);!t||"function"!=typeof t.mouseDragCallback||t.mouseDragCallback(e)}const{Active:tp,Passive:np}=ne;function op(e){if(Ze.isInteractingWithTool||Ze.isMultiPartToolActive)return;const t=$f(e,[tp,np]),n=e.detail,{element:o}=n,i=Bf(o,t),a=t.filter((e=>!i.some((t=>t.tool.getToolName()===e.getToolName()))));let r=!1;for(const{tool:t,annotations:n}of i)"function"==typeof t.mouseMoveCallback&&(r=t.mouseMoveCallback(e,n)||r);a.forEach((t=>{"function"==typeof t.mouseMoveCallback&&t.mouseMoveCallback(e)})),!0===r&&Ir(o)}const ip=Lf.bind(null,"Mouse","mouseUpCallback"),ap=Lf.bind(null,"MouseWheel","mouseWheelCallback"),rp={enable:function(e){e.addEventListener(re.MOUSE_CLICK,kf),e.addEventListener(re.MOUSE_DOWN,Yf),e.addEventListener(re.MOUSE_DOWN_ACTIVATE,Qf),e.addEventListener(re.MOUSE_DOUBLE_CLICK,Uf),e.addEventListener(re.MOUSE_DRAG,ep),e.addEventListener(re.MOUSE_MOVE,op),e.addEventListener(re.MOUSE_UP,ip),e.addEventListener(re.MOUSE_WHEEL,ap)},disable:function(e){e.removeEventListener(re.MOUSE_CLICK,kf),e.removeEventListener(re.MOUSE_DOWN,Yf),e.removeEventListener(re.MOUSE_DOWN_ACTIVATE,Qf),e.removeEventListener(re.MOUSE_DOUBLE_CLICK,Uf),e.removeEventListener(re.MOUSE_DRAG,ep),e.removeEventListener(re.MOUSE_MOVE,op),e.removeEventListener(re.MOUSE_UP,ip),e.removeEventListener(re.MOUSE_WHEEL,ap)}},{Active:sp}=ne;function lp(e){const{renderingEngineId:t,viewportId:n}=e.detail,o=ct.mouseButton,i=An.getModifierKey(),a=Vp(n,t);if(!a)return null;const r=Object.keys(a.toolOptions),s=a.getDefaultMousePrimary();for(let e=0;e<r.length;e++){const t=r[e],n=a.toolOptions[t],l=n.bindings.length&&n.bindings.some((e=>e.mouseButton===(o??s)&&e.modifierKey===i));if(n.mode===sp&&l)return a.getToolInstance(t)}}function dp(e){const t=lp(e);if(!t)return;const{renderingEngineId:n,viewportId:o}=e.detail,i=Vp(o,n),a=t.getToolName();Object.keys(i.toolOptions).includes(a)&&i.setViewportsCursorByToolName(a)}function cp(e){const t=lp(e);if(!t)return;const{renderingEngineId:n,viewportId:o}=e.detail,i=Vp(o,n);xn();const a=t.getToolName();Object.keys(i.toolOptions).includes(a)&&i.setViewportsCursorByToolName(a)}const up={enable:function(e){e.addEventListener(re.KEY_DOWN,dp),e.addEventListener(re.KEY_UP,cp)},disable:function(e){e.removeEventListener(re.KEY_DOWN,dp),e.removeEventListener(re.KEY_UP,cp)}},{Active:hp,Passive:gp,Enabled:mp}=ne,fp=function(e){$f(e,[hp,gp,mp]).forEach((t=>{t.onCameraModified&&t.onCameraModified(e)}))},pp={enable:function(e){e.addEventListener(te.Enums.Events.CAMERA_MODIFIED,fp)},disable:function(e){e.removeEventListener(te.Enums.Events.CAMERA_MODIFIED,fp)}},{Active:vp,Passive:Ep,Enabled:wp}=ne,Ip=function(e){$f(e,[vp,Ep,wp]).forEach((t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)}))},Cp={enable:function(e){e.addEventListener(te.Enums.Events.IMAGE_SPACING_CALIBRATED,Ip)},disable:function(e){e.removeEventListener(te.Enums.Events.IMAGE_SPACING_CALIBRATED,Ip)}},{Active:Tp}=ne;function bp(e){const{renderingEngineId:t,viewportId:n}=e.detail,o=e.detail.event,i=Vp(n,t);if(!i)return null;const a=Object.keys(i.toolOptions),r=Object.keys(o.touches).length,s=Hf(o)||An.getModifierKey(),l=i.getDefaultMousePrimary();for(let e=0;e<a.length;e++){const t=a[e],n=i.toolOptions[t],o=n.bindings.length&&n.bindings.some((e=>(e.numTouchPoints===r||1===r&&e.mouseButton===l)&&e.modifierKey===s));if(n.mode===Tp&&o)return i.getToolInstance(t)}}function _p(e,t,n){const{renderingEngineId:o,viewportId:i}=e.detail,a=Vp(i,o);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const o=s[e],i=a.toolOptions[o],l=null!=n&&i.bindings.length&&i.bindings.some((e=>e.numTouchPoints===n));if(t.includes(i.mode)&&(!n||l)){const e=a.getToolInstance(o);r.push(e)}}return r}const{Active:Dp,Passive:Sp}=ne;function yp(e){if(Ze.isInteractingWithTool)return;const t=bp(e);if(t&&"function"==typeof t.preTouchStartCallback){if(t.preTouchStartCallback(e))return}const n=1===Object.keys(e.detail.event.touches).length,o=[..._p(e,[Dp],Object.keys(e.detail.event.touches).length)||[],...(n?_p(e,[Sp]):void 0)||[],t],i=e.detail,{element:a}=i,r=Bf(a,o),s=i.currentPoints.canvas,l=Vf(a,r,s,"touch");if(l.length>0){const{tool:t,annotation:n,handle:o}=Op(l);return Pp(n.annotationUID,false),void t.handleSelectedCallback(e,n,o,"Touch")}const d=Ff(a,r,s,"touch");if(d.length>0){const{tool:t,annotation:n}=Op(d);return Pp(n.annotationUID,false),void t.toolSelectedCallback(e,n,"Touch")}if(t&&"function"==typeof t.postTouchStartCallback){if(t.postTouchStartCallback(e))return}}function Op(e){return e.length>1&&e.find((e=>!pe(e.annotation)&&Ue(e.annotation.annotationUID)))||e[0]}function Pp(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1])if(Pe(e))De(e,!1);else{De(e,!0,!0)}else{De(e,!0,!1)}}function Mp(e){if(Ze.isInteractingWithTool)return;const t=bp(e);if(t&&!Ze.isMultiPartToolActive&&t.addNewAnnotation){const n=t.addNewAnnotation(e,"touch");n&&De(n.annotationUID)}}function xp(e){if(Ze.isInteractingWithTool)return;const t=bp(e);!t||"function"!=typeof t.touchDragCallback||t.touchDragCallback(e)}const Rp=Lf.bind(null,"Touch","touchEndCallback"),Np=Lf.bind(null,"Touch","touchTapCallback"),Ap=Lf.bind(null,"Touch","touchPressCallback"),Lp={enable:function(e){e.addEventListener(re.TOUCH_START,yp),e.addEventListener(re.TOUCH_START_ACTIVATE,Mp),e.addEventListener(re.TOUCH_DRAG,xp),e.addEventListener(re.TOUCH_END,Rp),e.addEventListener(re.TOUCH_TAP,Np),e.addEventListener(re.TOUCH_PRESS,Ap)},disable:function(e){e.removeEventListener(re.TOUCH_START,yp),e.removeEventListener(re.TOUCH_START_ACTIVATE,Mp),e.removeEventListener(re.TOUCH_DRAG,xp),e.removeEventListener(re.TOUCH_END,Rp),e.removeEventListener(re.TOUCH_PRESS,Ap)}};function kp(e){const{element:t,viewportId:n}=e.detail,o=function(e){const t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),o=`svg-layer-${e}`;n.classList.add("svg-layer"),n.setAttribute("id",o),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";const i=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),r=document.createElementNS(t,"feOffset"),s=document.createElementNS(t,"feColorMatrix"),l=document.createElementNS(t,"feBlend");return a.setAttribute("id",`shadow-${o}`),a.setAttribute("filterUnits","userSpaceOnUse"),r.setAttribute("result","offOut"),r.setAttribute("in","SourceGraphic"),r.setAttribute("dx","0.5"),r.setAttribute("dy","0.5"),s.setAttribute("result","matrixOut"),s.setAttribute("in","offOut"),s.setAttribute("in2","matrix"),s.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),l.setAttribute("in","SourceGraphic"),l.setAttribute("in2","matrixOut"),l.setAttribute("mode","normal"),a.appendChild(r),a.appendChild(s),a.appendChild(l),i.appendChild(a),n.appendChild(i),n}(n);var i;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;Ze.svgNodeCache[o]={}}(t),i=o,t.querySelector("div.viewport-element").appendChild(i),wr.addViewportElement(n,t),yt.enable(t),Dn.enable(t),wn.enable(t),An.enable(t),Nf.enable(t),pp.enable(t),Cp.enable(t),rp.enable(t),up.enable(t),Lp.enable(t),Ze.enabledElements.push(t)}const Up=function(e,t){const n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(let o=0;o<Ze.synchronizers.length;o++){const i=Ze.synchronizers[o],a=!i.isDisabled(),r=i.hasSourceViewport(t,e),s=i.hasTargetViewport(t,e);a&&(r||s)&&n.push(i)}return n};const Vp=function(e,t){const n=Ze.toolGroups.filter((n=>n.viewportsInfo.some((n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)))));if(n.length){if(n.length>1)throw new Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${e}. You should only\n      have one tool group per viewport in a renderingEngine.`);return n[0]}},Bp="viewport-element";const Fp=e=>{const t=(0,te.getEnabledElement)(e);Up(t.viewportId,t.renderingEngineId).forEach((e=>{e.remove(t)}))},Hp=e=>{const{renderingEngineId:t,viewportId:n}=(0,te.getEnabledElement)(e),o=Vp(n,t);o&&o.removeViewports(t,n)};const Wp=function(e){const t=Ze.enabledElements.findIndex((t=>t===e));t>-1&&Ze.enabledElements.splice(t,1)},Gp=function(e){const{element:t,viewportId:n}=e.detail;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;delete Ze.svgNodeCache[o]}(t),function(e){const t=e.querySelector(`div.${Bp}`),n=t.querySelector("svg");n&&t.removeChild(n)}(t),wr.removeViewportElement(n,t),yt.disable(t),Dn.disable(t),wn.disable(t),An.disable(t),Nf.disable(t),pp.disable(t),Cp.disable(t),rp.disable(t),up.disable(t),Lp.disable(t),Fp(t),Hp(t),Wp(t)};function $p(e){const t=Bf(e,fr(e,[ne.Active,ne.Passive]));for(const{tool:n}of t){const t=n.cancel(e);if(t)return t}}function zp(e,t){return e.findIndex((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))}function Kp(e,t){return e.some((e=>e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId))}const qp=class{constructor(e,t,n,o){this._viewportOptions={},this._onEvent=e=>{if(!0===this._ignoreFiredEvents)return;if(!this._targetViewports.length)return;const t=(0,te.getEnabledElement)(e.currentTarget);if(!t)return;const{renderingEngineId:n,viewportId:o}=t;this._sourceViewports.find((e=>e.viewportId===o))&&this.fireEvent({renderingEngineId:n,viewportId:o},e)},this._enabled=!0,this._eventName=t,this._eventHandler=n,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=o||{},this.id=e}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._viewportOptions[e]=t}getOptions(e){return this._viewportOptions[e]}add(e){this.addTarget(e),this.addSource(e)}addSource(e){if(Kp(this._sourceViewports,e))return;const{renderingEngineId:t,viewportId:n}=e,{element:o}=(0,te.getRenderingEngine)(t).getViewport(n);o.addEventListener(this._eventName,this._onEvent.bind(this)),this._updateDisableHandlers(),this._sourceViewports.push(e)}addTarget(e){Kp(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach((e=>this.removeSource(e))),this._targetViewports.forEach((e=>this.removeTarget(e)))}remove(e){this.removeTarget(e),this.removeSource(e)}removeSource(e){const t=zp(this._sourceViewports,e);if(-1===t)return;const n=function(e){const t=(0,te.getRenderingEngine)(e.renderingEngineId);if(!t)throw new Error(`No RenderingEngine for Id: ${e.renderingEngineId}`);return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._updateDisableHandlers()}removeTarget(e){const t=zp(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}hasSourceViewport(e,t){return Kp(this._sourceViewports,{renderingEngineId:e,viewportId:t})}hasTargetViewport(e,t){return Kp(this._targetViewports,{renderingEngineId:e,viewportId:t})}fireEvent(e,t){if(this.isDisabled()||this._ignoreFiredEvents)return;this._ignoreFiredEvents=!0;const n=[];try{for(let o=0;o<this._targetViewports.length;o++){const i=this._targetViewports[o];e.viewportId===i.viewportId||n.push(this._eventHandler(this,e,i,t,this._options))}}catch(e){console.warn(`Synchronizer, for: ${this._eventName}`,e)}finally{n.length?Promise.allSettled(n).then((()=>{this._ignoreFiredEvents=!1})):this._ignoreFiredEvents=!1}}_hasSourceElements(){return 0!==this._sourceViewports.length}_updateDisableHandlers(){const e=function(e,t){const n=[],o=e.concat(t);for(let e=0;e<o.length;e++){const t=o[e];n.some((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))||n.push(t)}return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=e=>{t(e.detail.element)};e.forEach((function(e){const t=(0,te.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId);if(!t)return;const{element:o}=t;o.removeEventListener(te.Enums.Events.ELEMENT_DISABLED,n),o.addEventListener(te.Enums.Events.ELEMENT_DISABLED,n)}))}};const jp=function(e,t,n,o){if(Ze.synchronizers.some((t=>t.id===e)))throw new Error(`Synchronizer with id '${e}' already exists.`);const i=new qp(e,t,n,o);return Ze.synchronizers.push(i),i};const Zp=function(){for(;Ze.synchronizers.length>0;){Ze.synchronizers.pop().destroy()}};const Yp=function(e){return Ze.synchronizers.find((t=>t.id===e))};const Xp=function(){return Ze.synchronizers};const Jp=function(e){const t=Ze.synchronizers.findIndex((t=>t.id===e));if(t>-1){Ze.synchronizers[t].destroy(),Ze.synchronizers.splice(t,1)}};var Qp=n(20346),ev=n.n(Qp);const{Active:tv,Passive:nv,Enabled:ov,Disabled:iv}=ne;class av{constructor(e){this.viewportsInfo=[],this.toolOptions={},this._toolInstances={},this.id=e}getViewportIds(){return this.viewportsInfo.map((e=>{let{viewportId:t}=e;return t}))}getViewportsInfo(){return this.viewportsInfo.slice()}getToolInstance(e){const t=this._toolInstances[e];if(t)return t;console.warn(`'${e}' is not registered with this toolGroup (${this.id}).`)}addTool(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=Ze.tools[e],o=void 0!==e&&""!==e,i=this.toolOptions[e];if(!o)return void console.warn("Tool with configuration did not produce a toolName: ",t);if(!n)return void console.warn(`'${e}' is not registered with the library. You need to use cornerstoneTools.addTool to register it.`);if(i)return void console.warn(`'${e}' is already registered for ToolGroup ${this.id}.`);const{toolClass:a}=n,r=new a({name:e,toolGroupId:this.id,configuration:t});this._toolInstances[e]=r}addToolInstance(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=Ze.tools[e]?.toolClass;if(!o){const n=Ze.tools[t].toolClass;class i extends n{}i.toolName=e,o=i,Ze.tools[e]={toolClass:i}}this.addTool(o.toolName,n)}addViewport(e,t){const n=(0,te.getRenderingEngines)();if(!t&&n.length>1)throw new Error("You must specify a renderingEngineId when there are multiple rendering engines.");const o=t||n[0].id;this.viewportsInfo.some((t=>{let{viewportId:n}=t;return n===e}))||this.viewportsInfo.push({viewportId:e,renderingEngineId:o});const i=this.getActivePrimaryMouseButtonTool();te.Settings.getRuntimeSettings().get("useCursors")&&this.setViewportsCursorByToolName(i)}removeViewports(e,t){const n=[];if(this.viewportsInfo.forEach(((o,i)=>{let a=!1;o.renderingEngineId===e&&(a=!0,t&&o.viewportId!==t&&(a=!1)),a&&n.push(i)})),n.length)for(let e=n.length-1;e>=0;e--)this.viewportsInfo.splice(n[e],1)}setActiveStrategy(e,t){const n=this._toolInstances[e];void 0!==n?n.setActiveStrategy(t):console.warn(`Tool ${e} not added to toolGroup, can't set tool configuration.`)}setToolMode(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e?t!==ne.Active?t!==ne.Passive?t!==ne.Enabled?t!==ne.Disabled?console.warn("setToolMode: mode must be defined"):this.setToolDisabled(e):this.setToolEnabled(e):this.setToolPassive(e):this.setToolActive(e,n):console.warn("setToolMode: toolName must be defined")}setToolActive(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=this._toolInstances[e];if(void 0===n)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);if(!n)return void console.warn(`'${e}' instance ${n} is not registered with this toolGroup, can't set tool mode.`);const o={bindings:[...this.toolOptions[e]?this.toolOptions[e].bindings:[],...t.bindings?t.bindings:[]].reduce(((e,t)=>{const n=void 0!==t.numTouchPoints,o=void 0!==t.mouseButton;return e.some((e=>function(e,t){if(e.mouseButton!==t.mouseButton)return!1;return e.modifierKey===t.modifierKey}(e,t)))||!n&&!o||e.push(t),e}),[]),mode:tv};this.toolOptions[e]=o,this._toolInstances[e].mode=tv;const i=te.Settings.getRuntimeSettings().get("useCursors");if(this._hasMousePrimaryButtonBinding(t)&&i)this.setViewportsCursorByToolName(e);else{if(!this.getActivePrimaryMouseButtonTool()&&i){const e=Cs.getDefinedCursor("default");this._setCursorForViewports(e)}}"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports();const a={toolGroupId:this.id,toolName:e,toolBindingsOptions:t};(0,te.triggerEvent)(te.eventTarget,re.TOOL_ACTIVATED,a),this._triggerToolModeChangedEvent(e,tv,t)}setToolPassive(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n=this.getToolOptions(e),o=Object.assign({bindings:n?n.bindings:[]},n,{mode:nv}),i=this.getDefaultMousePrimary();o.bindings=o.bindings.filter((e=>e.mouseButton!==i||e.modifierKey));let a=nv;0!==o.bindings.length&&(a=tv,o.mode=a),this.toolOptions[e]=o,t.mode=a,"function"==typeof t.onSetToolPassive&&t.onSetToolPassive(),this._renderViewports(),this._triggerToolModeChangedEvent(e,nv)}setToolEnabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n={bindings:[],mode:ov};this.toolOptions[e]=n,t.mode=ov,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,ov)}setToolDisabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n={bindings:[],mode:iv};this.toolOptions[e]=n,t.mode=iv,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,iv)}getToolOptions(e){const t=this.toolOptions[e];if(void 0!==t)return t}getActivePrimaryMouseButtonTool(){return Object.keys(this.toolOptions).find((e=>{const t=this.toolOptions[e];return t.mode===tv&&this._hasMousePrimaryButtonBinding(t)}))}setViewportsCursorByToolName(e,t){const n=this._getCursor(e,t);this._setCursorForViewports(n)}_getCursor(e,t){let n,o;return t&&(n=`${e}.${t}`,o=Vs.getDefinedCursor(n,!0),o)?o:(n=`${e}`,o=Vs.getDefinedCursor(n,!0),o||(n=e,o=Vs.getDefinedCursor(n,!0),o||Cs.getDefinedCursor("default")))}_setCursorForViewports(e){this.viewportsInfo.forEach((t=>{let{renderingEngineId:n,viewportId:o}=t;const i=(0,te.getEnabledElementByIds)(o,n);if(!i)return;const{viewport:a}=i;zs(a.element,e)}))}setToolConfiguration(e,t,n){if(void 0===this._toolInstances[e])return console.warn(`Tool ${e} not present, can't set tool configuration.`),!1;let o;return o=n?t:Object.assign(this._toolInstances[e].configuration,t),this._toolInstances[e].configuration=o,this._renderViewports(),!0}getDefaultMousePrimary(){return J.Primary}getToolConfiguration(e,t){if(void 0===this._toolInstances[e])return void console.warn(`Tool ${e} not present, can't set tool configuration.`);const n=ev()(this._toolInstances[e].configuration,t);return ue()(n)}clone(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=dv(e);return n?(console.warn(`ToolGroup ${e} already exists`),n):(n=rv(e),t=t??(()=>!0),Object.keys(this._toolInstances).filter(t).forEach((e=>{const t=this._toolInstances[e],o=this.toolOptions[e],i=t.mode;n.addTool(e),n.setToolMode(e,i,{bindings:o.bindings??[]})})),n)}_hasMousePrimaryButtonBinding(e){const t=this.getDefaultMousePrimary();return e?.bindings?.some((e=>e.mouseButton===t&&void 0===e.modifierKey))}_renderViewports(){this.viewportsInfo.forEach((e=>{let{renderingEngineId:t,viewportId:n}=e;(0,te.getRenderingEngine)(t).renderViewport(n)}))}_triggerToolModeChangedEvent(e,t,n){const o={toolGroupId:this.id,toolName:e,mode:t,toolBindingsOptions:n};(0,te.triggerEvent)(te.eventTarget,re.TOOL_MODE_CHANGED,o)}}const rv=function(e){if(Ze.toolGroups.some((t=>t.id===e)))return void console.warn(`'${e}' already exists.`);const t=new av(e);return Ze.toolGroups.push(t),t};const sv=function(e){const t=Ze.toolGroups.findIndex((t=>t.id===e));t>-1&&(Lr.removeToolGroup(e),ri(e),Ze.toolGroups.splice(t,1))};const lv=function(){const e=[...Ze.toolGroups];for(const t of e)sv(t.id);Ze.toolGroups=[]};const dv=function(e){return Ze.toolGroups.find((t=>t.id===e))};const cv=function(){return Ze.toolGroups},uv=[ne.Active,ne.Passive,ne.Enabled];const hv=function(e){return Ze.toolGroups.filter((t=>{let{toolOptions:n}=t;const o=Object.keys(n);for(let t=0;t<o.length;t++)if(e===o[t]&&n[e]&&uv.includes(n[e].mode))return!0;return!1}))};let gv=ze;function mv(){return gv}function fv(e){gv=e}function pv(){gv=ze}function vv(e,t){const n=mv(),o=n.getGroupKey(t);return n.getAnnotations(o,e)}function Ev(e,t){void 0===e.annotationUID&&(e.annotationUID=te.utilities.uuidv4());const n=mv(),o=n.getGroupKey(t);return n.addAnnotation(e,o),t instanceof HTMLDivElement?function(e,t){const n=(0,te.getEnabledElement)(t),{renderingEngine:o,viewportId:i}=n,a=re.ANNOTATION_ADDED,r={annotation:e,viewportId:i,renderingEngineId:o.id};(0,te.triggerEvent)(te.eventTarget,a,r)}(e,t):function(e){const{toolName:t}=e.metadata,n=hv(t);if(!n.length)return;const o=[];if(n.forEach((t=>{t.viewportsInfo.forEach((t=>{const{renderingEngineId:n,viewportId:i}=t,{FrameOfReferenceUID:a}=(0,te.getEnabledElementByIds)(i,n);e.metadata.FrameOfReferenceUID===a&&o.push(t)}))})),!o.length)return;const i=re.ANNOTATION_ADDED;o.forEach((t=>{let{renderingEngineId:n,viewportId:o}=t;const a={annotation:e,viewportId:o,renderingEngineId:n};(0,te.triggerEvent)(te.eventTarget,i,a)}))}(e),e.annotationUID}function wv(e,t){const n=mv(),o=n.getGroupKey(t);return n.getNumberOfAnnotations(o,e)}function Iv(e){const t=mv(),n=t.getAnnotation(e);if(!n)return;t.removeAnnotation(e);const o=re.ANNOTATION_REMOVED,i={annotation:n,annotationManagerUID:t.uid};(0,te.triggerEvent)(te.eventTarget,o,i)}function Cv(e){return mv().getAnnotation(e)}function Tv(){mv().removeAllAnnotations()}let bv=!1;function _v(){bv||(!function(){Sv();const e=te.Enums.Events.ELEMENT_ENABLED,t=te.Enums.Events.ELEMENT_DISABLED;te.eventTarget.addEventListener(e,kp),te.eventTarget.addEventListener(t,Gp)}(),yv(),te.eventTarget.addEventListener(re.ANNOTATION_MODIFIED,xf),te.eventTarget.addEventListener(re.ANNOTATION_SELECTION_CHANGE,Mf),te.eventTarget.addEventListener(re.ANNOTATION_SELECTION_CHANGE,Mf),te.eventTarget.addEventListener(re.SEGMENTATION_MODIFIED,Hr),te.eventTarget.addEventListener(re.SEGMENTATION_DATA_MODIFIED,Br),te.eventTarget.addEventListener(re.SEGMENTATION_REPRESENTATION_MODIFIED,Vr),te.eventTarget.addEventListener(re.SEGMENTATION_REPRESENTATION_REMOVED,Fr),bv=!0)}function Dv(){Sv(),yv(),lv(),Ye();const e=mv(),t=Jn();e.restoreAnnotations({}),t.resetState(),bv=!1}function Sv(){const e=te.Enums.Events.ELEMENT_ENABLED,t=te.Enums.Events.ELEMENT_DISABLED;te.eventTarget.removeEventListener(e,kp),te.eventTarget.removeEventListener(t,Gp)}function yv(){te.eventTarget.removeEventListener(re.ANNOTATION_MODIFIED,xf),te.eventTarget.removeEventListener(re.ANNOTATION_SELECTION_CHANGE,Mf),te.eventTarget.removeEventListener(re.ANNOTATION_SELECTION_CHANGE,Mf),te.eventTarget.removeEventListener(re.SEGMENTATION_MODIFIED,Hr),te.eventTarget.removeEventListener(re.SEGMENTATION_DATA_MODIFIED,Br),te.eventTarget.removeEventListener(re.SEGMENTATION_REPRESENTATION_MODIFIED,Vr),te.eventTarget.removeEventListener(re.SEGMENTATION_REPRESENTATION_REMOVED,Fr)}function Ov(e,t,n,o){const{camera:i}=o.detail,a=(0,te.getRenderingEngine)(n.renderingEngineId);if(!a)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const r=a.getViewport(n.viewportId);r.setCamera(i),r.render()}const{CAMERA_MODIFIED:Pv}=te.Enums.Events;function Mv(e){return jp(e,Pv,Ov)}function xv(e,t,n,o,i){const a=o.detail,{volumeId:r,range:s,invertStateChanged:l,invert:d}=a,c=(0,te.getRenderingEngine)(n.renderingEngineId);if(!c)throw new Error(`Rendering Engine does not exist: ${n.renderingEngineId}`);const u=c.getViewport(n.viewportId),h={voiRange:s};if(i?.syncInvertState&&l&&(h.invert=d),u instanceof te.BaseVolumeViewport)u.setProperties(h,r);else{if(!(u instanceof te.StackViewport))throw new Error("Viewport type not supported.");u.setProperties(h)}u.render()}function Rv(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{syncInvertState:!0};return jp(e,te.Enums.Events.VOI_MODIFIED,xv,t)}function Nv(e,t,n){const o=(0,te.getRenderingEngine)(n.renderingEngineId);if(!o)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const i=e.getOptions(n.viewportId),a=o.getViewport(n.viewportId),r=o.getViewport(t.viewportId);if(!1!==i?.syncZoom){const e=r.getZoom();a.setZoom(e)}if(!1!==i?.syncPan){const e=r.getPan();a.setPan(e)}a.render()}const{CAMERA_MODIFIED:Av}=te.Enums.Events;function Lv(e){return jp(e,Av,Nv)}const kv=(e,t)=>te.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",[e,t]);async function Uv(e,t,n){const o=(0,te.getRenderingEngine)(n.renderingEngineId);if(!o)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const i=o.getViewport(t.viewportId),a=e.getOptions(n.viewportId);if(a?.disabled)return;const r=o.getViewport(n.viewportId),s=i.getCurrentImageId(),l=te.metaData.get("imagePlaneModule",s).imagePositionPatient,d=r.getImageIds();if(!function(e,t){const{viewPlaneNormal:n}=e.getCamera(),{viewPlaneNormal:o}=t.getCamera(),i=$a.R3.dot(n,o);return Math.abs(i)>.9}(i,r))return;let c=kv(n.viewportId,t.viewportId);if(!c){if(i.getFrameOfReferenceUID()===r.getFrameOfReferenceUID()&&!1!==a?.useInitialPosition?c=$a._E.identity($a._E.create()):(te.utilities.calculateViewportsSpatialRegistration(i,r),c=kv(n.viewportId,t.viewportId)),!c)return}const u=$a.R3.transformMat4($a.R3.create(),l,c),h=(g=u,d.reduce(((e,t,n)=>{const{imagePositionPatient:o}=te.metaData.get("imagePlaneModule",t),i=$a.R3.distance(o,g);return i<e.distance?{distance:i,index:n}:e}),{distance:1/0,index:-1}));var g;-1!==h.index&&r.getCurrentImageIdIndex()!==h.index&&await es(r.element,{imageIndex:h.index})}const{STACK_NEW_IMAGE:Vv}=te.Enums.Events;function Bv(e){return jp(e,Vv,Uv)}class Fv extends Rr{constructor(){var e;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),e=this,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,te.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l={metadata:{viewPlaneNormal:[0,0,1],viewUp:[0,1,0],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:r.getFrameOfReferenceUID(),toolName:this.getToolName()},data:{invalidated:!0,handles:{points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},cachedStats:{},active:!0}};Ev(l,o);const d=Ul(o,this.getToolName(),!1);return this.editData={annotation:l,viewportUIDsToRender:d,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),js(o),e.preventDefault(),Jr(s,d),l},this.getHandleNearImagePoint=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles;for(let e=0;e<s.length;e++){const t=s[e],i=a.worldToCanvas(t);if(!0===$a.K4.distance(n,i)<o)return r.handles.activeHandleIndex=e,t}r.handles.activeHandleIndex=null},this.isPointNearTool=(e,t,n,o)=>{const i=(0,te.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles,l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[3]),c=this._getRectangleImageCoordinates([l,d]),u=[n[0],n[1]],{left:h,top:g,width:m,height:f}=c;if(Xd([h,g,m,f],u)<=o)return!0},this.toolSelectedCallback=function(t,n){const o=t.detail,{element:i}=o,{data:a}=n;a.active=!0;const r=Ul(i,e.getToolName(),!1);e.editData={annotation:n,viewportUIDsToRender:r},e._activateModify(i),js(i);const s=(0,te.getEnabledElement)(i),{renderingEngine:l}=s;Jr(l,r),t.preventDefault()},this.handleSelectedCallback=function(t,n,o){const i=t.detail,{element:a}=i,{data:r}=n;r.active=!0;let s,l=!1;o.worldPosition?l=!0:s=r.handles.points.findIndex((e=>e===o));const d=Ul(a,e.getToolName(),!1);e.editData={annotation:n,viewportUIDsToRender:d,handleIndex:s},e._activateModify(a),js(a);const c=(0,te.getEnabledElement)(a),{renderingEngine:u}=c;Jr(u,d),t.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportUIDsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.active=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),qs(n);const l=(0,te.getEnabledElement)(n),{renderingEngine:d}=l;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&Iv(o.annotationUID),Jr(d,i)},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportUIDsToRender:i,handleIndex:a}=this.editData,{data:r}=o;if(void 0===a){const{deltaPoints:e}=t,n=e.world,{points:o}=r.handles;o.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),r.invalidated=!0}else{const{currentPoints:e}=t,o=(0,te.getEnabledElement)(n),{worldToCanvas:i,canvasToWorld:s}=o.viewport,l=e.world,{points:d}=r.handles;let c,u,h,g,m,f,p,v;switch(d[a]=[...l],a){case 0:case 3:c=i(d[0]),g=i(d[3]),u=[g[0],c[1]],h=[c[0],g[1]],f=s(u),p=s(h),d[1]=f,d[2]=p;break;case 1:case 2:u=i(d[1]),h=i(d[2]),c=[h[0],u[1]],g=[u[0],h[1]],m=s(c),v=s(g),d[0]=m,d[3]=v}r.invalidated=!0}this.editData.hasMoved=!0;const s=(0,te.getEnabledElement)(n),{renderingEngine:l}=s;Jr(l,i)},this._activateDraw=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._mouseUpCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(re.TOUCH_END,this._mouseUpCallback),e.addEventListener(re.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateDraw=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(re.TOUCH_END,this._mouseUpCallback),e.removeEventListener(re.TOUCH_DRAG,this._mouseDragCallback)},this._activateModify=e=>{Ze.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._mouseUpCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(re.TOUCH_END,this._mouseUpCallback),e.addEventListener(re.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateModify=e=>{Ze.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(re.TOUCH_END,this._mouseUpCallback),e.removeEventListener(re.TOUCH_DRAG,this._mouseDragCallback)},this.renderAnnotation=(e,t)=>{const{viewport:n}=e,{element:o}=n;let i=vv(this.getToolName(),o);if(!i?.length)return false;if(i=this.filterInteractableAnnotationsForElement(o,i),!i?.length)return false;this.getTargetId(n),n.getRenderingEngine();const a={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<i.length;e++){const o=i[e],{annotationUID:r}=o,s=(o.metadata,o.data),{points:l,activeHandleIndex:d}=s.handles,c=l.map((e=>n.worldToCanvas(e))),u=this.getStyle("lineWidth",a,o),h=this.getStyle("lineDash",a,o),g=this.getStyle("color",a,o);if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");let m;if(this.editData||null===d||(m=[c[d]]),m){or(t,r,"0",m,{color:g})}mr(t,r,"0",c[0],c[3],{color:"black",lineDash:h,lineWidth:u})}},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,o,i)=>{const{data:a}=e,{viewportUID:r,renderingEngineUID:s,sceneUID:l}=i,d=a.handles.points[0],c=a.handles.points[3],{cachedStats:u}=a,h=Object.keys(u);for(let e=0;e<h.length;e++){const i=h[e],{imageVolume:a}=this._getImageVolumeFromTargetUID(i,o),{dimensions:r,scalarData:s,vtkImageData:l,metadata:g}=a,m=$a.R3.fromValues(0,0,0),f=$a.R3.fromValues(0,0,0);if(l.worldToIndexVec3(d,m),m[0]=Math.floor(m[0]),m[1]=Math.floor(m[1]),m[2]=Math.floor(m[2]),l.worldToIndexVec3(c,f),f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),this._isInsideVolume(m,f,r)){this.isHandleOutsideImage=!1;const e=Math.min(m[0],f[0]),o=Math.max(m[0],f[0]),a=Math.min(m[1],f[1]),l=Math.max(m[1],f[1]),h=Math.min(m[2],f[2]),p=Math.max(m[2],f[2]),{worldWidth:v,worldHeight:E}=ic(t,n,d,c),w=v*E;let I=0,C=0,T=0;const b=r[0],_=r[0]*r[1];for(let t=h;t<=p;t++)for(let n=a;n<=l;n++)for(let i=e;i<=o;i++){I++,C+=s[t*_+n*b+i]}C/=I;for(let t=h;t<=p;t++)for(let n=a;n<=l;n++)for(let i=e;i<=o;i++){const e=s[t*_+n*b+i]-C;T+=e*e}T/=I,T=Math.sqrt(T),u[i]={Modality:g.Modality,area:w,mean:C,stdDev:T}}else this.isHandleOutsideImage=!0,u[i]={Modality:g.Modality}}a.invalidated=!1;const g=re.ANNOTATION_MODIFIED,m={annotation:e,viewportUID:r,renderingEngineUID:s,sceneUID:l};return(0,te.triggerEvent)(te.eventTarget,g,m),u},this._isInsideVolume=(e,t,n)=>te.utilities.indexWithinDimensions(e,n)&&te.utilities.indexWithinDimensions(t,n),this._getTargetVolumeUID=e=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const t=e.getVolumeActors();return t||t.length?t[0].uid:void 0},this._throttledCalculateCachedStats=qr(this._calculateCachedStats,100,{trailing:!0})}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),qs(e);const{annotation:t,viewportUIDsToRender:n}=this.editData,{data:o}=t;o.active=!1,o.handles.activeHandleIndex=null;const i=(0,te.getEnabledElement)(e),{renderingEngine:a}=i;return Jr(a,n),this.editData=null,t.metadata.annotationUID}_getImageVolumeFromTargetUID(e,t){let n;if(e.startsWith("stackTarget")){const o=e.indexOf(":"),i=e.substring(o+1);n=t.getViewport(i).getImageData()}else n=te.cache.getVolume(e);return{imageVolume:n,viewport:undefined}}_getTargetStackUID(e){return`stackTarget:${e.uid}`}}Fv.toolName="VideoRedaction";const Hv=Fv}}]);