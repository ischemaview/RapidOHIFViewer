"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[921],{42921:(e,t,a)=>{a.r(t),a.d(t,{ContextMenuController:()=>wt,CustomizableContextMenuTypes:()=>n,createReportAsync:()=>Fe,createReportDialogPrompt:()=>Le,default:()=>pa,dicomWebUtils:()=>s,getStudiesForPatientByMRN:()=>Ue});var n={};a.r(n);var s={};a.r(s),a.d(s,{fixBulkDataURI:()=>R});var r=a(97604),i=a(71771),o=a(62971);const{getString:c,getName:l,getModalities:u}=i.DICOMWeb;function d(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),date:c(e["00080020"]),time:c(e["00080030"]),accession:c(e["00080050"])||"",mrn:c(e["00100020"])||"",patientName:i.utils.formatPN(l(e["00100010"]))||"",instances:Number(c(e["00201208"]))||0,description:c(e["00081030"])||"",modalities:c(u(e["00080060"],e["00080061"]))||""}))),t}async function m(e,t,a,n){return await e.searchForStudies({studyInstanceUid:void 0,queryParams:n})}function p(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return;const a=["00081030","00080060"].join(","),{supportsWildcard:n}=t,s=e=>n&&e?`*${e}*`:e,r={PatientName:s(e.patientName),"00100020":s(e.patientId),AccessionNumber:s(e.accessionNumber),StudyDescription:s(e.studyDescription),ModalitiesInStudy:e.modalitiesInStudy,limit:e.limit||101,offset:e.offset||0,fuzzymatching:!0===t.supportsFuzzyMatching,includefield:a};if(e.startDate&&e.endDate)r.StudyDate=`${e.startDate}-${e.endDate}`;else if(e.startDate){const t=new Date,a=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),s=`${t.getFullYear()}${n}${a}`;r.StudyDate=`${e.startDate}-${s}`}else if(e.endDate){const t="19700102";r.StudyDate=`${t}-${e.endDate}`}if(e.studyInstanceUid){let t=e.studyInstanceUid;t=Array.isArray(t)?t.join():t,t=t.replace(/[^0-9.]+/g,"\\"),r.StudyInstanceUID=t}const i={};return Object.keys(r).forEach((e=>{void 0!==r[e]&&""!==r[e]&&(i[e]=r[e])})),i}function g(e){let{instance:t,frame:a,config:n,thumbnail:s=!1}=e;if(!t)return;if(t.url)return t.url;const r=s?"thumbnailRendering":"imageRendering";if(n[r]&&"wadouri"!==n[r])return function(e,t,a){const n=function(e,t,a){const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=e;return`${t.wadoRoot}/studies/${a}/series/${n}/instances/${s}`}(e,t);return`${n}/frames/${a=a||1}`}(e,t,a);if(n)return`wadors:${n}`}(t,n,a);{const e=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=t,r=[];r.push("requestType=WADO"),r.push(`studyUID=${a}`),r.push(`seriesUID=${n}`),r.push(`objectUID=${s}`),r.push("contentType=application/dicom"),r.push("transferSyntax=*");const i=r.join("&");return`${e.wadoUriRoot}?${i}`}(n,t);let s="dicomweb:"+e;return void 0!==a&&(s+="&frame="+a),s}}var f=a(67540);function I(e,t){const a=Object.keys(e),n=Object.keys(t);if(a.length!==n.length)return!1;for(const n of a){const a=e[n],s=t[n],r=y(a)&&y(s);if(r&&!I(a,s)||!r&&a!==s)return!1}return!0}function y(e){return null!=e&&"object"==typeof e}class S{constructor(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,r=arguments.length>5?arguments[5]:void 0;this.client=e,this.studyInstanceUID=t,this.filters=a,this.sortCriteria=n,this.sortFunction=s,this.withCredentials=r}async execLoad(){const e=await this.preLoad(),t=await this.load(e);return await this.posLoad(t)}async runLoaders(e){let t;for(const a of e)try{if(t=await a(),t&&t.length)break}catch(e){throw e}if(e.next().done&&!t)throw new Error("RetrieveMetadataLoader failed");return t}async configLoad(){}async preLoad(){}async load(e){}async posLoad(e){}}class h extends S{getOptions(){const{studyInstanceUID:e,filters:t,withCredentials:a}=this,n={studyInstanceUID:e,withCredentials:a},{seriesInstanceUID:s}=t;return s&&(n.seriesInstanceUID=s),n}*getLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n,withCredentials:s}=this;a&&e.push(n.retrieveSeriesMetadata.bind(n,{studyInstanceUID:t,seriesInstanceUID:a,withCredentials:s})),e.push(n.retrieveStudyMetadata.bind(n,{studyInstanceUID:t,withCredentials:s})),yield*e}async load(e){const t=this.getLoaders();return this.runLoaders(t)}async posLoad(e){return e}}class v extends S{*getPreLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n,withCredentials:s}=this;if(a){const r={studyInstanceUID:t,queryParams:{SeriesInstanceUID:a},withCredentials:s};e.push(n.searchForSeries.bind(n,r))}e.push(n.searchForSeries.bind(n,{studyInstanceUID:t,withCredentials:s})),yield*e}async preLoad(){const e=this.getPreLoaders(),t=await this.runLoaders(e),a=this.sortCriteria,n=this.sortFunction,{naturalizeDataset:s}=f.default.data.DicomMetaDictionary,r=t.map(s);return(0,o.IO)(r,a||o.S1.seriesSortCriteria.seriesInfoSortingCriteria,n)}async load(e){const{client:t,studyInstanceUID:a,withCredentials:n}=this,s=function(e,t,a,n){return Object.freeze({hasNext:()=>a.length>0,async next(){const s=a.shift();return e.retrieveSeriesMetadata({studyInstanceUID:t,seriesInstanceUID:s,withCredentials:n})}})}(t,a,e.map((e=>e.SeriesInstanceUID)),n),r=[];for(;s.hasNext();)r.push(s.next());return{preLoadData:e,promises:r}}async posLoad(e){let{preLoadData:t,promises:a}=e;return{preLoadData:t,promises:a}}}const D=async function(e,t,a){const n=new(!1!==a?v:h)(e,t,arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},arguments.length>4?arguments[4]:void 0,arguments.length>5?arguments[5]:void 0,arguments.length>6?arguments[6]:void 0);return await n.execLoad()},w="RetrieveStudyMetadata",b=new Map;function E(e,t,a,n,s,r,i){if(!e)throw new Error(`${w}: Required 'dicomWebClient' parameter not provided.`);if(!t)throw new Error(`${w}: Required 'StudyInstanceUID' parameter not provided.`);if(b.has(t)){const e=b.get(t).find(((e,t,a)=>I(e.filters,n)));if(e)return e.promise}const o=new Promise(((o,c)=>{D(e,t,a,n,s,r,i).then((function(e){o(e)}),c)}));let c;return b.has(t)?c=b.get(t):(c=[],b.set(c)),c.push({promise:o,filters:n}),o}function M(e){b.has(e)&&b.delete(e)}class U extends r.hi.DICOMwebClient{constructor(e){super(e),this.staticWado=e.staticWado}async searchForStudies(e){if(!this.staticWado)return super.searchForStudies(e);const t=await super.searchForStudies(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter((e=>{for(const t of Object.keys(U.studyFilterKeys))if(!this.filterItem(t,n,e,U.studyFilterKeys))return!1;return!0}))}async searchForSeries(e){if(!this.staticWado)return super.searchForSeries(e);const t=await super.searchForSeries(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter((e=>{for(const t of Object.keys(U.seriesFilterKeys))if(!this.filterItem(t,n,e,U.seriesFilterKeys))return!1;return!0}))}compareValues(e,t){if(Array.isArray(e))return e.find((e=>this.compareValues(e,t)));if(Array.isArray(t))return t.find((t=>this.compareValues(e,t)));if(t?.Alphabetic&&(t=t.Alphabetic),"string"==typeof t){if(0===t.length)return!0;if(0===e.length||"*"===e)return!0;if("*"===e[0]&&"*"===e[e.length-1])return-1!=t.indexOf(e.substring(1,e.length-1));if("*"===e[e.length-1])return-1!=t.indexOf(e.substring(0,e.length-1));if("*"===e[0])return t.indexOf(e.substring(1))===t.length-e.length+1}return e===t}compareDateRange(e,t){if(!t)return!0;const a=e.indexOf("-");if(-1===a)return this.compareValues(e,t);const n=e.substring(0,a),s=e.substring(a+1);return(!n||t>=n)&&(!s||t<=s)}filterItem(e,t,a,n){const s=n[e]||e;if(!t)return!0;const r=t[e]||t[s];if(!r)return!0;const i=a[e]||a[s];if(!i)return!1;if("DA"===i.vr&&i.Value?.[0])return this.compareDateRange(r,i.Value[0]);const o=i.Value;return this.compareValues(r,o)}toLowerParams(e){const t={};return Object.entries(e).forEach((e=>{let[a,n]=e;t[a.toLowerCase()]=n})),t}}U.studyFilterKeys={studyinstanceuid:"0020000D",patientname:"00100010","00100020":"mrn",studydescription:"00081030",studydate:"00080020",modalitiesinstudy:"00080061",accessionnumber:"00080050"},U.seriesFilterKeys={seriesinstanceuid:"0020000E",seriesnumber:"00200011",modality:"00080060"};const x=(e,t)=>{const{wadoRoot:a,singlepart:n}=e,{instance:s,tag:r="PixelData",defaultPath:o="/pixeldata",defaultType:c="video/mp4",singlepart:l="video"}=t,u=s[r];if(!u)return;if(u.DirectRetrieveURL)return u.DirectRetrieveURL;if(u.InlineBinary){const e=i.utils.b64toBlob(u.InlineBinary,c);return u.DirectRetrieveURL=URL.createObjectURL(e),u.DirectRetrieveURL}if(!n||!0!==n&&-1===n.indexOf(l))return u.retrieveBulkData?u.retrieveBulkData().then((e=>(u.DirectRetrieveURL=URL.createObjectURL(new Blob([e],{type:c})),u.DirectRetrieveURL))):void console.warn("Unable to retrieve",r,"from",s);const{StudyInstanceUID:d,SeriesInstanceUID:m,SOPInstanceUID:p}=s,g=u&&u.BulkDataURI||`series/${m}/instances/${p}${o}`,f=-1!==g.indexOf("?"),I=-1!==g.indexOf("accept=");return"PixelData"===r||"EncapsulatedDocument"===r?`${a}/studies/${d}/series/${m}/instances/${p}/rendered`:g+(I?"":(f?"&":"?")+`accept=${c}`)};function R(e,t,a){if(e.BulkDataURI.startsWith("http")||e.BulkDataURI.startsWith("/")){if("/"===e.BulkDataURI[0]&&a.wadoRoot.startsWith("http")){const t=new URL(a.wadoRoot);e.BulkDataURI=`${t.origin}${e.BulkDataURI}`}}else"studies"===a.bulkDataURI?.relativeResolution?e.BulkDataURI=`${a.wadoRoot}/studies/${t.StudyInstanceUID}/${e.BulkDataURI}`:"series"!==a.bulkDataURI?.relativeResolution&&a.bulkDataURI?.relativeResolution||(e.BulkDataURI=`${a.wadoRoot}/studies/${t.StudyInstanceUID}/series/${t.SeriesInstanceUID}/${e.BulkDataURI}`)}const{DicomMetaDictionary:C,DicomDict:N}=f.default.data,{naturalizeDataset:P,denaturalizeDataset:T}=C,O="2.25.270695996825855179949881587723571202391.2.0.0",A="OHIF-VIEWER-2.0.0",L="1.2.840.10008.1.2.1",k=i.classes.MetadataProvider;function F(e,t){let a,n,s,l,u,f,I;const y=Object.assign({EVENTS:{NEW_STUDY:"event::DicomWebDatasource::NEW_STUDY",RELOAD_STUDY:"event::DicomWebDatasource::RELOAD_STUDY"},listeners:[]},i.KZ),S=e=>{a=JSON.parse(JSON.stringify(e)),f=()=>{const e={},a=t.getAuthorizationHeader();return a&&a.Authorization&&(e.Authorization=a.Authorization),e},I=()=>({...f(),Accept:i.utils.generateAcceptHeader(e.acceptHeader,e.requestTransferSyntaxUID,e.omitQuotationForMultipartRequest)}),n={url:e.qidoRoot,staticWado:e.staticWado,singlepart:e.singlepart,headers:t.getAuthorizationHeader(),errorInterceptor:i.Po.getHTTPErrorHandler()},s={url:e.wadoRoot,staticWado:e.staticWado,singlepart:e.singlepart,headers:t.getAuthorizationHeader(),errorInterceptor:i.Po.getHTTPErrorHandler()},l=e.staticWado?new U(n):new r.hi.DICOMwebClient(n),u=e.staticWado?new U(s):new r.hi.DICOMwebClient(s)},h={updateConfig:e=>{S(e)},onNewStudy:e=>{y.subscribe(y.EVENTS.NEW_STUDY,e)},onReloadStudy:e=>{y.subscribe(y.EVENTS.RELOAD_STUDY,e)},reloadStudy:e=>{let{studyInstanceUIDs:t,seriesInstanceUIDs:a}=e;y._broadcastEvent(y.EVENTS.RELOAD_STUDY,{studyInstanceUIDs:t,seriesInstanceUIDs:a})},setNewStudy:e=>{let{studyInstanceUIDs:t,seriesInstanceUIDs:a}=e;y._broadcastEvent(y.EVENTS.NEW_STUDY,{studyInstanceUIDs:t,seriesInstanceUIDs:a})},initialize:t=>{let{params:a,query:n}=t;S(e)},query:{studies:{mapParams:p.bind(),search:async function(t){l.headers=f();const{studyInstanceUid:a,seriesInstanceUid:n,...s}=p(t,{supportsFuzzyMatching:e.supportsFuzzyMatching,supportsWildcard:e.supportsWildcard})||{};return d(await m(l,0,0,s))},processResults:d.bind()},series:{search:async function(e){l.headers=f();return function(e){const t=[];return e&&e.length&&e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),seriesInstanceUid:c(e["0020000E"]),modality:c(e["00080060"]),seriesNumber:c(e["00200011"]),seriesDate:i.utils.formatDate(c(e["00080021"])),numSeriesInstances:Number(c(e["00201209"])),description:c(e["0008103E"])}))),(0,o.IO)(t),t}(await function(e,t){const a={includefield:["0008103E","00080021"].join(",")};return e.searchForSeries({studyInstanceUID:t,queryParams:a})}(l,e))}},instances:{search:(e,t)=>{l.headers=f(),m.call(void 0,l,e,null,t)}}},retrieve:{directURL:e=>x({wadoRoot:a.wadoRoot,singlepart:a.singlepart},e),bulkDataURI:async e=>{let{StudyInstanceUID:t,BulkDataURI:a}=e;l.headers=f();const n={multipart:!1,BulkDataURI:a,StudyInstanceUID:t};return l.retrieveBulkData(n).then((e=>e&&e[0]||void 0))},series:{metadata:async function(){let{StudyInstanceUID:t,filters:a,sortCriteria:n,sortFunction:s,madeInClient:r=!1,withCredentials:i=!!e.withCredentials}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!t)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");return e.enableStudyLazyLoad?h._retrieveSeriesMetadataAsync(t,a,n,s,r,i):h._retrieveSeriesMetadataSync(t,a,n,s,r,i)}}},store:{dicom:async(e,t)=>{if(u.headers=f(),e instanceof ArrayBuffer){const a={datasets:[e],request:t};await u.storeInstances(a)}else{const a={FileMetaInformationVersion:e._meta?.FileMetaInformationVersion?.Value,MediaStorageSOPClassUID:e.SOPClassUID,MediaStorageSOPInstanceUID:e.SOPInstanceUID,TransferSyntaxUID:L,ImplementationClassUID:O,ImplementationVersionName:A},n=T(a),s=new N(n);s.dict=T(e);const r={datasets:[s.write()],request:t};await u.storeInstances(r)}}},_retrieveSeriesMetadataSync:async(t,a,n,s,r,o)=>{u.headers=I();const c=(await E(u,t,!1,a,n,s,o)).map(P),l={},d={};c.forEach((a=>{l[a.SeriesInstanceUID]||(l[a.SeriesInstanceUID]={StudyInstanceUID:a.StudyInstanceUID,StudyDescription:a.StudyDescription,SeriesInstanceUID:a.SeriesInstanceUID,SeriesDescription:a.SeriesDescription,SeriesNumber:a.SeriesNumber,SeriesTime:a.SeriesTime,SOPClassUID:a.SOPClassUID,ProtocolName:a.ProtocolName,Modality:a.Modality}),d[a.SeriesInstanceUID]||(d[a.SeriesInstanceUID]=[]);const n=h.getImageIdsForInstance({instance:a});a.imageId=n,a.wadoRoot=e.wadoRoot,a.wadoUri=e.wadoUri,k.addImageIdToUIDs(n,{StudyInstanceUID:t,SeriesInstanceUID:a.SeriesInstanceUID,SOPInstanceUID:a.SOPInstanceUID}),d[a.SeriesInstanceUID].push(a)}));const m=Object.values(l);i.DicomMetadataStore.addSeriesMetadata(m,r),Object.keys(d).forEach((e=>i.DicomMetadataStore.addInstances(d[e],r)))},_retrieveSeriesMetadataAsync:async function(e,t,n,s){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];u.headers=I();const{preLoadData:c,promises:d}=await E(u,e,!0,t,n,s,o),m=e=>{const t=P(e);return a.bulkDataURI?.enabled?(Object.keys(t).forEach((e=>{const n=t[e];n&&n.BulkDataURI&&!n.Value&&(n.retrieveBulkData=()=>{R(n,t,a);const e={multipart:!1,BulkDataURI:n.BulkDataURI,StudyInstanceUID:t.StudyInstanceUID};return l.retrieveBulkData(e).then((e=>{const t=e instanceof Array&&e.find((e=>e?.byteLength))||void 0;return n.Value=t,t}))})})),t):t};c.forEach((t=>{t.StudyInstanceUID=e})),i.DicomMetadataStore.addSeriesMetadata(c,r);const p=d.map((t=>t.then((t=>{!function(t){const n=t.map(m);n.forEach(((t,n)=>{t.wadoRoot=a.wadoRoot,t.wadoUri=a.wadoUri;const s=h.getImageIdsForInstance({instance:t});t.imageId=s,k.addImageIdToUIDs(s,{StudyInstanceUID:e,SeriesInstanceUID:t.SeriesInstanceUID,SOPInstanceUID:t.SOPInstanceUID})})),i.DicomMetadataStore.addInstances(n,r)}(t)}))));await Promise.all(p),i.DicomMetadataStore.getStudy(e,r).isLoaded=!0},deleteStudyMetadataPromise:M,async getImageIdsForStudy(e){const t=await this.query.series.search(e);return(await Promise.all(t.map((t=>u.retrieveSeriesMetadata({studyInstanceUID:e,seriesInstanceUID:t.seriesInstanceUid}))))).map((e=>{const t=e.map(P);return this.getImageIdsForDisplaySet({images:t})}))},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((t=>{const n=t.NumberOfFrames;let s=1,r=n;const i=e.getAttribute("multiFrameImagesMapper");if(i&&i instanceof Function&&(s=i().startIndex,r=i().endIndex),n>1)for(let e=s;e<=r;e++){const n=this.getImageIdsForInstance({instance:t,frame:e});a.push(n)}else{const e=this.getImageIdsForInstance({instance:t});a.push(e)}})),a):a},getImageIdsForInstance(e){let{instance:t,frame:n}=e;return g({instance:t,frame:n,config:a})},getConfig:()=>a,getStudyInstanceUIDs(e){let{params:t,query:a}=e;const{StudyInstanceUIDs:n}=t,{SeriesInstanceUIDs:s}=t,r=i.utils.splitComma(a.getAll("StudyInstanceUIDs")),o=i.utils.splitComma(a.getAll("SeriesInstanceUIDs")),c=r.length&&r||n,l=o||s;return{studyInstanceUIDs:c&&Array.isArray(c)?c:[c],seriesInstanceUIDs:l&&Array.isArray(l)?l:[l],filters:null,sortCriteria:null,sortFunction:null}}};var v;return e.supportsReject&&(h.reject=(v=e.wadoRoot,{series:(e,t)=>new Promise(((a,n)=>{const s=`${v}/studies/${e}/series/${t}/reject/113001%5EDCM`,r=new XMLHttpRequest;r.open("POST",s,!0),console.log(r),r.onreadystatechange=function(){if(4==r.readyState)switch(r.status){case 204:a(r.responseText);break;case 404:n("Your dataSource does not support reject functionality")}},r.send()}))})),i.Is.create(h)}const V=i.ZP.classes.MetadataProvider,$={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let q={urls:[],studyInstanceUIDMap:new Map};const _=e=>q.urls.find((t=>t.url===e)),j=(e,t)=>{let a=[];return q.urls.map((n=>{n.studies.map((n=>{n[e]===t&&a.push(n)}))})),a};let Z=null;function H(e){var{name:t,wadoRoot:a}=e;const n=e=>{Z=e,Z.name,a=Z.wadoRoot};n(e);const s={updateConfig:e=>{n(e)},initialize:async e=>{let{params:t,query:a,url:n}=e;n||(n=a.get("url"));let s=_(n);if(s)return s.studies.map((e=>e.StudyInstanceUID));const r=await fetch(n),i=await r.json();let o,c;i.studies.forEach((e=>{o=e.StudyInstanceUID,e.series.forEach((e=>{c=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:a}=e;V.addImageIdToUIDs(t,{StudyInstanceUID:o,SeriesInstanceUID:c,SOPInstanceUID:a.SOPInstanceUID})}))}))})),q.urls.push({url:n,studies:[...i.studies]}),q.studyInstanceUIDMap.set(n,i.studies.map((e=>e.StudyInstanceUID)))},query:{studies:{mapParams:()=>{},search:async e=>{const[t,a]=Object.entries(e)[0],n=$[t];return j(n,a).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.warn(" DICOMJson QUERY processResults not implemented")}},series:{search:()=>{console.warn(" DICOMJson QUERY SERIES SEARCH not implemented")}},instances:{search:()=>{console.warn(" DICOMJson QUERY instances SEARCH not implemented")}}},retrieve:{directURL:e=>x(a,e),series:{metadata:async function(){let{StudyInstanceUID:e,madeInClient:t=!1,customSort:a}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const n=j("StudyInstanceUID",e)[0];let s;s=a?a(n.series):n.series;const r=s.map((e=>{const t={StudyInstanceUID:n.StudyInstanceUID,...e};return delete t.instances,t}));i.DicomMetadataStore.addSeriesMetadata(r,t);const o=s.length;s.forEach(((a,s)=>{const r=a.instances.map((e=>{const t={...e.metadata,url:e.url,imageId:e.url,...a,...n};return delete t.instances,delete t.series,t}));var c;c=r,i.DicomMetadataStore.addInstances(c,t),s===o-1&&(i.DicomMetadataStore.getStudy(e,t).isLoaded=!0)}))}}},store:{dicom:()=>{console.warn(" DICOMJson store dicom not implemented")}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=0;n<t;n++){const t=g({instance:e,frame:n,config:Z});a.push(t)}else{const t=g({instance:e,config:Z});a.push(t)}})),a):a},getImageIdsForInstance(e){let{instance:t,frame:a}=e;return g({instance:t,frame:a})},getStudyInstanceUIDs:e=>{let{params:t,query:a}=e;const n=a.get("url");return q.studyInstanceUIDMap.get(n)}};return i.Is.create(s)}const B=i.ZP.classes.MetadataProvider,{EVENTS:G}=i.DicomMetadataStore,z={SR:!0,SEG:!0,DOC:!0},W=function(e,t){return e===t?arguments.length>2&&void 0!==arguments[2]?arguments[2]:0:e<t?-1:1},Y=(e,t)=>{const a=e.instances[0],n=t.instances[0],s=a.Modality,r=n.Modality,i=z[s],o=z[r];return i&&o?W(a.SeriesNumber,n.SeriesNumber):i||o?i?-1:1:W(n.SeriesNumber,a.SeriesNumber)};function X(e){const{name:t}=e,a={initialize:e=>{let{params:t,query:a}=e},query:{studies:{mapParams:()=>{},search:e=>i.DicomMetadataStore.getStudyInstanceUIDs().map((e=>{let t=0;const a=new Set,n=i.DicomMetadataStore.getStudy(e);n.series.forEach((e=>{t+=e.instances.length,a.add(e.instances[0].Modality)}));const s=n?.series[0]?.instances[0];if(s)return{accession:s.AccessionNumber,date:s.StudyDate,description:s.StudyDescription,mrn:s.PatientID,patientName:i.utils.formatPN(s.PatientName),studyInstanceUid:s.StudyInstanceUID,time:s.StudyTime,instances:t,modalities:Array.from(a).join("/"),NumInstances:t}})),processResults:()=>{console.warn(" DICOMLocal QUERY processResults not implemented")}},series:{search:e=>i.DicomMetadataStore.getStudy(e).series.map((t=>{const a=t?.instances[0];return{studyInstanceUid:e,seriesInstanceUid:a.SeriesInstanceUID,modality:a.Modality,seriesNumber:a.SeriesNumber,seriesDate:a.SeriesDate,numSeriesInstances:t.instances.length,description:a.SeriesDescription}}))},instances:{search:()=>{console.warn(" DICOMLocal QUERY instances SEARCH not implemented")}}},retrieve:{directURL:e=>{const{instance:t,tag:a,defaultType:n}=e,s=t[a];if(s instanceof Array&&s[0]instanceof ArrayBuffer)return URL.createObjectURL(new Blob([s[0]],{type:n}))},series:{metadata:async function(){let{StudyInstanceUID:e,madeInClient:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const a=i.DicomMetadataStore.getStudy(e,t);i.DicomMetadataStore._broadcastEvent(G.SERIES_ADDED,{StudyInstanceUID:e,madeInClient:t}),a.series.forEach((a=>{const{SeriesInstanceUID:n}=a,s=a.instances[0].NumberOfFrames>1;a.instances.forEach(((e,t)=>{const{url:a,StudyInstanceUID:n,SeriesInstanceUID:r,SOPInstanceUID:i}=e;e.imageId=a,B.addImageIdToUIDs(a,{StudyInstanceUID:n,SeriesInstanceUID:r,SOPInstanceUID:i,frameIndex:s?t:1})})),i.DicomMetadataStore._broadcastEvent(G.INSTANCES_ADDED,{StudyInstanceUID:e,SeriesInstanceUID:n,madeInClient:t})}))}}},store:{dicom:e=>{const t=f.default.data.datasetToBlob(e);var a=URL.createObjectURL(t);window.location.assign(a)}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}})),a):a},getImageIdsForInstance(e){let{instance:t,frame:a}=e;const{StudyInstanceUID:n,SeriesInstanceUID:s,SOPInstanceUID:r}=t;let o=i.DicomMetadataStore.getInstance(n,s,r).url;return void 0!==a&&(o+=`&frame=${a}`),o},deleteStudyMetadataPromise(){console.log("deleteStudyMetadataPromise not implemented")},getStudyInstanceUIDs:e=>{let{params:t,query:a}=e;const{StudyInstanceUIDs:n}=t,s=a.getAll("StudyInstanceUIDs")||n,r=s&&Array.isArray(s)?s:[s];let o=!1;return r.forEach((e=>{const t=i.DicomMetadataStore.getStudy(e);t&&(t.series=t.series.sort(Y),o=!0)})),o?r:[]}};return i.Is.create(a)}function J(e,t){const{name:a}=e;let n;const s={initialize:async e=>{let{params:s,query:r}=e;const i=r.get("url");if(!i)throw new Error(`No url for '${a}'`);{const e=await fetch(i);let a=await e.json();if(!a.servers?.dicomWeb?.[0])throw new Error("Invalid configuration returned by url");n=F(a.servers.dicomWeb[0].configuration,t),n.initialize({params:s,query:r})}},query:{studies:{search:e=>n.query.studies.search(e)},series:{search:function(){return n.query.series.search(...arguments)}},instances:{search:(e,t)=>n.query.instances.search(e,t)}},retrieve:{directURL:function(){return n.retrieve.directURL(...arguments)},series:{metadata:async function(){return n.retrieve.series.metadata(...arguments)}}},store:{dicom:function(){return n.store(...arguments)}},deleteStudyMetadataPromise:function(){return n.deleteStudyMetadataPromise(...arguments)},getImageIdsForDisplaySet:function(){return n.getImageIdsForDisplaySet(...arguments)},getImageIdsForInstance:function(){return n.getImageIdsForInstance(...arguments)},getStudyInstanceUIDs(e){let{params:t,query:n}=e,s=[];const r=n.get("studyInstanceUIDs")||n.get("studyInstanceUids");if(!r)throw new Error(`No studyInstanceUids in request for '${a}'`);return s=r.split(";"),s}};return i.Is.create(s)}const K=function(){return[{name:"dicomweb",type:"webApi",createDataSource:F},{name:"dicomwebproxy",type:"webApi",createDataSource:J},{name:"dicomjson",type:"jsonApi",createDataSource:H},{name:"dicomlocal",type:"localApi",createDataSource:X}]};var Q=a(43001),ee=a(3827),te=a.n(ee),ae=a(92375),ne=a(62657),se=a(62474),re=a(69190),ie=a(85066),oe=a(50376),ce=a(44921),le=a.n(ce);function ue(){return ue=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},ue.apply(this,arguments)}function de(e){let{servicesManager:t}=e;const{toolbarService:a}=t.services,[n,s]=(0,Q.useState)([]);(0,Q.useEffect)((()=>{const{unsubscribe:e}=a.subscribe(a.EVENTS.TOOL_BAR_MODIFIED,(()=>s(a.getButtonSection("primary"))));return()=>{e()}}),[a]);const r=(0,Q.useCallback)((e=>a.recordInteraction(e)),[a]);return Q.createElement(Q.Fragment,null,n.map((e=>{const{id:a,Component:n,componentProps:s}=e;return Q.createElement("div",{key:a,className:le()("mr-1")},Q.createElement(n,ue({id:a},s,{onInteraction:r,servicesManager:t})))})))}const{availableLanguages:me,defaultLanguage:pe,currentLanguage:ge}=oe.default;const fe=function(e){let{hotkeysManager:t,extensionManager:a,servicesManager:n}=e;const[s]=(0,ne.M)(),r=(0,se.s0)(),o=(0,ie.TH)(),{t:c}=(0,re.$G)(),{show:l,hide:u}=(0,ae.dd)(),{hotkeyDefinitions:d,hotkeyDefaults:m}=t,p=[{title:c("Header:About"),icon:"info",onClick:()=>l({content:ae.tk,title:"About OHIF Viewer",contentProps:{versionNumber:"3.8.0-beta.0",commitHash:"55002fbd712b6470b2217f75588e6a43366803e6"}})},{title:c("Header:Preferences"),icon:"settings",onClick:()=>l({title:c("UserPreferencesModal:User Preferences"),content:ae.i1,contentProps:{hotkeyDefaults:t.getValidHotkeyDefinitions(m),hotkeyDefinitions:d,currentLanguage:ge(),availableLanguages:me,defaultLanguage:pe,onCancel:()=>{i.dD.stopRecord(),i.dD.unpause(),u()},onSubmit:e=>{let{hotkeyDefinitions:a,language:n}=e;n.value!==ge().value&&oe.default.changeLanguage(n.value),t.setHotkeys(a),u()},onReset:()=>t.restoreDefaultBindings(),hotkeysModule:i.dD}})}];return s.oidc&&p.push({title:c("Header:Logout"),icon:"power-off",onClick:async()=>{r(`/logout?redirect_uri=${encodeURIComponent(window.location.href)}`)}}),Q.createElement(ae.h4,{menuOptions:p,isReturnEnabled:!!s.showStudyList,onClickReturnButton:()=>{const{pathname:e}=o,t=e.indexOf("/",1),n=new URLSearchParams(window.location.search).get("configUrl"),s=e.substring(t+1),i=a.getDataSources(s),c=new URLSearchParams;-1!==t&&i&&c.append("datasources",e.substring(t+1)),n&&c.append("configUrl",n),r({pathname:"/",search:decodeURIComponent(c.toString())})},WhiteLabeling:s.whiteLabeling},Q.createElement(ae.SV,{context:"Primary Toolbar"},Q.createElement("div",{className:"relative flex justify-center"},Q.createElement(de,{servicesManager:n}))))},Ie=e=>{let{servicesManager:t,side:a,className:n,activeTabIndex:s,tabs:r}=e;const i=t?.services?.panelService,[o,c]=(0,Q.useState)(!1),[l,u]=(0,Q.useState)(s);return(0,Q.useEffect)((()=>{if(i){const e=i.subscribe(i.EVENTS.ACTIVATE_PANEL,(e=>{if(!o||e.forceActive){const t=r.findIndex((t=>t.id===e.panelId));-1!==t&&u(t)}}));return()=>{e.unsubscribe()}}}),[r,o,i]),Q.createElement(ae.hs,{side:a,className:n,activeTabIndex:l,tabs:r,onOpen:()=>{c(!0)}})};function ye(e){let{extensionManager:t,servicesManager:a,hotkeysManager:n,commandsManager:s,viewports:r,ViewportGridComp:o,leftPanels:c=[],rightPanels:l=[],leftPanelDefaultClosed:u=!1,rightPanelDefaultClosed:d=!1,disableHeader:m=!1,viewerLayoutHeight:p="calc(100vh - 52px)"}=e;const[g]=(0,ne.M)(),{hangingProtocolService:f}=a.services,[I,y]=(0,Q.useState)(g.showLoadingIndicator);(0,Q.useEffect)((()=>(document.body.classList.add("bg-black"),document.body.classList.add("overflow-hidden"),()=>{document.body.classList.remove("bg-black"),document.body.classList.remove("overflow-hidden")})),[]);const S=e=>{const a=t.getModuleEntry(e);if(!a)throw new Error(`${e} is not valid for an extension module. Please verify your configuration or ensure that the extension is properly registered. It's also possible that your mode is utilizing a module from an extension that hasn't been included in its dependencies (add the extension to the "extensionDependencies" array in your mode's index.js file)`);let n;if(!a||!a.component)throw new Error(`No component found from extension ${e}. Check the reference string to the extension in your Mode configuration`);return n=a.component,{entry:a,content:n}},h=e=>{const{content:t,entry:a}=S(e);return{id:a.id,iconName:a.iconName,iconLabel:a.iconLabel,label:a.label,name:a.name,content:t}};(0,Q.useEffect)((()=>{const{unsubscribe:e}=f.subscribe(i.hy.EVENTS.PROTOCOL_CHANGED,(()=>{y(!1)}));return()=>{e()}}),[f]);const v=c.map(h),D=l.map(h),w=r.map((e=>{const{entry:t}=S(e.namespace);return{component:t.component,displaySetsToDisplay:e.displaySetsToDisplay}}));return Q.createElement("div",null,Q.createElement(fe,{hotkeysManager:n,extensionManager:t,servicesManager:a}),Q.createElement("div",{className:"relative flex w-full flex-row flex-nowrap items-stretch overflow-hidden bg-black",style:{height:p}},Q.createElement(Q.Fragment,null,I&&Q.createElement(ae.LE,{className:"h-full w-full bg-black"}),v.length?Q.createElement(ae.SV,{context:"Left Panel"},Q.createElement(Ie,{side:"left",activeTabIndex:u?null:0,tabs:v,servicesManager:a})):null,Q.createElement("div",{className:"flex h-full flex-1 flex-col"},Q.createElement("div",{className:"relative flex h-full flex-1 items-center justify-center overflow-hidden bg-black"},Q.createElement(ae.SV,{context:"Grid"},Q.createElement(o,{servicesManager:a,viewportComponents:w,commandsManager:s})))),D.length?Q.createElement(ae.SV,{context:"Right Panel"},Q.createElement(Ie,{side:"right",activeTabIndex:d?null:0,tabs:D,servicesManager:a})):null)))}ye.propTypes={extensionManager:te().shape({getModuleEntry:te().func.isRequired}).isRequired,commandsManager:te().instanceOf(i.HQ),servicesManager:te().instanceOf(i.Xw),leftPanels:te().array,rightPanels:te().array,leftPanelDefaultClosed:te().bool.isRequired,rightPanelDefaultClosed:te().bool.isRequired,children:te().oneOfType([te().node,te().func]).isRequired,disableHeader:te().bool.isRequired,viewerLayoutHeight:te().string.isRequired,viewports:te().array};const Se=ye;const{sortStudyInstances:he,formatDate:ve}=i.utils;function De(e){let{servicesManager:t,getImageSrc:a,getStudiesForPatientByMRN:n,requestDisplaySetCreationForStudy:s,dataSource:r}=e;const{hangingProtocolService:i,displaySetService:o,uiNotificationService:c}=t.services,l=(0,se.s0)(),{StudyInstanceUIDs:u}=(0,ae.zG)(),[{activeViewportId:d,viewports:m},p]=(0,ae.O_)(),[g,f]=(0,Q.useState)("primary"),[I,y]=(0,Q.useState)([...u]),[S,h]=(0,Q.useState)([]),[v,D]=(0,Q.useState)([]),[w,b]=(0,Q.useState)({});(0,Q.useEffect)((()=>{u.forEach((e=>async function(e){const t=await r.query.studies.search({studyInstanceUid:e});if(!t?.length)throw l("/notfoundstudy","_self"),new Error("Invalid study URL");let a=t;try{a=await n(t)}catch(e){console.warn(e)}const s=a.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:ve(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));h((e=>{const t=[...e];for(const a of s)e.find((e=>e.studyInstanceUid===a.studyInstanceUid))||t.push(a);return t}))}(e)))}),[u,r,n,l]),(0,Q.useEffect)((()=>{o.activeDisplaySets.forEach((async e=>{const t={},n=o.getDisplaySetByUID(e.displaySetInstanceUID),s=r.getImageIdsForDisplaySet(n),i=s[Math.floor(s.length/2)];i&&!n?.unsupported&&(t[e.displaySetInstanceUID]=await a(i),b((e=>({...e,...t}))))}))}),[u,r,o,a]),(0,Q.useEffect)((()=>{const e=be(o.activeDisplaySets,w);he(e),D(e)}),[u,w,o]),(0,Q.useEffect)((()=>{const e=o.subscribe(o.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:t,options:n}=e;t.forEach((async e=>{const t={},n=o.getDisplaySetByUID(e.displaySetInstanceUID);if(n?.unsupported)return;const s=r.getImageIdsForDisplaySet(n),i=s[Math.floor(s.length/2)];i&&(t[e.displaySetInstanceUID]=await a(i,e.initialViewport),b((e=>({...e,...t}))))}))}));return()=>{e.unsubscribe()}}),[a,r,o]),(0,Q.useEffect)((()=>{const e=o.subscribe(o.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=be(e,w);D(t)})),t=o.subscribe(o.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,(()=>{const e=be(o.getActiveDisplaySets(),w);D(e)}));return()=>{e.unsubscribe(),t.unsubscribe()}}),[u,w,o]);const E=function(e,t,a){const n=[],s=[],r=[];t.forEach((t=>{const i=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),o=Object.assign({},t,{displaySets:i});e.includes(t.studyInstanceUid)?n.push(o):(s.push(o),r.push(o))}));const i=[{name:"primary",label:"Primary",studies:n},{name:"recent",label:"Recent",studies:s},{name:"all",label:"All",studies:r}];return i}(u,S,v);const M=m.get(d)?.displaySetInstanceUIDs;return Q.createElement(ae.eX,{tabs:E,servicesManager:t,activeTabName:g,onDoubleClickThumbnail:e=>{let t=[];const a=d;try{t=i.getViewportsRequireUpdate(a,e)}catch(e){console.warn(e),c.show({title:"Thumbnail Double Click",message:"The selected display sets could not be added to the viewport.",type:"info",duration:3e3})}p.setDisplaySetsForViewports(t)},activeDisplaySetInstanceUIDs:M,expandedStudyInstanceUIDs:I,onClickStudy:function(e){const t=I.includes(e),a=t?[...I.filter((t=>t!==e))]:[...I,e];if(y(a),!t){s(o,e,!0)}},onClickTab:e=>{f(e)}})}De.propTypes={servicesManager:te().object.isRequired,dataSource:te().shape({getImageIdsForDisplaySet:te().func.isRequired}).isRequired,getImageSrc:te().func.isRequired,getStudiesForPatientByMRN:te().func.isRequired,requestDisplaySetCreationForStudy:te().func.isRequired};const we=De;function be(e,t){const a=[],n=[];return e.filter((e=>!e.excludeFromThumbnailBrowser)).forEach((e=>{const s=t[e.displaySetInstanceUID],r=function(e){if(Ee.includes(e.Modality)||e?.unsupported)return"thumbnailNoImage";return"thumbnail"}(e);("thumbnail"===r?a:n).push({displaySetInstanceUID:e.displaySetInstanceUID,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:e.SeriesDate,seriesTime:e.SeriesTime,numInstances:e.numImageFrames,countIcon:e.countIcon,StudyInstanceUID:e.StudyInstanceUID,messages:e.messages,componentType:r,imageSrc:s,dragData:{type:"displayset",displaySetInstanceUID:e.displaySetInstanceUID},isHydratedForDerivedDisplaySet:e.isHydrated})})),[...a,...n]}const Ee=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"];const Me=function(e,t){return new Promise(((a,n)=>{const s=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:s,imageId:t}).then((e=>{a(s.toDataURL())})).catch(n)}))};const Ue=async function(e,t){return t&&t.length&&t[0].mrn?e.query.studies.search({patientId:t[0].mrn}):(console.log("No mrn found for",t),t)};const xe=function(e,t,a,n){t.activeDisplaySets.some((e=>e.StudyInstanceUID===a))||e.retrieve.series.metadata({StudyInstanceUID:a,madeInClient:n})};function Re(e){let{commandsManager:t,extensionManager:a,servicesManager:n}=e;const s=a.getDataSources()[0],r=Ue.bind(null,s),i=function(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return Me.bind(null,e)}catch(e){throw new Error("Required command not found")}}(a),o=xe.bind(null,s);return Q.createElement(we,{servicesManager:n,dataSource:s,getImageSrc:i,getStudiesForPatientByMRN:r,requestDisplaySetCreationForStudy:o})}Re.propTypes={commandsManager:te().object.isRequired,extensionManager:te().object.isRequired,servicesManager:te().object.isRequired};const Ce=Re;function Ne(e){let{onExportClick:t,onCreateReportClick:a}=e;const{t:n}=(0,re.$G)("MeasurementTable");return Q.createElement(Q.Fragment,null,Q.createElement(ae.HO,{color:"black",size:"inherit"},Q.createElement(ae.mN,{className:"px-2 py-2 text-base",onClick:t},n("Export CSV")),Q.createElement(ae.mN,{className:"px-2 py-2 text-base",onClick:a},n("Create Report"))))}Ne.propTypes={onExportClick:te().func,onCreateReportClick:te().func},Ne.defaultProps={onExportClick:()=>alert("Export"),onCreateReportClick:()=>alert("Create Report")};const Pe=Ne;var Te=a(8324),Oe=a.n(Te);const Ae={CANCEL:0,CREATE_REPORT:1};function Le(e,t){let{extensionManager:a}=t;return new Promise((function(t,n){let s;const r=Object.keys(a.dataSourceMap).filter((e=>{const t=a.dataSourceDefs[e]?.configuration;return t?.supportsStow??t?.wadoRoot})).map((e=>({value:e,label:e,placeHolder:e})));s=e.create({centralize:!0,isDraggable:!1,content:ae.Vq,useLastPosition:!1,showOverlay:!0,contentProps:{title:"Create Report",value:{label:"",dataSourceName:a.activeDataSource},noCloseButton:!0,onClose:()=>{e.dismiss({id:s}),t({action:Ae.CANCEL,value:void 0,dataSourceName:void 0})},actions:[{id:"cancel",text:"Cancel",type:ae.LZ.dt.secondary},{id:"save",text:"Save",type:ae.LZ.dt.primary}],onSubmit:a=>{let{action:n,value:r}=a;switch(e.dismiss({id:s}),n.id){case"save":t({action:Ae.CREATE_REPORT,value:r.label,dataSourceName:r.dataSourceName});break;case"cancel":t({action:Ae.CANCEL,value:void 0,dataSourceName:void 0})}},body:a=>{let{value:n,setValue:i}=a;return Q.createElement(Q.Fragment,null,r.length>1&&window.config?.allowMultiSelectExport&&Q.createElement("div",null,Q.createElement("label",{className:"text-[14px] leading-[1.2] text-white"},"Data Source"),Q.createElement(ae.Ph,{closeMenuOnSelect:!0,className:"border-primary-main  mt-2 bg-black",options:r,placeholder:r.find((e=>e.value===n.dataSourceName)).placeHolder,value:n.dataSourceName,onChange:e=>{i((t=>({...t,dataSourceName:e.value})))},isClearable:!1})),Q.createElement("div",{className:"mt-3"},Q.createElement(ae.II,{autoFocus:!0,label:"Enter the report name",labelClassName:"text-white text-[14px] leading-[1.2]",className:"border-primary-main bg-black",type:"text",value:n.label,onChange:e=>{e.persist(),i((t=>({...t,label:e.target.value})))},onKeyPress:a=>{"Enter"===a.key&&(e.dismiss({id:s}),t({action:Ae.CREATE_REPORT,value:n.label}))},required:!0})))}}})}))}function ke(){return Q.createElement("div",{className:"text-primary-active"},"Loading...")}const Fe=async function(e){let{servicesManager:t,getReport:a,reportType:n="measurement"}=e;const{displaySetService:s,uiNotificationService:r,uiDialogService:o}=t.services,c=o.create({showOverlay:!0,isDraggable:!1,centralize:!0,content:ke});try{const e=await a();i.DicomMetadataStore.addInstances([e],!0);const t=s.getMostRecentDisplaySet().displaySetInstanceUID;return r.show({title:"Create Report",message:`${n} saved successfully`,type:"success"}),[t]}catch(e){r.show({title:"Create Report",message:e.message||`Failed to store ${n}`,type:"error"})}finally{o.dismiss({id:c})}},Ve=4700;function $e(e,t){const a=t.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).find((t=>t.SeriesDescription===e));if(a){console.log("Storing to same series",a);const{instance:e}=a,{SeriesInstanceUID:t,SeriesDescription:n,SeriesDate:s,SeriesTime:r,SeriesNumber:i,Modality:o}=e;return{SeriesInstanceUID:t,SeriesDescription:n,SeriesDate:s,SeriesTime:r,SeriesNumber:i,Modality:o,InstanceNumber:a.instances.length+1}}const n=function(e){const t=e.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).map((e=>e.SeriesNumber));return Math.max(...t,Ve)+1}(t);return{SeriesDescription:e,SeriesNumber:n}}const{downloadCSVReport:qe}=i.utils;function _e(e){let{servicesManager:t,commandsManager:a,extensionManager:n}=e;const[s,r]=(0,ae.O_)(),{activeViewportId:i,viewports:o}=s,{measurementService:c,uiDialogService:l,uiNotificationService:u,displaySetService:d}=t.services,[m,p]=(0,Q.useState)([]);(0,Q.useEffect)((()=>{const e=Oe()(p,100);p(je(c));const t=c.EVENTS.MEASUREMENT_ADDED,a=c.EVENTS.RAW_MEASUREMENT_ADDED,n=c.EVENTS.MEASUREMENT_UPDATED,s=c.EVENTS.MEASUREMENT_REMOVED,r=c.EVENTS.MEASUREMENTS_CLEARED,i=[];return[t,a,n,s,r].forEach((t=>{i.push(c.subscribe(t,(()=>{e(je(c))})).unsubscribe)})),()=>{i.forEach((e=>{e()})),e.cancel()}}),[]);const g=e=>{let{uid:t,isActive:a}=e;if(!a){const e=[...m],a=e.find((e=>e.uid===t));e.forEach((e=>e.isActive=e.uid===t)),a.isActive=!0,p(e)}};return Q.createElement(Q.Fragment,null,Q.createElement("div",{className:"ohif-scrollbar overflow-y-auto overflow-x-hidden","data-cy":"measurements-panel"},Q.createElement(ae.wt,{title:"Measurements",servicesManager:t,data:m,onClick:e=>{let{uid:t,isActive:a}=e;c.jumpToMeasurement(s.activeViewportId,t),g({uid:t,isActive:a})},onEdit:e=>{let{uid:t,isActive:a}=e;const n=c.getMeasurement(t),s=e=>{let{action:a,value:s}=e;if("save"===a.id)c.update(t,{...n,...s},!0);l.dismiss({id:"enter-annotation"})};l.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:ae.Vq,contentProps:{title:"Annotation",noCloseButton:!0,value:{label:n.label||""},body:e=>{let{value:t,setValue:a}=e;return Q.createElement(ae.II,{label:"Enter your annotation",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,id:"annotation",className:"border-primary-main bg-black",type:"text",value:t.label,onChange:e=>{e.persist(),a((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&s({value:t,action:{id:"save"}})}})},actions:[{id:"cancel",text:"Cancel",type:ae.LZ.dt.secondary},{id:"save",text:"Save",type:ae.LZ.dt.primary}],onSubmit:s}})}})),Q.createElement("div",{className:"flex justify-center p-4"},Q.createElement(Pe,{onExportClick:async function(){const e=c.getMeasurements();qe(e,c)},onClearMeasurementsClick:async function(){c.clearMeasurements()},onCreateReportClick:async function(){const e=o.get(i),s=c.getMeasurements(),r=d.getDisplaySetByUID(e.displaySetInstanceUIDs[0]),m=s.filter((e=>r.StudyInstanceUID===e.referenceStudyUID));if(m.length<=0)return void u.show({title:"No Measurements",message:"No Measurements are added to the current Study.",type:"info",duration:3e3});const p=await Le(l,{extensionManager:n});if(p.action===Ae.CREATE_REPORT){const e=n.getDataSources(p.dataSourceName)[0],s=$e(void 0===p.value||""===p.value?"Research Derived Series":p.value,d);return Fe({servicesManager:t,getReport:async()=>a.runCommand("storeMeasurements",{measurementData:m,dataSource:e,additionalFindingTypes:["ArrowAnnotate"],options:s},"CORNERSTONE_STRUCTURED_REPORT")})}}})))}function je(e){return e.getMeasurements().map(((t,a)=>function(e,t,a){const{displayText:n,uid:s,label:r,type:i,selected:o,findingSites:c,finding:l}=e,u=c?.[0],d=r||l?.text||u?.text||"(empty)";let m=n||[];if(c){const e=[];c.forEach((t=>{t?.text!==d&&e.push(t.text)})),m=[...e,...m]}l&&l?.text!==d&&(m=[l.text,...m]);return{uid:s,label:d,baseLabel:r,measurementType:i,displayText:m,baseDisplayText:n,isActive:o,finding:l,findingSites:c}}(t,0,e.VALUE_TYPES)))}_e.propTypes={servicesManager:te().instanceOf(i.Xw).isRequired};const Ze=function(e){let{commandsManager:t,extensionManager:a,servicesManager:n}=e;return[{name:"seriesList",iconName:"tab-studies",iconLabel:"Studies",label:"Studies",component:Ce.bind(null,{commandsManager:t,extensionManager:a,servicesManager:n})},{name:"measure",iconName:"tab-linear",iconLabel:"Measure",label:"Measurements",secondaryLabel:"Measurements",component:()=>Q.createElement(_e,{commandsManager:t,servicesManager:n,extensionManager:a})}]};var He=a(11835),Be=a(24369),Ge=a(13950),ze=a(89359);const We=JSON.parse('{"u2":"@ohif/extension-default"}').u2;var Ye=a(87425);var Xe=a(94972);var Je=a(45451);function Ke(e,t,a,n){const s=Je.R3.scaleAndAdd(Je.R3.create(),e,a,n);return Je.R3.distance(t,s)>n}function Qe(e){if(!e?.length)return!1;const t=(0,Xe.Z)(e[0].ImageOrientationPatient);if(!t)return!1;const a=function(e){const t=Je.R3.fromValues(e[0],e[1],e[2]),a=Je.R3.fromValues(e[3],e[4],e[5]);return Je.R3.cross(Je.R3.create(),t,a)}(t),n=(0,Xe.Z)(e[0].ImagePositionPatient),s=(0,Xe.Z)(e[e.length-1].ImagePositionPatient),r=(0,ze.Xn)(n,s)/(e.length-1);let i=n;for(let t=1;t<e.length;t++){const n=e[t],s=(0,Xe.Z)(n.ImagePositionPatient);if(Ke(i,s,a,r))return!1;i=s}return!0}function et(e,t){e.length>2&&(function(e){if(!e?.length)return!1;const t=e[0],a=(0,Xe.Z)(t.Rows),n=(0,Xe.Z)(t.Columns);for(let t=1;t<e.length;t++){const s=e[t],{Rows:r,Columns:i}=s;if(r!==a||i!==n)return!1}return!0}(e)||t.addMessage(i.Lt.CODES.INCONSISTENT_DIMENSIONS),function(e){if(!e?.length)return!1;const t=e[0],a=(0,Xe.Z)(t.SamplesPerPixel);for(let t=1;t<e.length;t++){const n=e[t],{SamplesPerPixel:s}=n;if(s!==a)return!1}return!0}(e)||t.addMessage(i.Lt.CODES.INCONSISTENT_COMPONENTS),function(e){if(!e?.length)return!1;const t=e[0],a=(0,Xe.Z)(t.ImageOrientationPatient);for(let t=1;t<e.length;t++){const n=e[t],s=(0,Xe.Z)(n.ImageOrientationPatient);if(!(0,ze.NB)(s,a))return!1}return!0}(e)||t.addMessage(i.Lt.CODES.INCONSISTENT_ORIENTATIONS),Qe(e)||t.addMessage(i.Lt.CODES.INCONSISTENT_POSITION_INFORMATION),function(e,t){if(!e?.length)return;const a=(0,Xe.Z)(e[0].ImagePositionPatient);if(!a)return;const n=(0,Xe.Z)(e[e.length-1].ImagePositionPatient),s=(0,ze.Xn)(a,n)/(e.length-1);let r=a;const o=[];for(let a=1;a<e.length;a++){const n=e[a],c=(0,Xe.Z)(n.ImagePositionPatient),l=(0,ze.Xn)(c,r),u=(0,ze.bg)(l,s);if(u){const e=u.issue;if(o.includes(e)||(o.push(e),e===ze.e1.MISSING_FRAMES?t.addMessage(i.Lt.CODES.MISSING_FRAMES):e===ze.e1.IRREGULAR_SPACING&&t.addMessage(i.Lt.CODES.IRREGULAR_SPACING)),o.length>1)break}r=c}}(e,t))}function tt(e,t){const a=new i.iK;if(!e.length)return void a.addMessage(i.Lt.CODES.NO_VALID_INSTANCES);const n=e[0],{Modality:s,ImageType:r,NumberOfFrames:o}=n;if(r?.includes("LOCALIZER"))return a;if(!ze.M6.includes(s))return a;const c=o>1;c||e.every((e=>e.ImagePositionPatient))||a.addMessage(i.Lt.CODES.NO_POSITION_INFORMATION);const l=(0,Ye.Z)(e);return c?function(e,t){(0,ze.hu)(e)||t.addMessage(i.Lt.CODES.MULTIFRAME_NO_PIXEL_MEASUREMENTS),(0,ze.sb)(e)||t.addMessage(i.Lt.CODES.MULTIFRAME_NO_ORIENTATION),(0,ze.kN)(e)||t.addMessage(i.Lt.CODES.MULTIFRAME_NO_POSITION_INFORMATION)}(l[0],a):et(l,a),t||a.addMessage(i.Lt.CODES.NOT_RECONSTRUCTABLE),a}function at(e){const t=new Ge.Z(e),a=new i.iK;a.addMessage(i.Lt.CODES.UNSUPPORTED_DISPLAYSET);const n=e[0];return t.setAttributes({displaySetInstanceUID:t.uid,SeriesDate:n.SeriesDate,SeriesTime:n.SeriesTime,SeriesInstanceUID:n.SeriesInstanceUID,StudyInstanceUID:n.StudyInstanceUID,SeriesNumber:n.SeriesNumber||0,FrameRate:n.FrameTime,SOPClassUID:n.SOPClassUID,SeriesDescription:n.SeriesDescription||"",Modality:n.Modality,numImageFrames:e.length,unsupported:!0,SOPClassHandlerId:"unsupported",isReconstructable:!1,messages:a}),[t]}const nt="stack",st=e=>e.NumberOfFrames>1,rt=e=>{const t=e[0],a=new Ge.Z(e),{value:n,averageSpacingBetweenFrames:s}=(0,ze.ZP)(e),r=tt(e,n);a.setAttributes({displaySetInstanceUID:a.uid,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,SeriesNumber:t.SeriesNumber||0,FrameRate:t.FrameTime,SOPClassUID:t.SOPClassUID,SeriesDescription:t.SeriesDescription||"",Modality:t.Modality,isMultiFrame:st(t),countIcon:n?"icon-mpr":void 0,numImageFrames:e.length,SOPClassHandlerId:`${We}.sopClassHandlerModule.${nt}`,isReconstructable:n,messages:r,averageSpacingBetweenFrames:s||null});return a.sortBy(((e,t)=>(parseInt(e.InstanceNumber)||0)-(parseInt(t.InstanceNumber)||0))),a},it=e=>"CR"===e||"MG"===e||"DX"===e;function ot(e){if(!e||!e.length)throw new Error("No instances were provided");const t=[],a=function(e){const t=new Set;return e.forEach((e=>{t.add(e.SOPClassUID)})),Array.from(t)}(e),n=[];if(e.forEach((e=>{if(!(0,He.O)(e.SOPClassUID)&&!e.Rows)return;let s;st(e)?(s=rt([e]),s.setAttributes({sopClassUids:a,isClip:!0,numImageFrames:e.NumberOfFrames,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(s)):it(e.Modality)?(s=rt([e]),s.setAttributes({sopClassUids:a,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(s)):n.push(e)})),n.length){const s=rt(n);s.setAttribute("studyInstanceUid",e[0].StudyInstanceUID),s.setAttributes({sopClassUids:a}),t.push(s)}return t}const ct=[Be.Z.ComputedRadiographyImageStorage,Be.Z.DigitalXRayImageStorageForPresentation,Be.Z.DigitalXRayImageStorageForProcessing,Be.Z.DigitalMammographyXRayImageStorageForPresentation,Be.Z.DigitalMammographyXRayImageStorageForProcessing,Be.Z.DigitalIntraOralXRayImageStorageForPresentation,Be.Z.DigitalIntraOralXRayImageStorageForProcessing,Be.Z.CTImageStorage,Be.Z.EnhancedCTImageStorage,Be.Z.LegacyConvertedEnhancedCTImageStorage,Be.Z.UltrasoundMultiframeImageStorage,Be.Z.MRImageStorage,Be.Z.EnhancedMRImageStorage,Be.Z.EnhancedMRColorImageStorage,Be.Z.LegacyConvertedEnhancedMRImageStorage,Be.Z.UltrasoundImageStorage,Be.Z.UltrasoundImageStorageRET,Be.Z.SecondaryCaptureImageStorage,Be.Z.MultiframeSingleBitSecondaryCaptureImageStorage,Be.Z.MultiframeGrayscaleByteSecondaryCaptureImageStorage,Be.Z.MultiframeGrayscaleWordSecondaryCaptureImageStorage,Be.Z.MultiframeTrueColorSecondaryCaptureImageStorage,Be.Z.XRayAngiographicImageStorage,Be.Z.EnhancedXAImageStorage,Be.Z.XRayRadiofluoroscopicImageStorage,Be.Z.EnhancedXRFImageStorage,Be.Z.XRay3DAngiographicImageStorage,Be.Z.XRay3DCraniofacialImageStorage,Be.Z.BreastTomosynthesisImageStorage,Be.Z.BreastProjectionXRayImageStorageForPresentation,Be.Z.BreastProjectionXRayImageStorageForProcessing,Be.Z.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,Be.Z.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,Be.Z.NuclearMedicineImageStorage,Be.Z.VLEndoscopicImageStorage,Be.Z.VideoEndoscopicImageStorage,Be.Z.VLMicroscopicImageStorage,Be.Z.VideoMicroscopicImageStorage,Be.Z.VLSlideCoordinatesMicroscopicImageStorage,Be.Z.VLPhotographicImageStorage,Be.Z.VideoPhotographicImageStorage,Be.Z.OphthalmicPhotography8BitImageStorage,Be.Z.OphthalmicPhotography16BitImageStorage,Be.Z.OphthalmicTomographyImageStorage,Be.Z.VLWholeSlideMicroscopyImageStorage,Be.Z.PositronEmissionTomographyImageStorage,Be.Z.EnhancedPETImageStorage,Be.Z.LegacyConvertedEnhancedPETImageStorage,Be.Z.RTImageStorage,Be.Z.EnhancedUSVolumeStorage];const lt=function(){return[{name:nt,sopClassUids:ct,getDisplaySetsFromSeries:ot},{name:"not-supported-display-sets-handler",sopClassUids:[],getDisplaySetsFromSeries:at}]};function ut(){return Q.createElement("span",{className:"border-common-dark mx-2 h-8 w-4 self-center border-l"})}function dt(){return dt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},dt.apply(this,arguments)}function mt(e){let{rows:t,columns:a,className:n,onSelection:s,...r}=e;const[i,o]=(0,Q.useState)(!1),c=()=>{i&&o(!1)};(0,Q.useEffect)((()=>(window.addEventListener("click",c),()=>{window.removeEventListener("click",c)})),[i]);const l=i?ae.OF:null;return Q.createElement(ae.hA,{id:"Layout",label:"Grid Layout",icon:"tool-layout",onInteraction:()=>o(!i),className:n,rounded:r.rounded,dropdownContent:null!==l&&Q.createElement(l,{rows:t,columns:a,onSelection:s}),isActive:i,type:"toggle"})}mt.propTypes={rows:te().number,columns:te().number,onLayoutChange:te().func,servicesManager:te().instanceOf(i.Xw)},mt.defaultProps={rows:3,columns:3,onLayoutChange:()=>{}};const pt=function(e){let{servicesManager:t,...a}=e;const{toolbarService:n}=t.services,s=(0,Q.useCallback)((e=>{n.recordInteraction({interactionType:"action",commands:[{commandName:"setViewportGridLayout",commandOptions:{...e},context:"DEFAULT"}]})}),[n]);return Q.createElement(mt,dt({},a,{onSelection:s}))};function gt(){return gt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},gt.apply(this,arguments)}function ft(e){let{isRadio:t,isAction:a,groupId:n,primary:s,secondary:r,items:i,renderer:o,onInteraction:c,servicesManager:l}=e;const{toolbarService:u}=l?.services,d=(e,s)=>{const{id:r,type:o,commands:l}=e;c({groupId:n,itemId:r,interactionType:o,commands:l}),I((n=>({...n,primary:!a&&t?{...e,index:s}:n.primary,isExpanded:!1,items:m(i).filter((e=>!(t&&!a)||e.index!==s))})))},m=e=>e.map(((e,t)=>({...e,index:t,onClick:()=>d(e,t)}))),[p,g]=(0,Q.useState)({primaryToolId:"",toggles:{},groups:{}}),[f,I]=(0,Q.useState)({primary:s,items:m(i).filter((e=>!(t&&!a)||e.id!==s.id))}),{primaryToolId:y,toggles:S}=p,h="toggle"===f.primary.type,v="tool"===f.primary.type&&y===f.primary.id||h&&!0===S[f.primary.id],D=u?.getButtonComponentForUIType(f.primary.uiType)??ae.hA;(0,Q.useEffect)((()=>{const{unsubscribe:e}=u.subscribe(u.EVENTS.TOOL_BAR_STATE_MODIFIED,(e=>{g({...e})}));return()=>{e()}}),[u]);const w=f.items.map((e=>{const t="tool"===e.type&&y===e.id;return{...e,isActive:t}})),b=o||(e=>{let{type:t,icon:a,label:n,t:s,id:r}=e;const i="toggle"===t&&!0===S[r];return Q.createElement("div",{className:le()("hover:bg-primary-dark flex h-8 w-full flex-row items-center p-3","whitespace-pre text-base",i&&"bg-primary-dark",i?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},a&&Q.createElement("span",{className:"mr-4"},Q.createElement(ae.JO,{name:a,className:"h-5 w-5"})),Q.createElement("span",{className:"mr-5"},s(n)))});return Q.createElement(ae.aW,{isRadio:t,isAction:a,primary:f.primary,secondary:r,items:w,groupId:n,renderer:b,isActive:v||w.some((e=>e.isActive)),isToggle:h,onInteraction:c,Component:e=>Q.createElement(D,gt({},e,{servicesManager:l}))})}ft.propTypes={isRadio:te().bool,isAction:te().bool,groupId:te().string,primary:te().shape({id:te().string.isRequired,type:te().oneOf(["tool","action","toggle"]).isRequired,uiType:te().string}),secondary:te().shape({id:te().string,icon:te().string.isRequired,label:te().string,tooltip:te().string.isRequired,isActive:te().bool}),items:te().arrayOf(te().shape({id:te().string.isRequired,type:te().oneOf(["tool","action","toggle"]).isRequired,icon:te().string,label:te().string,tooltip:te().string})),renderer:te().func,onInteraction:te().func.isRequired,servicesManager:te().shape({services:te().shape({toolbarService:te().object})})},ft.defaultProps={isRadio:!1,isAction:!1};const It=ft;function yt(){return yt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},yt.apply(this,arguments)}function St(e){let{id:t,type:a,commands:n,onInteraction:s,servicesManager:r,...i}=e;const{toolbarService:o}=r?.services||{},[c,l]=(0,Q.useState)({primaryToolId:"",toggles:{},groups:{}}),{primaryToolId:u}=c,d="tool"===a&&t===u||"toggle"===a&&!0===c.toggles[t];return(0,Q.useEffect)((()=>{const{unsubscribe:e}=o.subscribe(o.EVENTS.TOOL_BAR_STATE_MODIFIED,(e=>{l({...e})}));return()=>{e()}}),[o]),Q.createElement(ae.hA,yt({commands:n,id:t,type:a,isActive:d,onInteraction:s},i))}St.propTypes={id:te().string.isRequired,type:te().oneOf(["tool","action","toggle"]).isRequired,commands:te().arrayOf(te().shape({commandName:te().string.isRequired,context:te().string})),onInteraction:te().func.isRequired,servicesManager:te().shape({services:te().shape({toolbarService:te().shape({subscribe:te().func.isRequired,state:te().shape({primaryToolId:te().string,toggles:te().objectOf(te().bool),groups:te().objectOf(te().object)}).isRequired}).isRequired}).isRequired}).isRequired};const ht=St;function vt(e,t,a,n){const s={selectorProps:e,event:t},r=function(e,t,a){const{subMenu:n}=t,s=function*(){yield function(e,t){if(t)return e.find((e=>e.id===t))}(e,a||n),yield function(e,t){return e?e.find((e=>!e.selector||e.selector(t.selectorProps))):null}(e,t)}();let r=s.next(),i=r.value;for(;!r.done;)i=r.value,i&&s.return(),r=s.next();return console.log("Menu chosen",i?.id||"NONE"),i}(a,s,n);if(!r)return;if(!r.items)return console.warn("Must define items in menu",r),[];let i=[];return r.items.forEach((n=>{const{delegating:r,selector:o,subMenu:c}=n;if(!o||o(e))if(r)i=[...i,...vt(e,t,a,c)];else{const e=function(e,t){const a={...e,value:t.selectorProps?.value};"ShowSubMenu"!==e.actionType||a.iconRight||(a.iconRight="chevron-menu");e.action||(a.action=(e,n)=>{const{event:s={}}=n,{detail:r={}}=s;a.element=r.element,n.onClose();const i=n[`on${e.actionType||"Default"}`];i?i.call(n,a,e,t):console.warn("No action defined for",e)});return a}(n,s);i.push(e)}})),i}var Dt=a(5638);class wt{constructor(e,t){this.commandsManager=void 0,this.services=void 0,this.menuItems=void 0,this.services=e.services,this.commandsManager=t}closeContextMenu(){this.services.uiDialogService.dismiss({id:"context-menu"})}showContextMenu(e,t,a){if(!this.services.uiDialogService)return void console.warn("Unable to show dialog; no UI Dialog Service available.");const{event:n,subMenu:s,menuId:r,menus:i,selectorProps:o}=e;console.log("Getting items from",i);const c=vt(o||e,n,i,r);this.services.uiDialogService.dismiss({id:"context-menu"}),this.services.uiDialogService.create({id:"context-menu",isDraggable:!1,preservePosition:!1,preventCutOf:!0,defaultPosition:wt._getDefaultPosition(a,n?.detail,t),event:n,content:Dt.Z,onClickOutside:()=>this.services.uiDialogService.dismiss({id:"context-menu"}),contentProps:{items:c,selectorProps:o,menus:i,event:n,subMenu:s,eventData:n?.detail,onClose:()=>{this.services.uiDialogService.dismiss({id:"context-menu"})},onShowSubMenu:(n,s,r)=>{s.subMenu?this.showContextMenu({...e,menuId:s.subMenu},t,a):console.warn("No submenu defined for",n,s,r)},onDefault:(e,t,a)=>{this.commandsManager.run(e,{...o,...t,subProps:a})}}})}}wt.getDefaultPosition=()=>({x:0,y:0}),wt._getEventDefaultPosition=e=>({x:e&&e.currentPoints.client[0],y:e&&e.currentPoints.client[1]}),wt._getElementDefaultPosition=e=>{if(e){const t=e.getBoundingClientRect();return{x:t.x,y:t.y}}return{x:void 0,y:void 0}},wt._getCanvasPointsPosition=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;const a=wt._getElementDefaultPosition(t);for(let t=0;t<e.length;t++){const n={x:e[t][0]||e[t].x,y:e[t][1]||e[t].y};if(wt._isValidPosition(n)&&wt._isValidPosition(a))return{x:n.x+a.x,y:n.y+a.y}}},wt._isValidPosition=e=>e&&"number"==typeof e.x&&"number"==typeof e.y,wt._getDefaultPosition=(e,t,a)=>{const n=function*(){yield wt._getCanvasPointsPosition(e,a),yield wt._getEventDefaultPosition(t),yield wt._getElementDefaultPosition(a),yield wt.getDefaultPosition()}();let s=n.next(),r=s.value;for(;!s.done;)r=s.value,wt._isValidPosition(r)&&n.return(),s=n.next();return r};const bt={id:"measurementsContextMenu",customizationType:"ohif.contextMenu",menus:[{id:"forExistingMeasurement",selector:e=>{let{nearbyToolData:t}=e;return!!t},items:[{label:"Delete measurement",commands:[{commandName:"deleteMeasurement"}]},{label:"Add Label",commands:[{commandName:"setMeasurementLabel"}]}]}]};var Et=a(71271),Mt=a.n(Et),Ut=a(94614);const xt={padding:"10px 0"},Rt={borderBottomWidth:"1px",...xt};function Ct(e){let{tagRef:t,vrRef:a,keywordRef:n,valueRef:s}=e;return Q.createElement("div",{className:le()("bg-secondary-dark ohif-scrollbar flex w-full flex-row overflow-y-scroll"),style:xt},Q.createElement("div",{className:"w-4/24 px-3"},Q.createElement("label",{ref:t,className:"flex flex-1 select-none flex-col pl-1 text-lg text-white"},Q.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Tag"))),Q.createElement("div",{className:"w-2/24 px-3"},Q.createElement("label",{ref:a,className:"flex flex-1 select-none flex-col pl-1 text-lg text-white"},Q.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"VR"))),Q.createElement("div",{className:"w-6/24 px-3"},Q.createElement("label",{ref:n,className:"flex flex-1 select-none flex-col pl-1 text-lg text-white"},Q.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Keyword"))),Q.createElement("div",{className:"w-5/24 grow px-3"},Q.createElement("label",{ref:s,className:"flex flex-1 select-none flex-col pl-1 text-lg text-white"},Q.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Value"))))}const Nt=function(e){let{rows:t}=e;const a=(0,Q.useRef)(),n=(0,Q.useRef)(),[s,r]=(0,Q.useState)(null),[i,o]=(0,Q.useState)(null),[c,l]=(0,Q.useState)(null),[u,d]=(0,Q.useState)(null);(0,Q.useEffect)((()=>{a?.current&&(a.current.scrollTo(0),a.current.resetAfterIndex(0))}),[t]),(0,Q.useEffect)((()=>{const e=Oe()((()=>a.current.resetAfterIndex(0)),100);return window.addEventListener("resize",e),()=>{e.cancel(),window.removeEventListener("resize",e)}}),[]);const m=(0,Q.useCallback)((e=>{let{index:a,style:n}=e;const s=t[a];return Q.createElement("div",{style:{...n,...Rt},className:le()("hover:bg-secondary-main border-secondary-light flex w-full flex-row items-center break-all bg-black text-base transition duration-300","leading-[20px]"),key:`DICOMTagRow-${a}`},Q.createElement("div",{className:"w-4/24 px-3"},s[0]),Q.createElement("div",{className:"w-2/24 px-3"},s[1]),Q.createElement("div",{className:"w-6/24 px-3"},s[2]),Q.createElement("div",{className:"w-5/24 grow px-3"},s[3]))}),[t]),p=(0,Q.useCallback)((()=>null!==s),[s]),g=(0,Q.useCallback)((e=>{const a=[s.offsetWidth,i.offsetWidth,c.offsetWidth,u.offsetWidth],r=n.current.getContext("2d");return r.font=getComputedStyle(n.current).font,t[e].map(((e,t)=>{const n=r.measureText(e).width;return 20*Math.ceil(n/a[t])+20+1})).reduce(((e,t)=>Math.max(e,t)))}),[t,c,s,u,i]);return Q.createElement("div",null,Q.createElement("canvas",{style:{visibility:"hidden",position:"absolute"},className:"text-base",ref:n}),Q.createElement(Ct,{tagRef:e=>{e&&r(e)},vrRef:e=>{e&&o(e)},keywordRef:e=>{e&&l(e)},valueRef:e=>{e&&d(e)}}),Q.createElement("div",{className:"relative m-auto border-2 border-black bg-black",style:{height:"32rem"}},p()&&Q.createElement(Ut.S_,{ref:a,height:500,itemCount:t.length,itemSize:g,width:"100%",className:"ohif-scrollbar"},m)))},{ImageSet:Pt}=i.classes,{DicomMetaDictionary:Tt}=f.default.data,{nameMap:Ot}=Tt;function At(e,t){const a=[];return e.forEach((e=>{if("SQ"===e.vr){a.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,""]);const{values:n}=e;n.forEach(((e,n)=>{const s=At(e,t);a.push([`${e[0].tagIndent}(FFFE,E000)`,"",`Item #${n}`,""]),a.push(...s)}))}else{if("xs"===e.vr)try{const a=f.default.data.Tag.fromPString(e.tag).toCleanString(),n=t[a];e.vr=n.vr}catch(t){console.error(`Failed to parse value representation for tag '${e.keyword}'`)}a.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,e.value])}})),a}function Lt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const a=Object.keys(e);let n="";for(let e=0;e<t;e++)n+=">";t>0&&(n+=" ");const s=[];for(let i=0;i<a.length;i++){let o=a[i];if("_vrMap"===o)continue;const c=Ot[o];let l=e[o];if(c&&"SQ"===c.vr){const e=(r=l,Array.isArray(r)?r:[r]),a={tag:c.tag,tagIndent:n,vr:c.vr,keyword:o,values:[]};if(s.push(a),null===l)continue;e.forEach((e=>{const n=Lt(e,t+1);n.length&&(kt(n),a.values.push(n))}))}else if(Array.isArray(l)&&l.length>0&&"object"!=typeof l[0]&&(l=l.join("\\")),"number"==typeof l&&(l=l.toString()),"string"!=typeof l&&(null===l?l=" ":"object"==typeof l?l.InlineBinary?l="Inline Binary":l.BulkDataURI?l="Bulk Data URI":l.Alphabetic?l=l.Alphabetic:(console.warn(`Unrecognised Value: ${l} for ${o}:`),console.warn(l),l=" "):(console.warn(`Unrecognised Value: ${l} for ${o}:`),l=" ")),o=o.replace("RETIRED_",""),c)s.push({tag:c.tag,tagIndent:n,vr:c.vr,keyword:o,value:l});else{const e=/[0-9A-Fa-f]{6}/g;if(o.match(e)){const e=`(${o.substring(0,4)},${o.substring(4,8)})`;s.push({tag:e,tagIndent:n,vr:"",keyword:"Private Tag",value:l})}}}var r;return s}function kt(e){e.sort(((e,t)=>e.tag<t.tag?-1:1))}const Ft=e=>{let{displaySets:t,displaySetInstanceUID:a}=e;const n=new Set([1]),[s,r]=(0,Q.useState)(a),[i,o]=(0,Q.useState)(1),[c,l]=(0,Q.useState)(""),u=t.find((e=>e.displaySetInstanceUID===s)),d=u instanceof Pt;const m=d&&u.images.length>1,p=(0,Q.useMemo)((()=>(t.sort(((e,t)=>e.SeriesNumber-t.SeriesNumber)),t.map((e=>{const{displaySetInstanceUID:t,SeriesDate:a,SeriesTime:n,SeriesNumber:s,SeriesDescription:r,Modality:i}=e,o=`${a}:${n}`.split(".")[0];return{value:t,label:`${s} (${i}): ${r}`,description:Mt()(o,"YYYYMMDD:HHmmss").format("ddd, MMM Do YYYY")}})))),[t]),g=(0,Q.useMemo)((()=>{let e;e=d?u.images[i-1]:u.instance||u;const t=function(e){const t=Lt(e);return kt(t),t}(e);return At(t,e)}),[i,s]),f=(0,Q.useMemo)((()=>{if(!c)return g;const e=c.toLowerCase();return g.filter((t=>t.reduce(((t,a,s)=>t||(n.has(s)?t:t||a.toLowerCase().includes(e))),!1)))}),[g,c]),I=(0,Q.useMemo)((()=>Oe()(l,200)),[]);return(0,Q.useEffect)((()=>()=>{I?.cancel()}),[]),Q.createElement("div",{className:"dicom-tag-browser-content"},Q.createElement("div",{className:"mb-6 flex flex-row items-center pl-1"},Q.createElement("div",{className:"flex w-1/2 flex-row items-center"},Q.createElement(ae.ZT,{variant:"subtitle",className:"mr-4"},"Series"),Q.createElement("div",{className:"mr-8 grow"},Q.createElement(ae.Ph,{id:"display-set-selector",isClearable:!1,onChange:e=>{r(e.value),o(1)},options:p,value:p.find((e=>e.value===s)),className:"text-white"}))),Q.createElement("div",{className:"flex w-1/2 flex-row items-center"},m&&Q.createElement(ae.ZT,{variant:"subtitle",className:"mr-4"},"Instance Number"),m&&Q.createElement("div",{className:"grow"},Q.createElement(ae.OX,{value:i,key:s,onChange:e=>{o(parseInt(e))},minValue:1,maxValue:u.images.length,step:1,inputClassName:"w-full",labelPosition:"left",trackColor:"#3a3f99"})))),Q.createElement("div",{className:"h-1 w-full bg-black"}),Q.createElement("div",{className:"my-3 flex w-1/2 flex-row"},Q.createElement(ae.Xe,{className:"mr-8 block w-full",placeholder:"Search metadata...",onDebounceChange:l})),Q.createElement(Nt,{rows:f}))},Vt=(e,t,a)=>{const{activeViewportId:n}=e,{protocol:s}=t.getActiveProtocol(),r=t.getState(),{protocolId:i,stageIndex:o,activeStudyUID:c}=r,l=a.getState(),u={...l.viewportGridStore},d={...l.displaySetSelectorMap},m=s.stages[o],p=`${c}:${i}:${o}`,g=`${c}:${i}`,f={...l.hangingProtocolStageIndexMap},{rows:I,columns:y}=m.viewportStructure.properties,S=m.viewports.length!==e.viewports.size||e.layout.numRows!==I||e.layout.numCols!==y;return f[g]=r,p&&S&&(u[p]={...e}),e.viewports.forEach(((e,t)=>{const{displaySetOptions:a,displaySetInstanceUIDs:s}=e;if(a)for(let e=0;e<a.length;e++){const r=s[e];r&&(t===n&&0===e&&(d[`${c}:activeDisplaySet:0`]=r),a[e]?.id&&(d[`${c}:${a[e].id}:${a[e].matchedDisplaySetsIndex||0}`]=r))}})),{hangingProtocolStageIndexMap:f,viewportGridStore:u,displaySetSelectorMap:d}},$t=(e,t,a,n,s)=>{const r=t?.[n];if(r)return{...r};const{protocolId:i,stageIndex:o}=e.getState();s.inDisplay||(s.inDisplay=[...t.initialInDisplay]);const c=e.getMissingViewport(i,o,s);if(c){const e=c.displaySetsInfo.map((e=>e.displaySetInstanceUID));return s.inDisplay.push(...e),{displaySetInstanceUIDs:e,displaySetOptions:c.displaySetsInfo.map((e=>e.displaySetOptions)),viewportOptions:{...c.viewportOptions}}}return{}},qt=(e,t,a)=>{let{numRows:n,numCols:s}=t;const{viewports:r}=e,i={...a.getState().viewportsByPosition},o=[];r.forEach((e=>{if(e.positionId){const t={...e,viewportOptions:{...e.viewportOptions}};i[e.positionId]=t}}));for(let e=0;e<n;e++)for(let t=0;t<s;t++){const a=i[`${t}-${e}`];a?.displaySetInstanceUIDs&&o.push(...a.displaySetInstanceUIDs)}return i.initialInDisplay=o,{viewportsByPosition:i}};var _t=a(21962);const{subscribeToNextViewportGridChange:jt}=i.utils,Zt=e=>e&&("setHangingProtocol"===e.commandName||"toggleHangingProtocol"===e.commandName),Ht=e=>{let{servicesManager:t,commandsManager:a}=e;const{customizationService:n,measurementService:s,hangingProtocolService:r,uiNotificationService:i,viewportGridService:o,displaySetService:c,stateSyncService:l,toolbarService:u}=t.services,d=new wt(t,a),m={showContextMenu:e=>{const{menuCustomizationId:t,element:a,event:s,selectorProps:i,defaultPointsPosition:o=[]}=e,c={...e};t&&Object.assign(c,n.get(t,bt));const{protocol:l,stage:u}=r.getActiveProtocol();c.selectorProps={event:s,protocol:l,stage:u,...i},d.showContextMenu(c,a,o)},closeContextMenu:()=>{d.closeContextMenu()},displayNotification:e=>{let{text:t,title:a,type:n}=e;i.show({title:a,message:t,type:n})},clearMeasurements:()=>{s.clear()},toggleHpTools:()=>{const{protocol:e,stageIndex:t,stage:a}=r.getActiveProtocol(),n=s=>{if(!s.id)return;const{commands:r,items:i}=s.props||s;i&&i.forEach(n);const o=r?.find?.(Zt);if(!o)return;const{protocolId:c,stageIndex:l,stageId:d}=o.commandOptions,m=!(c&&c!==e.id||void 0!==l&&l!==t||d&&d!==a.id);u.setToggled(s.id,m)};Object.values(u.getButtons()).forEach(n)},setHangingProtocol:e=>{let{activeStudyUID:t="",protocolId:n,stageId:s,stageIndex:c,reset:d=!1}=e;const p=u.getActivePrimaryTool();try{a.run(r.getActiveProtocol().protocol.callbacks?.onLayoutChange);const e=o.getState(),i=r.getState(),{protocol:g}=r.getActiveProtocol(),f=Vt(e,r,l),{hangingProtocolStageIndexMap:I,viewportGridStore:y,displaySetSelectorMap:S}=f;if(n){if(void 0===c&&void 0===s){const e=`${t||i.activeStudyUID}:${n}`;c=I[e]?.stageIndex}}else n=i.protocolId,void 0===s&&void 0===c&&(c=i.stageIndex);const h=c??r.getStageIndex(n,{stageId:s,stageIndex:c});t&&r.setActiveStudyUID(t);const v=`${r.getState().activeStudyUID}:${n}:${h||0}`,D=!d&&y[v];n!==i.protocolId||h!==i.stageIndex||t?(r.setProtocol(n,{displaySetSelectorMap:S,stageId:s,stageIndex:h,restoreProtocol:D}),D&&o.set(y[v])):r.setProtocol(n,{stageId:s,stageIndex:h}),delete S[`${t||i.activeStudyUID}:activeDisplaySet:0`],l.store(f);const{protocol:w}=r.getActiveProtocol();m.toggleHpTools();const b=u.getButton(p);if(b){let e=b.props?.interactionType;if(!e&&b.props?.items){const t=b.props.items[0];e=t.props?.interactionType||t.props?.type}e&&u.recordInteraction({interactionType:e,...b.props})}return n!==i.protocolId&&a.run(g.callbacks?.onProtocolExit),a.run(w.callbacks?.onProtocolEnter),!0}catch(e){return console.error(e),m.toggleHpTools(),i.show({title:"Apply Hanging Protocol",message:"The hanging protocol could not be applied.",type:"error",duration:3e3}),!1}},toggleHangingProtocol:e=>{let{protocolId:t,stageIndex:a}=e;const{protocol:n,stageIndex:s,activeStudy:i}=r.getActiveProtocol(),{toggleHangingProtocol:o}=l.getState(),c=`${i.StudyInstanceUID}:${t}:${0|a}`;if(n.id!==t||void 0!==a&&a!==s)return l.store({toggleHangingProtocol:{...o,[c]:{protocolId:n.id,stageIndex:s}}}),m.setHangingProtocol({protocolId:t,stageIndex:a,reset:!0});{const e=o[c]||{protocolId:"default"};return m.setHangingProtocol(e)}},deltaStage:e=>{let{direction:t}=e;const{protocolId:a,stageIndex:n}=r.getState(),{protocol:s}=r.getActiveProtocol();for(let e=n+t;e>=0&&e<s.stages.length;e+=t)if("disabled"!==s.stages[e].status)return m.setHangingProtocol({protocolId:a,stageIndex:e});i.show({title:"Change Stage",message:"The hanging protocol has no more applicable stages",type:"info",duration:3e3})},setViewportGridLayout:e=>{let{numRows:t,numCols:n}=e;const{protocol:s}=r.getActiveProtocol(),i=s.callbacks?.onLayoutChange;if(!1===a.run(i,{numRows:t,numCols:n}))return void console.log("setViewportGridLayout running",i,t,n);window.setTimeout((()=>{const e=o.getState(),a=qt(e,{numRows:t,numCols:n},l),s=$t.bind(null,r,a.viewportsByPosition);o.setLayout({numRows:t,numCols:n,findOrCreateViewport:s}),l.store(a)}),0)},toggleOneUp(){const e=o.getState(),{activeViewportId:t,viewports:a,layout:n}=e,{displaySetInstanceUIDs:s,displaySetOptions:i,viewportOptions:c}=a.get(t);if(1===n.numCols&&1===n.numRows){const{toggleOneUpViewportGridStore:e}=l.getState();if(!e.layout)return;const t=e.activeViewportId,a=s.length>1?[]:s.map((e=>r.getViewportsRequireUpdate(t,e))).flat(),n=(t,n)=>{const s=Array.from(e.viewports.values()).find((e=>e.positionId===n)),r=a.find((e=>e.viewportId===s.viewportId));return r?{viewportOptions:c,displaySetOptions:i,...r}:s},u=o.getLayoutOptionsFromState(e);o.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportId:t,layoutOptions:u,findOrCreateViewport:n})}else{l.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:s,displaySetOptions:i,viewportOptions:c});o.setLayout({numRows:1,numCols:1,findOrCreateViewport:t});jt(o,(()=>{l.store({toggleOneUpViewportGridStore:{}})}))}},navigateHistory(e){_t.m.navigate(e.to,e.options)},openDICOMTagViewer(){const{activeViewportId:e,viewports:a}=o.getState(),n=a.get(e),{displaySetInstanceUIDs:s}=n,r=c.activeDisplaySets,{UIModalService:i}=t.services,l=s[0];i.show({content:Ft,contentProps:{displaySets:r,displaySetInstanceUID:l,onClose:i.hide},title:"DICOM Tag Browser"})},toggleOverlays:()=>{const e=document.getElementsByClassName("viewport-overlay");for(let t=0;t<e.length;t++)e.item(t).classList.toggle("hidden")},scrollActiveThumbnailIntoView:()=>{const{activeViewportId:e,viewports:t}=o.getState(),a=t.get(e).displaySetInstanceUIDs[0],n=document.querySelector("#ohif-thumbnail-list");if(!n)return;const s=n.getBoundingClientRect(),r=document.querySelector(`#thumbnail-${a}`);if(!r)return;const i=r.getBoundingClientRect();i.top>=s.top&&i.top<=s.bottom||r.scrollIntoView({behavior:"smooth"})},updateViewportDisplaySet:e=>{let{direction:t,excludeNonImageModalities:a}=e;const n=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"],s=r.getDisplaySetSortFunction(),l=[...c.activeDisplaySets];l.sort(s);const{activeViewportId:u,viewports:d}=o.getState(),{displaySetInstanceUIDs:p}=d.get(u);let g;for(g=l.findIndex((e=>p.includes(e.displaySetInstanceUID)))+t;g>-1&&g<l.length&&(a&&n.includes(l[g].Modality));g+=t);if(g<0||g>=l.length)return;const{displaySetInstanceUID:f}=l[g];let I=[];try{I=r.getViewportsRequireUpdate(u,f)}catch(e){console.warn(e),i.show({title:"Navigate Viewport Display Set",message:"The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.",type:"info",duration:3e3})}o.setDisplaySetsForViewports(I),setTimeout((()=>m.scrollActiveThumbnailIntoView()),0)}},p={showContextMenu:{commandFn:m.showContextMenu},closeContextMenu:{commandFn:m.closeContextMenu},clearMeasurements:{commandFn:m.clearMeasurements,storeContexts:[],options:{}},displayNotification:{commandFn:m.displayNotification,storeContexts:[],options:{}},setHangingProtocol:{commandFn:m.setHangingProtocol,storeContexts:[],options:{}},toggleHangingProtocol:{commandFn:m.toggleHangingProtocol,storeContexts:[],options:{}},navigateHistory:{commandFn:m.navigateHistory,storeContexts:[],options:{}},nextStage:{commandFn:m.deltaStage,storeContexts:[],options:{direction:1}},previousStage:{commandFn:m.deltaStage,storeContexts:[],options:{direction:-1}},setViewportGridLayout:{commandFn:m.setViewportGridLayout,storeContexts:[],options:{}},toggleOneUp:{commandFn:m.toggleOneUp,storeContexts:[],options:{}},openDICOMTagViewer:{commandFn:m.openDICOMTagViewer},updateViewportDisplaySet:{commandFn:m.updateViewportDisplaySet,storeContexts:[],options:{}}};return{actions:m,definitions:p,defaultContext:"DEFAULT"}},Bt={id:"@ohif/mnGrid",description:"Has various hanging protocol grid layouts",name:"2x2",protocolMatchingRules:[{id:"OneOrMoreSeries",weight:25,attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}},required:!0},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{id:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]}]},{id:"3x1",requiredViewports:1,preferredViewports:3,stageActivation:{enabled:{minViewportsMatched:3}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:1}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:2}]}]},{id:"2x1",requiredViewports:1,preferredViewports:2,stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]}]},{id:"1x1",requiredViewports:1,preferredViewports:1,stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]}]}],numberOfPriorsReferenced:-1},Gt={id:"defaultDisplaySetId"},zt={id:"priorDisplaySetId"},Wt={viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[Gt]},Yt={...Wt,displaySets:[{...Gt,matchedDisplaySetsIndex:1}]},Xt={...Wt,displaySets:[zt]},Jt={id:"@ohif/hpCompare",description:"Compare two studies in various layouts",name:"Compare Two Studies",numberOfPriorsReferenced:1,protocolMatchingRules:[{id:"Two Studies",weight:1e3,attribute:"StudyInstanceUID",from:"prior",required:!0,constraint:{notNull:!0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{studyMatchingRules:[{attribute:"studyInstanceUIDsIndex",from:"options",required:!0,constraint:{equals:{value:0}}}],seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]},priorDisplaySetId:{studyMatchingRules:[{attribute:"studyInstanceUIDsIndex",from:"options",required:!0,constraint:{equals:{value:1}}}],seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{name:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[Wt,Xt,Yt,{...Xt,displaySets:[{...zt,matchedDisplaySetsIndex:1}]}]},{name:"2x1",stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[Wt,Xt]}]},Kt={id:"default",locked:!0,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2023-04-01",availableTo:{},editableBy:{},protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{viewportType:"stack",viewportId:"default",toolGroupId:"default",initialImageOptions:{custom:"sopInstanceLocation"}},displaySets:[{id:"defaultDisplaySetId"}]}],createdDate:"2021-02-23T18:32:42.850Z"}]};const Qt=function(){return[{name:Kt.id,protocol:Kt},{name:Bt.id,protocol:Bt},{name:Jt.id,protocol:Jt}]};const ea=function(){const[e]=(0,ne.M)(),t=(0,se.s0)(),a=e.dataSources;return Q.createElement("div",{style:{width:"100%",height:"100%"}},Q.createElement("div",{className:"flex h-screen w-screen items-center justify-center "},Q.createElement("div",{className:"bg-secondary-dark mx-auto space-y-2 rounded-lg py-8 px-8 drop-shadow-md"},Q.createElement("img",{className:"mx-auto block h-14",src:"./ohif-logo.svg",alt:"OHIF"}),Q.createElement("div",{className:"space-y-2 pt-4 text-center"},a.filter((e=>"dicomjson"!==e.sourceName&&"dicomlocal"!==e.sourceName)).map((e=>Q.createElement("div",{key:e.sourceName},Q.createElement("h1",{className:"text-white"},e.configuration?.friendlyName||e.friendlyName),Q.createElement(ae.zx,{type:ae.LZ.dt.primary,className:le()("ml-2"),onClick:()=>{t({pathname:"/",search:`datasources=${e.sourceName}`})}},e.sourceName),Q.createElement("br",null))))))))};const ta=function(e){let{itemLabel:t,itemList:a,onItemClicked:n}=e;const{t:s}=(0,re.$G)("DataSourceConfiguration"),[r,i]=(0,Q.useState)("");return(0,Q.useEffect)((()=>{i("")}),[a]),Q.createElement("div",{className:"flex min-h-[1px] grow flex-col gap-4"},Q.createElement("div",{className:"flex items-center justify-between"},Q.createElement("div",{className:"text-primary-light text-[20px]"},s(`Select ${t}`)),Q.createElement(ae.Xe,{className:"max-w-[40%] grow",value:r,onDebounceChange:i,placeholder:s(`Search ${t} list`)})),Q.createElement("div",{className:"relative flex min-h-[1px] grow flex-col bg-black text-[14px]"},null==a?Q.createElement(ae.LE,{className:"h-full w-full"}):0===a.length?Q.createElement("div",{className:"text-primary-light flex h-full flex-col items-center justify-center px-6 py-4"},Q.createElement(ae.JO,{name:"magnifier",className:"mb-4"}),Q.createElement("span",null,s(`No ${t} available`))):Q.createElement(Q.Fragment,null,Q.createElement("div",{className:"bg-secondary-dark px-3 py-1.5 text-white"},s(t)),Q.createElement("div",{className:"ohif-scrollbar overflow-auto"},a.filter((e=>!r||e.name.toLowerCase().includes(r.toLowerCase()))).map((e=>Q.createElement("div",{className:le()("hover:text-primary-light hover:bg-primary-dark group mx-2 flex items-center justify-between px-6 py-2","rounded border-transparent border-b-secondary-light border-[1px] hover:border-primary-light"),key:e.id},Q.createElement("div",null,e.name),Q.createElement(ae.zx,{onClick:()=>n(e),className:"invisible group-hover:visible",endIcon:Q.createElement(ae.JO,{name:"arrow-left"})},s("Select")))))))))},aa="text-ellipsis whitespace-nowrap overflow-hidden";const na=function(e){let{configurationAPI:t,configuredItems:a,onHide:n}=e;const{t:s}=(0,re.$G)("DataSourceConfiguration"),[r,i]=(0,Q.useState)(),[o,c]=(0,Q.useState)(a),[l,u]=(0,Q.useState)(),[d]=(0,Q.useState)(t.getItemLabels()),[m,p]=(0,Q.useState)(d.length===a.length),g=m?o.length-2:o.length-1;(0,Q.useEffect)((()=>{let e=!0;return u(null),i(null),0===o.length?t.initialize().then((t=>{e&&i(t)})).catch((e=>u(e.message))):m||o.length!==d.length?t.setCurrentItem(o[g]).then((t=>{e&&i(t)})).catch((e=>u(e.message))):(t.setCurrentItem(o[o.length-1]),n()),()=>{e=!1}}),[o,t,n,d,m,g]);const f=e=>e<o.length?le()("bg-black/[.4]",e!==d.length-1?"hover:bg-transparent active:bg-secondary-dark":""):"bg-transparent",I=e=>e===g+1?le()("border-2","border-solid","border-primary-light"):e<o.length?"border border-solid border-primary-active hover:border-primary-light active:border-white":"border border-dashed border-secondary-light",y=e=>e<=o.length?"text-primary-light":"text-primary-active";return Q.createElement("div",{className:"flex h-[calc(100vh-300px)] select-none flex-col gap-4 pt-0.5"},Q.createElement("div",{className:"flex gap-4"},d.map(((e,t)=>{return Q.createElement("div",{key:e,className:le()("flex min-w-[1px] shrink basis-[200px] flex-col gap-1 rounded-md p-3.5",(a=t,a!==d.length-1&&a<o.length?"cursor-pointer":"cursor-auto"),f(t),I(t),y(t)),onClick:m&&t<g||t<=g?()=>{p(!1),c((e=>e.slice(0,t)))}:void 0},Q.createElement("div",{className:"text- flex items-center gap-2"},t<o.length?Q.createElement(ae.JO,{name:"status-tracked"}):Q.createElement(ae.JO,{name:"status-untracked"}),Q.createElement("div",{className:le()(aa)},s(e))),t<o.length?Q.createElement("div",{className:le()("text-[14px] text-white",aa)},o[t].name):Q.createElement("br",null));var a}))),Q.createElement("div",{className:"h-0.5 w-full shrink-0 bg-black"}),l?Q.createElement("div",{className:"flex min-h-[1px] grow flex-col gap-4"},Q.createElement("div",{className:"text-primary-light text-[20px]"},s(`Error fetching ${d[o.length]} list`)),Q.createElement("div",{className:"grow bg-black p-4 text-[14px]"},l)):Q.createElement(ta,{itemLabel:d[g+1],itemList:r,onItemClicked:e=>{p(!1),c((t=>[...t.slice(0,g+1),e]))}}))};const sa=function(e){let{servicesManager:t,extensionManager:a}=e;const{t:n}=(0,re.$G)("DataSourceConfiguration"),{show:s,hide:r}=(0,ae.dd)(),{customizationService:i}=t.services,[o,c]=(0,Q.useState)(),[l,u]=(0,Q.useState)();(0,Q.useEffect)((()=>{let e=!0;const t=async()=>{const t=a.getActiveDataSourceDefinition();if(!t.configuration.configurationAPI)return;const{factory:n}=i.get(t.configuration.configurationAPI)??{};if(!n)return;const s=n(t.sourceName);c(s),u(null),s.getConfiguredItems().then((t=>{e&&u(t)}))},n=a.subscribe(a.EVENTS.ACTIVE_DATA_SOURCE_CHANGED,t);return t(),()=>{e=!1,n.unsubscribe()}}),[]);const d=(0,Q.useCallback)((()=>{s({content:na,title:n("Configure Data Source"),contentProps:{configurationAPI:o,configuredItems:l,onHide:r}})}),[o,l]);return(0,Q.useEffect)((()=>{o&&l&&l.length!==o.getItemLabels().length&&d()}),[o,l,d]),l?Q.createElement("div",{className:"text-aqua-pale flex items-center overflow-hidden"},Q.createElement(ae.JO,{name:"settings",className:"mr-2.5 h-3.5 w-3.5 shrink-0 cursor-pointer",onClick:d}),l.map(((e,t)=>Q.createElement("div",{key:t,className:"flex overflow-hidden"},Q.createElement("div",{key:t,className:"overflow-hidden text-ellipsis whitespace-nowrap"},e.name),t!==l.length-1&&Q.createElement("div",{className:"px-2.5"},"|"))))):Q.createElement(Q.Fragment,null)};var ra=function(e){return e[e.projects=0]="projects",e[e.locations=1]="locations",e[e.datasets=2]="datasets",e[e.dicomStores=3]="dicomStores",e}(ra||{});const ia="https://cloudresourcemanager.googleapis.com/v1",oa="https://healthcare.googleapis.com/v1";class ca{constructor(e,t,a){this._extensionManager=void 0,this._fetchOptions=void 0,this._dataSourceName=void 0,this.getItemLabels=()=>["Project","Location","Data set","DICOM store"],this._dataSourceName=e,this._extensionManager=a;const n=t.services.userAuthenticationService;this._fetchOptions={method:"GET",headers:n.getAuthorizationHeader()}}async initialize(){const e=`${ia}/projects`,t=await ca._doFetch(e,ra.projects,this._fetchOptions);if(!t?.length)return[];return t.map((e=>({id:e.projectId,name:e.name,itemType:ra.projects,url:`${oa}/projects/${e.projectId}`})))}async setCurrentItem(e){const t=e;if(t.itemType===ra.dicomStores){const e=`${t.url}/dicomWeb`,a=JSON.parse(JSON.stringify(this._extensionManager.getDataSourceDefinition(this._dataSourceName)));return a.configuration={...a.configuration,wadoUriRoot:e,qidoRoot:e,wadoRoot:e},this._extensionManager.updateDataSourceConfiguration(a.sourceName,a.configuration),[]}const a=t.itemType+1,n=`${ra[a]}`,s=`${t.url}/${n}`,r=await ca._doFetch(s,a,this._fetchOptions);if(!r?.length)return[];return r.map((e=>{const t=e.name.split("/");return{id:e.name,name:t[t.length-1],itemType:a,url:`${oa}/${e.name}`}}))}async getConfiguredItems(){const e=this._extensionManager.getDataSourceDefinition(this._dataSourceName).configuration.wadoUriRoot,t=e.indexOf("projects"),a=e.substring(t).split("/"),n=[];for(let e=0;e<4&&2*(e+1)<a.length;e+=1)if(e===ra.projects){const t=a[1],s=`${ia}/projects/${t}`,r=(await ca._doFetch(s,ra.projects,this._fetchOptions))[0];n.push({id:r.projectId,name:r.name,itemType:e,url:`${oa}/projects/${r.projectId}`})}else{const t=a.slice(0,2*e+2).join("/");n.push({id:t,name:a[2*e+1],itemType:e,url:`${oa}/${t}`})}return n}static async _doFetch(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};try{const s=new URL(e);s.search=new URLSearchParams(n).toString();const r=await fetch(s,a),i=await r.json();if(r.status>=200&&r.status<300&&null!=i){if(null!=i.nextPageToken){n.pageToken=i.nextPageToken;const s=await this._doFetch(e,t,a,n);i[ra[t]]=i[ra[t]].concat(s)}return i[ra[t]]?i[ra[t]]:i.name?[i]:[]}{const e=i?.error?.message||`Error returned from Google Cloud Healthcare: ${r.status} - ${r.statusText}`;throw new Error(e)}}catch(e){throw new Error(e?.message||"Error occurred during fetch request.")}}}var la=a(15747);const ua=i.ZP.classes.MetadataProvider;const da=i.classes.MetadataProvider;const ma=e=>{let{SeriesInstanceUID:t,StudyInstanceUID:a}=e;const{instances:n}=i.DicomMetadataStore.getSeries(a,t);if("PT"!==n[0].Modality)return;const s=n.map((e=>e.imageId)),r=[];if(s.forEach((e=>{const t=function(e){const t=ua.get("instance",e);if(!t)throw new Error("dicom metadata are required");if(void 0===t.SeriesDate||void 0===t.SeriesTime||void 0===t.CorrectedImage||void 0===t.Units||!t.RadiopharmaceuticalInformationSequence||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose||void 0===t.DecayCorrection||void 0===t.AcquisitionDate||void 0===t.AcquisitionTime||void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime&&void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime)throw new Error("required metadata are missing");void 0===t.PatientWeight&&console.warn("PatientWeight missing from PT instance metadata");const a={CorrectedImage:t.CorrectedImage,Units:t.Units,RadionuclideHalfLife:t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadionuclideTotalDose:t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadiopharmaceuticalStartDateTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime,RadiopharmaceuticalStartTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,DecayCorrection:t.DecayCorrection,PatientWeight:t.PatientWeight,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,AcquisitionDate:t.AcquisitionDate,AcquisitionTime:t.AcquisitionTime};if(t[70531e3]||void 0!==t[70531e3]||t[70531009]||void 0!==t[70531009]){const e={SUVScaleFactor:t[70531e3],ActivityConcentrationScaleFactor:t[70531009]};a.PhilipsPETPrivateGroup=e}return t["0009100d"]&&void 0!==t["0009100d"]&&(a.GEPrivatePostInjectionDateTime=t["0009100d"]),t.FrameReferenceTime&&void 0!==t.FrameReferenceTime&&(a.FrameReferenceTime=t.FrameReferenceTime),t.ActualFrameDuration&&void 0!==t.ActualFrameDuration&&(a.ActualFrameDuration=t.ActualFrameDuration),t.PatientSex&&void 0!==t.PatientSex&&(a.PatientSex=t.PatientSex),t.PatientSize&&void 0!==t.PatientSize&&(a.PatientSize=t.PatientSize),a}(e);t&&r.push(t)})),!r.length)return;let o;try{o=(0,la.d)(r)}catch(e){console.log(e)}o&&r.forEach(((e,t)=>{da.addCustomMetadata(s[t],"scalingModule",o[t])}))},pa={id:We,preRegistration:function(e){let{servicesManager:t,configuration:a={}}=e;const{stateSyncService:n}=t.services;i.DicomMetadataStore.subscribe(i.DicomMetadataStore.EVENTS.INSTANCES_ADDED,ma),i.DicomMetadataStore.subscribe(i.DicomMetadataStore.EVENTS.SERIES_UPDATED,ma),n.register("viewportGridStore",{clearOnModeExit:!0}),n.register("displaySetSelectorMap",{clearOnModeExit:!0}),n.register("hangingProtocolStageIndexMap",{clearOnModeExit:!0}),n.register("toggleHangingProtocol",{clearOnModeExit:!0}),n.register("viewportsByPosition",{clearOnModeExit:!0}),n.register("rapidIconState",{clearOnModeExit:!0})},getDataSourcesModule:K,getLayoutTemplateModule:function(e){let{servicesManager:t,extensionManager:a,commandsManager:n,hotkeysManager:s}=e;return[{name:"viewerLayout",id:"viewerLayout",component:function(e){return Se({servicesManager:t,extensionManager:a,commandsManager:n,hotkeysManager:s,...e})}}]},getPanelModule:Ze,getHangingProtocolModule:Qt,getSopClassHandlerModule:lt,getToolbarModule:function(e){let{commandsManager:t,servicesManager:a}=e;return[{name:"ohif.divider",defaultComponent:ut,clickHandler:()=>{}},{name:"ohif.action",defaultComponent:ht,clickHandler:()=>{}},{name:"ohif.radioGroup",defaultComponent:ht,clickHandler:()=>{}},{name:"ohif.splitButton",defaultComponent:It,clickHandler:()=>{}},{name:"ohif.layoutSelector",defaultComponent:pt,clickHandler:(e,t,a)=>{}},{name:"ohif.toggle",defaultComponent:ht,clickHandler:()=>{}}]},getCommandsModule:Ht,getUtilityModule(e){let{servicesManager:t}=e;return[{name:"common",exports:{getStudiesForPatientByMRN:Ue}}]},getCustomizationModule:function(e){let{servicesManager:t,extensionManager:a}=e;return[{name:"helloPage",value:{id:"customRoutes",routes:[{path:"/custom",children:()=>Q.createElement("h1",{style:{color:"white"}},"Hello Custom Route")}]}},{name:"datasources",value:{id:"customRoutes",routes:[{path:"/datasources",children:ea}]}},{name:"default",value:[{id:"ohif.overlayItem",content:function(e){if(this.condition&&!this.condition(e))return null;const{instance:t}=e,a=t&&this.attribute?t[this.attribute]:this.contentF&&"function"==typeof this.contentF?this.contentF(e):null;return a?Q.createElement("span",{className:"overlay-item flex flex-row",style:{color:this.color||void 0},title:this.title||""},this.label&&Q.createElement("span",{className:"mr-1 shrink-0"},this.label),Q.createElement("span",{className:"font-light"},a)):null}},{id:"ohif.contextMenu",transform:function(e){const t={...this};t.menus=this.menus.map((e=>({...e})));for(const a of t.menus){const{items:t}=a;a.items=[];for(const n of t)a.items.push(e.transform(n))}return t}},{id:"ohif.dataSourceConfigurationComponent",component:sa.bind(null,{servicesManager:t,extensionManager:a})},{id:"ohif.dataSourceConfigurationAPI.google",factory:e=>new ca(e,t,a)}]}]}}}}]);