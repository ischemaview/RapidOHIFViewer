"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[99],{6099:(e,t,n)=>{n.r(t),n.d(t,{default:()=>He});var r=n(43001),i=n(14347),o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)};function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function s(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}var l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{};var c=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},u="object"==typeof l&&l&&l.Object===Object&&l,m="object"==typeof self&&self&&self.Object===Object&&self,p=u||m||Function("return this")(),d=p,f=function(){return d.Date.now()},v=/\s/;var g=function(e){for(var t=e.length;t--&&v.test(e.charAt(t)););return t},E=/^\s+/;var w=function(e){return e?e.slice(0,g(e)+1).replace(E,""):e},b=p.Symbol,y=b,I=Object.prototype,h=I.hasOwnProperty,S=I.toString,O=y?y.toStringTag:void 0;var T=function(e){var t=h.call(e,O),n=e[O];try{e[O]=void 0;var r=!0}catch(e){}var i=S.call(e);return r&&(t?e[O]=n:delete e[O]),i},D=Object.prototype.toString;var R=T,C=function(e){return D.call(e)},V=b?b.toStringTag:void 0;var M=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":V&&V in Object(e)?R(e):C(e)},N=function(e){return null!=e&&"object"==typeof e};var L=w,A=c,_=function(e){return"symbol"==typeof e||N(e)&&"[object Symbol]"==M(e)},x=/^[-+]0x[0-9a-f]+$/i,P=/^0b[01]+$/i,k=/^0o[0-7]+$/i,H=parseInt;var j=c,z=f,F=function(e){if("number"==typeof e)return e;if(_(e))return NaN;if(A(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=A(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=L(e);var n=P.test(e);return n||k.test(e)?H(e.slice(2),n?2:8):x.test(e)?NaN:+e},W=Math.max,G=Math.min;var U=function(e,t,n){var r,i,o,a,s,l,c=0,u=!1,m=!1,p=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function d(t){var n=r,o=i;return r=i=void 0,c=t,a=e.apply(o,n)}function f(e){var n=e-l;return void 0===l||n>=t||n<0||m&&e-c>=o}function v(){var e=z();if(f(e))return g(e);s=setTimeout(v,function(e){var n=t-(e-l);return m?G(n,o-(e-c)):n}(e))}function g(e){return s=void 0,p&&r?d(e):(r=i=void 0,a)}function E(){var e=z(),n=f(e);if(r=arguments,i=this,l=e,n){if(void 0===s)return function(e){return c=e,s=setTimeout(v,t),u?d(e):a}(l);if(m)return clearTimeout(s),s=setTimeout(v,t),d(l)}return void 0===s&&(s=setTimeout(v,t)),a}return t=F(t)||0,j(n)&&(u=!!n.leading,o=(m="maxWait"in n)?W(F(n.maxWait)||0,t):o,p="trailing"in n?!!n.trailing:p),E.cancel=function(){void 0!==s&&clearTimeout(s),c=0,r=l=i=s=void 0},E.flush=function(){return void 0===s?a:g(z())},E},K=U,$=c;var q=function(e,t,n){var r=!0,i=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return $(n)&&(r="leading"in n?!!n.leading:r,i="trailing"in n?!!n.trailing:i),K(e,t,{leading:r,maxWait:t,trailing:i})},Y=function(e,t,n,r){switch(t){case"debounce":return U(e,n,r);case"throttle":return q(e,n,r);default:return e}},B=function(e){return"function"==typeof e},J=function(){return"undefined"==typeof window},Z=function(e){return e instanceof Element||e instanceof HTMLDocument},Q=function(e,t,n,r){return function(i){var o=i.width,a=i.height;t((function(t){return t.width===o&&t.height===a||t.width===o&&!r||t.height===a&&!n?t:(e&&B(e)&&e(o,a),{width:o,height:a})}))}},X=function(e){function t(t){var n=e.call(this,t)||this;n.cancelHandler=function(){n.resizeHandler&&n.resizeHandler.cancel&&(n.resizeHandler.cancel(),n.resizeHandler=null)},n.attachObserver=function(){var e=n.props,t=e.targetRef,r=e.observerOptions;if(!J()){t&&t.current&&(n.targetRef.current=t.current);var i=n.getElement();i&&(n.observableElement&&n.observableElement===i||(n.observableElement=i,n.resizeObserver.observe(i,r)))}},n.getElement=function(){var e=n.props,t=e.querySelector,r=e.targetDomEl;if(J())return null;if(t)return document.querySelector(t);if(r&&Z(r))return r;if(n.targetRef&&Z(n.targetRef.current))return n.targetRef.current;var o=(0,i.findDOMNode)(n);if(!o)return null;switch(n.getRenderType()){case"renderProp":case"childFunction":case"child":case"childArray":return o;default:return o.parentElement}},n.createResizeHandler=function(e){var t=n.props,r=t.handleWidth,i=void 0===r||r,o=t.handleHeight,a=void 0===o||o,s=t.onResize;if(i||a){var l=Q(s,n.setState.bind(n),i,a);e.forEach((function(e){var t=e&&e.contentRect||{},r=t.width,i=t.height;!n.skipOnMount&&!J()&&l({width:r,height:i}),n.skipOnMount=!1}))}},n.getRenderType=function(){var e=n.props,t=e.render,i=e.children;return B(t)?"renderProp":B(i)?"childFunction":(0,r.isValidElement)(i)?"child":Array.isArray(i)?"childArray":"parent"};var o=t.skipOnMount,a=t.refreshMode,s=t.refreshRate,l=void 0===s?1e3:s,c=t.refreshOptions;return n.state={width:void 0,height:void 0},n.skipOnMount=o,n.targetRef=(0,r.createRef)(),n.observableElement=null,J()||(n.resizeHandler=Y(n.createResizeHandler,a,l,c),n.resizeObserver=new window.ResizeObserver(n.resizeHandler)),n}return a(t,e),t.prototype.componentDidMount=function(){this.attachObserver()},t.prototype.componentDidUpdate=function(){this.attachObserver()},t.prototype.componentWillUnmount=function(){J()||(this.resizeObserver.disconnect(),this.cancelHandler())},t.prototype.render=function(){var e,t=this.props,n=t.render,i=t.children,o=t.nodeType,a=void 0===o?"div":o,l=this.state,c={width:l.width,height:l.height,targetRef:this.targetRef};switch(this.getRenderType()){case"renderProp":return n&&n(c);case"childFunction":return(e=i)(c);case"child":if((e=i).type&&"string"==typeof e.type){var u=s(c,["targetRef"]);return(0,r.cloneElement)(e,u)}return(0,r.cloneElement)(e,c);case"childArray":return(e=i).map((function(e){return!!e&&(0,r.cloneElement)(e,c)}));default:return r.createElement(a,null)}},t}(r.PureComponent);J()?r.useEffect:r.useLayoutEffect;var ee=n(3827),te=n.n(ee),ne=n(51692),re=n(82125),ie=n(71771),oe=n(20662),ae=n(73704);function se(e){let{viewportData:t,viewportId:n,element:i,imageSliceData:o,setImageSliceData:a,scrollbarHeight:s,servicesManager:l}=e;const{cineService:c,cornerstoneViewportService:u}=l.services;return(0,r.useEffect)((()=>{if(!t)return;const e=u.getCornerstoneViewport(n);if(e)if(t.viewportType!==re.Enums.ViewportType.STACK){if(t.viewportType===re.Enums.ViewportType.ORTHOGRAPHIC){const t=re.utilities.getImageSliceDataForVolumeViewport(e);if(!t)return;const{imageIndex:n,numberOfSlices:r}=t;a({imageIndex:n,numberOfSlices:r})}}else{const n=e.getCurrentImageIdIndex();a({imageIndex:n,numberOfSlices:t.data.imageIds.length})}}),[n,t]),(0,r.useEffect)((()=>{if(t?.viewportType!==re.Enums.ViewportType.STACK)return;const e=e=>{const{newImageIdIndex:n}=e.detail;a({imageIndex:n,numberOfSlices:t.data.imageIds.length})};return i.addEventListener(re.Enums.Events.STACK_VIEWPORT_SCROLL,e),()=>{i.removeEventListener(re.Enums.Events.STACK_VIEWPORT_SCROLL,e)}}),[t,i]),(0,r.useEffect)((()=>{if(t?.viewportType!==re.Enums.ViewportType.ORTHOGRAPHIC)return;const e=e=>{const{imageIndex:t,numberOfSlices:n}=e.detail;a({imageIndex:t,numberOfSlices:n})};return i.addEventListener(re.Enums.Events.VOLUME_NEW_IMAGE,e),()=>{i.removeEventListener(re.Enums.Events.VOLUME_NEW_IMAGE,e)}}),[t,i]),r.createElement(oe.Ln,{onChange:e=>((e,t)=>{const n=u.getCornerstoneViewport(t),{isCineEnabled:r}=c.getState();r&&(c.stopClip(i),c.setCine({id:t,isPlaying:!1})),ne.utilities.jumpToSlice(n.element,{imageIndex:e,debounceLoading:!0})})(e,n),max:o.numberOfSlices?o.numberOfSlices-1:0,height:s,value:o.imageIndex})}se.propTypes={viewportData:te().object,viewportId:te().string.isRequired,element:te().instanceOf(Element),scrollbarHeight:te().string,imageSliceData:te().object.isRequired,setImageSliceData:te().func.isRequired,servicesManager:te().object.isRequired};const le=se;var ce=n(45451),ue=n(71271),me=n.n(ue);function pe(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(null!==e)return parseFloat(e).toFixed(t)}function de(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"MMM D, YYYY";return me()(e,"YYYYMMDD").format(t)}function fe(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"HH:mm:ss";return me()(e,"HH:mm:ss").format(t)}function ve(e){if(!e)return"";const t=e.split("^").filter((e=>!!e)).join(", ").trim();return","===t||""===t?"":t}const ge=1e-4;function Ee(e){let{voi:t,customization:n}=e;const{windowWidth:i,windowCenter:o}=t;return"number"!=typeof o||"number"!=typeof i?null:r.createElement("div",{className:"overlay-item flex flex-row",style:{color:n&&n.color||void 0}},r.createElement("span",{className:"mr-1 shrink-0"},"W:"),r.createElement("span",{className:"ml-1 mr-2 shrink-0 font-light"},i.toFixed(0)),r.createElement("span",{className:"mr-1 shrink-0"},"L:"),r.createElement("span",{className:"ml-1 shrink-0 font-light"},o.toFixed(0)))}function we(e){let{scale:t,customization:n}=e;return r.createElement("div",{className:"overlay-item flex flex-row",style:{color:n&&n.color||void 0}},r.createElement("span",{className:"mr-1 shrink-0"},"Zoom:"),r.createElement("span",{className:"font-light"},t.toFixed(2),"x"))}function be(e){let{instanceNumber:t,imageSliceData:n,customization:i}=e;const{imageIndex:o,numberOfSlices:a}=n;return r.createElement("div",{className:"overlay-item flex flex-row",style:{color:i&&i.color||void 0}},r.createElement("span",{className:"mr-1 shrink-0"},"I:"),r.createElement("span",{className:"font-light"},null!=t?`${t} (${o+1}/${a})`:`${o+1}/${a}`))}function ye(e){let{element:t,viewportData:n,imageSliceData:i,viewportId:o,servicesManager:a}=e;const{toolbarService:s,cornerstoneViewportService:l,customizationService:c}=a.services,[u,m]=(0,r.useState)({windowCenter:null,windowWidth:null}),[p,d]=(0,r.useState)(1),[f,v]=(0,r.useState)([]),{imageIndex:g}=i,E=c.getModeCustomization("cornerstoneOverlayTopLeft"),w=c.getModeCustomization("cornerstoneOverlayTopRight"),b=c.getModeCustomization("cornerstoneOverlayBottomLeft"),y=c.getModeCustomization("cornerstoneOverlayBottomRight"),I=(0,r.useMemo)((()=>null!=n?function(e,t){let n=null;if(e.viewportType===re.Enums.ViewportType.STACK)n=e.data.imageIds[t];else if(e.viewportType===re.Enums.ViewportType.ORTHOGRAPHIC){const r=e.data;if(r&&1==r.length){n=r[0].imageIds[t]}}return n&&re.metaData.get("instance",n)||{}}(n,g):null),[n,g]),h=(0,r.useMemo)((()=>null!=n?function(e,t,n,r){let i;if(e.viewportType===re.Enums.ViewportType.STACK){if(i=function(e,t){const n=e.data.imageIds,r=n[t];if(!r)return;const i=re.metaData.get("generalImageModule",r)||{},{instanceNumber:o}=i;if(n.length<=1)return;return parseInt(o)}(e,n),!i&&0!==i)return null}else e.viewportType===re.Enums.ViewportType.ORTHOGRAPHIC&&(i=Ie(e,n,t));return i}(n,o,g):null),[n,o,g,l]);(0,r.useEffect)((()=>{v(s.getActiveTools())}),[]),(0,r.useEffect)((()=>{const e=e=>{const{range:t}=e.detail;if(!t)return;const{lower:n,upper:r}=t,{windowWidth:i,windowCenter:o}=re.utilities.windowLevel.toWindowLevel(n,r);m({windowCenter:o,windowWidth:i})};return t.addEventListener(re.Enums.Events.VOI_MODIFIED,e),()=>{t.removeEventListener(re.Enums.Events.VOI_MODIFIED,e)}}),[o,n,u,t]),(0,r.useEffect)((()=>{const e=e=>{const{previousCamera:n,camera:r}=e.detail;if(n.parallelScale!==r.parallelScale||n.scale!==r.scale){const e=l.getCornerstoneViewport(o);if(!e)return;const n=e.getImageData();if(!n)return;if(r.scale)return void d(r.scale);const{spacing:i}=n,a=t.clientHeight*i[0]*.5/r.parallelScale;d(a)}};return t.addEventListener(re.Enums.Events.CAMERA_MODIFIED,e),()=>{t.removeEventListener(re.Enums.Events.CAMERA_MODIFIED,e)}}),[o,n,l,t]),(0,r.useEffect)((()=>{const{unsubscribe:e}=s.subscribe(s.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>{v(s.getActiveTools())}));return()=>{e()}}),[s]);const S=(0,r.useCallback)((e=>{const s={element:t,viewportData:n,imageSliceData:i,viewportId:o,servicesManager:a,customization:e,formatters:{formatPN:ve,formatDate:de,formatTime:fe,formatNumberPrecision:pe},instance:I,voi:u,scale:p,instanceNumber:h};if("ohif.overlayItem.windowLevel"===e.customizationType)return r.createElement(Ee,s);if("ohif.overlayItem.zoomLevel"===e.customizationType)return r.createElement(we,s);if("ohif.overlayItem.instanceNumber"===e.customizationType)return r.createElement(be,s);{const t=c.transform(e);if("function"==typeof t.content)return t.content(s)}}),[t,n,i,o,a,c,I,u,p,h]),O=(0,r.useCallback)((()=>{const e=E?.items||[{id:"WindowLevel",customizationType:"ohif.overlayItem.windowLevel"}];return r.createElement(r.Fragment,null,e.map(((e,t)=>r.createElement("div",{key:`topLeftOverlayItem_${t}`},S(e)))))}),[E,S]),T=(0,r.useCallback)((()=>{const e=w?.items||[{id:"InstanceNmber",customizationType:"ohif.overlayItem.instanceNumber"}];return r.createElement(r.Fragment,null,e.map(((e,t)=>r.createElement("div",{key:`topRightOverlayItem_${t}`},S(e)))))}),[w,S]),D=(0,r.useCallback)((()=>{const e=b?.items||[];return r.createElement(r.Fragment,null,e.map(((e,t)=>r.createElement("div",{key:`bottomLeftOverlayItem_${t}`},S(e)))))}),[b,S]),R=(0,r.useCallback)((()=>{const e=y?.items||[];return r.createElement(r.Fragment,null,e.map(((e,t)=>r.createElement("div",{key:`bottomRightOverlayItem_${t}`},S(e)))))}),[y,S]);return r.createElement(oe.No,{topLeft:O(),topRight:T(),bottomLeft:D(),bottomRight:R()})}function Ie(e,t,n){const r=e.volumes;if(!r||r.length>1)return;const i=r[0],{direction:o,imageIds:a}=i,s=n.getCornerstoneViewport(t);if(!s)return;const l=s.getCamera(),{viewPlaneNormal:c}=l,u=o.slice(6,9),m=ce.R3.cross(ce.R3.create(),c,u);if(ce.R3.length(m)<ge){const e=a[imageIndex];if(!e)return{};const{instanceNumber:t}=re.metaData.get("generalImageModule",e)||{};return parseInt(t)}}ye.propTypes={viewportData:te().object,imageIndex:te().number,viewportId:te().string};const he=ye;var Se=n(44921),Oe=n.n(Se);const{getOrientationStringLPS:Te,invertOrientationStringLPS:De}=ne.utilities.orientation;function Re(e){let{element:t,viewportData:n,imageSliceData:i,viewportId:o,servicesManager:a,orientationMarkers:s=["top","left"]}=e;const[l,c]=(0,r.useState)(0),[u,m]=(0,r.useState)(!1),[p,d]=(0,r.useState)(!1),{cornerstoneViewportService:f}=a.services;(0,r.useEffect)((()=>{const e=e=>{const{rotation:t,previousCamera:n,camera:r}=e.detail;void 0!==t&&c(t),void 0!==r.flipHorizontal&&n.flipHorizontal!==r.flipHorizontal&&m(r.flipHorizontal),void 0!==r.flipVertical&&n.flipVertical!==r.flipVertical&&d(r.flipVertical)};return t.addEventListener(re.Enums.Events.CAMERA_MODIFIED,e),()=>{t.removeEventListener(re.Enums.Events.CAMERA_MODIFIED,e)}}),[]);const v=(0,r.useMemo)((()=>{if(!n)return"";let e,a;if("stack"===n.viewportType){const t=i.imageIndex,r=n.data.imageIds?.[t];if(!r)return!1;({rowCosines:e,columnCosines:a}=re.metaData.get("imagePlaneModule",r)||{})}else{if(!t||!(0,re.getEnabledElement)(t))return"";const{viewport:n}=(0,re.getEnabledElement)(t),{viewUp:r,viewPlaneNormal:i}=n.getCamera(),o=ce.R3.create();ce.R3.cross(o,r,i),a=[-r[0],-r[1],-r[2]],e=o}if(!e||!a||void 0===l)return"";const c=function(e,t,n,r,i){const o=Te(e),a=Te(t),s=De(o),l={top:De(a),left:s,right:o,bottom:a};r&&(l.top=De(l.top),l.bottom=De(l.bottom));i&&(l.left=De(l.left),l.right=De(l.right));if(90===n||-270===n)return{top:l.left,left:De(l.top),right:De(l.bottom),bottom:l.right};if(-90===n||270===n)return{top:De(l.left),left:l.top,bottom:l.left,right:l.bottom};if(180===n||-180===n)return{top:De(l.top),left:De(l.left),bottom:De(l.bottom),right:De(l.right)};return l}(e,a,l,p,u),m=f.getViewportInfo(o);if(!m)return console.log("ViewportOrientationMarkers::No viewport"),null;const d=m.getViewportOptions().background,v=!!d&&re.utilities.isEqual(d,[1,1,1]);return s.map(((e,t)=>r.createElement("div",{className:Oe()(`${e}-mid orientation-marker`,v?"text-[#726F7E]":"text-[#ccc]"),key:`${e}-mid orientation-marker`},r.createElement("div",{className:"orientation-marker-value"},c[e]))))}),[n,i,l,p,u,s,t]);return r.createElement("div",{className:"ViewportOrientationMarkers noselect"},v)}Re.propTypes={percentComplete:te().number,error:te().object},Re.defaultProps={percentComplete:0,error:null};const Ce=Re;function Ve(e){let{viewportData:t,element:n}=e;const[i,o]=(0,r.useState)(!1),[a,s]=(0,r.useState)(!1),l=(0,r.useRef)(null),c=(0,r.useRef)(null),u=e=>{clearTimeout(l.current),l.current=setTimeout((()=>{o(!0)}),50)},m=e=>{clearTimeout(l.current),o(!1)},p=e=>{clearTimeout(l.current),c.current===e.detail.imageId&&(s(e.detail.error),c.current=null)};return(0,r.useEffect)((()=>(n.addEventListener(re.Enums.Events.STACK_VIEWPORT_SCROLL,u),n.addEventListener(re.Enums.Events.IMAGE_LOAD_ERROR,p),n.addEventListener(re.Enums.Events.STACK_NEW_IMAGE,m),()=>{n.removeEventListener(re.Enums.Events.STACK_VIEWPORT_SCROLL,u),n.removeEventListener(re.Enums.Events.STACK_NEW_IMAGE,m),n.removeEventListener(re.Enums.Events.IMAGE_LOAD_ERROR,p)})),[n,t]),a?r.createElement(r.Fragment,null,r.createElement("div",{className:"absolute top-0 left-0 h-full w-full bg-black opacity-50"},r.createElement("div",{className:"transparent flex h-full w-full items-center justify-center"},r.createElement("p",{className:"text-primary-light text-xl font-light"},r.createElement("h4",null,"Error Loading Image"),r.createElement("p",null,"An error has occurred."),r.createElement("p",null,a))))):i?r.createElement("div",{className:"pointer-events-none absolute top-0 left-0 h-full w-full bg-black opacity-50"},r.createElement("div",{className:"transparent flex h-full w-full items-center justify-center"},r.createElement("p",{className:"text-primary-light text-xl font-light"},"Loading..."))):null}Ve.propTypes={percentComplete:te().number,error:te().object,element:te().object},Ve.defaultProps={percentComplete:0,error:null};const Me=Ve;const Ne=function(e){const{viewportId:t,element:n,scrollbarHeight:i,servicesManager:o}=e,{disableViewportImageScrollbar:a,disableViewportOverlay:s,disableViewportImageSliceLoadingIndicator:l,disableViewportOrientationMarkers:c}=e,{cornerstoneViewportService:u}=o.services,[m,p]=(0,r.useState)({imageIndex:0,numberOfSlices:0}),[d,f]=(0,r.useState)(null);if((0,r.useEffect)((()=>{const{unsubscribe:e}=u.subscribe(u.EVENTS.VIEWPORT_DATA_CHANGED,(e=>{e.viewportId===t&&f(e.viewportData)}));return()=>{e()}}),[t]),!n)return null;if(d){const e=u.getViewportInfo(t);if(e?.viewportOptions?.customViewportProps?.hideOverlays)return null}return r.createElement("div",{className:"noselect"},!a&&r.createElement(le,{viewportId:t,viewportData:d,element:n,imageSliceData:m,setImageSliceData:p,scrollbarHeight:i,servicesManager:o}),!s&&r.createElement(he,{imageSliceData:m,viewportData:d,viewportId:t,servicesManager:o,element:n}),!l&&r.createElement(Me,{viewportData:d,element:n}),!c&&r.createElement(Ce,{imageSliceData:m,element:n,viewportData:d,servicesManager:o,viewportId:t}))};var Le=n(87172);const Ae=function(e){let{enabledVPElement:t,viewportId:n,servicesManager:i}=e;const{toolbarService:o,customizationService:a}=i.services,[{isCineEnabled:s,cines:l},c]=(0,oe.vQ)(),[{activeViewportId:u}]=(0,oe.O_)(),{component:m=oe.H6}=a.get("cinePlayer")??{},p=()=>{if(!l||!l[n]||!t)return;const e=l[n],r=e.isPlaying||!1,i=e.frameRate||24,o=Math.max(i,1);r?c.playClip(t,{framesPerSecond:o}):c.stopClip(t)};(0,r.useEffect)((()=>(re.eventTarget.addEventListener(re.Enums.Events.STACK_VIEWPORT_NEW_STACK,p),()=>{c.setCine({id:n,isPlaying:!1}),re.eventTarget.removeEventListener(re.Enums.Events.STACK_VIEWPORT_NEW_STACK,p)})),[t]),(0,r.useEffect)((()=>{if(l&&l[n]&&t)return p(),()=>{t&&l?.[n]?.isPlaying&&c.stopClip(t)}}),[l,n,c,t,p]);const d=l[n],f=d&&d.isPlaying||!1;return s&&r.createElement(m,{className:"absolute left-1/2 bottom-3 -translate-x-1/2",isPlaying:f,onClose:()=>{o.recordInteraction({groupId:"MoreTools",interactionType:"toggle",commands:[{commandName:"toggleCine",commandOptions:{},toolName:"cine",context:"CORNERSTONE"}]})},onPlayPauseChange:e=>c.setCine({id:u,isPlaying:e}),onFrameRateChange:e=>c.setCine({id:u,frameRate:e})})};let _e;function xe(e,t){if(t.needsRerendering)return!1;if(e.displaySets.length!==t.displaySets.length)return!1;if(e.viewportOptions.orientation!==t.viewportOptions.orientation)return!1;if(e.viewportOptions.toolGroupId!==t.viewportOptions.toolGroupId)return!1;if(e.viewportOptions.viewportType!==t.viewportOptions.viewportType)return!1;if(t.viewportOptions.needsRerendering)return!1;const n=e.displaySets,r=t.displaySets;if(n.length!==r.length)return!1;for(let e=0;e<n.length;e++){const t=n[e],i=r.find((e=>e.displaySetInstanceUID===t.displaySetInstanceUID));if(!i)return!1;if(i.images?.length!==t.images?.length)return!1;if(i.images?.length)for(let e=0;e<i.images.length;e++)if(i.images[e].imageId!==t.images[e].imageId)return!1}return!0}const Pe=r.memo(r.forwardRef(((e,t)=>{const{displaySets:n,dataSource:i,viewportOptions:o,displaySetOptions:a,servicesManager:s,commandsManager:l,onElementEnabled:c,onElementDisabled:u,isJumpToMeasurementDisabled:m,onViewportDataLoad:p,initialImageIndex:d,disableViewportImageScrollbar:f,disableViewportOverlay:v,disableViewportImageSliceLoadingIndicator:g,disableViewportOrientationMarkers:E}=e,w=o.viewportId,[b,y]=(0,r.useState)("100px"),[I,h]=(0,r.useState)(null),S=(0,r.useRef)();r.useImperativeHandle(t,(()=>S.current));const{measurementService:O,displaySetService:T,toolbarService:D,toolGroupService:R,syncGroupService:C,cornerstoneViewportService:V,cornerstoneCacheService:M,viewportGridService:N,stateSyncService:L}=s.services,[A]=(0,oe.en)(),_=(0,r.useCallback)((()=>{const e=S.current.clientHeight-20+"px";y(e)}),[S]),x=(0,r.useCallback)((()=>{S.current&&(V.resize(),_())}),[S]),P=(0,r.useCallback)((e=>{const t=e.getRenderingEngineId(),n=e.getSyncGroups();R.removeViewportFromToolGroup(w,t),C.removeViewportFromSyncGroup(w,t,n)}),[w]),k=(0,r.useCallback)((e=>{if(e.detail.element!==S.current)return;const{viewportId:t,element:n}=e.detail,r=V.getViewportInfo(t);(0,ae.Yc)(t,n),h(n);const i=r.getRenderingEngineId(),o=r.getToolGroupId(),a=r.getSyncGroups();R.addViewportToToolGroup(t,i,o),C.addViewportToSyncGroup(t,i,a),c&&c(e)}),[w,c,R]);return(0,r.useEffect)((()=>(V.enableViewport(w,S.current),re.eventTarget.addEventListener(re.Enums.Events.ELEMENT_ENABLED,k),_(),()=>{const e=V.getViewportInfo(w);e&&(P(e),V.storePresentation({viewportId:w}),u&&u(e),re.eventTarget.removeEventListener(re.Enums.Events.ELEMENT_ENABLED,k))})),[]),(0,r.useEffect)((()=>{const{unsubscribe:e}=T.subscribe(T.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,(async e=>{let{displaySetInstanceUID:t,invalidateData:n}=e;if(!n)return;const r=V.getViewportInfo(w);if(r&&r.hasDisplaySet(t)){const e=r.getViewportData(),n=await M.invalidateViewportData(e,t,i,T),o=!0;V.updateViewport(w,n,o)}}));return()=>{e()}}),[w]),(0,r.useEffect)((()=>{o.viewportType||(o.viewportType="stack");(async()=>{const e=await M.createViewportData(n,o,i,d),{presentationIds:t}=o,r=V.getPresentationByID(t);let s;console.log(r),_e?.viewportId===w&&(s=_e.measurement,r.positionPresentation=null,_e=null),o.needsRerendering&&(o.needsRerendering=!1),V.setViewportData(w,e,o,a,r).then((e=>{p&&p(e)})),s&&ne.annotation.selection.setAnnotationSelected(s.uid)})()}),[o,n,i]),(0,r.useEffect)((()=>{if(m)return;const e=function(e,t,n,r,i,o,a){const{unsubscribe:s}=e.subscribe(ie.MeasurementService.EVENTS.JUMP_TO_MEASUREMENT_VIEWPORT,(i=>{_e=i;const{viewportId:s,measurement:l,isConsumed:c}=i;l&&!c&&(void 0===_e.cornerstoneViewport&&(_e.cornerstoneViewport=a.getViewportIdToJump(s,l.displaySetInstanceUID,{referencedImageId:l.referencedImageId})),_e.cornerstoneViewport===r&&ke(l,n,r,e,t,o,a))}));return s}(O,T,S,w,0,N,V);return function(e,t,n,r,i,o,a){if(!_e)return;if(_e.isConsumed)return void(_e=null);const s=i.map((e=>e.displaySetInstanceUID));if(!s?.length)return;const{measurement:l}=_e;l&&n&&s.includes(l?.displaySetInstanceUID)&&ke(l,n,r,e,t,o,a)}(O,T,S,w,n,N,V),()=>{e()}}),[n,S,w]),r.createElement(r.Fragment,null,r.createElement("div",{className:"viewport-wrapper"},r.createElement(X,{refreshMode:"debounce",refreshRate:50,onResize:x,targetRef:S.current}),r.createElement("div",{className:"cornerstone-viewport-element",style:{height:"100%",width:"100%"},onContextMenu:e=>e.preventDefault(),onMouseDown:e=>e.preventDefault(),ref:S}),r.createElement(Ne,{viewportId:w,disableViewportImageScrollbar:f,disableViewportOverlay:v,disableViewportImageSliceLoadingIndicator:g,disableViewportOrientationMarkers:E,toolBarService:D,element:S.current,scrollbarHeight:b,servicesManager:s}),r.createElement(Ae,{enabledVPElement:I,viewportId:w,servicesManager:s})),r.createElement("div",{className:"absolute w-full"},A.viewportId===w&&r.createElement(oe.P_,{id:"viewport-notification",message:A.message,type:A.type,actions:A.actions,onSubmit:A.onSubmit,onOutsideClick:A.onOutsideClick})))})),xe);function ke(e,t,n,r,i,o,a){const s=t.current,{displaySetInstanceUID:l,SOPInstanceUID:c,frameNumber:u}=e;if(!c)return void console.warn("cannot jump in a non-acquisition plane measurements yet");const m=i.getDisplaySetByUID(l);o.setActiveViewportId(n);const p=(0,re.getEnabledElement)(s);if(p){const t=p.viewport;let n=0,r=!0;if(t instanceof re.StackViewport){n=t.getImageIds().findIndex((e=>{const{SOPInstanceUID:t,frameNumber:n}=(0,Le.Z)(e);return t===c&&(!u||u===n)}))}else{const{viewPlaneNormal:i}=e.metadata;n=m.images.findIndex((e=>e.SOPInstanceUID===c));const{viewPlaneNormal:o}=t.getCamera();i&&!re.utilities.isEqual(i.map(Math.abs),o.map(Math.abs))&&(r=!1)}if(!r||-1===n)return;ne.utilities.jumpToSlice(s,{imageIndex:n}),ne.annotation.selection.setAnnotationSelected(e.uid),_e?.consume?.(),_e=null}}Pe.displayName="OHIFCornerstoneViewport",Pe.defaultProps={isJumpToMeasurementDisabled:!1},Pe.propTypes={displaySets:te().array.isRequired,dataSource:te().object.isRequired,viewportOptions:te().object,displaySetOptions:te().arrayOf(te().any),servicesManager:te().object.isRequired,onElementEnabled:te().func,isJumpToMeasurementDisabled:te().bool,onViewportDataLoad:te().func,initialImageIdOrIndex:te().oneOfType([te().string,te().number])};const He=Pe}}]);